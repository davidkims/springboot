name: Workflow Health Monitor and Alerting # ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„
description: Monitor recent workflow failures and notify via Slack

on:
  workflow_run:
    # 'on.workflow_run does not reference any workflows' ì˜¤ë¥˜ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ 'workflows: []'ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì¶”ê°€í•©ë‹ˆë‹¤.
    # ì´ëŠ” ë¦¬í¬ì§€í† ë¦¬ì˜ ëª¨ë“  ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ì„ ê°ì‹œí•˜ê² ë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.
    workflows: [] # 'workflow_run' í•˜ìœ„ì—ì„œ 2ì¹¸ ë“¤ì—¬ì“°ê¸°
    types: [completed] # 'workflow_run' í•˜ìœ„ì—ì„œ 2ì¹¸ ë“¤ì—¬ì“°ê¸°

  schedule:
    # UTC ê¸°ì¤€ ë§¤ ì‹œê°„ 0ë¶„(ì •ì‹œ)ì— ì›Œí¬í”Œë¡œìš°ë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤.
    # ì´ëŠ” 'workflow_run' íŠ¸ë¦¬ê±°ê°€ ë†“ì¹  ìˆ˜ ìˆëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ ë°±ì—… ì—­í• ì„ í•©ë‹ˆë‹¤.
    - cron: '0 * * * *' # 'schedule' í•˜ìœ„ì—ì„œ 2ì¹¸ ë“¤ì—¬ì“°ê¸°, ëª©ë¡ ì•„ì´í…œì€ í•˜ì´í”ˆ(-)ìœ¼ë¡œ ì‹œì‘

  workflow_dispatch: {} # GitHub UIì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©í•©ë‹ˆë‹¤.

jobs:
  monitor-and-alert:
    runs-on: ubuntu-latest # ì´ Jobì„ ì‹¤í–‰í•  GitHub í˜¸ìŠ¤íŒ… ëŸ¬ë„ˆ í™˜ê²½ì„ ì§€ì •í•©ë‹ˆë‹¤.

    # ì´ ì›Œí¬í”Œë¡œìš°ê°€ ë‹¤ë¥¸ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê¸°ë¡ì„ ì½ê³ , ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œë¥¼ ì²´í¬ì•„ì›ƒí•  ìˆ˜ ìˆë„ë¡ í•„ìš”í•œ ê¶Œí•œì„ ëª…ì‹œì ìœ¼ë¡œ ë¶€ì—¬í•©ë‹ˆë‹¤.
    permissions:
      actions: read # 'permissions' í•˜ìœ„ì—ì„œ 2ì¹¸ ë“¤ì—¬ì“°ê¸°
      contents: read # 'permissions' í•˜ìœ„ì—ì„œ 2ì¹¸ ë“¤ì—¬ì“°ê¸°

    steps: # 'monitor-and-alert' Job í•˜ìœ„ì—ì„œ 2ì¹¸ ë“¤ì—¬ì“°ê¸°, ëª©ë¡ ì•„ì´í…œì€ í•˜ì´í”ˆ(-)ìœ¼ë¡œ ì‹œì‘
      - name: Checkout repository code # 'steps'ì˜ ì²« ë²ˆì§¸ ì•„ì´í…œ. 'name'ì€ 4ì¹¸ ë“¤ì—¬ì“°ê¸°
        uses: actions/checkout@v4 # 'uses'ëŠ” 'name'ê³¼ ê°™ì€ ìˆ˜ì¤€ (4ì¹¸) ë“¤ì—¬ì“°ê¸°

      - name: Fetch recent workflow runs # 'steps'ì˜ ë‘ ë²ˆì§¸ ì•„ì´í…œ
        id: get_workflow_runs # 'Fetch recent workflow runs' ìŠ¤í… í•˜ìœ„ì—ì„œ 2ì¹¸ (ì´ 6ì¹¸) ë“¤ì—¬ì“°ê¸°
        run: | # 'run'ì€ 'id'ì™€ ê°™ì€ ìˆ˜ì¤€ (6ì¹¸) ë“¤ì—¬ì“°ê¸°. ì—¬ëŸ¬ ì¤„ ìŠ¤í¬ë¦½íŠ¸ëŠ” '|' ë’¤ì— ìƒˆ ì¤„ë¡œ ì‹œì‘í•˜ë©° ë“¤ì—¬ì“°ê¸° ìœ ì§€
          # GitHub APIë¥¼ ì‚¬ìš©í•˜ì—¬ ìµœê·¼ 24ì‹œê°„ ë‚´ì— ìƒì„±ëœ ì‹¤íŒ¨í•œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ëª©ë¡ì„ ì¿¼ë¦¬í•©ë‹ˆë‹¤.
          # 'jq'ëŠ” JSON ì‘ë‹µì„ íŒŒì‹±í•˜ëŠ” ë„êµ¬ì´ë©°, GitHub Actions ëŸ¬ë„ˆì— ê¸°ë³¸ìœ¼ë¡œ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
          FAILED_RUNS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?status=failure&created=>$(date -u -d '24 hours ago' '+%Y-%m-%dT%H:%M:%SZ')" | \
            jq -r '.workflow_runs[] | "- \(.name) (\(.html_url)) (ID: \(.id), Event: \(.event))"')

          # ì‹¤íŒ¨í•œ ì›Œí¬í”Œë¡œìš°ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , ê²°ê³¼ë¥¼ ì¶œë ¥ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
          if [ -n "$FAILED_RUNS" ]; then
            echo "::set-output name=failed_runs::$FAILED_RUNS"
            echo "ğŸš¨ Failed workflows detected:"
            echo "$FAILED_RUNS"
          else
            echo "âœ… No failed workflows detected in the last 24 hours."
            echo "::set-output name=failed_runs::" # ì‹¤íŒ¨ê°€ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ë¡œ ì„¤ì •
          fi
        env: # 'env'ëŠ” 'run'ê³¼ ê°™ì€ ìˆ˜ì¤€ (6ì¹¸) ë“¤ì—¬ì“°ê¸°
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # 'env' í•˜ìœ„ì—ì„œ 2ì¹¸ (ì´ 8ì¹¸) ë“¤ì—¬ì“°ê¸°

      - name: Send Alert if workflows failed (Slack Example) # 'steps'ì˜ ì„¸ ë²ˆì§¸ ì•„ì´í…œ
        if: steps.get_workflow_runs.outputs.failed_runs != '' # 'if'ëŠ” 'name'ê³¼ ê°™ì€ ìˆ˜ì¤€ (4ì¹¸) ë“¤ì—¬ì“°ê¸°
        uses: rtCamp/action-slack-notify@v2 # 'uses'ëŠ” 'name'ê³¼ ê°™ì€ ìˆ˜ì¤€ (4ì¹¸) ë“¤ì—¬ì“°ê¸°
        env: # 'env'ëŠ” 'uses'ì™€ ê°™ì€ ìˆ˜ì¤€ (4ì¹¸) ë“¤ì—¬ì“°ê¸°
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }} # 'env' í•˜ìœ„ì—ì„œ 2ì¹¸ (ì´ 6ì¹¸) ë“¤ì—¬ì“°ê¸°
          SLACK_MESSAGE: | # 'env' í•˜ìœ„ì—ì„œ 2ì¹¸ (ì´ 6ì¹¸) ë“¤ì—¬ì“°ê¸°. ì—¬ëŸ¬ ì¤„ ë©”ì‹œì§€ëŠ” '|' ë’¤ì— ìƒˆ ì¤„ë¡œ ì‹œì‘í•˜ë©° ë“¤ì—¬ì“°ê¸° ìœ ì§€
            *GitHub Actions Workflow Failure Alert*
            Repository: `${{ github.repository }}`
            Failed Workflows (Last 24h):
            ${{ steps.get_workflow_runs.outputs.failed_runs }}

            Please investigate immediately.
          SLACK_USERNAME: GitHub Actions Bot # 'SLACK_MESSAGE'ì™€ ê°™ì€ ìˆ˜ì¤€ (6ì¹¸) ë“¤ì—¬ì“°ê¸°
          SLACK_CHANNEL: '#github-alerts' # 'SLACK_USERNAME'ì™€ ê°™ì€ ìˆ˜ì¤€ (6ì¹¸) ë“¤ì—¬ì“°ê¸°
          SLACK_ICON_EMOJI: ':octocat:' # 'SLACK_CHANNEL'ì™€ ê°™ì€ ìˆ˜ì¤€ (6ì¹¸) ë“¤ì—¬ì“°ê¸°

      # ì„ íƒ ì‚¬í•­: ì›Œí¬í”Œë¡œìš° íŒŒì¼ ì„¤ëª… ëˆ„ë½ ê²€ì‚¬
      - name: Install yq # 'steps'ì˜ ë„¤ ë²ˆì§¸ ì•„ì´í…œ
        uses: mikefarah/yq@v4 # 'uses'ëŠ” 'name'ê³¼ ê°™ì€ ìˆ˜ì¤€ (4ì¹¸) ë“¤ì—¬ì“°ê¸°

      - name: Check for missing workflow descriptions # 'steps'ì˜ ë‹¤ì„¯ ë²ˆì§¸ ì•„ì´í…œ
        run: |
          MISSING_DESCRIPTIONS_COUNT=0
          MISSING_DESCRIPTIONS_LIST=""
          # .github/workflows ë””ë ‰í† ë¦¬ ë‚´ì˜ ëª¨ë“  .yml ì›Œí¬í”Œë¡œìš° íŒŒì¼ì„ ìˆœíšŒí•©ë‹ˆë‹¤.
          for workflow_file in .github/workflows/*.yml; do
            if [ -f "$workflow_file" ]; then
              description=$(yq e '.description // ""' "$workflow_file")
              if [ -z "$description" ]; then
                echo "::warning file=$workflow_file::Workflow '$workflow_file' is missing a 'description' field. Please add one for better documentation."
                MISSING_DESCRIPTIONS_COUNT=$((MISSING_DESCRIPTIONS_COUNT + 1))
                MISSING_DESCRIPTIONS_LIST+="\n- $workflow_file"
              fi
            fi
          done

          # ëˆ„ë½ëœ ì„¤ëª…ì´ ìˆì–´ë„ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤íŒ¨ì‹œí‚¤ì§€ ì•Šê³  ê²½ê³ ë§Œ ì¶œë ¥í•©ë‹ˆë‹¤.
          if [ "$MISSING_DESCRIPTIONS_COUNT" -gt 0 ]; then
            echo "::warning::Found $MISSING_DESCRIPTIONS_COUNT workflow(s) with missing 'description' field(s):$MISSING_DESCRIPTIONS_LIST"
          else
            echo "âœ… All workflow files have descriptions. Good for documentation!"
          fi
