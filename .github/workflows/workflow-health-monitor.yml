name: Workflow Health Monitor and Alerting # ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„. ì²« ì¤„ì— êµ¬ë¬¸ ì˜¤ë¥˜ê°€ ë°œìƒí•  ê°€ëŠ¥ì„±ì€ ë‚®ìŒ.

on:
  workflow_run:
    # 'on.workflow_run does not reference any workflows' ì˜¤ë¥˜ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ 'workflows: []'ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì¶”ê°€í•©ë‹ˆë‹¤.
    # ì´ëŠ” ë¦¬í¬ì§€í† ë¦¬ì˜ ëª¨ë“  ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ì„ ê°ì‹œí•˜ê² ë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.
    workflows: [] # ì´ ì¤„ì€ í•„ìˆ˜ì´ë©°, ë“¤ì—¬ì“°ê¸°ê°€ 'workflow_run'ê³¼ ë™ì¼í•´ì•¼ í•©ë‹ˆë‹¤.
    types: [completed] # ë‹¤ë¥¸ ì›Œí¬í”Œë¡œìš°ê°€ 'completed' (ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ì™„ë£Œ) ìƒíƒœì¼ ë•Œ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤.

  schedule:
    # UTC ê¸°ì¤€ ë§¤ ì‹œê°„ 0ë¶„(ì •ì‹œ)ì— ì›Œí¬í”Œë¡œìš°ë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤.
    # ì´ëŠ” 'workflow_run' íŠ¸ë¦¬ê±°ê°€ ë†“ì¹  ìˆ˜ ìˆëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ ë°±ì—… ì—­í• ì„ í•©ë‹ˆë‹¤.
    - cron: '0 * * * *'

  workflow_dispatch: {} # GitHub UIì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©í•©ë‹ˆë‹¤.

jobs:
  monitor-and-alert:
    runs-on: ubuntu-latest # ì´ Jobì„ ì‹¤í–‰í•  GitHub í˜¸ìŠ¤íŒ… ëŸ¬ë„ˆ í™˜ê²½ì„ ì§€ì •í•©ë‹ˆë‹¤.
    
    # ì´ ì›Œí¬í”Œë¡œìš°ê°€ ë‹¤ë¥¸ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê¸°ë¡ì„ ì½ê³ , ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œë¥¼ ì²´í¬ì•„ì›ƒí•  ìˆ˜ ìˆë„ë¡ í•„ìš”í•œ ê¶Œí•œì„ ëª…ì‹œì ìœ¼ë¡œ ë¶€ì—¬í•©ë‹ˆë‹¤.
    permissions:
      actions: read # ë‹¤ë¥¸ ì›Œí¬í”Œë¡œìš°ì˜ ì‹¤í–‰ ê¸°ë¡ì„ ì½ê¸° ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤.
      contents: read # ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œë¥¼ ì²´í¬ì•„ì›ƒí•˜ê³ , .github/workflows/*.yml íŒŒì¼ì„ ì½ê¸° ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤.

    steps:
      - name: Checkout repository code # ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œë¥¼ ëŸ¬ë„ˆì— ì²´í¬ì•„ì›ƒí•©ë‹ˆë‹¤.
        uses: actions/checkout@v4

      - name: Fetch recent workflow runs # ìµœê·¼ 24ì‹œê°„ ë‚´ì— ì‹¤íŒ¨í•œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê¸°ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        id: get_workflow_runs # ì´ ìŠ¤í…ì˜ ì¶œë ¥ì„ ì°¸ì¡°í•˜ê¸° ìœ„í•œ ID
        run: |
          # GitHub APIë¥¼ ì‚¬ìš©í•˜ì—¬ ìµœê·¼ 24ì‹œê°„ ë‚´ì— ìƒì„±ëœ ì‹¤íŒ¨í•œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ëª©ë¡ì„ ì¿¼ë¦¬í•©ë‹ˆë‹¤.
          # 'jq'ëŠ” JSON ì‘ë‹µì„ íŒŒì‹±í•˜ëŠ” ë„êµ¬ì´ë©°, GitHub Actions ëŸ¬ë„ˆì— ê¸°ë³¸ìœ¼ë¡œ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
          FAILED_RUNS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?status=failure&created=>$(date -u -d '24 hours ago' '+%Y-%m-%dT%H:%M:%SZ')" | \
            jq -r '.workflow_runs[] | "- \(.name) (\(.html_url)) (ID: \(.id), Event: \(.event))"')

          # ì‹¤íŒ¨í•œ ì›Œí¬í”Œë¡œìš°ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , ê²°ê³¼ë¥¼ ì¶œë ¥ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
          if [ -n "$FAILED_RUNS" ]; then
            echo "::set-output name=failed_runs::$FAILED_RUNS"
            echo "ğŸš¨ Failed workflows detected:"
            echo "$FAILED_RUNS"
          else
            echo "âœ… No failed workflows detected in the last 24 hours."
            echo "::set-output name=failed_runs::" # ì‹¤íŒ¨ê°€ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ë¡œ ì„¤ì •
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub Actionsì—ì„œ ê¸°ë³¸ ì œê³µí•˜ëŠ” í† í° (repo ìŠ¤ì½”í”„ì— 'actions:read' ê¶Œí•œ í•„ìš”)

      - name: Send Alert if workflows failed (Slack Example) # ì‹¤íŒ¨í•œ ì›Œí¬í”Œë¡œìš°ê°€ ìˆì„ ê²½ìš° Slackìœ¼ë¡œ ì•Œë¦¼ì„ ë³´ëƒ…ë‹ˆë‹¤.
        # ì´ì „ 'get_workflow_runs' ìŠ¤í…ì—ì„œ 'failed_runs' ì¶œë ¥ì´ ë¹„ì–´ìˆì§€ ì•Šì„ ë•Œë§Œ ì´ ìŠ¤í…ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
        if: steps.get_workflow_runs.outputs.failed_runs != ''
        uses: rtCamp/action-slack-notify@v2 # Slack ì•Œë¦¼ì„ ìœ„í•œ GitHub Action ì‚¬ìš©
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }} # GitHub Secretsì— ì €ì¥ëœ Slack Webhook URL ì‚¬ìš©
          SLACK_MESSAGE: | # Slackì— ì „ì†¡ë  ë©”ì‹œì§€ ë‚´ìš©ì„ ì •ì˜í•©ë‹ˆë‹¤. Markdown í˜•ì‹ ì§€ì›.
            *GitHub Actions Workflow Failure Alert*
            Repository: `${{ github.repository }}`
            Failed Workflows (Last 24h):
            ${{ steps.get_workflow_runs.outputs.failed_runs }}

            Please investigate immediately.
          SLACK_USERNAME: GitHub Actions Bot # Slack ì•Œë¦¼ì˜ ë°œì‹ ì ì´ë¦„
          SLACK_CHANNEL: '#github-alerts' # ì•Œë¦¼ì„ ë³´ë‚¼ Slack ì±„ë„ (í•„ìš”ì— ë”°ë¼ ë³€ê²½)
          SLACK_ICON_EMOJI: ':octocat:' # ì•Œë¦¼ì— ì‚¬ìš©í•  ì´ëª¨ì§€ (ì„ íƒ ì‚¬í•­)

      # --- ì„ íƒ ì‚¬í•­: ì›Œí¬í”Œë¡œìš° íŒŒì¼ ì„¤ëª… ëˆ„ë½ ê²€ì‚¬ ---
      # ì´ ì„¹ì…˜ì€ ì œê³µí•´ì£¼ì‹  'ì„¤ëª…ì´ í•„ìš”í•©ë‹ˆë‹¤' ë¬¸ì œì— ëŒ€í•œ í•´ê²°ì±…ì…ë‹ˆë‹¤.
      - name: Install yq # YAML íŒŒì¼ì„ ì•ˆì „í•˜ê²Œ íŒŒì‹±í•˜ê¸° ìœ„í•œ 'yq' ë„êµ¬ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.
        uses: mikefarah/yq@v4 # 'yq' ì•¡ì…˜ì˜ ìµœì‹  ì•ˆì • ë²„ì „ ì‚¬ìš©

      - name: Check for missing workflow descriptions # ëª¨ë“  ì›Œí¬í”Œë¡œìš° íŒŒì¼ì— 'description' í•„ë“œê°€ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
        run: |
          MISSING_DESCRIPTIONS_COUNT=0
          MISSING_DESCRIPTIONS_LIST=""
          # .github/workflows ë””ë ‰í† ë¦¬ ë‚´ì˜ ëª¨ë“  .yml ì›Œí¬í”Œë¡œìš° íŒŒì¼ì„ ìˆœíšŒí•©ë‹ˆë‹¤.
          for workflow_file in .github/workflows/*.yml; do
            # íŒŒì¼ì´ ì¡´ì¬í•˜ê³  ì¼ë°˜ íŒŒì¼ì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤.
            if [ -f "$workflow_file" ]; then
              # 'yq'ë¥¼ ì‚¬ìš©í•˜ì—¬ 'description' í•„ë“œë¥¼ ì½ìŠµë‹ˆë‹¤. í•„ë“œê°€ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
              description=$(yq e '.description // ""' "$workflow_file")
              
              # 'description'ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
              if [ -z "$description" ]; then
                echo "::warning file=$workflow_file::Workflow '$workflow_file' is missing a 'description' field. Please add one for better documentation."
                MISSING_DESCRIPTIONS_COUNT=$((MISSING_DESCRIPTIONS_COUNT + 1))
                MISSING_DESCRIPTIONS_LIST+="\n- $workflow_file"
              fi
            fi
          done

          # ì„¤ëª…ì´ ëˆ„ë½ëœ ì›Œí¬í”Œë¡œìš°ê°€ í•˜ë‚˜ë¼ë„ ìˆë‹¤ë©´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤íŒ¨ì‹œí‚µë‹ˆë‹¤.
          if [ "$MISSING_DESCRIPTIONS_COUNT" -gt 0 ]; then
            echo "::error::Found $MISSING_DESCRIPTIONS_COUNT workflow(s) with missing 'description' field(s):$MISSING_DESCRIPTIONS_LIST"
            exit 1 # ì´ ìŠ¤í…ì´ ì‹¤íŒ¨í•˜ì—¬ ì „ì²´ ì›Œí¬í”Œë¡œìš°ë„ ì‹¤íŒ¨í•˜ê²Œ ë©ë‹ˆë‹¤.
          else
            echo "âœ… All workflow files have descriptions. Good for documentation!"
          fi
