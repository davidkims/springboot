name: ğŸ§¾ Docker ëª…í•¨ ì´ë¯¸ì§€ ìƒì„± ë° ë³´ì•ˆ ë””ë²„ê¹…

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-customer-cards:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      packages: read
      security-events: write

    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ğŸ“ ë””ë ‰í† ë¦¬ ë° ì´ˆê¸° í™˜ê²½ ìƒì„±
      run: |
        sudo mkdir -p /data/cards /opt/bin /etc/workflows
        sudo chmod -R 777 /data /opt/bin /etc/workflows

    - name: ğŸ³ Dockerfile ë° Python ìŠ¤í¬ë¦½íŠ¸ ë‹¤ìš´ë¡œë“œ
      run: |
        mkdir -p app
        curl -fsSL https://raw.githubusercontent.com/davidkims/assets/main/customer/Dockerfile -o Dockerfile || {
          echo "FROM python:3.10-slim" > Dockerfile
          echo "WORKDIR /app" >> Dockerfile
          echo "COPY . ." >> Dockerfile
          echo "RUN pip install pillow" >> Dockerfile
          echo "CMD [\"python\", \"generate_card.py\"]" >> Dockerfile
        }

        curl -fsSL https://raw.githubusercontent.com/davidkims/assets/main/customer/generate_card.py -o app/generate_card.py || {
          echo "from PIL import Image, ImageDraw, ImageFont" > app/generate_card.py
          echo "img = Image.new('RGB', (400, 200), color = (73, 109, 137))" >> app/generate_card.py
          echo "d = ImageDraw.Draw(img)" >> app/generate_card.py
          echo "d.text((10,10), 'ê³ ê° ê±°ë˜ ëª…í•¨', fill=(255,255,0))" >> app/generate_card.py
          echo "img.save('/data/cards/customer_card.png')" >> app/generate_card.py
        }

    - name: ğŸ› ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ
      run: docker build -t customer-card-generator .

    - name: ğŸƒ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰
      run: |
        docker run --rm -v /data/cards:/data/cards customer-card-generator

    - name: ğŸ“· ê²°ê³¼ ì´ë¯¸ì§€ íŒŒì¼ í™•ì¸
      run: |
        ls -l /data/cards
        file /data/cards/customer_card.png || echo "âŒ ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨"

    - name: ğŸ” ê¶Œí•œ ë¬¸ì œ ë””ë²„ê·¸ (.github/workflows ì ‘ê·¼ ë“±)
      run: |
        echo "ğŸ›¡ï¸ .github/workflows ë””ë ‰í† ë¦¬ ê¶Œí•œ í™•ì¸:"
        ls -ld .github .github/workflows || echo "âŒ ì ‘ê·¼ ë¶ˆê°€"

        echo "ğŸ” ì‚¬ìš©ì ë° ì‹¤í–‰ ì •ë³´:"
        whoami
        id

        echo "ğŸ”§ ë””ë²„ê·¸ìš© ê¶Œí•œ ì¬ì„¤ì • ì‹œë„:"
        sudo chmod -R 755 .github || echo "âš ï¸ sudo ì‹¤íŒ¨"

        echo "âœ… í˜„ì¬ ìƒíƒœ:"
        stat .github || true
        stat .github/workflows || true

    - name: ğŸ“¦ ê²°ê³¼ë¬¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: generated-customer-cards
        path: /data/cards
