name: ğŸ¬ MySQL Setup, Migration & Backup

on:
  workflow_dispatch:

jobs:
  mysql_setup_and_backup:
    runs-on: ubuntu-latest

    env:
      MYSQL_IMAGE: mysql:8.0
      DB_NAME: example_db
      DB_USER: root
      DB_PASS: rootpass123
      ROOT_PASS: rootpass123
      MIGRATION_DIR: /opt/mysql/migrations
      BACKUP_DIR: /opt/backup/sql

    steps:
      - name: ğŸ“ ë§ˆì´ê·¸ë ˆì´ì…˜ ë””ë ‰í† ë¦¬ ë° SQL ìƒì„±
        run: |
          sudo mkdir -p $MIGRATION_DIR
          echo "CREATE TABLE IF NOT EXISTS accounts (id INT AUTO_INCREMENT PRIMARY KEY, name VARCHAR(50), balance DECIMAL(12,2));" > $MIGRATION_DIR/migrate.sql
          echo "INSERT INTO accounts(name, balance) VALUES ('í™ê¸¸ë™', 1000000);" >> $MIGRATION_DIR/migrate.sql
          sudo chmod -R 777 /opt/mysql

      - name: ğŸ§ª MySQL ì„¤ì¹˜
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y mysql-server

      - name: ğŸ§¼ MySQL ì´ˆê¸°í™” ë° root íŒ¨ìŠ¤ì›Œë“œ ì„¤ì •
        run: |
          sudo systemctl stop mysql
          sudo mkdir -p /var/run/mysqld
          sudo chown mysql:mysql /var/run/mysqld
          sudo mysqld_safe --skip-networking --skip-grant-tables &
          sleep 10

          echo "FLUSH PRIVILEGES;\nALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '${ROOT_PASS}';\nFLUSH PRIVILEGES;" | sudo mysql -u root

          sudo killall mysqld
          sleep 5
          sudo systemctl start mysql

      - name: ğŸ› ï¸ DB ë° ì‚¬ìš©ì ìƒì„±
        run: |
          mysql -u root -p$ROOT_PASS -e "CREATE DATABASE IF NOT EXISTS $DB_NAME;"
          mysql -u root -p$ROOT_PASS -e "CREATE USER IF NOT EXISTS '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASS';"
          mysql -u root -p$ROOT_PASS -e "GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'localhost';"
          mysql -u root -p$ROOT_PASS -e "FLUSH PRIVILEGES;"

      - name: ğŸ“¥ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
        run: |
          mysql -u $DB_USER -p$DB_PASS $DB_NAME < $MIGRATION_DIR/migrate.sql

      - name: âœ… ë°ì´í„° í™•ì¸
        run: |
          mysql -u $DB_USER -p$DB_PASS -e "USE $DB_NAME; SHOW TABLES; SELECT * FROM accounts;"

      - name: ğŸ•’ Generate Timestamp and Dynamic Port
        id: vars
        run: |
          TS=$(date +%Y%m%d%H%M%S)
          PORT=$((RANDOM%1000+3307))
          echo "timestamp=$TS" >> $GITHUB_OUTPUT
          echo "container=backup-mysql-$TS" >> $GITHUB_OUTPUT
          echo "host_port=$PORT" >> $GITHUB_OUTPUT

      - name: ğŸ³ Launch MySQL Backup Container
        run: |
          docker run -d \
            --name ${{ steps.vars.outputs.container }} \
            -e MYSQL_ROOT_PASSWORD=$DB_PASS \
            -e MYSQL_DATABASE=$DB_NAME \
            -p ${{ steps.vars.outputs.host_port }}:3306 \
            $MYSQL_IMAGE
          echo "â³ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘..."
          sleep 30

      - name: ğŸ” Generate Secure MySQL Login File (.my.cnf)
        run: |
          echo "[client]" > ~/.my.cnf
          echo "user=$DB_USER" >> ~/.my.cnf
          echo "password=$DB_PASS" >> ~/.my.cnf
          echo "host=127.0.0.1" >> ~/.my.cnf
          echo "port=${{ steps.vars.outputs.host_port }}" >> ~/.my.cnf
          chmod 600 ~/.my.cnf

      - name: ğŸ“ Create Backup Directory
        run: |
          sudo mkdir -p $BACKUP_DIR
          sudo chmod -R 777 $BACKUP_DIR

      - name: ğŸ’¾ Run mysqldump Backup
        run: |
          TIMESTAMP=${{ steps.vars.outputs.timestamp }}
          BACKUP_FILE="$BACKUP_DIR/backup-$TIMESTAMP.sql"
          echo "ğŸ” ë°±ì—… ì‹œì‘: $BACKUP_FILE"
          mysqldump $DB_NAME > $BACKUP_FILE || { echo "âŒ ë°±ì—… ì‹¤íŒ¨"; exit 1; }
          echo "âœ… ë°±ì—… ì™„ë£Œ: $BACKUP_FILE"
          ls -lh $BACKUP_DIR

      - name: ğŸ” Print Container Info
        run: |
          echo "ğŸ“¦ ì»¨í…Œì´ë„ˆ ì´ë¦„: ${{ steps.vars.outputs.container }}"
          echo "ğŸ”Œ ì—°ê²°ëœ í¬íŠ¸: ${{ steps.vars.outputs.host_port }}"
