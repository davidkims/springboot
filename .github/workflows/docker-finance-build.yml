name: 🐳 Build and Optional Push Docker Image

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  docker-build:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: ghcr.io/davidkims/finance-app
      IMAGE_TAG: latest
      GHCR_PAT: ${{ secrets.GHCR_PAT || '' }}  # optional
      KAFKA_LOG: kafka.log

    steps:
      - name: 📂 Checkout Repository
        uses: actions/checkout@v4

      - name: 🛠️ Ensure Dockerfile Exists (Autogenerate if missing)
        run: |
          if [ ! -f Dockerfile ]; then
            echo "⚠️ Dockerfile not found. Creating default Dockerfile..."
            cat <<EOF > Dockerfile
FROM alpine:latest

RUN mkdir -p /app
RUN echo "\$(date) 계좌이체 상태: 완료" > /app/transactions.log
RUN echo "\$(date) 신용카드 상태: 완료" >> /app/transactions.log
RUN echo "\$(date) 비트코인 상태: 진행중" >> /app/transactions.log

CMD ["cat", "/app/transactions.log"]
EOF
          else
            echo "✅ Dockerfile already exists."
          fi

      - name: 🏗️ Build Docker Image
        run: docker build -t $IMAGE_NAME:$IMAGE_TAG .

      - name: 🔐 Conditional Docker Login (GHCR)
        if: env.GHCR_PAT != ''
        run: echo "${GHCR_PAT}" | docker login ghcr.io -u davidkims --password-stdin

      - name: 🚀 Conditional Push to GHCR
        if: env.GHCR_PAT != ''
        run: docker push $IMAGE_NAME:$IMAGE_TAG

      - name: 📋 Simulate Kafka Log Output
        run: |
          echo "$(date '+%Y-%m-%d %H:%M:%S') [backup] 거래 상태: 완료" >> $KAFKA_LOG
          cat $KAFKA_LOG || echo "⚠️ 로그 없음"
