name: ðŸ’³ ì¹´ë“œì‚¬ë³„ ê±°ëž˜ ë°±ì—… + NetBackup + OCI ì—…ë¡œë“œ

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  finance-netbackup:
    runs-on: ubuntu-latest

    env:
      OCI_BUCKET_NAME: your-bucket-name
      OCI_NAMESPACE: your-namespace
      OCI_REGION: ap-seoul-1

    steps:
      - name: ðŸ“ ì €ìž¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ðŸ§° Swift ì„¤ì¹˜
        run: |
          sudo apt-get update
          sudo apt-get install -y clang libicu-dev libpython3-dev zip
          curl --proto '=https' --tlsv1.2 -fsSL https://download.swift.org/swift-5.9-release/ubuntu2204/swift-5.9-RELEASE/swift-5.9-RELEASE-ubuntu22.04.tar.gz -o swift.tar.gz
          sudo mkdir -p /opt/swift
          sudo tar -xzf swift.tar.gz -C /opt/swift --strip-components=1
          echo "/opt/swift/usr/bin" >> $GITHUB_PATH

      - name: ðŸ§¾ ì¹´ë“œì‚¬ë³„ ê±°ëž˜ íŒŒì¼ ìƒì„± (í…ìŠ¤íŠ¸ í˜•ì‹)
        run: |
          mkdir -p /opt/backup /opt/reports
          for company in ì‚¼ì„± í˜„ëŒ€ ë¡¯ë°; do
            filename="/opt/backup/transactions_${company}.txt"
            echo "company=${company}" > "$filename"
            echo "card=ì‹ ìš©ì¹´ë“œ amount=$((RANDOM % 500000 + 50000)) timestamp=$(date -Iseconds)" >> "$filename"
            echo "card=ë²•ì¸ì¹´ë“œ amount=$((RANDOM % 500000 + 50000)) timestamp=$(date -Iseconds)" >> "$filename"
            echo "card=ì²´í¬ì¹´ë“œ amount=$((RANDOM % 500000 + 50000)) timestamp=$(date -Iseconds)" >> "$filename"

            report="/opt/reports/report_${company}.txt"
            echo "=== ${company} ê±°ëž˜ ë³´ê³ ì„œ ===" > "$report"
            echo "ìƒì„± ì‹œê°„: $(date)" >> "$report"
            echo "íŒŒì¼ ê²½ë¡œ: $filename" >> "$report"
          done

      - name: ðŸ—œï¸ ZIP ì••ì¶•
        run: |
          mkdir -p output
          zip -j output/all_transactions_$(date +%Y%m%d%H%M).zip /opt/backup/*.txt

      - name: â˜ï¸ Oracle OCI CLI ì„¤ì¹˜
        run: |
          curl --proto '=https' --tlsv1.2 -sL https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh | bash -s -- --accept-all-defaults
          echo "$HOME/bin" >> $GITHUB_PATH
          oci --version || echo "âœ… OCI CLI ì„¤ì¹˜ë¨"

      - name: â˜ï¸ ì¹´ë“œì‚¬ë³„ ê±°ëž˜ íŒŒì¼ OCI ì—…ë¡œë“œ
        run: |
          for txtfile in /opt/backup/*.txt; do
            filename=$(basename $txtfile)
            echo "â˜ï¸ ì—…ë¡œë“œ ì¤‘: $filename"
            oci os object put \
              --bucket-name $OCI_BUCKET_NAME \
              --namespace $OCI_NAMESPACE \
              --file "$txtfile" \
              --name "backups/$filename" \
              --region $OCI_REGION \
              --force || echo "âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: $filename"
          done

      - name: ðŸ§± NetBackup CLI ì„¤ì¹˜ ë° bpbackup ì‹¤í–‰
        run: |
          echo "ðŸ“¦ NetBackup CLI ì‹œë®¬ë ˆì´ì…˜ ì„¤ì¹˜"
          sudo mkdir -p /usr/openv/netbackup/bin
          echo -e '#!/bin/bash\necho \"[bpbackup] ë°±ì—… ì‹¤í–‰: \$1\"' | sudo tee /usr/openv/netbackup/bin/bpbackup
          sudo chmod +x /usr/openv/netbackup/bin/bpbackup

          mkdir -p /opt/netbackup/data
          cp /opt/backup/*.txt /opt/netbackup/data/

          for file in /opt/netbackup/data/*.txt; do
            /usr/openv/netbackup/bin/bpbackup -f "$file"
          done

      - name: ðŸ“Š ìµœì¢… ë³´ê³ ì„œ
        run: |
          echo "âœ… ë°±ì—… ì™„ë£Œ ë³´ê³ ì„œ" > final-report.txt
          echo "ì‹¤í–‰ ì‹œê°„: $(date)" >> final-report.txt
          echo "ì••ì¶• íŒŒì¼: $(ls output/*.zip)" >> final-report.txt
          echo "NetBackup ë°±ì—… ëŒ€ìƒ:" >> final-report.txt
          ls /opt/netbackup/data >> final-report.txt
          cat final-report.txt
