# .github/workflows/jfrog-sast-scan.yml
name: "JFrog SAST Scan"

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: '25 4 * * 1'  # ë§¤ì£¼ ì›”ìš”ì¼ UTC 04:25

env:
  # JFrog í”Œë«í¼ URL ë° í† í°ì„ Secretsì— ì„¤ì •í•˜ì„¸ìš”
  JF_URL: ${{ secrets.JF_URL }}
  JF_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}

jobs:
  analyze:
    name: JFrog SAST Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16'

      - name: ğŸ› ï¸ Install JFrog CLI
        run: |
          echo "ğŸ“¦ Installing JFrog CLI via npm..."
          if npm install -g jfrog-cli-v2-jf; then
            echo "âœ… Installed JFrog CLI (npm)"
          else
            echo "âš ï¸ npm install failed, falling back to binary download"
            echo "ğŸ“¥ Downloading JFrog CLI binary..."
            curl -fL https://getcli.jfrog.io | sh
            chmod +x jfrog
            sudo mv jfrog /usr/local/bin/jfrog
            echo "âœ… Installed JFrog CLI (binary)"
          fi

      - name: ğŸ” Verify JFrog CLI version
        run: |
          echo "ğŸ”’ Verifying JFrog CLI..."
          jf --version

      - name: ğŸ“ Create JFrog CLI config directory
        run: |
          echo "ğŸ“‚ Setting up config directory..."
          mkdir -p ~/.jfrog

      - name: ğŸ”‘ Configure JFrog CLI
        run: |
          echo "ğŸ” Configuring JFrog CLI with defaults..."
          jf c add default \
            --url="$JF_URL" \
            --access-token="$JF_TOKEN" \
            --interactive=false

      - name: ğŸ“¦ Install project dependencies
        if: fileExists('package.json')
        run: |
          echo "ğŸ“¥ Installing project dependencies..."
          npm ci

      - name: ğŸ“‚ Create output directory
        run: |
          echo "ğŸ“‚ Creating reports directory..."
          mkdir -p reports

      - name: ğŸ” Run JFrog SAST scan
        run: |
          echo "ğŸ” Running JFrog SAST (SAST) scan..."
          jf audit --sast --format=sarif > reports/jfrog_sast.sarif
          echo "âœ… SAST scan complete, output -> reports/jfrog_sast.sarif"

      - name: â˜ï¸ Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/jfrog_sast.sarif
