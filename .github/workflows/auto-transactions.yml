name: üîê Fix MySQL Root Access and Create Ledger Table

on:
  workflow_dispatch:

jobs:
  fix-mysql:
    runs-on: ubuntu-latest

    env:
      MYSQL_ROOT_PASS: rootpass123
      DB_NAME: ledger_db

    steps:
      - name: üß± Install MySQL
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-server

      - name: ‚öôÔ∏è Force MySQL to start with no auth
        run: |
          echo '[mysqld]' | sudo tee /etc/mysql/mysql.conf.d/skip-auth.cnf
          echo 'skip-grant-tables' | sudo tee -a /etc/mysql/mysql.conf.d/skip-auth.cnf
          sudo systemctl restart mysql

      - name: üîê Set root password and auth method manually
        run: |
          sudo mysql -e "
            ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '${MYSQL_ROOT_PASS}';
            FLUSH PRIVILEGES;
          "

      - name: üßπ Remove skip-grant-tables and restart MySQL
        run: |
          sudo rm /etc/mysql/mysql.conf.d/skip-auth.cnf
          sudo systemctl restart mysql

      - name: üßæ Create ledger_db and ledger table
        run: |
          mysql -u root -p${MYSQL_ROOT_PASS} -e "
            CREATE DATABASE IF NOT EXISTS ${DB_NAME};
            USE ${DB_NAME};
            CREATE TABLE IF NOT EXISTS ledger (
              id INT AUTO_INCREMENT PRIMARY KEY,
              transaction_type VARCHAR(30),
              amount DECIMAL(12,2),
              currency VARCHAR(10),
              status VARCHAR(20),
              detail TEXT,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
            INSERT INTO ledger(transaction_type, amount, currency, status, detail) VALUES
              ('credit_card', 100000, 'KRW', 'completed', 'Ïã†Ïö©Ïπ¥Îìú Í≤∞Ï†ú'),
              ('check_card', 50000, 'KRW', 'completed', 'Ï≤¥ÌÅ¨Ïπ¥Îìú Í≤∞Ï†ú'),
              ('stock', 3000000, 'KRW', 'executed', 'Ï£ºÏãù Îß§Ïàò'),
              ('forex', 2000, 'USD', 'completed', 'ÌôòÏ†Ñ Í±∞Îûò'),
              ('bank_transfer', 150000, 'KRW', 'completed', 'Ïù¥Ï≤¥ ÏôÑÎ£å');
          "

      - name: üìã ÌôïÏù∏:Ledger Print
        run: |
          mysql -u root -p${MYSQL_ROOT_PASS} -e "USE ${DB_NAME}; SELECT * FROM ledger;"
