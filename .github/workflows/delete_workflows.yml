name: Archive & Delete Old Workflow Files

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ 0ì‹œ 30ë¶„ (UTC) ì‹¤í–‰ â†’ í•œêµ­ ì‹œê°„(KST)ìœ¼ë¡œ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ 30ë¶„
    - cron: '30 0 * * 1'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry Run (ì‹¤ì œ ì‚­ì œ ì—†ì´ ë¡œê·¸ë§Œ í™•ì¸) - true/false'
        required: false
        type: boolean
        default: true

jobs:
  archive_and_delete_old_files:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1) ì „ì²´ íˆìŠ¤í† ë¦¬ë¥¼ ë‚´ë ¤ë°›ì•„ì•¼ ìµœì¢… ìˆ˜ì • ì¼ìë¥¼ ì •í™•íˆ ë¹„êµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) Git ì‚¬ìš©ì ì •ë³´
      - name: Configure Git User
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # 3) ì˜¤ë˜ëœ ì›Œí¬í”Œë¡œìš° íŒŒì¼ì„ ì•„ì¹´ì´ë¸Œ(ì´ë™)í•˜ê³ , ì‚­ì œ ì—¬ë¶€ë¥¼ ê²°ì •í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸
      - name: Archive and Delete old workflow files
        env:
          DRY_RUN: ${{ github.event.inputs.dry_run }}
          ARCHIVE_DIR: .github/archived_workflows
          WORKFLOW_DIR: .github/workflows
        run: |
          echo "=========================================="
          echo "DRY_RUN ëª¨ë“œ ì„¤ì •: $DRY_RUN"
          echo "ì•„ì¹´ì´ë¸Œ ë””ë ‰í† ë¦¬: $ARCHIVE_DIR"
          echo "ì›Œí¬í”Œë¡œìš° ë””ë ‰í† ë¦¬: $WORKFLOW_DIR"
          echo "=========================================="

          # 1) .github/workflows ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if [ ! -d "$WORKFLOW_DIR" ]; then
            echo "âŒ ì›Œí¬í”Œë¡œìš° ë””ë ‰í† ë¦¬($WORKFLOW_DIR)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¢…ë£Œí•©ë‹ˆë‹¤."
            exit 0
          fi

          # 2) 1ë…„ ì „ ê¸°ì¤€ ë‚ ì§œ ê³„ì‚° (YYYY-MM-DD)
          ONE_YEAR_AGO=$(date -d "1 year ago" +%Y-%m-%d)
          echo "ê¸°ì¤€ ë‚ ì§œ (1ë…„ ì „): $ONE_YEAR_AGO"

          ARCHIVED_ANY=false
          FILES_TO_DELETE=()

          # 3) .yml íŒŒì¼ ìˆœíšŒ
          for file_path in "$WORKFLOW_DIR"/*.yml; do
            # íŒŒì¼ì´ ì—†ìœ¼ë©´ ê±´ë„ˆëœ€
            if [ ! -e "$file_path" ]; then
              echo "â€” í•´ë‹¹ ê²½ë¡œì— .yml íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: $file_path"
              continue
            fi

            file_name=$(basename "$file_path")
            echo ""
            echo "íŒŒì¼ ê²€ì‚¬ ì¤‘: $file_name"

            # 4) Git ë¡œê·¸ì—ì„œ ìµœì¢… ìˆ˜ì • ë‚ ì§œ ê°€ì ¸ì˜¤ê¸° (YYYY-MM-DD)
            last_modified_date=$(git log -1 --format="%ci" "$file_path" | cut -d ' ' -f1)
            echo "  â€¢ ìµœì¢… ìˆ˜ì • ë‚ ì§œ: $last_modified_date"

            # 5) ë¹„êµ: YYYY-MM-DD í˜•ì‹ì´ë¯€ë¡œ ë¬¸ìì—´ ë¹„êµë¡œ ê°€ëŠ¥
            if [[ "$last_modified_date" < "$ONE_YEAR_AGO" ]]; then
              echo "  âš ï¸ $file_name ì€(ëŠ”) ê¸°ì¤€ ë‚ ì§œ ì´ì „(1ë…„ ì´ìƒ)ìœ¼ë¡œ ìˆ˜ì •ë¨ â†’ ì•„ì¹´ì´ë¸Œ ëŒ€ìƒ"
              if [ "$DRY_RUN" = "true" ] || [ -z "$DRY_RUN" ]; then
                echo "    [DRY RUN] ì•„ì¹´ì´ë¸Œ ì˜ˆì •: $file_name"
              else
                # 6) ì‹¤ì œ ì•„ì¹´ì´ë¸Œ(ì´ë™)
                if [ ! -d "$ARCHIVE_DIR" ]; then
                  echo "    â–¶ ì•„ì¹´ì´ë¸Œ ë””ë ‰í† ë¦¬ ìƒì„±: $ARCHIVE_DIR"
                  mkdir -p "$ARCHIVE_DIR"
                  git add "$ARCHIVE_DIR"
                fi

                echo "    â–¶ ì•„ì¹´ì´ë¸Œ ì‹¤í–‰: $file_name â†’ $ARCHIVE_DIR/$file_name"
                mv "$file_path" "$ARCHIVE_DIR/$file_name"
                ARCHIVED_ANY=true
                FILES_TO_DELETE+=("$file_name")
              fi
            else
              echo "  â© $file_name ì€(ëŠ”) 1ë…„ ì´ë‚´ì— ìˆ˜ì •ë¨ â†’ ê±´ë„ˆëœ€"
            fi
          done

          echo ""
          # 7) Dry Run ìƒíƒœì—ì„œëŠ” ì‹¤ì œ ì‚­ì œì™€ ì»¤ë°‹ì„ ìˆ˜í–‰í•˜ì§€ ì•ŠìŒ
          if [ "$DRY_RUN" = "true" ] || [ -z "$DRY_RUN" ]; then
            echo "â­ [DRY RUN ëª¨ë“œ] ì‹¤ì œ íŒŒì¼ ì‚­ì œ ë° ì»¤ë°‹ì„ ìˆ˜í–‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            exit 0
          fi

          # 8) ì‹¤ì œ ì•„ì¹´ì´ë¸Œê°€ ë°œìƒí–ˆëŠ”ì§€ í™•ì¸
          if [ "$ARCHIVED_ANY" = true ]; then
            echo "=========================================="
            echo "ğŸ—‘ï¸ ì•„ì¹´ì´ë¸Œëœ íŒŒì¼ì´ ì¡´ì¬í•˜ë¯€ë¡œ ì‚­ì œ ë° ì»¤ë°‹ì„ ì§„í–‰í•©ë‹ˆë‹¤."
            for fname in "${FILES_TO_DELETE[@]}"; do
              echo "    â€¢ ì‚­ì œ: $WORKFLOW_DIR/$fname"
              git rm "$WORKFLOW_DIR/$fname"
            done

            COMMIT_MESSAGE="chore(workflow): Auto-archive and delete old workflow files"
            echo "â–¶ ì»¤ë°‹ ë©”ì‹œì§€: $COMMIT_MESSAGE"
            git commit -m "$COMMIT_MESSAGE"

            echo "â–¶ ì›ê²© ì €ì¥ì†Œì— í‘¸ì‹œ"
            # í˜„ì¬ ë¸Œëœì¹˜ë¥¼ ì¶”ì¶œ (ì˜ˆ: refs/heads/main â†’ main)
            CURRENT_BRANCH="${GITHUB_REF#refs/heads/}"
            git push origin "HEAD:${CURRENT_BRANCH}"
            echo "âœ… í‘¸ì‹œ ì™„ë£Œ"
          else
            echo "=========================================="
            echo "â„¹ï¸ ì•„ì¹´ì´ë¸Œ ëŒ€ìƒ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ì‚­ì œ ë° ì»¤ë°‹ì„ ê±´ë„ˆëœë‹ˆë‹¤."
          fi
