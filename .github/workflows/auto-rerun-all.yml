name: ì‹¤íŒ¨í•œ ëª¨ë“  ì›Œí¬í”Œë¡œ ìë™ ì¬ì‹œë„

permissions:
  actions: write   # reRunWorkflowFailedJobs í˜¸ì¶œ ê¶Œí•œ
  contents: read   # ë¦¬í¬ì§€í† ë¦¬ ì›Œí¬í”Œë¡œìš° ëª©ë¡ ì¡°íšŒ ê¶Œí•œ

on:
  schedule:
    # ë§¤ 5ë¶„ë§ˆë‹¤ ì‹¤í–‰
    - cron: '*/5 * * * *'

jobs:
  rerun-all-failed:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ ì¬ì‹¤í–‰ ëŒ€ìƒ íƒìƒ‰ ë° ì‹¤í–‰
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // 1) ë¦¬í¬ì§€í† ë¦¬ ë‚´ ëª¨ë“  ì›Œí¬í”Œë¡œìš° ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ
            const { data: wfList } = await github.rest.actions.listWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            for (const wf of wfList.workflows) {
              // 2) ê° ì›Œí¬í”Œë¡œìš°ë³„ ìµœê·¼ 10ê±´ì˜ completed ì‹¤í–‰ ì¡°íšŒ
              const { data: runs } = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: wf.id,
                status: 'completed',
                per_page: 10
              });
              
              for (const run of runs.workflow_runs) {
                // 3) ì‹¤íŒ¨(failure) ë˜ëŠ” ì·¨ì†Œ(cancelled)ëœ ê²½ìš°ë§Œ ì¬ì‹¤í–‰ API í˜¸ì¶œ
                if (['failure', 'cancelled'].includes(run.conclusion)) {
                  console.log(`ğŸ” Re-running failed jobs of '${wf.name}' run #${run.id}`);
                  await github.rest.actions.reRunWorkflowFailedJobs({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: run.id
                  });
                }
              }
            }
