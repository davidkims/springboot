name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ë°°í¬ with Echo

on:
  push:
    branches:
      - main # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
  pull_request:
    branches:
      - main # main ë¸Œëœì¹˜ë¡œ í’€ ë¦¬í€˜ìŠ¤íŠ¸ ë°œìƒ ì‹œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
  workflow_dispatch: # GitHub UIì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©

env:
  # Docker ì´ë¯¸ì§€ ì´ë¦„ (ì›í•˜ëŠ” ì´ë¦„ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”)
  IMAGE_NAME: my-app-image
  # Docker ì´ë¯¸ì§€ íƒœê·¸ (Git SHAë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©)
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # ì´ ì‘ì—…ì„ ì‹¤í–‰í•  ìš´ì˜ì²´ì œ í™˜ê²½ì„ ì§€ì •í•©ë‹ˆë‹¤.

    steps:
      - name: ğŸš€ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4 # ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œë¥¼ ì›Œí¬í”Œë¡œìš° ëŸ¬ë„ˆë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
        run: echo "--- ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œ ì²´í¬ì•„ì›ƒ ì™„ë£Œ ---"

      - name: ğŸ³ Docker ìµœì‹  ë²„ì „ ë° CLI ì„¤ì¹˜
        # Docker ê³µì‹ setup-docker-actionì„ ì‚¬ìš©í•˜ì—¬ Docker Engine ë° CLIë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.
        uses: docker/setup-docker@v4
        run: echo "--- Docker Engine ë° CLI ì„¤ì¹˜ ì™„ë£Œ ---"

      - name: â„¹ï¸ Docker CLI ë²„ì „ í™•ì¸
        run: |
          echo "í˜„ì¬ ì‹œìŠ¤í…œì˜ Docker ë²„ì „ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:"
          docker --version
          echo "Docker Compose ë²„ì „ (ì„¤ì¹˜ë˜ì–´ ìˆë‹¤ë©´):"
          docker compose version || true # docker composeê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•Šì•„ë„ ì˜¤ë¥˜ ë°œìƒí•˜ì§€ ì•Šë„ë¡
          echo "Docker ì‹œìŠ¤í…œ ì •ë³´:"
          docker info
          echo "--- Docker CLI ì¤€ë¹„ ì™„ë£Œ ---"

      - name: ğŸ“ íŒŒì¼ ë° ë””ë ‰í† ë¦¬ ìƒì„±
        run: |
          echo "--- íŒŒì¼ ë° ë””ë ‰í† ë¦¬ ìƒì„± ì‹œì‘ ---"
          echo "ìƒˆë¡œìš´ ë””ë ‰í† ë¦¬ 'my-data-volume' ìƒì„± ì¤‘..."
          mkdir -p my-data-volume/logs
          echo "ìƒˆë¡œìš´ íŒŒì¼ 'my-data-volume/app.log' ìƒì„± ì¤‘..."
          echo "ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ë¡œê·¸: $(date)" > my-data-volume/app.log
          echo "ë˜ ë‹¤ë¥¸ íŒŒì¼ 'my-data-volume/logs/error.log' ìƒì„± ì¤‘..."
          echo "ì—ëŸ¬ ë°œìƒ: $(date)" > my-data-volume/logs/error.log
          echo "ìƒì„±ëœ íŒŒì¼ ë° ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸:"
          ls -R my-data-volume/
          echo "--- íŒŒì¼ ë° ë””ë ‰í† ë¦¬ ìƒì„± ì™„ë£Œ ---"

      - name: âš™ï¸ Docker Buildx ì„¤ì • (ì„ íƒ ì‚¬í•­:ë©€í‹° í”Œë«í¼ ë¹Œë“œ ë° ìºì‹±ì— ìœ ìš©)
        # ë©€í‹° í”Œë«í¼ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê±°ë‚˜ ë¹Œë“œ ìºì‹±ì„ ì‚¬ìš©í•˜ë ¤ë©´ í•„ìš”í•©ë‹ˆë‹¤.
        # ë¹Œë“œ ì†ë„ í–¥ìƒì— ê¸°ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        uses: docker/setup-buildx-action@v3
        run: echo "--- Docker Buildx ì„¤ì • ì™„ë£Œ ---"

      - name: ğŸ”‘ Docker Hub ë¡œê·¸ì¸ (ì„ íƒ ì‚¬í•­:Docker Hubì— í‘¸ì‹œí•  ê²½ìš°)
        if: ${{ secrets.DOCKER_USERNAME && secrets.DOCKER_PASSWORD }} # ì‹œí¬ë¦¿ì´ ì„¤ì •ë˜ì–´ ìˆì„ ë•Œë§Œ ì‹¤í–‰
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
        run: echo "--- Docker Hub ë¡œê·¸ì¸ ì‹œë„ ì™„ë£Œ (ì‹œí¬ë¦¿ì´ ìˆëŠ” ê²½ìš°) ---"

      - name: ğŸ”‘ GitHub Container Registry (GHCR) ë¡œê·¸ì¸ (ì„ íƒ ì‚¬í•­:GHCRì— í‘¸ì‹œí•  ê²½ìš°)
        # GHCRì— í‘¸ì‹œí•  ê²½ìš°, GITHUB_TOKENì„ ì‚¬ìš©í•˜ì—¬ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
        run: echo "--- GHCR ë¡œê·¸ì¸ ì‹œë„ ì™„ë£Œ ---"

      - name: ğŸ—ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ
        # Dockerfileì„ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³  íƒœê·¸ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
        # `context: .`ì€ í˜„ì¬ ë¦¬í¬ì§€í† ë¦¬ ë£¨íŠ¸ë¥¼ ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ë¡œ ì‚¬ìš©í•¨ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
        # `push: false`ë¡œ ì„¤ì •í•˜ì—¬ ë¹Œë“œë§Œ í•˜ê³  í‘¸ì‹œëŠ” í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (ì•„ë˜ ìŠ¤í…ì—ì„œ í‘¸ì‹œ)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile # Dockerfile ê²½ë¡œ ì§€ì •
          tags: |
            ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest # GHCRì— í‘¸ì‹œí•  ë•Œ ìœ ìš©í•œ latest íƒœê·¸
          outputs: type=docker # ë¹Œë“œëœ ì´ë¯¸ì§€ë¥¼ Docker ë°ëª¬ì— ë¡œë“œí•˜ì—¬ ë‹¤ìŒ ìŠ¤í…ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.
          push: false # ì¼ë‹¨ ë¹Œë“œë§Œ í•˜ê³  í‘¸ì‹œëŠ” í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        run: |
          echo "--- Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘ ---"
          echo "ë¹Œë“œ ì¤‘ì¸ ì´ë¯¸ì§€: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          echo "Dockerfile ê²½ë¡œ: ./Dockerfile"
          echo "--- Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ ---"

      - name: ğŸ” ë¹Œë“œëœ Docker ì´ë¯¸ì§€ í™•ì¸
        run: |
          echo "--- ë¹Œë“œëœ Docker ì´ë¯¸ì§€ ëª©ë¡ ---"
          docker images
          echo "--- ì´ë¯¸ì§€ í™•ì¸ ì™„ë£Œ ---"

      - name: ğŸ“¤ Docker ì´ë¯¸ì§€ í‘¸ì‹œ (Docker Hub)
        if: ${{ secrets.DOCKER_USERNAME && secrets.DOCKER_PASSWORD }}
        run: |
          echo "--- Docker Hubë¡œ ì´ë¯¸ì§€ í‘¸ì‹œ ì‹œì‘ ---"
          docker push ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          docker push ${{ env.IMAGE_NAME }}:latest # latest íƒœê·¸ë„ í‘¸ì‹œ
          echo "--- Docker Hub í‘¸ì‹œ ì™„ë£Œ ---"

      - name: ğŸ“¤ Docker ì´ë¯¸ì§€ í‘¸ì‹œ (GitHub Container Registry)
        # GHCRì— í‘¸ì‹œí•  ê²½ìš°, ì´ë¯¸ì§€ ì´ë¦„ ì•ì— ghcr.io/OWNER/REPOë¥¼ ë¶™ì—¬ì•¼ í•©ë‹ˆë‹¤.
        run: |
          echo "--- GHCRë¡œ ì´ë¯¸ì§€ í‘¸ì‹œ ì‹œì‘ ---"
          docker push ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          docker push ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest
          echo "--- GHCR í‘¸ì‹œ ì™„ë£Œ ---"

      - name: ğŸƒ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ì„ íƒ ì‚¬í•­:ë¹Œë“œëœ ì´ë¯¸ì§€ í…ŒìŠ¤íŠ¸ìš©)
        # ë¹Œë“œëœ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•˜ì—¬ ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        run: |
          echo "--- Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹œì‘ (í…ŒìŠ¤íŠ¸ìš©) ---"
          echo "ì‹¤í–‰ ì¤‘ì¸ ì´ë¯¸ì§€: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          docker run --rm ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          echo "--- Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì™„ë£Œ ---"
