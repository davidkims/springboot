name: Install Java, Maven, NetBackup CLI & Ledger Generation

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-and-generate-ledger:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create pom.xml via echo
        run: |
          echo "‚ñ∂ Creating basic pom.xml"
          {
            echo '<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"'
            echo '         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">'
            echo '  <modelVersion>4.0.0</modelVersion>'
            echo '  <groupId>com.example</groupId>'
            echo '  <artifactId>ledger-generator</artifactId>'
            echo '  <version>1.0.0</version>'
            echo '  <properties>'
            echo '    <maven.compiler.source>17</maven.compiler.source>'
            echo '    <maven.compiler.target>17</maven.compiler.target>'
            echo '  </properties>'
            echo '  <dependencies>'
            echo '    <!-- ÌïÑÏöîÌïú ÏùòÏ°¥ÏÑ±ÏùÑ Ïó¨Í∏∞Ïóê Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî -->'
            echo '  </dependencies>'
            echo '</project>'
          } > pom.xml

      - name: Create install_java_maven.sh via echo
        run: |
          echo "üìÑ Generating scripts/install_java_maven.sh"
          mkdir -p scripts
          {
            echo '#!/usr/bin/env bash'
            echo 'set -euo pipefail'
            echo ''
            echo '# 1) APTÏúºÎ°ú OpenJDK 17 Î∞è Maven ÏÑ§Ïπò'
            echo 'sudo apt-get update -y'
            echo 'sudo apt-get install -y openjdk-17-jdk maven'
            echo ''
            echo '# 2) ÏÑ§Ïπò ÌôïÏù∏'
            echo 'java -version'
            echo 'mvn -version'
          } > scripts/install_java_maven.sh
          chmod +x scripts/install_java_maven.sh

      - name: Install Java & Maven
        run: |
          echo "‚ñ∂ Running install_java_maven.sh"
          ./scripts/install_java_maven.sh

      - name: Install NetBackup CLI
        run: |
          echo "‚ñ∂ Installing NetBackup CLI"
          sudo apt-get update -y
          # ÏòàÏãú: Ïã§Ï†ú Ìå®ÌÇ§ÏßÄ Ïù¥Î¶ÑÏúºÎ°ú Î∞îÍæ∏ÏÑ∏Ïöî
          sudo apt-get install -y netbackup-cli || echo "‚ö† NetBackup CLI package not found, skipping"

      - name: Build with Maven
        run: |
          echo "‚ñ∂ Building project (skip tests)"
          mvn clean package -DskipTests
          echo "‚úî Maven build completed"

      - name: Bulk-generate enterprise ledgers
        run: |
          echo "‚ñ∂ Generating large-scale customer transaction ledgers"
          JAR=$(find target -type f -name '*ledger-generator*.jar' | head -n1)
          if [ -z "$JAR" ]; then
            echo "‚ùå ledger-generator JAR not found in target/"
            exit 1
          fi
          echo "Using JAR: $JAR"
          java -jar "$JAR" \
            --enterprise \
            --count 1000000 \
            --out bulk_ledgers.csv
          echo "‚úî bulk_ledgers.csv created with 1,000,000 records"
