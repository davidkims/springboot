name: ğŸŒ€ Resident Batch Log Backup

on:
  workflow_dispatch:

jobs:
  resident_log_backup:
    runs-on: ubuntu-latest

    env:
      BACKUP_DIR: /opt/backup/logs
      LOG_BASE_DIR: /opt/logs
      LOG_DIR_KR: /opt/logs/kr
      LOG_DIR_VN: /opt/logs/vn
      LOG_DIR_BTC: /opt/logs/btc
      CONTAINER_IMAGE: alpine:latest

    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“ Prepare Log & Backup Directories with Sample Logs
        run: |
          sudo mkdir -p $LOG_DIR_KR $LOG_DIR_VN $LOG_DIR_BTC $BACKUP_DIR
          echo "[KR] ì´ˆê¸° ë¡œê·¸" | sudo tee $LOG_DIR_KR/log-kr.txt
          echo "[VN] ì´ˆê¸° ë¡œê·¸" | sudo tee $LOG_DIR_VN/log-vn.txt
          echo "[BTC] ì´ˆê¸° ë¡œê·¸" | sudo tee $LOG_DIR_BTC/log-btc.txt
          sudo chmod -R 777 /opt/logs $BACKUP_DIR

      - name: ğŸ³ Start Resident Backup Container (Looping Batch)
        run: |
          docker run -d \
            --name log-batch-resident \
            -v $LOG_BASE_DIR:/data/logs:ro \
            -v $BACKUP_DIR:/data/backup \
            $CONTAINER_IMAGE \
            sh -c '
              echo "ğŸ“¡ Resident backup started.";
              while true; do
                TS=$(date +%Y%m%d%H%M%S)
                DEST="/data/backup/$TS"
                mkdir -p "$DEST"
                cp -r /data/logs/* "$DEST/"
                echo "ğŸ“¦ ë°±ì—… ì™„ë£Œ at $TS"
                sleep 300  # 5ë¶„ ê°„ê²©
              done
            '

      - name: ğŸ“‹ Show Initial Backup Results
        run: |
          echo "ğŸ“‚ ìµœì‹  ë°±ì—… ìƒíƒœ:"
          ls -R $BACKUP_DIR | tail -n 50
