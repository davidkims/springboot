# .github/workflows/build-and-deploy.yml
name: Build & Deploy finance-transactions

on:
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 코드
        uses: actions/checkout@v4

      - name: Docker 설치 및 서비스 시작
        run: |
          echo "[build-and-deploy] apt-get update 시작..."
          sudo apt-get update
          echo "[build-and-deploy] apt-get update 완료"

          echo "[build-and-deploy] Docker 설치 시작..."
          sudo apt-get install -y docker.io
          echo "[build-and-deploy] Docker 설치 완료"

          echo "[build-and-deploy] Docker 서비스 시작..."
          sudo systemctl start docker || sudo service docker start

          echo "[build-and-deploy] Docker 버전 확인 시작..."
          docker --version
          echo "[build-and-deploy] Docker 버전 확인 완료"

      - name: finance-transactions 이미지 빌드
        run: |
          echo "[build-and-deploy] Docker 이미지 빌드 시작..."
          docker build -t finance-transactions:latest .
          echo "[build-and-deploy] Docker 이미지 빌드 완료"

      - name: finance-transactions 컨테이너 재시작
        run: |
          echo "[build-and-deploy] 기존 컨테이너 중지/삭제 시도..."
          docker rm -f finance-transactions || echo "[build-and-deploy] finance-transactions 컨테이너가 실행 중이 아니거나 이미 삭제됨"

          echo "[build-and-deploy] finance-transactions 컨테이너 실행 시작..."
          docker run -d \
            --name finance-transactions \
            -v finance-data:/data \
            finance-transactions:latest
          echo "[build-and-deploy] finance-transactions 컨테이너 실행 완료"

      - name: Run full setup script
        run: |
          echo "[build-and-deploy] Running full setup script..."
          ./scripts/full_setup.sh
          echo "[build-and-deploy] Full setup completed"

      - name: 컨테이너 정리
        if: always()
        run: |
          echo "[build-and-deploy] Cleaning up containers..."
          docker rm -f finance-transactions || true
          docker volume prune -f || true
