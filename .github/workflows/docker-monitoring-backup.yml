name: ğŸ³ Docker Finance Backup & GHCR Push

on:
  push:
    branches: [main]
  schedule:
    - cron: '*/10 * * * *'  # 10ë¶„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:

env:
  IMAGE_NAME: ghcr.io/davidkims/springboot/finance-app
  IMAGE_TAG: latest
  BACKUP_VOLUME: finance_backup_vol
  BACKUP_DIR_IN_CONTAINER: /backup
  KAFKA_LOG: kafka.log

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Docker Login to GitHub Container Registry
        run: echo "${{ secrets.GH_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: ğŸ› ï¸ Build Docker Image
        run: |
          docker build -t $IMAGE_NAME:$IMAGE_TAG .

      - name: ğŸš€ Push Docker Image to GHCR
        run: |
          docker push $IMAGE_NAME:$IMAGE_TAG

      - name: ğŸ—ƒï¸ Create Backup Volume
        run: |
          docker volume create $BACKUP_VOLUME || true

      - name: ğŸƒ Run Container for Backup
        run: |
          docker run --rm -d --name finance-backup-runner \
            -v $BACKUP_VOLUME:$BACKUP_DIR_IN_CONTAINER \
            $IMAGE_NAME:$IMAGE_TAG

          echo "â³ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘..."
          sleep 10

      - name: ğŸ’¾ Simulate Transaction Log Backup
        run: |
          docker exec finance-backup-runner sh -c "cp /app/transactions.log $BACKUP_DIR_IN_CONTAINER/transactions-$(date +%Y%m%d%H%M%S).log"
          echo "ğŸ“ ë°±ì—… ìƒì„± ì‹œê°„: $(date +%Y%m%d%H%M%S)" >> $KAFKA_LOG

      - name: ğŸ“¤ Stop Container After Backup
        run: |
          docker stop finance-backup-runner || echo "ì´ë¯¸ ì¢…ë£Œë¨"

      - name: ğŸ“‘ View Kafka-style Logs
        run: |
          cat $KAFKA_LOG || echo "âš ï¸ Kafka-style ë¡œê·¸ ì—†ìŒ"
