name: ðŸ’³ ì¹´ë“œì‚¬ë³„ ê±°ëž˜ ë°±ì—… + NetBackup + OCI ì—…ë¡œë“œ

on:
  workflow_dispatch:
  push:
    branches: 
      - main

jobs:
  finance-netbackup:
    runs-on: ubuntu-latest

    env:
      OCI_BUCKET_NAME: your-bucket-name
      OCI_NAMESPACE: your-namespace
      OCI_REGION: ap-seoul-1

    steps:
      - name: ðŸ“ ì €ìž¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ðŸ§° Swift ì„¤ì¹˜
        run: |
          sudo apt-get update
          sudo apt-get install -y clang libicu-dev libpython3-dev zip
          curl -fsSL https://download.swift.org/swift-5.9-release/ubuntu2204/swift-5.9-RELEASE/swift-5.9-RELEASE-ubuntu22.04.tar.gz -o swift.tar.gz
          sudo mkdir -p /opt/swift
          sudo tar -xzf swift.tar.gz -C /opt/swift --strip-components=1
          echo "/opt/swift/usr/bin" >> $GITHUB_PATH

      - name: ðŸ§¾ ì¹´ë“œì‚¬ë³„ ê±°ëž˜ JSON ìƒì„±
        run: |
          mkdir -p /opt/backup /opt/reports
          for company in ì‚¼ì„± í˜„ëŒ€ ë¡¯ë°; do
            cat > /opt/backup/transactions_${company}.json <<EOF


    "company": "${company}",
    "card": "ì‹ ìš©ì¹´ë“œ",
    "amount": "$((RANDOM % 500000 + 50000))",
    "timestamp": "$(date -Iseconds)"

    "company": "${company}",
    "card": "ë²•ì¸ì¹´ë“œ",
    "amount": "$((RANDOM % 500000 + 50000))",
    "timestamp": "$(date -Iseconds)"

    "company": "${company}",
    "card": "ì²´í¬ì¹´ë“œ",
    "amount": "$((RANDOM % 500000 + 50000))",
    "timestamp": "$(date -Iseconds)"


            echo "# ðŸ’³ ê±°ëž˜ ë³´ê³ ì„œ (${company})" > /opt/reports/report_${company}.md
            echo "- ìƒì„± ì‹œê°„: $(date)" >> /opt/reports/report_${company}.md
            echo "- íŒŒì¼: /opt/backup/transactions_${company}.json" >> /opt/reports/report_${company}.md
          done

      - name: ðŸ—œï¸ ZIP ì••ì¶•
        run: |
          mkdir -p output
          zip -j output/all_transactions_$(date +%Y%m%d%H%M).zip /opt/backup/transactions_*.json

      - name: â˜ï¸ Oracle OCI CLI ì„¤ì¹˜
        run: |
          curl -sL https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh | bash -s -- --accept-all-defaults
          echo "$HOME/bin" >> $GITHUB_PATH
          oci --version || echo "âœ… OCI CLI ì„¤ì¹˜ë¨"

      - name: â˜ï¸ ì¹´ë“œì‚¬ë³„ JSONì„ OCIì— ì—…ë¡œë“œ
        run: |
          for jsonfile in /opt/backup/transactions_*.json; do
            filename=$(basename $jsonfile)
            echo "â˜ï¸ Uploading $filename to OCI..."
            oci os object put \
              --bucket-name $OCI_BUCKET_NAME \
              --namespace $OCI_NAMESPACE \
              --file "$jsonfile" \
              --name "backups/$filename" \
              --region $OCI_REGION \
              --force || echo "âŒ ì‹¤íŒ¨: $filename"
          done

      - name: ðŸ§± NetBackup CLI ì„¤ì¹˜ ë° bpbackup ì‹¤í–‰
        run: |
          echo "ðŸ“¦ NetBackup CLI ì„¤ì¹˜ ì‹œë®¬ë ˆì´ì…˜"
          sudo mkdir -p /usr/openv/netbackup/bin
          echo -e '#!/bin/bash\necho \"[bpbackup] ë°±ì—… ì‹¤í–‰: \$1\"' | sudo tee /usr/openv/netbackup/bin/bpbackup
          sudo chmod +x /usr/openv/netbackup/bin/bpbackup

          mkdir -p /opt/netbackup/data
          cp /opt/backup/*.json /opt/netbackup/data/

          for file in /opt/netbackup/data/*.json; do
            /usr/openv/netbackup/bin/bpbackup -f "$file"
          done

      - name: ðŸ“Š ìµœì¢… ë³´ê³ ì„œ ìƒì„±
        run: |
          echo "# âœ… ë°±ì—… ë° ì—…ë¡œë“œ ìš”ì•½ ë³´ê³ ì„œ" > final-report.md
          echo "- ì‹œê°„: $(date)" >> final-report.md
          echo "- JSON ë°±ì—… íŒŒì¼ ìˆ˜: $(ls /opt/backup/transactions_*.json | wc -l)" >> final-report.md
          echo "- ì••ì¶• íŒŒì¼: $(ls output/*.zip)" >> final-report.md
          echo "- NetBackup ê²°ê³¼:" >> final-report.md
          for file in /opt/netbackup/data/*.json; do
            echo "- ë°±ì—…ë¨: $(basename $file)" >> final-report.md
          done
          cat final-report.md
