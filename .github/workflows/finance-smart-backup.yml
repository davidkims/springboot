name: ðŸ”„ Finance Smart Backup without OTP

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  finance-backup:
    runs-on: ubuntu-latest

    env:
      ROOT_PASS: rootpass123
      SQL_DIR: /opt/finance/sql
      BACKUP_DIR: /opt/finance/backups
      KAFKA_LOG: /opt/finance/kafka.log
      PG_DB: postgres_finance
      PG_USER: postgres
      PG_PASS: pgpass
      TYPES: |
        bank_transfer
        check_card
        credit_card
        bitcoin
        stock
        futures

    steps:
      - name: ðŸ“ Create Directories and Init SQL
        run: |
          sudo mkdir -p $SQL_DIR $BACKUP_DIR
          sudo chmod -R 777 /opt/finance
          echo "CREATE TABLE IF NOT EXISTS transfers (
            id SERIAL PRIMARY KEY,
            type VARCHAR(30),
            amount NUMERIC,
            currency VARCHAR(5),
            status VARCHAR(20),
            timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );" > $SQL_DIR/init.sql
          echo "INSERT INTO transfers(type, amount, currency, status) VALUES
            ('bank_transfer', 100000, 'KRW', 'completed'),
            ('check_card', 20000, 'KRW', 'completed'),
            ('credit_card', 150000, 'KRW', 'completed'),
            ('bitcoin', 0.03, 'BTC', 'pending'),
            ('stock', 1000000, 'KRW', 'completed'),
            ('futures', 500000, 'KRW', 'pending');" >> $SQL_DIR/init.sql

      - name: ðŸ˜ Install and Configure PostgreSQL
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql
          sudo systemctl start postgresql
          sudo systemctl enable postgresql
          sudo -u postgres psql -c "ALTER USER $PG_USER WITH PASSWORD '$PG_PASS';"
          echo "127.0.0.1:5432:$PG_DB:$PG_USER:$PG_PASS" > ~/.pgpass
          chmod 600 ~/.pgpass

      - name: ðŸ˜ Create PostgreSQL DB and Log Tables
        run: |
          sudo -u postgres createdb $PG_DB
          PGPASSFILE=$HOME/.pgpass psql -h 127.0.0.1 -U $PG_USER -d $PG_DB -c "
            CREATE TABLE IF NOT EXISTS logs (
              type VARCHAR,
              status VARCHAR,
              backup_time TIMESTAMP
            );"

      - name: ðŸ” Run Per-Type Backup Loop
        run: |
          for TYPE in $TYPES; do
            DB_NAME="db_${TYPE}"
            DB_USER="user_${TYPE}"
            DB_PASS="pass_${TYPE}"
            CONTAINER="mysql_${TYPE}"
            PORT=$((3307 + RANDOM % 1000))

            echo "ðŸš€ Starting $TYPE container on port $PORT"
            docker run -d --rm \
              --name $CONTAINER \
              -e MYSQL_ROOT_PASSWORD=$ROOT_PASS \
              -e MYSQL_DATABASE=$DB_NAME \
              -e MYSQL_USER=$DB_USER \
              -e MYSQL_PASSWORD=$DB_PASS \
              -v $SQL_DIR:/docker-entrypoint-initdb.d \
              -p $PORT:3306 \
              mysql:8.0

            echo "â³ Waiting for $TYPE container to initialize"
            sleep 30

            echo "ðŸ” Setting up MySQL login config"
            echo "[client]" > ~/.my.cnf
            echo "user=$DB_USER" >> ~/.my.cnf
            echo "password=$DB_PASS" >> ~/.my.cnf
            echo "host=127.0.0.1" >> ~/.my.cnf
            echo "port=$PORT" >> ~/.my.cnf
            chmod 600 ~/.my.cnf

            STATUS=$(mysql --defaults-file=~/.my.cnf -N -e "USE $DB_NAME; SELECT COUNT(*) FROM transfers WHERE type='$TYPE' AND status='completed';")

            if [ "$STATUS" -gt 0 ]; then
              BACKUP_FILE=$BACKUP_DIR/${TYPE}_backup.sql
              mysqldump --defaults-file=~/.my.cnf --no-tablespaces $DB_NAME > $BACKUP_FILE
              echo "âœ… Backup completed: $BACKUP_FILE"
              TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
              PGPASSFILE=$HOME/.pgpass psql -h 127.0.0.1 -U $PG_USER -d $PG_DB -c "INSERT INTO logs VALUES ('$TYPE', 'backup', '$TIMESTAMP');"
              echo "$TIMESTAMP [$TYPE] backup done" >> $KAFKA_LOG
            fi

            echo "âš¡ Updating pending to completed for $TYPE"
            mysql --defaults-file=~/.my.cnf -e "USE $DB_NAME; UPDATE transfers SET status='completed' WHERE type='$TYPE' AND status='pending';"

            docker stop $CONTAINER
          done

      - name: ðŸ“¦ Compress Backups
        run: |
          cd $BACKUP_DIR
          tar -czf finance-backups-${{ github.run_id }}.tar.gz *.sql
          ls -lh

      - name: ðŸ““ View PostgreSQL Logs
        run: |
          PGPASSFILE=$HOME/.pgpass psql -h 127.0.0.1 -U $PG_USER -d $PG_DB -c "SELECT * FROM logs;"

      - name: ðŸ“„ Kafka-style Logs
        run: |
          cat $KAFKA_LOG || echo "No kafka-style logs generated"
