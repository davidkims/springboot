# .github/workflows/docker-backup.yml
name: Docker Build, Deploy & Hourly Backup with Volume, Encryption & Optional Registry Push

permissions:
  contents: read      # 코드 체크아웃용
  packages: write     # GHCR에 이미지 푸시 권한

on:
  push:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'  # 매시간 0분(UTC)

jobs:
  setup-docker:
    runs-on: ubuntu-latest
    steps:
      - name: "[setup-docker] Remove legacy Docker packages"
        run: |
          echo "[setup-docker] Removing legacy Docker packages..."
          sudo apt-get remove -y docker docker-engine docker.io containerd containerd.io runc \
            || echo "[setup-docker] Nothing to remove"
          echo "[setup-docker] Legacy removal done."

      - name: "[setup-docker] Install prerequisites"
        run: |
          echo "[setup-docker] Installing prerequisites..."
          sudo apt-get update
          sudo apt-get install -y ca-certificates curl gnupg lsb-release
          echo "[setup-docker] Prerequisites installed."

      - name: "[setup-docker] Install additional components"
        run: |
          echo "[setup-docker] Checking for components.txt..."
          if [ -f components.txt ]; then
            echo "[setup-docker] Installing components from components.txt..."
            xargs sudo apt-get install -y < components.txt
            echo "[setup-docker] Additional components installed."
          else
            echo "[setup-docker] No components.txt found; skipping."
          fi

      - name: "[setup-docker] Add Docker GPG key"
        run: |
          echo "[setup-docker] Adding Docker GPG key..."
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg \
            | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
          echo "[setup-docker] GPG key added."

      - name: "[setup-docker] Configure Docker repository"
        run: |
          echo "[setup-docker] Configuring Docker repository..."
          echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] \
            https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" \
            | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          echo "[setup-docker] Repository configured."

      - name: "[setup-docker] Install Docker Engine & CLI"
        run: |
          echo "[setup-docker] Installing Docker Engine & CLI..."
          sudo apt-get update
          sudo apt-get install -y docker-ce docker-ce-cli containerd.io
          echo "[setup-docker] Docker Engine & CLI installed."

  build-and-deploy:
    needs: setup-docker
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'schedule' }}
    steps:
      - name: "[build-and-deploy] Checkout code"
        uses: actions/checkout@v4

      - name: "[build-and-deploy] Load image backups if present"
        run: |
          echo "[build-and-deploy] Checking for image backups..."
          for f in finance-transactions_*.tar.gz; do
            if [ -f "$f" ]; then
              echo "[build-and-deploy] Loading image from $f..."
              docker load -i "$f"
            fi
          done

      - name: "[build-and-deploy] Import container backups if present"
        run: |
          echo "[build-and-deploy] Checking for container backups..."
          for f in finance-transactions-container_*.tar.gz; do
            if [ -f "$f" ]; then
              echo "[build-and-deploy] Importing container from $f..."
              docker import "$f" finance-transactions:restored
            fi
          done

      - name: "[build-and-deploy] Restore volume backups if present"
        run: |
          echo "[build-and-deploy] Checking for volume backups..."
          for f in volume_*.tar.gz; do
            if [ -f "$f" ]; then
              echo "[build-and-deploy] Restoring volume from $f..."
              docker volume create finance-data || true
              docker run --rm -v finance-data:/data -v "$PWD":/backup ubuntu:latest \
                bash -c "cd /data && tar xzf /backup/$f"
            fi
          done

      - name: "[build-and-deploy] Ensure Dockerfile exists"
        run: |
          echo "[build-and-deploy] Checking for Dockerfile..."
          if [ ! -f Dockerfile ]; then
            echo "[build-and-deploy] Creating Dockerfile..."
            echo "FROM python:3.10-slim" > Dockerfile && echo "[Dockerfile] Base image"
            echo "WORKDIR /app" >> Dockerfile    && echo "[Dockerfile] WORKDIR"
            echo "COPY . ." >> Dockerfile       && echo "[Dockerfile] COPY ."
            echo "RUN if [ -f requirements.txt ]; then pip install --no-cache-dir -r requirements.txt; fi" >> Dockerfile \
              && echo "[Dockerfile] Conditional pip install"
            echo 'CMD ["python", "app.py"]' >> Dockerfile  && echo "[Dockerfile] CMD"
          fi

      - name: "[build-and-deploy] Build Docker image"
        run: |
          echo "[build-and-deploy] Building image finance-transactions:latest..."
          docker build -t finance-transactions:latest .
          echo "[build-and-deploy] Image build complete."

      - name: "[build-and-deploy] Login & Push to GHCR if GHCR_PAT set"
        run: |
          if [ -n "${{ secrets.GHCR_PAT }}" ]; then
            echo "[build-and-deploy] Logging in to GHCR..."
            echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
            echo "[build-and-deploy] Tagging image..."
            docker tag finance-transactions:latest ghcr.io/${{ github.repository_owner }}/finance-transactions:latest
            echo "[build-and-deploy] Pushing image to GHCR..."
            docker push ghcr.io/${{ github.repository_owner }}/finance-transactions:latest
          else
            echo "[build-and-deploy] GHCR_PAT not set; skipping registry push."
          fi

      - name: "[build-and-deploy] Restart container"
        run: |
          echo "[build-and-deploy] Restarting finance-transactions container..."
          if docker ps -a --format '{{.Names}}' | grep -q '^finance-transactions$'; then
            docker rm -f finance-transactions
          fi
          docker run -d --name finance-transactions -v finance-data:/data finance-transactions:latest

  backup:
    needs: setup-docker
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'schedule' }}
    env:
      BACKUP_PASSPHRASE: ${{ secrets.BACKUP_PASSPHRASE }}
    steps:
      - name: "[backup] Create raw backups"
        run: |
          echo "[backup] Starting raw backups..."
          TIMESTAMP=$(date +'%Y%m%d%H%M')
          docker save finance-transactions:latest | gzip > finance-transactions_${TIMESTAMP}.tar.gz
          docker export finance-transactions | gzip > finance-transactions-container_${TIMESTAMP}.tar.gz
          docker run --rm -v finance-data:/data -v $PWD:/backup ubuntu:latest \
            bash -c "cd /data && tar czf /backup/volume_${TIMESTAMP}.tar.gz ."

      - name: "[backup] Encrypt backups with GPG"
        run: |
          echo "[backup] Encrypting backups..."
          for F in *_${TIMESTAMP}.tar.gz; do
            gpg --batch --yes --passphrase "$BACKUP_PASSPHRASE" -c "$F"
            rm "$F"
          done

      - name: "[backup] Generate key file"
        run: |
          TIMESTAMP=$(date +'%Y%m%d%H%M')
          echo "$BACKUP_PASSPHRASE" > backup_key_${TIMESTAMP}.txt

      - name: "[backup] Upload artifacts"
        uses: actions/upload-artifact@v3
        with:
          name: docker-backup-${{ github.run_id }}
          path: |
            '*.tar.gz.gpg'
            'backup_key_*.txt'
