name: π” κ³ κ° κ±°λ μ›ν¬ν”λ΅μ° μλ™ μ•”νΈν™”

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *' # λ§¤μΌ 03:00 μλ™ μ‹¤ν–‰ (UTC)

jobs:
  detect-and-encrypt:
    runs-on: ubuntu-latest
    env:
      ENCRYPTION_KEY: ${{ secrets.CUSTOMER_AES_KEY }} # AES ν‚¤λ” GitHub Secretsμ— λ“±λ΅ ν•„μ

    steps:
      - name: π“¥ Checkout repository
        uses: actions/checkout@v4

      - name: π“ .github/workflows λ‚΄ μ „μ²΄ νμΌ κ²€μƒ‰
        id: find_files
        run: |
          mkdir -p .encrypted
          files=$(find .github/workflows -type f \( -iname '*.yml' -o -iname '*.yaml' \))
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: π” κ³ κ° κ±°λ ν¬ν•¨λ νμΌ νƒμƒ‰ λ° μ•”νΈν™”
        run: |
          echo "π” 'κ³ κ° κ±°λ' ν‚¤μ›λ“ ν¬ν•¨ νμΌ μ•”νΈν™” μ‹μ‘"
          for file in ${{ steps.find_files.outputs.files }}; do
            if grep -q 'κ³ κ° κ±°λ' "$file"; then
              echo "π” μ•”νΈν™” λ€μƒ: $file"

              # μ•”νΈν™”λ μ¶λ ¥ νμΌλ…
              encrypted_file=".encrypted/$(basename $file).enc"

              # AES256 μ•”νΈν™” μν–‰
              openssl enc -aes-256-cbc -pbkdf2 -salt -in "$file" -out "$encrypted_file" -pass pass:"$ENCRYPTION_KEY"

              echo "β… μ•”νΈν™” μ™„λ£ β†’ $encrypted_file"
            else
              echo "β­οΈ 'κ³ κ° κ±°λ' ν‚¤μ›λ“ μ—†μ: $file"
            fi
          done

      - name: π“¤ μ•”νΈν™”λ νμΌ μ•„μΉ΄μ΄λΈ (μ„ νƒ)
        if: always()
        run: |
          zip -r customer-encrypted.zip .encrypted
          echo "β… μ•”νΈν™”λ μ›ν¬ν”λ΅μ° ZIP μƒμ„± μ™„λ£"

      - name: π“¦ μ—…λ΅λ“: μ•”νΈν™” ZIP μ•„μΉ΄μ΄λΈ (Artifacts)
        uses: actions/upload-artifact@v4
        with:
          name: customer-encrypted-workflows
          path: customer-encrypted.zip
