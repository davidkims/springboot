name: 🔐 Reset MySQL Root Password Safely

on:
  workflow_dispatch:

jobs:
  reset-mysql:
    runs-on: ubuntu-latest

    env:
      MYSQL_ROOT_PASS: rootpass123

    steps:
      - name: 📦 Install MySQL
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-server

      - name: 🛠️ Reset root password (MySQL 8+)
        run: |
          echo "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '${MYSQL_ROOT_PASS}'; FLUSH PRIVILEGES;" > reset.sql
          sudo systemctl stop mysql
          sudo mysqld_safe --skip-grant-tables &
          sleep 10
          sudo mysql < reset.sql
          sudo killall mysqld || true
          sleep 5
          sudo systemctl start mysql

      - name: ✅ Verify root login
        run: |
          mysql -u root -p${MYSQL_ROOT_PASS} -e "SELECT user, host FROM mysql.user;"
