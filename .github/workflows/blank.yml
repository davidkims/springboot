name: ☕ Java Auto-Transfer Transaction Workflow

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  auto-transfer:
    runs-on: ubuntu-latest

    env:
      MAVEN_VERSION: 3.9.6
      MAVEN_HOME: /opt/maven
      EXPORT_DIR: /opt/export
      BUILD_DIR: build-artifacts
      TIMESTAMP: ${{ github.run_id }}

    steps:
      - name: 📁 코드 체크아웃
        uses: actions/checkout@v4

      - name: 📦 Maven 설치
        run: |
          wget https://dlcdn.apache.org/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz
          sudo tar -xzvf apache-maven-${MAVEN_VERSION}-bin.tar.gz -C /opt
          sudo mv /opt/apache-maven-${MAVEN_VERSION} $MAVEN_HOME
          echo "$MAVEN_HOME/bin" >> $GITHUB_PATH

      - name: 📂 샘플 Java 소스코드 자동 생성
        run: |
          mkdir -p src/main/java/com/finance
          cat <<EOF > src/main/java/com/finance/TransactionRunner.java
package com.finance;

public class TransactionRunner {
  public static void main(String[] args) {
    System.out.println("📋 자동 이체 거래 수행 중...");
    System.out.println("✅ 신용카드 거래: 완료");
    System.out.println("✅ 체크카드 거래: 완료");
    System.out.println("✅ 주식 매수: 완료");
    System.out.println("✅ 환율 거래: 완료");
  }
}
EOF

      - name: 🔨 Maven 빌드 및 테스트
        run: |
          /opt/maven/bin/mvn clean install -B

      - name: 📦 JAR 파일 추출 및 저장
        run: |
          mkdir -p $EXPORT_DIR $BUILD_DIR
          find . -type f -name "*.jar" -path "*/target/*.jar" -exec cp {} $EXPORT_DIR/ \;
          cp $EXPORT_DIR/*.jar $BUILD_DIR/
          echo "📦 Exported JARs:"
          ls -lh $BUILD_DIR

      - name: 📝 거래 로그 시뮬레이션
        run: |
          echo "$(date +'%F %T') 자동 이체 거래 완료" >> transaction.log
          cat transaction.log
