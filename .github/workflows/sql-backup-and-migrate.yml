name: ğŸ›¡ï¸ SQL Backup and DB Migration

on:
  workflow_dispatch:

jobs:
  sql_backup_and_migration:
    runs-on: ubuntu-latest

    env:
      DB_HOST: localhost
      DB_PORT: 3306
      DB_NAME: example_db
      DB_USER: root
      DB_PASS: password
      BACKUP_DIR: /opt/backup/sql
      MIGRATION_FILE: ./migrations/migrate.sql

    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“‚ Create backup directory
        run: |
          sudo mkdir -p $BACKUP_DIR
          sudo chmod -R 777 $BACKUP_DIR

      - name: ğŸ’¾ Backup SQL Database
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_FILE="$BACKUP_DIR/backup-$TIMESTAMP.sql"

          echo "ğŸ” ë°±ì—… ì‹œì‘: $BACKUP_FILE"
          mysqldump -h $DB_HOST -P $DB_PORT -u $DB_USER -p$DB_PASS $DB_NAME > $BACKUP_FILE || {
            echo "âŒ ë°±ì—… ì‹¤íŒ¨" >> backup-report.md
            exit 1
          }

          echo "âœ… ë°±ì—… ì™„ë£Œ: $BACKUP_FILE" >> backup-report.md
          ls -lh $BACKUP_DIR >> backup-report.md

      - name: ğŸ§± Run DB Migration
        run: |
          echo "ğŸ” ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘: $MIGRATION_FILE"
          mysql -h $DB_HOST -P $DB_PORT -u $DB_USER -p$DB_PASS $DB_NAME < $MIGRATION_FILE || {
            echo "âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨" >> migration-report.md
            exit 1
          }

          echo "âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ" >> migration-report.md

      - name: ğŸ“¦ ë””ìŠ¤í¬ ê³µê°„ í™•ë³´ (.github/workflows)
        run: |
          if sudo fallocate -l 50G .github/workflows/.reserved_space; then
            echo "âœ… ë””ìŠ¤í¬ ì˜ˆì•½ ì„±ê³µ"
          else
            echo "âš ï¸ fallocate ì‹¤íŒ¨ â†’ ddë¡œ ëŒ€ì²´ ì‹œë„"
            sudo dd if=/dev/zero of=.github/workflows/.reserved_space bs=1M count=51200 || echo "âŒ ì˜ˆì•½ ì‹¤íŒ¨"
          fi

      - name: ğŸ“‹ ë¡œê·¸ ì¶œë ¥
        run: |
          echo "ğŸ” ë°±ì—… ë¡œê·¸:"
          cat backup-report.md || echo "âŒ backup-report.md ì—†ìŒ"
          echo "ğŸ” ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡œê·¸:"
          cat migration-report.md || echo "âŒ migration-report.md ì—†ìŒ"
