name: Build & Deploy finance-transactions with DB Backup

on:
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“… Checkout ì½”ë“œ
        uses: actions/checkout@v4

      - name: ğŸ“¦ requirements.txt ìƒì„±
        run: |
          echo "[+] requirements.txt ìƒì„±"
          echo "flask" > requirements.txt
          echo "python-dotenv" >> requirements.txt
          echo "psycopg2-binary" >> requirements.txt
          echo "SQLAlchemy" >> requirements.txt
          echo "[âœ”] requirements.txt ìƒì„± ì™„ë£Œ"

      - name: âš™ï¸ .env íŒŒì¼ ìƒì„±
        run: |
          echo "[+] .env íŒŒì¼ ìƒì„±"
          echo "FLASK_ENV=production" > .env
          echo "APP_NAME=FinanceTransactions" >> .env
          echo "DEBUG=False" >> .env
          echo "POSTGRES_DB=finance" >> .env
          echo "POSTGRES_USER=postgres" >> .env
          echo "POSTGRES_PASSWORD=postgres123" >> .env
          echo "DB_HOST=db" >> .env
          echo "DB_PORT=5432" >> .env
          echo "[âœ”] .env íŒŒì¼ ìƒì„± ì™„ë£Œ"

      - name: ğŸ app.py ìƒì„±
        run: |
          echo "[+] app.py ìƒì„± ì‹œì‘"
          cat << 'EOF' > app.py
from flask import Flask, request, jsonify
from flask_sqlalchemy import SQLAlchemy
from dotenv import load_dotenv
import os

load_dotenv()
app = Flask(__name__)

DB_URI = f"postgresql://{os.getenv('POSTGRES_USER')}:{os.getenv('POSTGRES_PASSWORD')}@{os.getenv('DB_HOST')}:{os.getenv('DB_PORT')}/{os.getenv('POSTGRES_DB')}"
app.config['SQLALCHEMY_DATABASE_URI'] = DB_URI
db = SQLAlchemy(app)

class Transaction(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    amount = db.Column(db.Float)
    currency = db.Column(db.String(10))
    status = db.Column(db.String(20))

@app.before_first_request
def create_tables():
    db.create_all()

@app.route('/', methods=['GET'])
def index():
    return jsonify({'status': 'success', 'message': f"{os.getenv('APP_NAME')} is running!"})

@app.route('/transaction', methods=['POST'])
def transaction():
    try:
        data = request.get_json(force=True)
        tx = Transaction(**data)
        db.session.add(tx)
        db.session.commit()
        return jsonify({'status': 'success', 'message': 'Saved', 'data': data})
    except Exception as e:
        return jsonify({'status': 'error', 'message': str(e)}), 400

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
EOF
          echo "[âœ”] app.py ìƒì„± ì™„ë£Œ"

      - name: ğŸ³ Dockerfile ìƒì„±
        run: |
          echo "[+] Dockerfile ìƒì„± ì‹œì‘"
          cat << 'EOF' > Dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY . .
RUN pip install --no-cache-dir -r requirements.txt
EXPOSE 5000
CMD ["python", "app.py"]
EOF
          echo "[âœ”] Dockerfile ìƒì„± ì™„ë£Œ"

      - name: ğŸ› ï¸ Docker ì„¤ì¹˜
        run: |
          echo "[+] Docker ì„¤ì¹˜ ì¤‘..."
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          sudo systemctl start docker || sudo service docker start
          docker --version
          echo "[âœ”] Docker ì„¤ì¹˜ ì™„ë£Œ"

      - name: ğŸ˜ PostgreSQL ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        run: |
          echo "[+] PostgreSQL ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
          docker run -d \
            --name db \
            -e POSTGRES_DB=finance \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres123 \
            -p 5432:5432 \
            postgres:15
          echo "â³ DB ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘..."
          sleep 20
          echo "[âœ”] PostgreSQL ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì™„ë£Œ"

      - name: ğŸ—ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ
        run: |
          echo "[+] Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘"
          docker build -t finance-transactions:latest .
          docker image ls
          echo "[âœ”] Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"

      - name: ğŸš€ Flask ì•± ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        run: |
          echo "[+] finance-transactions ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
          docker run -d \
            --name finance-transactions \
            --link db \
            --env-file .env \
            -p 8080:5000 \
            finance-transactions:latest
          echo "[âœ”] finance-transactions ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì™„ë£Œ"

      - name: ğŸ“‚ backup.sh ìƒì„± ë° ì‹¤í–‰
        run: |
          echo "[+] backup.sh ìƒì„± ì‹œì‘"
          mkdir -p backup
          cat << 'EOF' > backup.sh
#!/bin/bash
mkdir -p backup
TIMESTAMP=$(date +%Y%m%d%H%M%S)
docker exec db pg_dump -U postgres -d finance > backup/backup-$TIMESTAMP.sql
EOF
          chmod +x backup.sh
          echo "[ğŸ”] backup.sh ì‹¤í–‰ ì¤‘..."
          ./backup.sh
          echo "[âœ”] ë°±ì—… ì™„ë£Œ. íŒŒì¼ ëª©ë¡:"
          ls -lh backup

      - name: ğŸ“¦ GitHub Releaseì— DB ë°±ì—… ì—…ë¡œë“œ
        uses: softprops/action-gh-release@v2
        with:
          name: "ğŸ“¦ PostgreSQL DB Backup"
          tag_name: "db-backup-${{ github.run_id }}"
          files: backup/*.sql
        env:
          GITHUB_TOKEN: ${{ secrets.GH_RELEASE_PAT }}

      - name: ğŸ§¹ ë§ˆë¬´ë¦¬ ì •ë¦¬
        if: always()
        run: |
          echo "[+] ë§ˆë¬´ë¦¬ ì •ë¦¬ ì‹œì‘"
          docker ps -a
          echo "[âœ”] ë§ˆë¬´ë¦¬ ì •ë¦¬ ì™„ë£Œ"
