name: ğŸ§¾ ê±°ë˜ ìë™í™” - Docker Compose + ì§€ì† ì»¨í…Œì´ë„ˆ

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  compose-ledger:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‚ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ ë° ë””ë ‰í† ë¦¬ ìƒì„±
        uses: actions/checkout@v4

      - name: ğŸ“ echo ê¸°ë°˜ íŒŒì¼ ë° í´ë” ìƒì„±
        run: |
          mkdir -p app output

          echo "ğŸ“„ ledger.py ìƒì„±"
          echo 'import csv' > app/ledger.py
          echo 'import datetime' >> app/ledger.py
          echo 'import random' >> app/ledger.py
          echo 'import psycopg2, mysql.connector' >> app/ledger.py
          echo 'import os, time' >> app/ledger.py
          echo '' >> app/ledger.py
          echo 'def wait_for_db(): time.sleep(10)' >> app/ledger.py
          echo '' >> app/ledger.py
          echo 'def connect_postgres(): return psycopg2.connect(host="postgres", dbname="ledgerdb", user="ledger", password="ledgerpass")' >> app/ledger.py
          echo 'def connect_mysql(): return mysql.connector.connect(host="mysql", database="ledgerdb", user="ledger", password="ledgerpass")' >> app/ledger.py
          echo '' >> app/ledger.py
          echo 'def generate(): return [' >> app/ledger.py
          echo ' [datetime.datetime.now().isoformat(), t, c, round(random.uniform(10.0,10000.0),2), random.choice(["KRW","USD"]), random.choice(["ìŠ¹ì¸","ê±°ì ˆ"]), f"{c} {t} ê±°ë˜"]' >> app/ledger.py
          echo ' for _ in range(50) for t in ["ì‹ ìš©ì¹´ë“œ","ì²´í¬ì¹´ë“œ","FX"] for c in ["ì¤‘ì†Œê¸°ì—…","ëŒ€ê¸°ì—…"]]' >> app/ledger.py
          echo '' >> app/ledger.py
          echo 'def save_csv(rows):' >> app/ledger.py
          echo ' with open("output/transactions.csv", "w", newline="", encoding="utf-8") as f:' >> app/ledger.py
          echo '  writer = csv.writer(f); writer.writerow(["ì‹œê°„","ìœ í˜•","ê¸°ì—…êµ¬ë¶„","ê¸ˆì•¡","í†µí™”","ìƒíƒœ","ì„¤ëª…"]); writer.writerows(rows)' >> app/ledger.py
          echo '' >> app/ledger.py
          echo 'def save_pg(rows):' >> app/ledger.py
          echo '  conn = connect_postgres(); cur = conn.cursor()' >> app/ledger.py
          echo '  cur.execute("CREATE TABLE IF NOT EXISTS tx_pg (ì‹œê°„ TEXT, ìœ í˜• TEXT, ê¸°ì—…êµ¬ë¶„ TEXT, ê¸ˆì•¡ REAL, í†µí™” TEXT, ìƒíƒœ TEXT, ì„¤ëª… TEXT)")' >> app/ledger.py
          echo '  cur.executemany("INSERT INTO tx_pg VALUES (%s,%s,%s,%s,%s,%s,%s)", rows); conn.commit(); cur.close(); conn.close()' >> app/ledger.py
          echo '' >> app/ledger.py
          echo 'def save_mysql(rows):' >> app/ledger.py
          echo '  conn = connect_mysql(); cur = conn.cursor()' >> app/ledger.py
          echo '  cur.execute("CREATE TABLE IF NOT EXISTS tx_my (ì‹œê°„ TEXT, ìœ í˜• TEXT, ê¸°ì—…êµ¬ë¶„ TEXT, ê¸ˆì•¡ FLOAT, í†µí™” TEXT, ìƒíƒœ TEXT, ì„¤ëª… TEXT)")' >> app/ledger.py
          echo '  cur.executemany("INSERT INTO tx_my VALUES (%s,%s,%s,%s,%s,%s,%s)", rows); conn.commit(); cur.close(); conn.close()' >> app/ledger.py
          echo '' >> app/ledger.py
          echo 'if __name__ == "__main__":' >> app/ledger.py
          echo ' wait_for_db(); rows = generate(); save_csv(rows); save_pg(rows); save_mysql(rows)' >> app/ledger.py

          echo "ğŸ“„ Dockerfile ìƒì„±"
          echo 'FROM python:3.10-slim' > app/Dockerfile
          echo 'WORKDIR /app' >> app/Dockerfile
          echo 'COPY ledger.py .' >> app/Dockerfile
          echo 'RUN apt-get update && apt-get install -y gcc libpq-dev default-libmysqlclient-dev' >> app/Dockerfile
          echo 'RUN pip install psycopg2 mysql-connector-python' >> app/Dockerfile
          echo 'CMD ["python", "ledger.py"]' >> app/Dockerfile

          echo "ğŸ“„ docker-compose.yml ìƒì„±"
          echo 'version: "3.8"' > docker-compose.yml
          echo 'services:' >> docker-compose.yml
          echo '  postgres:' >> docker-compose.yml
          echo '    image: postgres:14' >> docker-compose.yml
          echo '    environment:' >> docker-compose.yml
          echo '      POSTGRES_USER: ledger' >> docker-compose.yml
          echo '      POSTGRES_PASSWORD: ledgerpass' >> docker-compose.yml
          echo '      POSTGRES_DB: ledgerdb' >> docker-compose.yml
          echo '    volumes:' >> docker-compose.yml
          echo '      - pgdata:/var/lib/postgresql/data' >> docker-compose.yml
          echo '' >> docker-compose.yml
          echo '  mysql:' >> docker-compose.yml
          echo '    image: mysql:8' >> docker-compose.yml
          echo '    environment:' >> docker-compose.yml
          echo '      MYSQL_ROOT_PASSWORD: ledgerpass' >> docker-compose.yml
          echo '      MYSQL_DATABASE: ledgerdb' >> docker-compose.yml
          echo '      MYSQL_USER: ledger' >> docker-compose.yml
          echo '      MYSQL_PASSWORD: ledgerpass' >> docker-compose.yml
          echo '    volumes:' >> docker-compose.yml
          echo '      - mysqldata:/var/lib/mysql' >> docker-compose.yml
          echo '' >> docker-compose.yml
          echo '  ledger:' >> docker-compose.yml
          echo '    build: ./app' >> docker-compose.yml
          echo '    depends_on:' >> docker-compose.yml
          echo '      - postgres' >> docker-compose.yml
          echo '      - mysql' >> docker-compose.yml
          echo '    volumes:' >> docker-compose.yml
          echo '      - ./output:/app/output' >> docker-compose.yml
          echo 'volumes:' >> docker-compose.yml
          echo '  pgdata:' >> docker-compose.yml
          echo '  mysqldata:' >> docker-compose.yml

      - name: ğŸ› ï¸ Docker Compose Build & Start
        run: |
          echo "ğŸ”§ Docker Compose Build ì‹œì‘"
          docker-compose build
          echo "ğŸš€ Docker Compose ì»¨í…Œì´ë„ˆ ì‹œì‘"
          docker-compose up -d

      - name: â±ï¸ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™” ëŒ€ê¸°
        run: |
          echo "â±ï¸ DB ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘ (20ì´ˆ)"
          sleep 20

      - name: ğŸ“„ ê²°ê³¼ CSV í™•ì¸ ë° ì—…ë¡œë“œ
        run: |
          cat output/transactions.csv || echo "âš ï¸ CSV íŒŒì¼ ì—†ìŒ"
        shell: bash

      - name: ğŸ“¤ CSV ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: ê±°ë˜ë°ì´í„°
          path: output/transactions.csv
