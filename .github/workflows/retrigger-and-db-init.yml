name: 🐘 PostgreSQL 초기화 및 거래 테이블 생성

on:
  workflow_dispatch:

jobs:
  init-postgres:
    runs-on: ubuntu-latest

    steps:
      - name: 📂 저장소 체크아웃
        uses: actions/checkout@v4

      - name: 📁 SQL 초기화 디렉토리 생성 및 테이블 스크립트 작성
        run: |
          mkdir -p db/init
          cat << 'EOF' > db/init/create_ledger_tables.sql
          CREATE TABLE IF NOT EXISTS tx_pg (
            시간 TEXT,
            유형 TEXT,
            기업구분 TEXT,
            금액 REAL,
            통화 TEXT,
            상태 TEXT,
            설명 TEXT
          );
          EOF

      - name: 🐘 PostgreSQL 컨테이너 시작 및 테이블 적용
        run: |
          echo "🐘 PostgreSQL 시작"
          docker run --name pg-init \
            -e POSTGRES_PASSWORD=pass \
            -e POSTGRES_DB=ledger \
            -v ${{ github.workspace }}/db/init:/docker-entrypoint-initdb.d \
            -d --health-cmd="pg_isready -U postgres" \
            --health-interval=5s --health-retries=10 \
            postgres:14

          echo "⏱️ PostgreSQL 초기화 대기"
          for i in {1..20}; do
            status=$(docker inspect --format='{{.State.Health.Status}}' pg-init || echo "no-container")
            echo "📊 상태: $status"
            if [ "$status" = "healthy" ]; then
              echo "✅ PostgreSQL 컨테이너 정상 실행됨"
              break
            fi
            sleep 5
          done

          echo "🗒️ PostgreSQL 로그 요약"
          docker logs pg-init | tail -n 20

          echo "📥 테이블 생성 확인"
          docker exec pg-init psql -U postgres -d ledger -c '\dt'

          echo "🧹 PostgreSQL 컨테이너 중지 및 삭제"
          docker stop pg-init
          docker rm pg-init
