name: 🧱 Maven Build & Export

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      MAVEN_VERSION: 3.9.6
      MAVEN_HOME: /opt/maven
      EXPORT_DIR: /opt/export
      BUILD_DIR: build-artifacts

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: ⚙️ Install Maven
        run: |
          MAVEN_URL="https://archive.apache.org/dist/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz"
          wget -q "$MAVEN_URL" -O maven.tar.gz
          sudo tar xzf maven.tar.gz -C /opt
          sudo mv "/opt/apache-maven-${MAVEN_VERSION}" "$MAVEN_HOME"
          echo "$MAVEN_HOME/bin" >> $GITHUB_PATH

      - name: 🧾 Create pom.xml if missing
        run: |
          if [ ! -f pom.xml ]; then
            echo "📄 pom.xml 자동 생성"
            tee pom.xml > /dev/null <<'EOF'
          fi

      - name: 🔨 Build with Maven
        run: |
          echo "⚙️ 빌드 시작"
          mvn clean install -B

      - name: 📂 Prepare export directories
        run: |
          mkdir -p "$EXPORT_DIR"
          mkdir -p "$BUILD_DIR"

      - name: 📦 Export JARs
        run: |
          find . -type f -name "*.jar" -path "*/target/*.jar" -exec cp {} "$EXPORT_DIR/" \;
          cp "$EXPORT_DIR"/*.jar "$BUILD_DIR/" || echo "❌ JAR 파일이 없습니다"

      - name: ✅ 완료
        run: echo "🎉 JAR 빌드 및 내보내기 작업이 성공적으로 완료되었습니다"
