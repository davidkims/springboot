name: ğŸ’³ AutoTransfer Ledger Generation

on:
  workflow_dispatch:
  schedule:
    - cron: '*/10 * * * *'

jobs:
  autotransfer-ledger:
    runs-on: ubuntu-latest

    env:
      PG_DB: finance
      PG_USER: postgres
      PG_PASS: pgpass
      MYSQL_ROOT_PASS: rootpass
      LEDGER_PATH: ledger
      SQL_DIR: sql
      TIMESTAMP: "20250603020557"

    steps:
      - name: ğŸ“ ë””ë ‰í† ë¦¬ ìƒì„±
        run: |
          mkdir -p $LEDGER_PATH $SQL_DIR

      - name: ğŸ˜ PostgreSQL ì„¤ì¹˜ ë° ì´ˆê¸°í™”
        run: |
          sudo apt update
          sudo apt install -y postgresql
          sudo systemctl start postgresql
          sudo -u postgres psql -c "ALTER USER $PG_USER WITH PASSWORD '$PG_PASS';"
          echo "127.0.0.1:5432:$PG_DB:$PG_USER:$PG_PASS" > ~/.pgpass
          chmod 600 ~/.pgpass

      - name: ğŸ˜ PostgreSQL ê±°ë˜ í…Œì´ë¸” ìƒì„±
        run: |
          sudo -u postgres createdb $PG_DB || echo "ì´ë¯¸ ì¡´ì¬"
          PGPASSFILE=$HOME/.pgpass psql -U $PG_USER -d $PG_DB -c "
            CREATE TABLE IF NOT EXISTS transactions (
              id SERIAL PRIMARY KEY,
              type VARCHAR(20),
              amount NUMERIC,
              currency VARCHAR(10),
              status VARCHAR(20),
              timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );"

      - name: ğŸ’³ ìë™ì´ì²´ ê±°ë˜ ì‚½ì…
        run: |
          PGPASSFILE=$HOME/.pgpass psql -U $PG_USER -d $PG_DB -c "
            INSERT INTO transactions (type, amount, currency, status)
            VALUES
              ('credit_card', 125000, 'KRW', 'completed'),
              ('check_card', 58000, 'KRW', 'completed'),
              ('stock', 1000000, 'KRW', 'completed'),
              ('forex', 870, 'USD', 'completed');"

      - name: ğŸ§¾ ê±°ë˜ ì›ì¥ CSV ìƒì„±
        run: |
          PGPASSFILE=$HOME/.pgpass psql -U $PG_USER -d $PG_DB -c "\COPY transactions TO '$LEDGER_PATH/ledger-${TIMESTAMP}.csv' WITH CSV HEADER"

      - name: ğŸ“„ ìƒì„±ëœ ê±°ë˜ ì›ì¥ í™•ì¸
        run: |
          ls -lh $LEDGER_PATH
          cat $LEDGER_PATH/ledger-${TIMESTAMP}.csv || echo "âš ï¸ ì›ì¥ íŒŒì¼ ì—†ìŒ"
