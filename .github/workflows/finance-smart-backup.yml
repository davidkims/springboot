name: 🔄 Finance Smart Backup with PostgreSQL & Kafka + OTP

on:
  schedule:
    - cron: "*/5 * * * *"  # 매 5분마다 실행
  workflow_dispatch:

jobs:
  finance-backup:
    runs-on: ubuntu-latest

    env:
      ROOT_PASS: rootpass123
      SQL_DIR: /opt/finance/sql
      BACKUP_DIR: /opt/finance/backups
      KAFKA_LOG: /opt/finance/kafka.log
      PG_DB: postgres_finance
      PG_USER: postgres
      PG_PASS: pgpass
      TYPES: |
        bank_transfer
        check_card
        credit_card
        bitcoin
        stock
        futures

    steps:
      - name: 📁 Create Directories and Init SQL
        run: |
          sudo mkdir -p $SQL_DIR $BACKUP_DIR
          sudo chmod -R 777 /opt/finance
          echo "CREATE TABLE IF NOT EXISTS transfers (
            id SERIAL PRIMARY KEY,
            type VARCHAR(30),
            amount NUMERIC,
            currency VARCHAR(5),
            status VARCHAR(20),
            otp_code VARCHAR(10),
            timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );" > $SQL_DIR/init.sql
          echo "INSERT INTO transfers(type, amount, currency, status, otp_code) VALUES
            ('bank_transfer', 100000, 'KRW', 'completed', '123456'),
            ('check_card', 20000, 'KRW', 'completed', '654321'),
            ('credit_card', 150000, 'KRW', 'completed', '111222'),
            ('bitcoin', 0.03, 'BTC', 'pending', '999999'),
            ('stock', 1000000, 'KRW', 'completed', '333444'),
            ('futures', 500000, 'KRW', 'pending', '555666');" >> $SQL_DIR/init.sql

      - name: 🐐 Install and Start PostgreSQL
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql oathtool
          sudo systemctl start postgresql
          sudo systemctl enable postgresql

      - name: 🔐 Create OTP Secret and Validate
        run: |
          OTP_SECRET=JBSWY3DPEHPK3PXP
          OTP_CODE=$(oathtool --totp -b $OTP_SECRET)
          echo "Generated OTP: $OTP_CODE"
          echo $OTP_CODE > /opt/finance/otp.code

      - name: 🔐 Create MySQL .my.cnf for Secure Auth
        run: |
          echo "[client]" > ~/.my.cnf
          echo "user=root" >> ~/.my.cnf
          echo "password=$ROOT_PASS" >> ~/.my.cnf
          chmod 600 ~/.my.cnf

      - name: 🔐 Create PostgreSQL .pgpass
        run: |
          echo "127.0.0.1:5432:$PG_DB:$PG_USER:$PG_PASS" > ~/.pgpass
          chmod 600 ~/.pgpass

      - name: 🐐 Create PostgreSQL DB and Financial Tables
        run: |
          sudo -u postgres psql -c "CREATE DATABASE $PG_DB;"
          sudo -u postgres psql -d $PG_DB -c "
            CREATE TABLE IF NOT EXISTS logs (
              type VARCHAR,
              status VARCHAR,
              backup_time TIMESTAMP
            );
            CREATE TABLE IF NOT EXISTS accounts (
              id SERIAL PRIMARY KEY,
              holder_name VARCHAR(100),
              account_number VARCHAR(30),
              account_type VARCHAR(30),
              currency VARCHAR(10),
              balance NUMERIC
            );
            CREATE TABLE IF NOT EXISTS transactions (
              id SERIAL PRIMARY KEY,
              account_id INT,
              amount NUMERIC,
              transaction_type VARCHAR(30),
              status VARCHAR(20),
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
            CREATE TABLE IF NOT EXISTS cards (
              id SERIAL PRIMARY KEY,
              account_id INT,
              card_type VARCHAR(20),
              card_number VARCHAR(20),
              expiry DATE,
              active BOOLEAN
            );
            CREATE TABLE IF NOT EXISTS crypto_wallets (
              id SERIAL PRIMARY KEY,
              wallet_address VARCHAR(100),
              currency VARCHAR(10),
              balance NUMERIC
            );
            CREATE TABLE IF NOT EXISTS securities (
              id SERIAL PRIMARY KEY,
              ticker VARCHAR(10),
              quantity INT,
              purchase_price NUMERIC,
              account_id INT
            );
            CREATE TABLE IF NOT EXISTS forex_trades (
              id SERIAL PRIMARY KEY,
              base_currency VARCHAR(10),
              quote_currency VARCHAR(10),
              rate NUMERIC,
              amount NUMERIC,
              trade_time TIMESTAMP
            );
            CREATE TABLE IF NOT EXISTS futures_contracts (
              id SERIAL PRIMARY KEY,
              symbol VARCHAR(20),
              contract_size NUMERIC,
              margin NUMERIC,
              expiration_date DATE
            );
            CREATE TABLE IF NOT EXISTS payment_gateway_logs (
              id SERIAL PRIMARY KEY,
              gateway_name VARCHAR(50),
              request_payload TEXT,
              response_payload TEXT,
              status VARCHAR(20),
              timestamp TIMESTAMP
            );
          "

      - name: ↺ Run Per-Type Backup Loop
        run: |
          for TYPE in $TYPES; do
            DB_NAME="db_${TYPE}"
            DB_USER="user_${TYPE}"
            DB_PASS="pass_${TYPE}"
            CONTAINER="mysql_${TYPE}"
            PORT=$((3307 + RANDOM % 1000))

            echo "🚀 Starting $TYPE container on port $PORT"
            docker run -d --rm \
              --name $CONTAINER \
              -e MYSQL_ROOT_PASSWORD=$ROOT_PASS \
              -e MYSQL_DATABASE=$DB_NAME \
              -e MYSQL_USER=$DB_USER \
              -e MYSQL_PASSWORD=$DB_PASS \
              -v $SQL_DIR:/docker-entrypoint-initdb.d \
              -p $PORT:3306 \
              mysql:8.0

            echo "⏳ Waiting for $TYPE container to initialize"
            sleep 30

            OTP_EXPECTED=$(cat /opt/finance/otp.code)
            OTP_DB=$(mysql -h 127.0.0.1 -P $PORT -u$DB_USER -p$DB_PASS -N -e "USE $DB_NAME; SELECT otp_code FROM transfers WHERE type='$TYPE' AND status='completed' LIMIT 1;")

            if [ "$OTP_EXPECTED" = "$OTP_DB" ]; then
              STATUS=$(mysql -h 127.0.0.1 -P $PORT -u$DB_USER -p$DB_PASS -N -e "USE $DB_NAME; SELECT COUNT(*) FROM transfers WHERE type='$TYPE' AND status='completed';")
              echo "🔍 $TYPE completed: $STATUS"

              if [ "$STATUS" != "0" ]; then
                BACKUP_FILE=$BACKUP_DIR/${TYPE}_backup.sql
                mysqldump --no-tablespaces -h 127.0.0.1 -P $PORT -u$DB_USER -p$DB_PASS $DB_NAME > $BACKUP_FILE
                echo "✅ Backup completed: $BACKUP_FILE"
                TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
                sudo -u postgres psql -d $PG_DB -c "INSERT INTO logs VALUES ('$TYPE', 'completed', '$TIMESTAMP');"
                echo "$TIMESTAMP [$TYPE] backup done" >> $KAFKA_LOG
              fi
            else
              echo "❌ OTP 인증 실패: $TYPE"
            fi

            docker stop $CONTAINER
          done

      - name: 📦 Compress Backups
        run: |
          cd $BACKUP_DIR
          tar -czf finance-backups-${{ github.run_id }}.tar.gz *.sql
          ls -lh

      - name: 📓 View PostgreSQL Logs
        run: |
          sudo -u postgres psql -d $PG_DB -c "SELECT * FROM logs;"

      - name: 📄 Kafka-style Logs
        run: |
          cat $KAFKA_LOG || echo "No kafka-style logs generated"
