name: Build & Deploy finance-transactions with DB Backup + Provenance + Restart + Preserve

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“… Checkout ì½”ë“œ
        uses: actions/checkout@v4

      - name: ğŸ“¦ requirements.txt ìƒì„± ë° í™•ì¸
        run: |
          echo "flask" > requirements.txt
          echo "flask_sqlalchemy" >> requirements.txt
          echo "python-dotenv" >> requirements.txt
          echo "psycopg2-binary" >> requirements.txt
          echo "SQLAlchemy" >> requirements.txt
          echo "faker" >> requirements.txt
          pip install -r requirements.txt
          test -f requirements.txt && echo "[âœ”] requirements.txt ìƒì„± ì™„ë£Œ" || (echo "[âŒ] requirements.txt ìƒì„± ì‹¤íŒ¨" && exit 1)

      - name: âš™ï¸ .env íŒŒì¼ ìƒì„± ë° í™•ì¸
        run: |
          echo "FLASK_ENV=production" > .env
          echo "APP_NAME=FinanceTransactions" >> .env
          echo "DEBUG=False" >> .env
          echo "POSTGRES_DB=finance" >> .env
          echo "POSTGRES_USER=postgres" >> .env
          echo "POSTGRES_PASSWORD=postgres123" >> .env
          echo "DB_HOST=db" >> .env
          echo "DB_PORT=5432" >> .env
          test -f .env && echo "[âœ”] .env ìƒì„± ì™„ë£Œ" || (echo "[âŒ] .env ìƒì„± ì‹¤íŒ¨" && exit 1)

      - name: ğŸ ê±°ë˜ ì›ì¥ ë° ê±°ë˜ ë°œìƒ ì‹œë®¬ë ˆì´ì…˜ ì½”ë“œ ìƒì„±
        run: |
          mkdir -p backup
          echo "import csv, random, datetime, time" > ledger.py
          echo "from faker import Faker" >> ledger.py
          echo "fake = Faker()" >> ledger.py
          echo "accounts = [[fake.name(), fake.bban(), round(random.uniform(1000,100000),2)] for _ in range(10)]" >> ledger.py
          echo "with open('backup/accounts.csv', 'w', newline='') as f:" >> ledger.py
          echo "    writer = csv.writer(f)" >> ledger.py
          echo "    writer.writerow(['name','account','balance'])" >> ledger.py
          echo "    writer.writerows(accounts)" >> ledger.py
          echo "with open('backup/transactions.csv', 'w', newline='') as f_all, open('backup/retries.csv', 'w', newline='') as f_retry:" >> ledger.py
          echo "    writer_all = csv.writer(f_all)" >> ledger.py
          echo "    writer_all.writerow(['timestamp','amount','currency','status'])" >> ledger.py
          echo "    writer_retry = csv.writer(f_retry)" >> ledger.py
          echo "    writer_retry.writerow(['timestamp','amount','currency'])" >> ledger.py
          echo "    for _ in range(20):" >> ledger.py
          echo "        ts = datetime.datetime.now().isoformat()" >> ledger.py
          echo "        amt = round(random.uniform(1.0, 5000.0), 2)" >> ledger.py
          echo "        currency = random.choice(['USD','KRW','JPY'])" >> ledger.py
          echo "        status = random.choice(['completed','pending','failed'])" >> ledger.py
          echo "        writer_all.writerow([ts, amt, currency, status])" >> ledger.py
          echo "        if status != 'completed':" >> ledger.py
          echo "            writer_retry.writerow([ts, amt, currency])" >> ledger.py
          echo "        print(f'ğŸ’¸ ê±°ë˜ ë°œìƒ: {amt} {currency} / ìƒíƒœ: {status}')" >> ledger.py
          echo "        time.sleep(0.1)" >> ledger.py
          echo "with open('backup/retries.csv', newline='') as src, open('backup/transactions.csv', 'a', newline='') as dst:" >> ledger.py
          echo "    reader = csv.DictReader(src)" >> ledger.py
          echo "    writer = csv.writer(dst)" >> ledger.py
          echo "    for row in reader:" >> ledger.py
          echo "        ts = datetime.datetime.now().isoformat()" >> ledger.py
          echo "        writer.writerow([ts, row['amount'], row['currency'], 'completed'])" >> ledger.py
          echo "        print(f'âœ… ì¬ì²˜ë¦¬ ì™„ë£Œ: {row['amount']} {row['currency']}')" >> ledger.py
          python3 ledger.py

      - name: ğŸ“œ ê±°ë˜ ì›ì¥ íŒŒì¼ ìƒíƒœ ì²´í¬ ë° ë°°ì§€ ì¶œë ¥
        run: |
          for file in backup/accounts.csv backup/transactions.csv; do
            if [ -f "$file" ]; then echo "âœ”ï¸ $file ìƒì„±ë¨"; else echo "âŒ $file ëˆ„ë½ë¨" && exit 1; fi
          done

      - name: ğŸ” Provenance ìƒì„± (CSV í•´ì‹œ)
        run: |
          mkdir -p provenance
          TS=$(date +%Y%m%d%H%M%S)
          OUT="provenance/csv-metadata-$TS.json"
          echo "[" > "$OUT"
          for f in backup/*.csv; do
            HASH=$(sha256sum "$f" | awk '{print $1}')
            echo "  {\"file\": \"$f\", \"sha256\": \"$HASH\" }," >> "$OUT"
          done
          sed -i '$ s/},/}/' "$OUT"
          echo "]" >> "$OUT"

      - name: â¬‡ï¸ ì¦ëª…ì„œ ë‹¤ìš´ë¡œë“œìš© ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: csv-provenance
          path: provenance/*.json

      - name: ğŸ˜ PostgreSQL ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        run: |
          docker run -d --name db \
            -e POSTGRES_DB=finance \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres123 \
            -p 5432:5432 postgres:15
          sleep 10

      - name: ğŸ—ƒï¸ CSV â†’ PostgreSQL ì ì¬
        run: |
          tail -n +2 backup/transactions.csv > backup/tmp.csv
          docker exec db psql -U postgres -d finance -c "CREATE TABLE IF NOT EXISTS transactions (timestamp TIMESTAMP, amount NUMERIC, currency VARCHAR(10), status VARCHAR(20));"
          docker cp backup/tmp.csv db:/tmp/tmp.csv
          docker exec db psql -U postgres -d finance -c "COPY transactions(timestamp, amount, currency, status) FROM '/tmp/tmp.csv' DELIMITER ',' CSV;"

      - name: ğŸ’¾ DB ë°±ì—…
        run: |
          TS=$(date +%Y%m%d%H%M%S)
          docker exec db pg_dump -U postgres -d finance > backup/backup-$TS.sql
          echo "$TS" > backup/latest.txt

      - name: ğŸ§¾ Backup Provenance ìƒì„±
        run: |
          mkdir -p provenance
          TS=$(cat backup/latest.txt)
          BACKUP_FILE="backup/backup-$TS.sql"
          HASH=$(sha256sum "$BACKUP_FILE" | awk '{print $1}')
          echo "{\"artifact\": \"$BACKUP_FILE\", \"sha256\": \"$HASH\", \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" > provenance/provenance-$TS.json

      - name: â¬‡ï¸ DB Backup ì¦ëª…ì„œ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: db-provenance
          path: provenance/provenance-*.json

      - name: â™»ï¸ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ ì²˜ë¦¬
        run: |
          if ! docker ps | grep -q db; then
            docker start db || docker run -d --name db \
              -e POSTGRES_DB=finance \
              -e POSTGRES_USER=postgres \
              -e POSTGRES_PASSWORD=postgres123 \
              -p 5432:5432 postgres:15
          fi

      - name: ğŸ§¹ ì»¨í…Œì´ë„ˆ ì •ë¦¬
        if: always()
        run: |
          docker stop db || true
          docker rm db || true
