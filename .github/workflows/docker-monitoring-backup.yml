name: 🐳 Docker Finance Image Build & Conditional GHCR Push

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-and-optional-push:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/finance-app
      IMAGE_TAG: latest

    steps:
      - name: 📦 Checkout Source
        uses: actions/checkout@v4

      - name: 🏗️ Build Docker Image
        run: |
          docker build -t $IMAGE_NAME:$IMAGE_TAG .

      - name: 🔍 Check if GH_PAT is available
        id: check_pat
        run: |
          if [ -z "${{ secrets.GH_PAT }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: 🔐 Docker Login to GHCR (if token exists)
        if: steps.check_pat.outputs.skip == 'false'
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          echo "$GH_PAT" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: 🚀 Push Image to GHCR (if token exists)
        if: steps.check_pat.outputs.skip == 'false'
        run: |
          docker push $IMAGE_NAME:$IMAGE_TAG

      - name: ✅ Show Local Docker Images
        run: |
          docker images | grep finance-app || echo "🟡 Image not found"
