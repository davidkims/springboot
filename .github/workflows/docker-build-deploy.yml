name: Build & Deploy finance-transactions

on:
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›’ Checkout ì½”ë“œ
        uses: actions/checkout@v4

      - name: ğŸ“„ Dockerfile ìƒì„± (echo ê¸°ë°˜)
        run: |
          echo "[build-and-deploy] Dockerfile ìƒì„± ì‹œì‘..."
          echo "echo 'FROM python:3.11-slim'" > Dockerfile
          echo "echo 'WORKDIR /app'" >> Dockerfile
          echo "echo 'COPY . .'" >> Dockerfile
          echo "echo 'RUN pip install --no-cache-dir -r requirements.txt'" >> Dockerfile
          echo "echo 'CMD [\"python\", \"app.py\"]'" >> Dockerfile
          
          echo "FROM python:3.11-slim" > Dockerfile
          echo "WORKDIR /app" >> Dockerfile
          echo "COPY . ." >> Dockerfile
          echo "RUN pip install --no-cache-dir -r requirements.txt" >> Dockerfile
          echo "CMD [\"python\", \"app.py\"]" >> Dockerfile

          echo "[build-and-deploy] Dockerfile ìƒì„± ì™„ë£Œ âœ…"
          echo "---------------- Dockerfile ë‚´ìš© ----------------"
          cat Dockerfile
          echo "------------------------------------------------"

      - name: ğŸ³ Docker ì„¤ì¹˜
        run: |
          echo "[build-and-deploy] Docker ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ ë‹¤ìš´ë¡œë“œ ì¤‘..."
          curl -fsSL https://get.docker.com -o get-docker.sh
          echo "[build-and-deploy] Docker ì„¤ì¹˜ ì¤‘..."
          sudo sh get-docker.sh
          sudo systemctl start docker || sudo service docker start
          echo "[build-and-deploy] Docker ë²„ì „ í™•ì¸:"
          docker --version

      - name: ğŸ—ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ
        run: |
          echo "[build-and-deploy] Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘..."
          docker build -t finance-transactions:latest .
          echo "[build-and-deploy] Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ âœ…"

      - name: ğŸš€ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        run: |
          echo "[build-and-deploy] ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±° ì‹œë„..."
          docker rm -f finance-transactions || echo "âš ï¸ ì´ì „ ì»¨í…Œì´ë„ˆ ì—†ìŒ ë˜ëŠ” ì´ë¯¸ ì¢…ë£Œë¨"

          echo "[build-and-deploy] ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
          docker run -d \
            --name finance-transactions \
            -v finance-data:/data \
            finance-transactions:latest
          echo "[build-and-deploy] ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì™„ë£Œ âœ…"

      - name: ğŸ”§ ì „ì²´ ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        run: |
          echo "[build-and-deploy] ./scripts/full_setup.sh ì‹¤í–‰ ì¤‘..."
          chmod +x ./scripts/full_setup.sh || echo "âš ï¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ì‹¤íŒ¨ ë˜ëŠ” íŒŒì¼ ì—†ìŒ"
          ./scripts/full_setup.sh || echo "âš ï¸ full_setup.sh ì‹¤í–‰ ì‹¤íŒ¨ ë˜ëŠ” íŒŒì¼ ì—†ìŒ"

      - name: ğŸ§¹ ì •ë¦¬ ì‘ì—… (Always)
        if: always()
        run: |
          echo "[build-and-deploy] ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
          docker rm -f finance-transactions || true
          docker volume prune -f || true
