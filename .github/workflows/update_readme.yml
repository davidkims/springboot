name: Analyze Repo and Update README

on:
  workflow_dispatch: # GitHub UIì—ì„œ ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©
  push:
    branches: ["main"] # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰ (í•„ìš”ì— ë”°ë¼ ë³€ê²½)
    paths-ignore:
      - 'README.md' # README.md ë³€ê²½ìœ¼ë¡œ ì¸í•œ ë¬´í•œ ë£¨í”„ ë°©ì§€

jobs:
  analyze-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4
        with:
          # README.mdë¥¼ ì—…ë°ì´íŠ¸í•˜ê³  ë‹¤ì‹œ í‘¸ì‹œí•˜ë ¤ë©´ í† í°ì— ì“°ê¸° ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.
          # ê¸°ë³¸ GITHUB_TOKENì€ ì½ê¸° ì „ìš©ì´ë¯€ë¡œ, ì“°ê¸° ê¶Œí•œì„ ë¶€ì—¬í•´ì•¼ í•©ë‹ˆë‹¤.
          # jobs.<job_id>.permissions.contents: write ë¡œ ì„¤ì •í•˜ê±°ë‚˜,
          # ê°œì¸ ì•¡ì„¸ìŠ¤ í† í°(PAT)ì„ ì‚¬ìš©í•´ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Set up Python (Optional:for more complex scripting)
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' # í•„ìš”ì— ë”°ë¼ 3.9, 3.10 ë“±ìœ¼ë¡œ ì§€ì •

      - name: ğŸ“ Generate Analysis Report and Update README.md
        id: generate_report
        run: |
          REPORT_FILE="temp_analysis_report.md"
          README_PATH="README.md"
          REPO_NAME="davidkims/springboot" # ë¶„ì„í•  ì €ì¥ì†Œ ì´ë¦„

          echo "## ğŸš€ ${REPO_NAME} ì €ì¥ì†Œ ë¶„ì„ ë³´ê³ ì„œ" > $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "ì´ ë³´ê³ ì„œëŠ” GitHub Actions ì›Œí¬í”Œë¡œìš°ì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ê° íŒŒì¼ì˜ ê¸°ë³¸ì ì¸ ì •ë³´ì™€ ìë™ ë¶„ì„ëœ íŠ¹ì´ì‚¬í•­ì„ í¬í•¨í•©ë‹ˆë‹¤." >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "### ğŸ“‚ íŒŒì¼ ëª©ë¡ ë° íŠ¹ì´ì‚¬í•­" >> $REPORT_FILE
          echo "" >> $REPORT_FILE

          # git ls-files ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  íŒŒì¼ì„ ë‚˜ì—´í•©ë‹ˆë‹¤.
          # .git/ ë””ë ‰í† ë¦¬ì™€ ê°™ì€ ì œì™¸í•  í•„ìš”ê°€ ìˆëŠ” ë””ë ‰í† ë¦¬ëŠ” ë³„ë„ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          git ls-files | while IFS= read -r file; do
              # ìˆ¨ê¹€ íŒŒì¼ ë° íŠ¹ì • ë””ë ‰í† ë¦¬ ì œì™¸ (ì˜ˆ: .git/, target/, build/)
              if [[ "$file" == ".git/"* || "$file" == "target/"* || "$file" == "build/"* || "$file" == "src/main/resources/static/"* ]]; then
                  continue
              fi

              FILE_SIZE=$(du -b "$file" | cut -f1) # íŒŒì¼ í¬ê¸° (ë°”ì´íŠ¸)
              FILE_TYPE=$(file -b --mime-type "$file") # íŒŒì¼ MIME íƒ€ì…

              echo "#### ğŸ“„ $file" >> $REPORT_FILE
              echo "- **íŒŒì¼ ê²½ë¡œ:** \`$file\`" >> $REPORT_FILE
              echo "- **íŒŒì¼ í¬ê¸°:** $FILE_SIZE ë°”ì´íŠ¸" >> $REPORT_FILE
              echo "- **íŒŒì¼ íƒ€ì…:** \`$FILE_TYPE\`" >> $REPORT_FILE

              # --- ìë™ ë¶„ì„ ë¡œì§ Placeholder ---
              # ì—¬ê¸°ì— ê° íŒŒì¼ ë˜ëŠ” ì½”ë“œ ë¸”ë¡ì— ëŒ€í•œ êµ¬ì²´ì ì¸ "íŠ¹ì´ì‚¬í•­"ì„
              # ìë™ ë¶„ì„í•˜ì—¬ ì¶”ê°€í•˜ëŠ” ë¡œì§ì´ ë“¤ì–´ê°€ì•¼ í•©ë‹ˆë‹¤.
              # ì˜ˆ: íŠ¹ì • í‚¤ì›Œë“œ ê²€ìƒ‰, íŒŒì¼ ë‚´ìš© ê¸°ë°˜ì˜ ê°„ë‹¨í•œ ë¶„ì„.
              # ë³µì¡í•œ ë¶„ì„ì€ Python ìŠ¤í¬ë¦½íŠ¸ë‚˜ ì™¸ë¶€ ë„êµ¬ í†µí•©ì´ í•„ìš”í•©ë‹ˆë‹¤.

              SPECIAL_NOTE="ì´ ë¶€ë¶„ì€ ìë™í™”ëœ ì½”ë“œ ë¶„ì„ìœ¼ë¡œëŠ” íŠ¹ì´ì‚¬í•­ì„ ì‹ë³„í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤."
              if [[ "$file" == *.java ]]; then
                  # Java íŒŒì¼ì— ëŒ€í•œ ê°„ë‹¨í•œ ì˜ˆì‹œ íŠ¹ì´ì‚¬í•­: 'TODO' ì£¼ì„ í™•ì¸
                  if grep -q "TODO" "$file"; then
                      SPECIAL_NOTE="TODO ì£¼ì„ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
                  fi
                  # ë” ë³µì¡í•œ Java ì½”ë“œ ë¶„ì„ì€ ì™¸ë¶€ ë„êµ¬(ì˜ˆ: Checkstyle, PMD)ê°€ í•„ìš”í•©ë‹ˆë‹¤.
              elif [[ "$file" == *.xml || "$file" == *.properties || "$file" == *.yml || "$file" == *.yaml ]]; then
                  # ì„¤ì • íŒŒì¼ì— ëŒ€í•œ ì˜ˆì‹œ íŠ¹ì´ì‚¬í•­: ë¯¼ê° ì •ë³´ ê°€ëŠ¥ì„± ê²½ê³ 
                  if grep -qE "password|secret|api_key" "$file"; then
                      SPECIAL_NOTE="ë¯¼ê° ì •ë³´(password, secret ë“±) í‚¤ì›Œë“œ ë°œê²¬ ê°€ëŠ¥ì„±. ì£¼ì˜ ìš”ë§."
                  fi
              elif [[ "$file" == *.md ]]; then
                  SPECIAL_NOTE="ì´ íŒŒì¼ì€ ë§ˆí¬ë‹¤ìš´ ë¬¸ì„œì…ë‹ˆë‹¤."
              fi

              echo "- **íŠ¹ì´ì‚¬í•­:** $SPECIAL_NOTE" >> $REPORT_FILE
              echo "" >> $REPORT_FILE
          done

          echo "## ğŸ“… ìƒì„± ë‚ ì§œ" >> $REPORT_FILE
          echo "$(date '+%Yë…„ %mì›” %dì¼ %Hì‹œ %Më¶„ %Sì´ˆ')" >> $REPORT_FILE
          echo "" >> $REPORT_FILE

          # ê¸°ì¡´ README.md ë‚´ìš©ì„ ë°±ì—… (ë§Œì•½ì„ ëŒ€ë¹„)
          # mv $README_PATH ${README_PATH}.bak

          # REPORT_FILE ë‚´ìš©ì„ README.mdì— ë®ì–´ì”ë‹ˆë‹¤.
          # ê¸°ì¡´ README.md ë‚´ìš©ì— ì¶”ê°€í•˜ê³  ì‹¶ë‹¤ë©´ 'cat $REPORT_FILE >> $README_PATH' ë˜ëŠ”
          # íŠ¹ì • ì„¹ì…˜ë§Œ ì—…ë°ì´íŠ¸í•˜ëŠ” ë” ë³µì¡í•œ ìŠ¤í¬ë¦½íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.
          cat $REPORT_FILE > $README_PATH
          rm $REPORT_FILE # ì„ì‹œ íŒŒì¼ ì‚­ì œ

          # ë³€ê²½ ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          if git diff --exit-code --quiet $README_PATH; then
              echo "âœ… README.mdì— ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. ì—…ë°ì´íŠ¸ë¥¼ ê±´ë„ˆëœ€."
              echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
              echo "ğŸ”„ README.mdê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì»¤ë°‹ ë° í‘¸ì‹œ ì¤€ë¹„ ì¤‘..."
              echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: âš™ï¸ Configure Git
        if: steps.generate_report.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: â¬†ï¸ Commit and Push Changes
        if: steps.generate_report.outputs.has_changes == 'true'
        run: |
          git add README.md
          git commit -m "Docs: Auto-generate repository analysis report in README.md"
          git push
        env:
          # GITHUB_TOKENì€ ê¸°ë³¸ì ìœ¼ë¡œ ì œê³µë˜ë©°, 'contents: write' ê¶Œí•œì´ ìˆë‹¤ë©´ ì‚¬ìš© ê°€ëŠ¥
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
