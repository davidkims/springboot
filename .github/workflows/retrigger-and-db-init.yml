name: ğŸ˜ PostgreSQL ì´ˆê¸°í™” ë° ê±°ë˜ í…Œì´ë¸” ìƒì„±

on:
  workflow_dispatch:

jobs:
  init-postgres:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‚ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“ SQL ì´ˆê¸°í™” ë””ë ‰í† ë¦¬ ìƒì„± ë° í…Œì´ë¸” ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
        run: |
          mkdir -p db/init
          cat << 'EOF' > db/init/create_ledger_tables.sql
          CREATE TABLE IF NOT EXISTS tx_pg (
            ì‹œê°„ TEXT,
            ìœ í˜• TEXT,
            ê¸°ì—…êµ¬ë¶„ TEXT,
            ê¸ˆì•¡ REAL,
            í†µí™” TEXT,
            ìƒíƒœ TEXT,
            ì„¤ëª… TEXT
          );
          EOF

      - name: ğŸ˜ PostgreSQL ì»¨í…Œì´ë„ˆ ì‹œì‘ ë° í…Œì´ë¸” ì ìš©
        run: |
          echo "ğŸ˜ PostgreSQL ì‹œì‘"
          docker run --name pg-init \
            -e POSTGRES_PASSWORD=pass \
            -e POSTGRES_DB=ledger \
            -v ${{ github.workspace }}/db/init:/docker-entrypoint-initdb.d \
            -d --health-cmd="pg_isready -U postgres" \
            --health-interval=5s --health-retries=10 \
            postgres:14

          echo "â±ï¸ PostgreSQL ì´ˆê¸°í™” ëŒ€ê¸°"
          for i in {1..20}; do
            status=$(docker inspect --format='{{.State.Health.Status}}' pg-init || echo "no-container")
            echo "ğŸ“Š ìƒíƒœ: $status"
            if [ "$status" = "healthy" ]; then
              echo "âœ… PostgreSQL ì»¨í…Œì´ë„ˆ ì •ìƒ ì‹¤í–‰ë¨"
              break
            fi
            sleep 5
          done

          echo "ğŸ—’ï¸ PostgreSQL ë¡œê·¸ ìš”ì•½"
          docker logs pg-init | tail -n 20

          echo "ğŸ“¥ í…Œì´ë¸” ìƒì„± í™•ì¸"
          docker exec pg-init psql -U postgres -d ledger -c '\dt'

          echo "ğŸ§¹ PostgreSQL ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ"
          docker stop pg-init
          docker rm pg-init
