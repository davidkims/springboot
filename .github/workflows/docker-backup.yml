# .github/workflows/docker-backup.yml
name: Docker Build, Deploy & Hourly Backup with Volume & Encryption

on:
  push:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'  # Îß§ÏãúÍ∞Ñ 0Î∂Ñ (UTC) Ïã§Ìñâ

jobs:
  setup-docker:
    runs-on: ubuntu-latest
    outputs:
      docker_ready: true
    steps:
      - name: Removing old Docker / containerd packages
        run: |
          echo "üóëÔ∏è  Removing legacy Docker packages..."
          sudo apt-get remove -y docker docker-engine docker.io containerd containerd.io runc || echo "No legacy packages to remove."

      - name: Installing prerequisites
        run: |
          echo "üîß Installing prerequisites: ca-certificates, curl, gnupg, lsb-release..."
          sudo apt-get update
          sudo apt-get install -y ca-certificates curl gnupg lsb-release

      - name: Adding Docker‚Äôs official GPG key
        run: |
          echo "üîë Adding Docker GPG key..."
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg \
            | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

      - name: Setting up Docker stable repository
        run: |
          echo "üì¶ Setting up Docker stable repository..."
          echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] \
            https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" \
            | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

      - name: Installing Docker Engine & CLI
        run: |
          echo "üöÄ Installing Docker Engine & CLI..."
          sudo apt-get update
          sudo apt-get install -y docker-ce docker-ce-cli containerd.io

  build-and-deploy:
    if: github.event_name != 'schedule'
    needs: setup-docker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure Dockerfile exists
        run: |
          echo "üìù Checking for Dockerfile..."
          if [ ! -f Dockerfile ]; then
            echo "üìã Dockerfile not found ‚Äî creating with echo commands..."
            echo "FROM python:3.10-slim" > Dockerfile
            echo "WORKDIR /app" >> Dockerfile
            echo "COPY . ." >> Dockerfile
            echo "RUN if [ -f requirements.txt ]; then pip install --no-cache-dir -r requirements.txt; fi" >> Dockerfile
            echo 'CMD ["python", "app.py"]' >> Dockerfile
            echo "‚úÖ Dockerfile created."
          else
            echo "‚úÖ Dockerfile already exists."
          fi

      - name: Build Docker image
        run: |
          echo "üî® Building Docker image: finance-transactions:latest..."
          docker build -t finance-transactions:latest .

      - name: Restart finance-transactions container
        run: |
          echo "‚ôªÔ∏è  Restarting finance-transactions container..."
          if docker ps -a --format '{{.Names}}' | grep -q '^finance-transactions$'; then
            echo "üõë Stopping and removing existing container..."
            docker rm -f finance-transactions
          fi
          echo "‚ñ∂Ô∏è  Launching new container with volume mount..."
          docker run -d \
            --name finance-transactions \
            -v finance-data:/data \
            finance-transactions:latest
          echo "‚úÖ Container is up."

  backup:
    if: github.event_name == 'schedule'
    needs: setup-docker
    runs-on: ubuntu-latest
    env:
      BACKUP_PASSPHRASE: ${{ secrets.BACKUP_PASSPHRASE }}
    steps:
      - name: Create raw backups (image, container, volume)
        run: |
          TIMESTAMP=$(date +'%Y%m%d%H%M')
          echo "üì¶ Creating raw backups with timestamp ${TIMESTAMP}..."
          echo "   ‚Ä¢ Saving image..."
          docker save finance-transactions:latest \
            | gzip > finance-transactions_${TIMESTAMP}.tar.gz
          echo "   ‚Ä¢ Exporting container filesystem..."
          docker export finance-transactions \
            | gzip > finance-transactions-container_${TIMESTAMP}.tar.gz
          echo "   ‚Ä¢ Archiving volume data..."
          docker run --rm \
            -v finance-data:/data \
            -v $PWD:/backup \
            ubuntu:latest \
            bash -c "cd /data && tar czf /backup/volume_${TIMESTAMP}.tar.gz ."
          echo "‚úÖ Raw backups created."

      - name: Encrypt all backups with GPG
        run: |
          echo "üîí Encrypting backups with GPG..."
          for F in *_${TIMESTAMP}.tar.gz; do
            echo "   ‚Ä¢ Encrypting $F..."
            gpg --batch --yes \
                --passphrase "$BACKUP_PASSPHRASE" \
                -c "$F"
            rm "$F"
          done
          echo "‚úÖ All backups encrypted."

      - name: Upload encrypted artifacts
        uses: actions/upload-artifact@v3
        with:
          name: docker-backup-${{ github.run_id }}
          path: '*.tar.gz.gpg'

      - name: Confirm upload complete
        run: |
          echo "‚òÅÔ∏è  Uploaded encrypted artifacts to GitHub."
