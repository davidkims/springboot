name: üê¨ MySQL Setup & Migration

on:
  workflow_dispatch:

jobs:
  mysql:
    runs-on: ubuntu-latest

    env:
      DB_NAME: example_db
      DB_USER: runner
      DB_PASS: runnerpass
      ROOT_PASS: rootpass123
      MIGRATION_DIR: /opt/mysql/migrations

    steps:
      - name: üìÅ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò ÎîîÎ†âÌÜ†Î¶¨ Î∞è SQL ÏÉùÏÑ±
        run: |
          sudo mkdir -p $MIGRATION_DIR
          echo "CREATE TABLE IF NOT EXISTS accounts (id INT AUTO_INCREMENT PRIMARY KEY, name VARCHAR(50), balance DECIMAL(12,2));" > $MIGRATION_DIR/migrate.sql
          echo "INSERT INTO accounts(name, balance) VALUES ('ÌôçÍ∏∏Îèô', 1000000);" >> $MIGRATION_DIR/migrate.sql
          sudo chmod -R 777 /opt/mysql

      - name: üß™ MySQL ÏÑ§Ïπò
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y mysql-server

      - name: üßº MySQL Ï¥àÍ∏∞Ìôî Î∞è root Ìå®Ïä§ÏõåÎìú ÏÑ§Ï†ï
        run: |
          sudo systemctl stop mysql
          sudo mkdir -p /var/run/mysqld
          sudo chown mysql:mysql /var/run/mysqld
          sudo mysqld_safe --skip-networking --skip-grant-tables &
          sleep 10

          echo "FLUSH PRIVILEGES;
          ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '${ROOT_PASS}';
          FLUSH PRIVILEGES;" | sudo mysql -u root

          sudo killall mysqld
          sleep 5
          sudo systemctl start mysql

      - name: üõ†Ô∏è DB Î∞è ÏÇ¨Ïö©Ïûê ÏÉùÏÑ±
        run: |
          mysql -u root -p$ROOT_PASS -e "CREATE DATABASE IF NOT EXISTS $DB_NAME;"
          mysql -u root -p$ROOT_PASS -e "CREATE USER IF NOT EXISTS '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASS';"
          mysql -u root -p$ROOT_PASS -e "GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'localhost';"
          mysql -u root -p$ROOT_PASS -e "FLUSH PRIVILEGES;"

      - name: üì• ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ïã§Ìñâ
        run: |
          mysql -u $DB_USER -p$DB_PASS $DB_NAME < $MIGRATION_DIR/migrate.sql

      - name: ‚úÖ Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
        run: |
          mysql -u $DB_USER -p$DB_PASS -e "USE $DB_NAME; SHOW TABLES; SELECT * FROM accounts;"
