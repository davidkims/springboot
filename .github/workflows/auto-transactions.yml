name: ğŸ’³ Auto Transaction Ledger Backup

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  auto-transactions:
    runs-on: ubuntu-latest
    env:
      PG_DB: finance
      PG_USER: postgres
      PG_PASS: pgpass
      MYSQL_ROOT_PASS: rootpass
      LEDGER_PATH: ledger
      SQL_DIR: sql
      TIMESTAMP: 20250603020857

    steps:
      - name: ğŸ“ ë””ë ‰í† ë¦¬ ìƒì„±
        run: |
          sudo mkdir -p $LEDGER_PATH $SQL_DIR
          sudo chmod -R 777 $LEDGER_PATH $SQL_DIR
          echo "CREATE TABLE IF NOT EXISTS transactions (
            id SERIAL PRIMARY KEY,
            type VARCHAR(20),
            amount NUMERIC,
            currency VARCHAR(10),
            status VARCHAR(20),
            timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );" > $SQL_DIR/init.sql

      - name: ğŸ˜ PostgreSQL ì„¤ì¹˜ ë° ì´ˆê¸°í™”
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql
          sudo systemctl start postgresql
          sudo -u postgres psql -c "ALTER USER postgres PASSWORD '$PG_PASS';"
          echo "127.0.0.1:5432:$PG_DB:$PG_USER:$PG_PASS" > ~/.pgpass
          chmod 600 ~/.pgpass

      - name: ğŸ˜ PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ ìƒì„± ë° í…Œì´ë¸” êµ¬ì¶•
        run: |
          sudo -u postgres createdb $PG_DB || echo "âœ… ì´ë¯¸ ì¡´ì¬"
          PGPASSFILE=$HOME/.pgpass psql -U $PG_USER -d $PG_DB -f $SQL_DIR/init.sql

      - name: ğŸ’³ ê°€ìƒ ìë™ì´ì²´ ê±°ë˜ ì…ë ¥
        run: |
          PGPASSFILE=$HOME/.pgpass psql -U $PG_USER -d $PG_DB -c "
            INSERT INTO transactions (type, amount, currency, status)
            VALUES
              ('credit_card', 150000, 'KRW', 'completed'),
              ('check_card', 35000, 'KRW', 'completed'),
              ('stock', 300000, 'KRW', 'completed'),
              ('forex', 1000, 'USD', 'completed');
          "

      - name: ğŸ“œ ê±°ë˜ ì›ì¥ ìƒì„±
        run: |
          PGPASSFILE=$HOME/.pgpass psql -U $PG_USER -d $PG_DB -c "\copy transactions TO '$LEDGER_PATH/ledger-${{ env.TIMESTAMP }}.csv' CSV HEADER"
          ls -lh $LEDGER_PATH

      - name: ğŸ“„ ì¶œë ¥ ë¡œê·¸ í™•ì¸
        run: |
          cat $LEDGER_PATH/ledger-${{ env.TIMESTAMP }}.csv
