name: 🧾 Docker 명함 이미지 생성 및 보안 디버깅

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-customer-cards:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      packages: read
      security-events: write

    steps:
    - name: 📥 코드 체크아웃
      uses: actions/checkout@v4

    - name: 📁 디렉토리 및 초기 환경 생성
      run: |
        sudo mkdir -p /data/cards /opt/bin /etc/workflows
        sudo chmod -R 777 /data /opt/bin /etc/workflows

    - name: 🐳 Dockerfile 및 Python 스크립트 다운로드
      run: |
        mkdir -p app
        curl -fsSL https://raw.githubusercontent.com/davidkims/assets/main/customer/Dockerfile -o Dockerfile || {
          echo "FROM python:3.10-slim" > Dockerfile
          echo "WORKDIR /app" >> Dockerfile
          echo "COPY . ." >> Dockerfile
          echo "RUN pip install pillow" >> Dockerfile
          echo "CMD [\"python\", \"generate_card.py\"]" >> Dockerfile
        }

        curl -fsSL https://raw.githubusercontent.com/davidkims/assets/main/customer/generate_card.py -o app/generate_card.py || {
          echo "from PIL import Image, ImageDraw, ImageFont" > app/generate_card.py
          echo "img = Image.new('RGB', (400, 200), color = (73, 109, 137))" >> app/generate_card.py
          echo "d = ImageDraw.Draw(img)" >> app/generate_card.py
          echo "d.text((10,10), '고객 거래 명함', fill=(255,255,0))" >> app/generate_card.py
          echo "img.save('/data/cards/customer_card.png')" >> app/generate_card.py
        }

    - name: 🛠️ Docker 이미지 빌드
      run: docker build -t customer-card-generator .

    - name: 🏃 Docker 컨테이너 실행
      run: |
        docker run --rm -v /data/cards:/data/cards customer-card-generator

    - name: 📷 결과 이미지 파일 확인
      run: |
        ls -l /data/cards
        file /data/cards/customer_card.png || echo "❌ 이미지 생성 실패"

    - name: 🔐 권한 문제 디버그 (.github/workflows 접근 등)
      run: |
        echo "🛡️ .github/workflows 디렉토리 권한 확인:"
        ls -ld .github .github/workflows || echo "❌ 접근 불가"

        echo "🔍 사용자 및 실행 정보:"
        whoami
        id

        echo "🔧 디버그용 권한 재설정 시도:"
        sudo chmod -R 755 .github || echo "⚠️ sudo 실패"

        echo "✅ 현재 상태:"
        stat .github || true
        stat .github/workflows || true

    - name: 📦 결과물 아티팩트 업로드
      uses: actions/upload-artifact@v4
      with:
        name: generated-customer-cards
        path: /data/cards
