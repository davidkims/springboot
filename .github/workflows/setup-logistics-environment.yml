name: Setup & Load Loans Ledger with Backup

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'  # Îß§Ïãú Ï†ïÍ∞Å ÏûêÎèô Ïã§Ìñâ

jobs:
  setup-and-load:
    runs-on: ubuntu-latest
    steps:

      - name: üìÅ Checkout Repo
        uses: actions/checkout@v4

      - name: üê≥ Setup Docker
        run: |
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          sudo systemctl start docker
          docker --version

      - name: üêò Run PostgreSQL Container
        run: |
          docker rm -f pg-loans || true
          docker run -d \
            --name pg-loans \
            -e POSTGRES_DB=loans \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres123 \
            -v pgdata:/var/lib/postgresql/data \
            -p 5433:5432 postgres:15
          echo "[‚úî] PostgreSQL Container Running"
          sleep 15

      - name: üîß Create loans DB Schema
        run: |
          INIT_SQL=$(mktemp)
          echo "CREATE TABLE IF NOT EXISTS loan_ledger (" > $INIT_SQL
          echo "  id SERIAL PRIMARY KEY," >> $INIT_SQL
          echo "  customer_id INT NOT NULL," >> $INIT_SQL
          echo "  loan_amount DECIMAL(10,2) NOT NULL," >> $INIT_SQL
          echo "  interest_rate DECIMAL(5,2)," >> $INIT_SQL
          echo "  issue_date DATE," >> $INIT_SQL
          echo "  due_date DATE," >> $INIT_SQL
          echo "  status VARCHAR(20)" >> $INIT_SQL
          echo ");" >> $INIT_SQL
          docker cp "$INIT_SQL" pg-loans:/tmp/schema.sql
          docker exec pg-loans psql -U postgres -d loans -f /tmp/schema.sql

      - name: üìÑ Create loans.csv
        run: |
          mkdir -p data
          echo "customer_id,loan_amount,interest_rate,issue_date,due_date,status" > data/loans.csv
          echo "1,10000,5.5,2024-01-01,2025-01-01,active" >> data/loans.csv
          echo "2,15000,4.2,2024-03-15,2025-03-15,active" >> data/loans.csv
          echo "3,5000,6.8,2024-05-01,2024-12-01,closed" >> data/loans.csv

      - name: üì• Load CSV to loan_ledger
        run: |
          docker cp data/loans.csv pg-loans:/tmp/loans.csv
          docker exec pg-loans bash -c "psql -U postgres -d loans -c \
            \"COPY loan_ledger(customer_id, loan_amount, interest_rate, issue_date, due_date, status) \
            FROM '/tmp/loans.csv' DELIMITER ',' CSV HEADER;\""
          echo "[‚úî] CSV Loaded"

      - name: üíæ Export SQL Backup
        run: |
          mkdir -p backup
          TIMESTAMP=$(date +'%Y%m%d%H%M')
          BACKUP_FILE=backup/loan_backup_$TIMESTAMP.sql
          docker exec pg-loans pg_dump -U postgres -d loans > $BACKUP_FILE
          echo "[‚úî] SQL Backup saved as $BACKUP_FILE"

      - name: üîÅ Restore Latest Backup on New Container (Optional Test)
        if: github.event_name == 'workflow_dispatch'
        run: |
          LATEST_BACKUP=$(ls backup/loan_backup_*.sql | sort | tail -n1)
          docker rm -f pg-restore || true
          docker run -d \
            --name pg-restore \
            -e POSTGRES_DB=loans \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres123 \
            -p 5434:5432 postgres:15
          sleep 10
          docker cp "$LATEST_BACKUP" pg-restore:/tmp/restore.sql
          docker exec pg-restore psql -U postgres -d loans -f /tmp/restore.sql
          echo "[‚úî] Restore completed from latest backup: $LATEST_BACKUP"
