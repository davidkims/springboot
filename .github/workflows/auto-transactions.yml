name: 🔐 Fix MySQL Root Password (2단계 방식)

on:
  workflow_dispatch:

jobs:
  mysql-fix:
    runs-on: ubuntu-latest

    env:
      MYSQL_ROOT_PASS: rootpass123

    steps:
      - name: 📦 Install MySQL
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-server

      - name: 🚫 Enable skip-grant-tables
        run: |
          echo '[mysqld]' | sudo tee /etc/mysql/mysql.conf.d/skip-auth.cnf
          echo 'skip-grant-tables' | sudo tee -a /etc/mysql/mysql.conf.d/skip-auth.cnf
          sudo systemctl restart mysql

      - name: 🛠️ Set password manually via system table
        run: |
          sudo mysql -e "
            UPDATE mysql.user
            SET authentication_string=PASSWORD('${MYSQL_ROOT_PASS}'), plugin='mysql_native_password'
            WHERE User='root' AND Host='localhost';
            FLUSH PRIVILEGES;
          "

      - name: 🔁 Disable skip-grant-tables
        run: |
          sudo rm /etc/mysql/mysql.conf.d/skip-auth.cnf
          sudo systemctl restart mysql

      - name: ✅ Verify login with password
        run: |
          mysql -u root -p${MYSQL_ROOT_PASS} -e "SELECT VERSION();"
