name: ğŸ³ Docker Image Build + GHCR Push + Kafka-style Logging

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"  # 5ë¶„ ê°„ê²© ìë™ ì‹¤í–‰

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: ghcr.io/${{ github.repository }}/finance-app
  IMAGE_TAG: latest
  BACKUP_VOLUME: finance_backup_vol
  BACKUP_DIR_IN_CONTAINER: /backup
  KAFKA_LOG: kafka.log

jobs:
  docker-build-and-backup:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Dockerfile ìƒì„±
        run: |
          echo 'FROM alpine:latest' > Dockerfile
          echo 'RUN mkdir -p /app && echo "FINANCE DATA" > /app/data.txt' >> Dockerfile
          echo 'CMD ["sleep", "3600"]' >> Dockerfile

      - name: ğŸ” Docker ë¡œê·¸ì¸ (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ
        run: |
          docker build -t $IMAGE_NAME:$IMAGE_TAG .

      - name: ğŸ“¤ Docker ì´ë¯¸ì§€ GHCRì— í‘¸ì‹œ
        run: |
          docker push $IMAGE_NAME:$IMAGE_TAG

      - name: ğŸ“¦ Docker ë³¼ë¥¨ ìƒì„±
        run: |
          docker volume create $BACKUP_VOLUME

      - name: ğŸš€ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        run: |
          docker run -d --rm \
            --name finance-container \
            -v $BACKUP_VOLUME:$BACKUP_DIR_IN_CONTAINER \
            $IMAGE_NAME:$IMAGE_TAG

      - name: ğŸ’¾ ë°±ì—… íŒŒì¼ ìƒì„± (íŒŒì¼ ë³µì‚¬)
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          docker exec finance-container sh -c "cp /app/data.txt $BACKUP_DIR_IN_CONTAINER/backup-$TIMESTAMP.txt"
          echo "ğŸ“ ë°±ì—… ìƒì„± ì‹œê°„: $TIMESTAMP" >> $KAFKA_LOG
          echo "$TIMESTAMP [backup] íŒŒì¼ ìƒì„± ì™„ë£Œ" >> $KAFKA_LOG

      - name: ğŸ“‚ ë³¼ë¥¨ ë‚´ ë°±ì—… í™•ì¸
        run: |
          docker run --rm \
            -v $BACKUP_VOLUME:$BACKUP_DIR_IN_CONTAINER \
            alpine ls -lh $BACKUP_DIR_IN_CONTAINER

      - name: ğŸ“„ Kafka-style ë¡œê·¸ ì¶œë ¥
        run: |
          cat $KAFKA_LOG || echo "âš ï¸ ë¡œê·¸ ì—†ìŒ"

      - name: ğŸ§¹ ì •ë¦¬ (ì»¨í…Œì´ë„ˆ ì¤‘ì§€)
        run: |
          docker stop finance-container || true
