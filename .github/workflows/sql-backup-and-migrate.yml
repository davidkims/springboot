name: ğŸ›¡ï¸ Secure SQL Backup and Migration

on:
  workflow_dispatch:

jobs:
  secure_sql_backup_and_migration:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: example_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DB_HOST: 127.0.0.1
      DB_PORT: 3306
      DB_NAME: example_db
      DB_USER: root
      DB_PASS: password
      BACKUP_DIR: /opt/backup/sql
      MIGRATION_FILE: ./migrations/migrate.sql

    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      - name: â³ Wait for MySQL Ready
        run: sleep 30

      - name: ğŸ” Generate ~/.my.cnf for Secure MySQL Login
        run: |
          echo "[client]" > ~/.my.cnf
          echo "user=${DB_USER}" >> ~/.my.cnf
          echo "password=${DB_PASS}" >> ~/.my.cnf
          echo "host=${DB_HOST}" >> ~/.my.cnf
          echo "port=${DB_PORT}" >> ~/.my.cnf
          chmod 600 ~/.my.cnf

      - name: ğŸ“ Create Backup Directory
        run: |
          sudo mkdir -p $BACKUP_DIR
          sudo chmod -R 777 $BACKUP_DIR

      - name: ğŸ’¾ Backup SQL Database (Secure Mode)
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_FILE="$BACKUP_DIR/backup-$TIMESTAMP.sql"
          echo "ğŸ” ë°±ì—… ì‹œì‘: $BACKUP_FILE"
          mysqldump $DB_NAME > $BACKUP_FILE || {
            echo "âŒ ë°±ì—… ì‹¤íŒ¨" >> backup-report.md
            exit 1
          }
          echo "âœ… ë°±ì—… ì™„ë£Œ: $BACKUP_FILE" >> backup-report.md
          ls -lh $BACKUP_DIR >> backup-report.md

      - name: ğŸ“„ Prepare Migration SQL If Missing
        run: |
          if [ ! -f "$MIGRATION_FILE" ]; then
            echo "âš ï¸ ë§ˆì´ê·¸ë ˆì´ì…˜ SQL ì—†ìŒ, ê¸°ë³¸ SQL ìƒì„± ì¤‘..."
            mkdir -p "$(dirname "$MIGRATION_FILE")"
            echo "CREATE TABLE IF NOT EXISTS test_table (" > "$MIGRATION_FILE"
            echo "  id INT PRIMARY KEY AUTO_INCREMENT," >> "$MIGRATION_FILE"
            echo "  name VARCHAR(100)" >> "$MIGRATION_FILE"
            echo ");" >> "$MIGRATION_FILE"
          fi
          cat "$MIGRATION_FILE"

      - name: ğŸ§ª Run DB Migration (Secure Mode)
        run: |
          echo "ğŸ” ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘: $MIGRATION_FILE"
          mysql $DB_NAME < "$MIGRATION_FILE" || {
            echo "âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨" >> migration-report.md
            exit 1
          }
          echo "âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ" >> migration-report.md

      - name: ğŸ“‹ Show Backup and Migration Logs
        run: |
          echo "ğŸ“„ ë°±ì—… ë¡œê·¸:"
          cat backup-report.md || echo "No backup-report.md"
          echo "ğŸ“„ ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡œê·¸:"
          cat migration-report.md || echo "No migration-report.md"
