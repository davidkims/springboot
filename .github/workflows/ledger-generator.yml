name: ğŸ§¾ ê±°ë˜ ì‹œë®¬ë ˆì´ì…˜ Docker ìë™í™”

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  generate-transactions:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‚ 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“ 2. ë””ë ‰í† ë¦¬ ë° echo ê¸°ë°˜ íŒŒì¼ ìƒì„±
        run: |
          echo "ğŸ“ app ë””ë ‰í† ë¦¬ ìƒì„±"
          mkdir -p app output

          echo "ğŸ“„ ledger.py ìƒì„± ì¤‘..."
          echo 'import csv' > app/ledger.py
          echo 'import datetime' >> app/ledger.py
          echo 'import random' >> app/ledger.py
          echo '' >> app/ledger.py
          echo 'def generate_transaction(transaction_type):' >> app/ledger.py
          echo '    company = random.choice(["ì¤‘ì†Œê¸°ì—…", "ëŒ€ê¸°ì—…"])' >> app/ledger.py
          echo '    amount = round(random.uniform(10.0, 10000.0), 2)' >> app/ledger.py
          echo '    currency = random.choice(["KRW", "USD", "JPY", "EUR"])' >> app/ledger.py
          echo '    status = random.choice(["ìŠ¹ì¸", "ê±°ì ˆ", "ë³´ë¥˜"])' >> app/ledger.py
          echo '    time = datetime.datetime.now().isoformat()' >> app/ledger.py
          echo '    description = f"{company} {transaction_type} ê±°ë˜"' >> app/ledger.py
          echo '    return {"ì‹œê°„": time, "ìœ í˜•": transaction_type, "ê¸°ì—…êµ¬ë¶„": company, "ê¸ˆì•¡": amount, "í†µí™”": currency, "ìƒíƒœ": status, "ì„¤ëª…": description}' >> app/ledger.py
          echo '' >> app/ledger.py
          echo 'def generate_all_transactions():' >> app/ledger.py
          echo '    transactions = []' >> app/ledger.py
          echo '    for _ in range(50):' >> app/ledger.py
          echo '        transactions.append(generate_transaction("ì‹ ìš©ì¹´ë“œ"))' >> app/ledger.py
          echo '        transactions.append(generate_transaction("ì²´í¬ì¹´ë“œ"))' >> app/ledger.py
          echo '        transactions.append(generate_transaction("FX"))' >> app/ledger.py
          echo '    with open("transactions.csv", mode="w", newline="", encoding="utf-8") as f:' >> app/ledger.py
          echo '        writer = csv.DictWriter(f, fieldnames=transactions[0].keys())' >> app/ledger.py
          echo '        writer.writeheader()' >> app/ledger.py
          echo '        writer.writerows(transactions)' >> app/ledger.py
          echo '    print("âœ… ê±°ë˜ ë°ì´í„°ê°€ transactions.csvì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")' >> app/ledger.py
          echo '' >> app/ledger.py
          echo 'if __name__ == "__main__":' >> app/ledger.py
          echo '    generate_all_transactions()' >> app/ledger.py

          echo "ğŸ“„ Dockerfile ìƒì„± ì¤‘..."
          echo 'FROM python:3.10-slim' > app/Dockerfile
          echo 'WORKDIR /app' >> app/Dockerfile
          echo 'COPY ledger.py .' >> app/Dockerfile
          echo 'RUN pip install --no-cache-dir --upgrade pip' >> app/Dockerfile
          echo 'CMD ["python", "ledger.py"]' >> app/Dockerfile

          echo "ğŸ“„ README.md ìƒì„± ì¤‘..."
          echo "# ê±°ë˜ ì‹œë®¬ë ˆì´ì…˜ ì•±" > app/README.md
          echo "ì‹ ìš©ì¹´ë“œ, ì²´í¬ì¹´ë“œ, FX ê±°ë˜ ë°ì´í„°ë¥¼ ìƒì„±í•˜ëŠ” Python ì•±ì…ë‹ˆë‹¤." >> app/README.md

      - name: ğŸ› ï¸ 3. Docker ì´ë¯¸ì§€ ë¹Œë“œ
        run: |
          echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘"
          docker build -t virtual-ledger ./app
          echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"

      - name: ğŸš€ 4. Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (output ë³¼ë¥¨ ì—°ë™)
        run: |
          echo "ğŸš€ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹œì‘"
          docker run --rm -v ${{ github.workspace }}/output:/app virtual-ledger
          echo "âœ… ê±°ë˜ CSV íŒŒì¼ output/transactions.csv ë¡œ ì €ì¥ ì™„ë£Œ"

      - name: ğŸ“¤ 5. ê±°ë˜ CSV ì—…ë¡œë“œ (ì•„í‹°íŒ©íŠ¸)
        uses: actions/upload-artifact@v4
        with:
          name: ê±°ë˜ë°ì´í„°
          path: output/transactions.csv
