name: ğŸ¬ MySQL Backup via Docker Container

on:
  workflow_dispatch:

jobs:
  mysql_backup:
    runs-on: ubuntu-latest

    env:
      MYSQL_CONTAINER_NAME: backup-mysql
      MYSQL_IMAGE: mysql:8.0
      DB_NAME: example_db
      DB_USER: root
      DB_PASS: password
      DB_PORT: 3307
      BACKUP_DIR: /opt/backup/sql

    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ³ Run MySQL Backup Container
        run: |
          docker run -d \
            --name $MYSQL_CONTAINER_NAME \
            -e MYSQL_ROOT_PASSWORD=$DB_PASS \
            -e MYSQL_DATABASE=$DB_NAME \
            -p $DB_PORT:3306 \
            $MYSQL_IMAGE

          echo "â³ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘..."
          sleep 30

      - name: ğŸ› ï¸ Create MySQL config file (.my.cnf)
        run: |
          echo "[client]" > ~/.my.cnf
          echo "user=$DB_USER" >> ~/.my.cnf
          echo "password=$DB_PASS" >> ~/.my.cnf
          echo "host=127.0.0.1" >> ~/.my.cnf
          echo "port=$DB_PORT" >> ~/.my.cnf
          chmod 600 ~/.my.cnf

      - name: ğŸ“ Create Backup Directory
        run: |
          sudo mkdir -p $BACKUP_DIR
          sudo chmod -R 777 $BACKUP_DIR

      - name: ğŸ’¾ Perform mysqldump Backup
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_FILE="$BACKUP_DIR/backup-$TIMESTAMP.sql"
          echo "ğŸ” ë°±ì—… ì‹œì‘: $BACKUP_FILE"

          mysqldump $DB_NAME > $BACKUP_FILE || {
            echo "âŒ ë°±ì—… ì‹¤íŒ¨"
            exit 1
          }

          echo "âœ… ë°±ì—… ì™„ë£Œ: $BACKUP_FILE"
          ls -lh $BACKUP_DIR

      - name: ğŸ§¹ Clean Up Docker Container
        run: |
          echo "ğŸ§¼ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
          docker rm -f $MYSQL_CONTAINER_NAME || true
