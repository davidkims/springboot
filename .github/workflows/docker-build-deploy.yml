name: Build & Deploy finance-transactions

on:
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 🛒 Checkout 코드
        uses: actions/checkout@v4

      - name: 📄 Dockerfile 생성 (echo 기반)
        run: |
          echo "[build-and-deploy] Dockerfile 생성 시작..."
          echo "echo 'FROM python:3.11-slim'" > Dockerfile
          echo "echo 'WORKDIR /app'" >> Dockerfile
          echo "echo 'COPY . .'" >> Dockerfile
          echo "echo 'RUN pip install --no-cache-dir -r requirements.txt'" >> Dockerfile
          echo "echo 'CMD [\"python\", \"app.py\"]'" >> Dockerfile
          
          echo "FROM python:3.11-slim" > Dockerfile
          echo "WORKDIR /app" >> Dockerfile
          echo "COPY . ." >> Dockerfile
          echo "RUN pip install --no-cache-dir -r requirements.txt" >> Dockerfile
          echo "CMD [\"python\", \"app.py\"]" >> Dockerfile

          echo "[build-and-deploy] Dockerfile 생성 완료 ✅"
          echo "---------------- Dockerfile 내용 ----------------"
          cat Dockerfile
          echo "------------------------------------------------"

      - name: 🐳 Docker 설치
        run: |
          echo "[build-and-deploy] Docker 설치 스크립트 다운로드 중..."
          curl -fsSL https://get.docker.com -o get-docker.sh
          echo "[build-and-deploy] Docker 설치 중..."
          sudo sh get-docker.sh
          sudo systemctl start docker || sudo service docker start
          echo "[build-and-deploy] Docker 버전 확인:"
          docker --version

      - name: 🏗️ Docker 이미지 빌드
        run: |
          echo "[build-and-deploy] Docker 이미지 빌드 시작..."
          docker build -t finance-transactions:latest .
          echo "[build-and-deploy] Docker 이미지 빌드 완료 ✅"

      - name: 🚀 컨테이너 실행
        run: |
          echo "[build-and-deploy] 기존 컨테이너 중지 및 제거 시도..."
          docker rm -f finance-transactions || echo "⚠️ 이전 컨테이너 없음 또는 이미 종료됨"

          echo "[build-and-deploy] 새 컨테이너 실행 중..."
          docker run -d \
            --name finance-transactions \
            -v finance-data:/data \
            finance-transactions:latest
          echo "[build-and-deploy] 컨테이너 실행 완료 ✅"

      - name: 🔧 전체 초기화 스크립트 실행
        run: |
          echo "[build-and-deploy] ./scripts/full_setup.sh 실행 중..."
          chmod +x ./scripts/full_setup.sh || echo "⚠️ 실행 권한 부여 실패 또는 파일 없음"
          ./scripts/full_setup.sh || echo "⚠️ full_setup.sh 실행 실패 또는 파일 없음"

      - name: 🧹 정리 작업 (Always)
        if: always()
        run: |
          echo "[build-and-deploy] 컨테이너 정리 중..."
          docker rm -f finance-transactions || true
          docker volume prune -f || true
