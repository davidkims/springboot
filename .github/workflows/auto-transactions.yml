name: 💳 Fix MySQL Access Denied & Auto Ledger Creation

on:
  workflow_dispatch:

jobs:
  mysql-fix:
    runs-on: ubuntu-latest

    env:
      MYSQL_ROOT_PASS: rootpass123
      DB_NAME: ledger_db

    steps:
      - name: 📦 MySQL 설치
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-server

      - name: 🚀 MySQL 시작
        run: |
          sudo systemctl start mysql
          sudo systemctl enable mysql

      - name: 🔐 root 인증 방식을 password로 변경
        run: |
          sudo mysql -e "
            ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '${MYSQL_ROOT_PASS}';
            FLUSH PRIVILEGES;
          "

      - name: 🧱 Ledger DB 및 거래 테이블 생성
        run: |
          mysql -u root -p${MYSQL_ROOT_PASS} -e "
            CREATE DATABASE IF NOT EXISTS ${DB_NAME};
            USE ${DB_NAME};
            CREATE TABLE IF NOT EXISTS ledger (
              id INT AUTO_INCREMENT PRIMARY KEY,
              transaction_type VARCHAR(30),
              amount DECIMAL(12,2),
              currency VARCHAR(10),
              status VARCHAR(20),
              detail TEXT,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
            INSERT INTO ledger(transaction_type, amount, currency, status, detail) VALUES
              ('credit_card', 150000, 'KRW', 'completed', '신용카드 결제'),
              ('check_card', 50000, 'KRW', 'completed', '체크카드 결제'),
              ('stock', 2000000, 'KRW', 'executed', '주식 매수'),
              ('forex', 2500, 'USD', 'completed', '환전 완료'),
              ('bank_transfer', 100000, 'KRW', 'completed', '이체 완료');
          "

      - name: 📋 거래 원장 확인
        run: |
          mysql -u root -p${MYSQL_ROOT_PASS} -e "USE ${DB_NAME}; SELECT * FROM ledger;"
