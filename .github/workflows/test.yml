name: ğŸ³ Docker Build & Run with Echo

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  docker-job:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‚ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“ ë””ë ‰í† ë¦¬ ìƒì„±
        run: |
          echo "ğŸ“ ë””ë ‰í† ë¦¬ ìƒì„± ì¤‘..."
          mkdir -p app

      - name: ğŸ“„ Dockerfile ìƒì„± (echo ë°©ì‹)
        run: |
          echo "ğŸ“„ echo ëª…ë ¹ì–´ë¡œ Dockerfile ìƒì„± ì¤‘..."
          echo 'FROM python:3.10-slim' > app/Dockerfile
          echo 'WORKDIR /app' >> app/Dockerfile
          echo 'COPY ledger.py .' >> app/Dockerfile
          echo 'CMD ["python", "ledger.py"]' >> app/Dockerfile
          echo "âœ… Dockerfile ìƒì„± ì™„ë£Œ"

      - name: ğŸ ledger.py ìƒì„±
        run: |
          echo "ğŸ“„ ledger.py ìƒì„± ì¤‘..."
          echo 'import datetime' > app/ledger.py
          echo 'print("ğŸ“˜ Ledger created at", datetime.datetime.now())' >> app/ledger.py
          echo "âœ… ledger.py ìƒì„± ì™„ë£Œ"

      - name: ğŸ“˜ README.md ìƒì„±
        run: |
          echo "# Dockerized Ledger App" > app/README.md
          echo "This app logs a timestamp when run inside Docker." >> app/README.md
          echo "âœ… README.md ìƒì„± ì™„ë£Œ"

      - name: ğŸ› ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ
        run: |
          echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
          docker build -t ledger-app ./app
          echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"

      - name: ğŸš€ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸš€ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
          output=$(docker run --rm ledger-app)
          echo "$output"
          echo "$output" | grep -q "Ledger created at"
          echo "âœ… ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì™„ë£Œ"

      - name: ğŸ§¹ Docker ì •ë¦¬
        run: |
          echo "ğŸ§¹ Docker ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
          docker rmi ledger-app || echo "â—ì´ë¯¸ì§€ ì‚­ì œ ì‹¤íŒ¨ - ë¬´ì‹œë¨"
          echo "âœ… Docker ì´ë¯¸ì§€ ì •ë¦¬ ì™„ë£Œ"
