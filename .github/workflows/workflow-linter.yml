name: π” κ³ κ° κ±°λ μ›ν¬ν”λ΅μ° μλ™ μ•”νΈν™”

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

jobs:
  detect-and-encrypt:
    runs-on: ubuntu-latest
    env:
      ENCRYPTION_KEY: ${{ secrets.CUSTOMER_AES_KEY }}

    steps:
      - name: π“¥ Checkout repository
        uses: actions/checkout@v4

      - name: π“ .github/workflows λ‚΄ μ „μ²΄ νμΌ κ²€μƒ‰
        id: find_files
        run: |
          mkdir -p .encrypted
          find .github/workflows -type f \( -iname '*.yml' -o -iname '*.yaml' \) > workflow_list.txt

      - name: π” κ³ κ° κ±°λ ν¬ν•¨λ νμΌ νƒμƒ‰ λ° μ•”νΈν™”
        run: |
          echo "π” 'κ³ κ° κ±°λ' ν‚¤μ›λ“ ν¬ν•¨ νμΌ μ•”νΈν™” μ‹μ‘"
          while IFS= read -r file; do
            if grep -q 'κ³ κ° κ±°λ' "$file"; then
              echo "π” μ•”νΈν™” λ€μƒ: $file"
              encrypted_file=".encrypted/$(basename "$file").enc"
              openssl enc -aes-256-cbc -pbkdf2 -salt -in "$file" -out "$encrypted_file" -pass pass:"$ENCRYPTION_KEY"
              echo "β… μ•”νΈν™” μ™„λ£ β†’ $encrypted_file"
            else
              echo "β­οΈ ν‚¤μ›λ“ μ—†μ: $file"
            fi
          done < workflow_list.txt

      - name: π“¦ μ•”νΈν™” ZIP μ•„μΉ΄μ΄λΈ μƒμ„±
        run: |
          zip -r customer-encrypted.zip .encrypted
          echo "β… ZIP μƒμ„± μ™„λ£"

      - name: π“¤ μ•”νΈν™”λ ZIP νμΌ μ—…λ΅λ“
        uses: actions/upload-artifact@v4
        with:
          name: customer-encrypted-workflows
          path: customer-encrypted.zip
