name: 💳 기업 카드 거래 백업 및 GitHub Release

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  finance-backup:
    runs-on: ubuntu-latest

    steps:
      - name: 📁 저장소 체크아웃
        uses: actions/checkout@v4

      - name: 🧰 Swift CLI 설치
        run: |
          sudo apt-get update
          sudo apt-get install -y clang libicu-dev libpython3-dev
          curl -fsSL https://download.swift.org/swift-5.9-release/ubuntu2204/swift-5.9-RELEASE/swift-5.9-RELEASE-ubuntu22.04.tar.gz -o swift.tar.gz
          sudo mkdir -p /opt/swift
          sudo tar -xzf swift.tar.gz -C /opt/swift --strip-components=1
          echo "/opt/swift/usr/bin" >> $GITHUB_PATH
          swift --version

      - name: 🛠️ Swift 프로그램 생성 및 실행
        run: |
          mkdir -p swiftapp
          echo 'import Foundation' > swiftapp/main.swift
          echo 'let companies = ["삼성", "현대", "롯데"]' >> swiftapp/main.swift
          echo 'let cards = ["신용카드", "법인카드", "체크카드"]' >> swiftapp/main.swift
          echo 'var transactions: [[String: String]] = []' >> swiftapp/main.swift
          echo 'for company in companies {' >> swiftapp/main.swift
          echo '  for card in cards {' >> swiftapp/main.swift
          echo '    let entry = ["company": company, "card": card, "amount": "\(Int.random(in: 10000...1000000))", "timestamp": ISO8601DateFormatter().string(from: Date())]' >> swiftapp/main.swift
          echo '    transactions.append(entry)' >> swiftapp/main.swift
          echo '  }' >> swiftapp/main.swift
          echo '}' >> swiftapp/main.swift
          echo 'let jsonData = try! JSONSerialization.data(withJSONObject: transactions, options: .prettyPrinted)' >> swiftapp/main.swift
          echo 'let path = "/opt/backup/transactions.json"' >> swiftapp/main.swift
          echo 'FileManager.default.createFile(atPath: path, contents: jsonData)' >> swiftapp/main.swift
          /opt/swift/usr/bin/swiftc swiftapp/main.swift -o swiftapp/Program
          sudo mkdir -p /opt/backup
          sudo ./swiftapp/Program
          cat /opt/backup/transactions.json

      - name: 🗜️ 백업 파일 압축 (.zip)
        run: |
          mkdir -p release_assets
          zip -j release_assets/transactions_$(date +%Y%m%d%H%M).zip /opt/backup/transactions.json

      - name: 📦 GitHub Release 업로드
        uses: softprops/action-gh-release@v2
        with:
          tag_name: finance-backup-${{ github.run_number }}
          name: 기업카드 백업 자동 릴리스 ${{ github.run_number }}
          files: |
            release_assets/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
