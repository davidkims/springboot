name: Generate and Backup Corporate Banking Data with Secure ZIP and Conditional OCI Upload

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  generate-and-backup:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¥ Install Required Python Packages
        run: |
          pip install pyyaml faker pillow

      - name: ğŸ“„ Generate YAML Configuration
        run: |
          mkdir -p config
          echo "# YAML configuration moved into separate file manually." > config/banking_schema.yaml
          echo "# Place the full YAML content into 'config/banking_schema.yaml'" >> config/banking_schema.yaml

      - name: ğŸ§ª Validate YAML File via echo-generated script
        run: |
          mkdir -p scripts
          echo "import yaml" > scripts/validate_yaml.py
          echo "with open('config/banking_schema.yaml') as f:" >> scripts/validate_yaml.py
          echo "    data = yaml.safe_load(f)" >> scripts/validate_yaml.py
          echo "print('âœ… YAML Validation Passed')" >> scripts/validate_yaml.py
          python scripts/validate_yaml.py

      - name: ğŸ“¦ Simulate Data Extraction
        run: |
          mkdir -p output
          echo "INFO: ë°ì´í„° ì¶”ì¶œ ì‹œì‘"
          touch output/corporate_banking_backup.sql
          echo '-- SQL Dump Placeholder' > output/corporate_banking_backup.sql
          echo "INFO: ë°ì´í„° ì¶”ì¶œ ì™„ë£Œ: output/corporate_banking_backup.sql"

      - name: ğŸ” Generate or Use Backup Password & Encrypt Backup File
        id: encrypt
        run: |
          # GitHub Secret ì— BACKUP_PASSWORDê°€ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ì‚¬ìš©, ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ëœë¤ ìƒì„±
          if [ -n "${{ secrets.BACKUP_PASSWORD }}" ]; then
            BACKUP_PASSWORD="${{ secrets.BACKUP_PASSWORD }}"
            echo "ğŸ”’ ì‚¬ìš© ì¤‘ì¸ BACKUP_PASSWORD: (secretì— ì •ì˜ëœ ê°’)"
          else
            BACKUP_PASSWORD=$(head -c 256 /dev/urandom | tr -dc 'A-Za-z0-9' | head -c 16)
            echo "ğŸ”‘ ìƒˆë¡œ ìƒì„±ëœ BACKUP_PASSWORD: ${BACKUP_PASSWORD}"
          fi

          zip -j -P "$BACKUP_PASSWORD" output/corporate_banking_backup.zip output/corporate_banking_backup.sql
          echo "âœ… ë°±ì—… íŒŒì¼ ì•”í˜¸í™”/ì••ì¶• ì™„ë£Œ: output/corporate_banking_backup.zip"
          echo "::set-output name=password::$BACKUP_PASSWORD"

      - name: ğŸ–¼ï¸ Generate Credit & Debit Card Transaction Images via echo-generated script
        run: |
          mkdir -p scripts

          echo "from PIL import Image, ImageDraw" > scripts/gen_images.py
          echo "import os" >> scripts/gen_images.py
          echo "cc_dir = 'output/credit_card_images'" >> scripts/gen_images.py
          echo "dc_dir = 'output/debit_card_images'" >> scripts/gen_images.py
          echo "os.makedirs(cc_dir, exist_ok=True)" >> scripts/gen_images.py
          echo "os.makedirs(dc_dir, exist_ok=True)" >> scripts/gen_images.py

          echo "for i in range(1, 11):" >> scripts/gen_images.py
          echo "    img = Image.new('RGB', (300, 180), color=(30, 144, 255))" >> scripts/gen_images.py
          echo "    d = ImageDraw.Draw(img)" >> scripts/gen_images.py
          echo "    text = f\"Credit Card TXN #{i}\"" >> scripts/gen_images.py
          echo "    d.text((10, 80), text, fill=(255, 255, 255))" >> scripts/gen_images.py
          echo "    img.save(f'{cc_dir}/credit_txn_{i}.png')" >> scripts/gen_images.py

          echo "for i in range(1, 11):" >> scripts/gen_images.py
          echo "    img = Image.new('RGB', (300, 180), color=(34, 139, 34))" >> scripts/gen_images.py
          echo "    d = ImageDraw.Draw(img)" >> scripts/gen_images.py
          echo "    text = f\"Debit Card TXN #{i}\"" >> scripts/gen_images.py
          echo "    d.text((10, 80), text, fill=(255, 255, 255))" >> scripts/gen_images.py
          echo "    img.save(f'{dc_dir}/debit_txn_{i}.png')" >> scripts/gen_images.py

          echo "print('âœ… ì‹ ìš©ì¹´ë“œ ë° ì²´í¬ì¹´ë“œ ê±°ë˜ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ')" >> scripts/gen_images.py

          python scripts/gen_images.py

      - name: â˜ Install OCI CLI
        run: |
          curl -sL https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh | bash -s -- --accept-all-defaults --install-dir $HOME/oci-cli
          echo "$HOME/oci-cli/bin" >> $GITHUB_PATH
          echo "âœ… OCI CLI ì„¤ì¹˜ ì™„ë£Œ: $(oci --version)"

      - name: â˜ Configure & Upload to OCI Object Storage (Conditional)
        env:
          OCI_CLI_AUTH: "api_key"
          OCI_CLI_USER: ${{ secrets.OCI_USER_OCID }}
          OCI_CLI_TENANCY: ${{ secrets.OCI_TENANCY_OCID }}
          OCI_CLI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
          OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_API_KEY }}
          OCI_CLI_REGION: "ap-seoul-1"
        run: |
          # í•„ìˆ˜ OCID/í‚¤ ì •ë³´ê°€ ëª¨ë‘ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if [ -z "${OCI_CLI_USER}" ] || [ -z "${OCI_CLI_TENANCY}" ] || [ -z "${OCI_CLI_FINGERPRINT}" ] || [ -z "${OCI_CLI_KEY_CONTENT}" ]; then
            echo "âš ï¸ OCI ì—…ë¡œë“œì— í•„ìš”í•œ ì¸ì¦ ì •ë³´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ì—…ë¡œë“œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi

          # ë ˆì´ë¸” ê²½ê³  ì–µì œ
          export SUPPRESS_LABEL_WARNING=True

          # ~/.oci ë””ë ‰í† ë¦¬ ë° key íŒŒì¼ ìƒì„±
          mkdir -p ~/.oci
          echo "$OCI_CLI_KEY_CONTENT" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem

          # ~/.oci/config íŒŒì¼ ì‘ì„±
          echo "[DEFAULT]" > ~/.oci/config
          echo "user=${OCI_CLI_USER}" >> ~/.oci/config
          echo "fingerprint=${OCI_CLI_FINGERPRINT}" >> ~/.oci/config
          echo "key_file=~/.oci/oci_api_key.pem" >> ~/.oci/config
          echo "tenancy=${OCI_CLI_TENANCY}" >> ~/.oci/config
          echo "region=${OCI_CLI_REGION}" >> ~/.oci/config
          chmod 600 ~/.oci/config

          echo "âœ… OCI CLI êµ¬ì„± ì™„ë£Œ"

          # ë°±ì—… ZIP ì—…ë¡œë“œ
          oci os object put \
            --bucket-name backups \
            --file output/corporate_banking_backup.zip \
            --name corporate_banking_backup.zip \
            --force \
            --region $OCI_CLI_REGION

          # ì‹ ìš©ì¹´ë“œ ì´ë¯¸ì§€ ì—…ë¡œë“œ
          for img in output/credit_card_images/*.png; do
            filename=$(basename "$img")
            oci os object put \
              --bucket-name backups \
              --file "$img" \
              --name "credit_card_images/$filename" \
              --force \
              --region $OCI_CLI_REGION
          done

          # ì²´í¬ì¹´ë“œ ì´ë¯¸ì§€ ì—…ë¡œë“œ
          for img in output/debit_card_images/*.png; do
            filename=$(basename "$img")
            oci os object put \
              --bucket-name backups \
              --file "$img" \
              --name "debit_card_images/$filename" \
              --force \
              --region $OCI_CLI_REGION
          done

          echo "âœ… ë°±ì—… íŒŒì¼(.zip) ë° ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ"

      - name: â˜‘ï¸ NetBackup CLI ì‹¤í–‰ (ì˜ˆì‹œ)
        run: |
          echo "ğŸ”„ NetBackup CLI ê°€ì • ì‹¤í–‰ ì¤‘..."
          echo "bpbackup -f output/corporate_banking_backup.zip"
          echo "bpbackup -d output/credit_card_images"
          echo "bpbackup -d output/debit_card_images"
          echo "âš ï¸ ì‹¤ì œ NetBackup ì„¤ì¹˜ í•„ìš” ë° CLI ê²½ë¡œ í™•ì¸ í•„ìš”"

      - name: âœ… ì™„ë£Œ ë©”ì‹œì§€
        run: echo "âœ… ê¸°ì—… ê¸ˆìœµ ë°ì´í„° ë°±ì—…, ì•”í˜¸í™”, ì´ë¯¸ì§€ ìƒì„±, ì—…ë¡œë“œê¹Œì§€ ëª¨ë‘ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
