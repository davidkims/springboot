name: ğŸ¬ MySQL Full Setup and Migration

on:
  workflow_dispatch:

jobs:
  mysql_setup:
    runs-on: ubuntu-latest

    env:
      DB_NAME: example_db
      DB_USER: runner
      DB_PASS: runnerpass
      MIGRATION_DIR: /opt/mysql/migrations
      DATA_DIR: /opt/mysql/data

    steps:
      - name: ğŸ“ ë””ë ‰í† ë¦¬ ë° ë””ìŠ¤í¬/íŒŒì¼ ì¤€ë¹„
        run: |
          sudo mkdir -p $DATA_DIR
          sudo mkdir -p $MIGRATION_DIR
          echo "CREATE TABLE IF NOT EXISTS accounts (id INT AUTO_INCREMENT PRIMARY KEY, name VARCHAR(50), balance DECIMAL(12,2)); INSERT INTO accounts(name, balance) VALUES ('í™ê¸¸ë™', 1000000);" > $MIGRATION_DIR/migrate.sql
          sudo chmod -R 777 /opt/mysql

      - name: ğŸ§ª MySQL ìµœì‹  ë²„ì „ ì„¤ì¹˜
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y mysql-server
          sudo systemctl start mysql
          sudo systemctl enable mysql

      - name: ğŸ” MySQL ì‚¬ìš©ì ë° DB ìƒì„± + ê¶Œí•œ ë¶€ì—¬
        run: |
          sudo mysql -e "CREATE DATABASE IF NOT EXISTS $DB_NAME;"
          sudo mysql -e "CREATE USER IF NOT EXISTS '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASS';"
          sudo mysql -e "GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'localhost';"
          sudo mysql -e "FLUSH PRIVILEGES;"

      - name: ğŸ› ï¸ DB ë§ˆì´ê·¸ë ˆì´ì…˜ ë° ì´ˆê¸°í™”
        run: |
          sudo mysql -u$DB_USER -p$DB_PASS $DB_NAME < $MIGRATION_DIR/migrate.sql

      - name: âœ… ê²°ê³¼ í™•ì¸ (í…Œì´ë¸”, ë°ì´í„°)
        run: |
          sudo mysql -u$DB_USER -p$DB_PASS -e "USE $DB_NAME; SHOW TABLES; SELECT * FROM accounts;"
