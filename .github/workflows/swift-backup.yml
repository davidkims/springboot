name: ğŸ’³ ê¸ˆìœµ ê±°ë˜ + ì‹œë§Œí… ë„·ë°±ì—… + Oracle CLI ë°±ì—…

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  finance-netbackup:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ§° Swift CLI ì„¤ì¹˜
        run: |
          sudo apt-get update
          sudo apt-get install -y clang libicu-dev libpython3-dev
          curl -fsSL https://download.swift.org/swift-5.9-release/ubuntu2204/swift-5.9-RELEASE/swift-5.9-RELEASE-ubuntu22.04.tar.gz -o swift.tar.gz
          sudo mkdir -p /opt/swift
          sudo tar -xzf swift.tar.gz -C /opt/swift --strip-components=1
          echo "/opt/swift/usr/bin" >> $GITHUB_PATH
          swift --version

      - name: ğŸ› ï¸ Swift ê±°ë˜ ë°±ì—… ìƒì„±
        run: |
          mkdir -p swiftapp
          echo 'import Foundation' > swiftapp/main.swift
          echo 'let companies = ["ì‚¼ì„±", "í˜„ëŒ€", "ë¡¯ë°"]' >> swiftapp/main.swift
          echo 'let cards = ["ì‹ ìš©ì¹´ë“œ", "ë²•ì¸ì¹´ë“œ", "ì²´í¬ì¹´ë“œ"]' >> swiftapp/main.swift
          echo 'var transactions: [[String: String]] = []' >> swiftapp/main.swift
          echo 'for company in companies {' >> swiftapp/main.swift
          echo '  for card in cards {' >> swiftapp/main.swift
          echo '    let entry = ["company": company, "card": card, "amount": "\(Int.random(in: 10000...1000000))", "timestamp": ISO8601DateFormatter().string(from: Date())]' >> swiftapp/main.swift
          echo '    transactions.append(entry)' >> swiftapp/main.swift
          echo '  }' >> swiftapp/main.swift
          echo '}' >> swiftapp/main.swift
          echo 'let jsonData = try! JSONSerialization.data(withJSONObject: transactions, options: .prettyPrinted)' >> swiftapp/main.swift
          echo 'let path = "/opt/backup/transactions.json"' >> swiftapp/main.swift
          echo 'FileManager.default.createFile(atPath: path, contents: jsonData)' >> swiftapp/main.swift
          /opt/swift/usr/bin/swiftc swiftapp/main.swift -o swiftapp/Program
          sudo mkdir -p /opt/backup
          sudo ./swiftapp/Program

      - name: ğŸ—œï¸ ê±°ë˜ ë‚´ì—­ ZIP ì••ì¶•
        run: |
          mkdir -p output
          zip -j output/transactions_$(date +%Y%m%d%H%M).zip /opt/backup/transactions.json
          echo "ğŸ“¦ ì••ì¶• ì™„ë£Œ: output/*.zip"

      - name: â˜ï¸ Oracle OCI CLI ì„¤ì¹˜
        run: |
          curl -sL https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh | bash -s -- --accept-all-defaults
          echo "$HOME/bin" >> $GITHUB_PATH
          oci --version || echo "âœ… OCI CLI ì„¤ì¹˜ë¨"

      - name: ğŸ§± NetBackup ë””ë ‰í† ë¦¬ ë° ì‹œë®¬ë ˆì´ì…˜
        run: |
          echo "ğŸ“¦ NetBackup ë””ë ‰í† ë¦¬ êµ¬ì„±"
          mkdir -p /opt/netbackup/logs /opt/netbackup/data /opt/netbackup/scripts
          cp /opt/backup/transactions.json /opt/netbackup/data/

          echo "ğŸ”§ NetBackup ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ ì‹œë®¬ë ˆì´ì…˜ ìƒì„±"
          cat << 'EOF' > /opt/netbackup/scripts/run_backup.sh
          chmod +x /opt/netbackup/scripts/run_backup.sh
          /opt/netbackup/scripts/run_backup.sh

      - name: ğŸ“Š ë°±ì—… ë¡œê·¸ ì¶œë ¥
        run: |
          echo "# ë°±ì—… ìµœì¢… ë³´ê³ ì„œ" > netbackup-report.md
          echo "- ì‹¤í–‰ ì‹œê°„: $(date)" >> netbackup-report.md
          echo "- ê±°ë˜ ë°±ì—… íŒŒì¼: /opt/backup/transactions.json" >> netbackup-report.md
          echo "- NetBackup ë°ì´í„° ê²½ë¡œ: /opt/netbackup/data" >> netbackup-report.md
          echo "- ZIP íŒŒì¼: output/*.zip" >> netbackup-report.md
          cat netbackup-report.md
