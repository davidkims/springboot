name: ğŸ§¾ Docker ëª…í•¨ ì´ë¯¸ì§€ ìƒì„± ë° ë³´ì•ˆ ë””ë²„ê¹… (echo ê¸°ë°˜)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-customer-cards:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      packages: read
      security-events: write

    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ğŸ“ ë””ë ‰í† ë¦¬ ìƒì„±
      run: |
        mkdir -p cards

    - name: ğŸ³ generate_card.py ë° Dockerfile ìƒì„± (echo ê¸°ë°˜)
      run: |
        echo "from PIL import Image, ImageDraw" > generate_card.py
        echo "img = Image.new('RGB', (400, 200), color=(73, 109, 137))" >> generate_card.py
        echo "d = ImageDraw.Draw(img)" >> generate_card.py
        echo "d.text((10,10), 'ê³ ê° ê±°ë˜ ëª…í•¨', fill=(255,255,0))" >> generate_card.py
        echo "img.save('/data/cards/customer_card.png')" >> generate_card.py

        echo "FROM python:3.10-slim" > Dockerfile
        echo "WORKDIR /app" >> Dockerfile
        echo "COPY generate_card.py /app/" >> Dockerfile
        echo "RUN pip install pillow" >> Dockerfile
        echo "CMD [\"python\", \"generate_card.py\"]" >> Dockerfile

    - name: ğŸ› ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ
      run: docker build -t customer-card-generator .

    - name: ğŸƒ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ë° ì´ë¯¸ì§€ ìƒì„±
      run: |
        docker run --rm -v $(pwd)/cards:/data/cards customer-card-generator

    - name: ğŸ“· ìƒì„±ëœ ëª…í•¨ ì´ë¯¸ì§€ í™•ì¸
      run: |
        ls -al cards
        file cards/customer_card.png || echo "âŒ ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨"

    - name: ğŸ” .github/workflows ê¶Œí•œ ë¬¸ì œ ë””ë²„ê·¸
      run: |
        echo "ğŸ›¡ï¸ .github/workflows ê¶Œí•œ ê²€ì‚¬"
        ls -ld .github .github/workflows || echo "âŒ ì ‘ê·¼ ì‹¤íŒ¨"
        stat .github/workflows || true
        sudo chmod -R 755 .github || true

    - name: ğŸ“¤ ìƒì„± ì´ë¯¸ì§€ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: customer-card-image
        path: cards/
