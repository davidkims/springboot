name: Generate Workflow Run Log

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # Daily at midnight UTC
  push:
    branches:
      - main # Or your default branch like 'master'
    paths:
      - '.github/workflows/**' # Trigger if any workflow file changes

jobs:
  generate_log:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Grant write permission to update the markdown file

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch workflow runs and generate log
        id: fetch_runs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Automatically provided token
        run: |
          #!/bin/bash

          REPO="${{ github.repository }}"
          LOG_FILE=".github/workflow_run_log.md"

          echo "# GitHub Workflow Run Log" > "$LOG_FILE"
          echo "" >> "$LOG_FILE"
          echo "This file is automatically generated by the \`Generate Workflow Run Log\` workflow." >> "$LOG_FILE"
          echo "" >> "$LOG_FILE"
          echo "| Workflow Name | Run ID | Status | Conclusion | Run Time (UTC) | Branch | Committer | Commit Message |" >> "$LOG_FILE"
          echo "|---|---|---|---|---|---|---|---|" >> "$LOG_FILE"

          # Use a higher per_page limit to fetch more runs, max is 100
          # We iterate through all workflows to get their runs.

          WORKFLOWS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO/actions/workflows" | jq -r '.workflows[] | .id')

          for WORKFLOW_ID in $WORKFLOWS; do
            WORKFLOW_NAME=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$REPO/actions/workflows/$WORKFLOW_ID" | jq -r '.name')

            # Fetch runs for the current workflow, sorted by created_at in descending order
            # Filter for completed, in_progress, or queued runs for a comprehensive log
            RUNS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$REPO/actions/workflows/$WORKFLOW_ID/runs?per_page=100&status=completed,in_progress,queued&event=push,workflow_dispatch,schedule,pull_request" | jq -r '.workflow_runs[] | "\(.name) \(.id) \(.status) \(.conclusion) \(.created_at) \(.head_branch) \(.head_commit.committer.name) \(.head_commit.message | gsub("[\r\n]"; " "))"') # Replace newlines in commit message

            if [ -z "$RUNS" ]; then
              continue # Skip if no runs found for this workflow
            fi

            while IFS= read -r RUN; do
              # Parse the run data
              # Note: awk tokenization might split names with spaces. 
              # A more robust parsing might involve sed or splitting by a delimiter if `jq` supported it directly.
              # For simplicity, we'll try to handle it here.
              RUN_ARRAY=($RUN)
              RUN_NAME="${RUN_ARRAY[0]}" # Assuming first word is name
              RUN_ID="${RUN_ARRAY[1]}"
              RUN_STATUS="${RUN_ARRAY[2]}"
              RUN_CONCLUSION="${RUN_ARRAY[3]}"
              RUN_CREATED_AT="${RUN_ARRAY[4]}"
              RUN_BRANCH="${RUN_ARRAY[5]}"
              RUN_COMMITTER="${RUN_ARRAY[6]}"
              
              # Reconstruct commit message (all remaining parts)
              RUN_COMMIT_MESSAGE=""
              for ((i=7; i<${#RUN_ARRAY[@]}; i++)); do
                  RUN_COMMIT_MESSAGE+="${RUN_ARRAY[i]} "
              done
              RUN_COMMIT_MESSAGE=$(echo "$RUN_COMMIT_MESSAGE" | sed 's/ $//') # Trim trailing space

              # Handle cases where conclusion might be null for in-progress or queued runs
              if [ "$RUN_CONCLUSION" == "null" ]; then
                RUN_CONCLUSION="N/A"
              fi

              # Add to markdown file
              echo "| $RUN_NAME | $RUN_ID | $RUN_STATUS | $RUN_CONCLUSION | $RUN_CREATED_AT | $RUN_BRANCH | $RUN_COMMITTER | $RUN_COMMIT_MESSAGE |" >> "$LOG_FILE"
            done <<< "$RUNS"
          done

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update workflow run log"
          file_pattern: ".github/workflow_run_log.md"
          commit_user_name: "GitHub Actions Bot"
          commit_user_email: "actions@github.com"
          commit_author: "GitHub Actions Bot <actions@github.com>"
          # --- Crucial addition to handle diverged branches ---
          pull_strategy: "rebase_merge" 
          # --- End of crucial addition ---
