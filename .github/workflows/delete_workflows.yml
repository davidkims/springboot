name: Auto YAML Workflow Fix & Re-run

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  auto_yaml_fix:
    name: "Auto-Fix YAML 워크플로우 파일 → 커밋 → 재실행"
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      ####################################################################
      # 1) 전체 히스토리 체크아웃
      ####################################################################
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      ####################################################################
      # 2) “auto-yaml-fix” 커밋인지 확인해서 중복 실행 방지
      ####################################################################
      - name: Check if this commit is auto-yaml-fix
        id: is_autofix
        run: |
          MSG="${{ github.event.head_commit.message }}"
          echo "HEAD commit message: $MSG"
          if [[ "$MSG" == *"chore(auto-yaml-fix)"* ]]; then
            echo "is_autofix=true" >> $GITHUB_OUTPUT
          else
            echo "is_autofix=false" >> $GITHUB_OUTPUT
          fi

      ####################################################################
      # 3) auto-yaml-fix 커밋이 아닌 경우 → 필요한 도구 설치
      ####################################################################
      - name: Install Node.js & YAML linter
        if: steps.is_autofix.outputs.is_autofix == 'false'
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install yamllint

          # Node.js 설치 (Prettier 실행용)
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs
          npm install -g prettier

      ####################################################################
      # 4) auto-yaml-fix 커밋이 아닌 경우 → Prettier로 YAML 포맷팅
      ####################################################################
      - name: Run Prettier on .github/workflows/*.yml
        if: steps.is_autofix.outputs.is_autofix == 'false'
        run: |
          set -eux
          echo "▶ Prettier로 YAML 워크플로우 파일 포맷팅 중..."
          prettier --write ".github/workflows/*.yml" || true

      ####################################################################
      # 5) 변경사항이 있으면 커밋 & 푸시 후 워크플로우 종료
      ####################################################################
      - name: Commit & push YAML fixes
        if: steps.is_autofix.outputs.is_autofix == 'false'
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit auto-YAML-fix
        if: steps.is_autofix.outputs.is_autofix == 'false' && steps.check_changes.outputs.no_changes == 'false'
        run: |
          echo "▶ YAML 워크플로우 파일 변경사항 감지됨 → 커밋 및 푸시"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .github/workflows/*.yml
          git commit -m "chore(auto-yaml-fix): format workflow YAML files"
          git push origin "HEAD:${{ github.ref_name }}"
          echo "✅ auto-yaml-fix 커밋 완료. 새 푸시로 워크플로우가 재실행됩니다."
          exit 0

      ####################################################################
      # 6) “auto-yaml-fix” 커밋이거나 변경사항 없는 경우 → yamllint 검사
      ####################################################################
      - name: Run yamllint on .github/workflows/*.yml
        run: |
          echo "=========================================="
          echo "▶ yamllint으로 YAML 워크플로우 파일 검사"
          echo "=========================================="
          yamllint -d "{extends: default, rules: {line-length: {max: 80}}}" .github/workflows/*.yml
