name: 🛠️ Maven SpringBoot Multi-Module Build & Export

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      M2_HOME: /opt/maven
      BUILD_DIR: build-artifacts
      EXPORT_DIR: /opt/export
      TIMESTAMP: "20250603015122"

    steps:
      - name: 📦 Checkout Code
        uses: actions/checkout@v4

      - name: ☕ Install Maven (최신)
        run: |
          sudo rm -rf /opt/maven
          MAVEN_VERSION=3.9.6
          wget https://downloads.apache.org/maven/maven-3/$MAVEN_VERSION/binaries/apache-maven-$MAVEN_VERSION-bin.tar.gz
          sudo tar xzf apache-maven-$MAVEN_VERSION-bin.tar.gz -C /opt
          sudo mv /opt/apache-maven-$MAVEN_VERSION /opt/maven
          echo "✅ Maven installed to /opt/maven"

      - name: 🔎 Detect and Build Modules
        run: |
          if [ -f "./pom.xml" ]; then
            echo "📁 루트에 pom.xml 있음 → 루트에서 빌드 수행"
            /opt/maven/bin/mvn clean install -B -DskipTests=false
          else
            for dir in */; do
              if [ -f "$dir/pom.xml" ]; then
                echo "📁 모듈 발견: $dir → 빌드 수행"
                cd $dir
                /opt/maven/bin/mvn clean install -B -DskipTests=false
                cd ..
              fi
            done
          fi

      - name: 📁 Create Export Directory
        run: |
          mkdir -p $EXPORT_DIR
          mkdir -p $BUILD_DIR

      - name: 📦 Export JARs from Target
        run: |
          find . -type f -name "*.jar" -path "*/target/*.jar" -exec cp {} $EXPORT_DIR/ \;
          cp -r $EXPORT_DIR/*.jar $BUILD_DIR/
          echo "📦 Exported JARs to $BUILD_DIR"

      - name: 🗜️ Compress All JARs
        run: |
          cd $BUILD_DIR
          tar -czf springboot-build-${TIMESTAMP}.tar.gz *.jar
          ls -lh springboot-build-${TIMESTAMP}.tar.gz
