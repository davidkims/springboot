name: Build & Deploy finance-transactions with DB Backup + Provenance + Restart + Preserve

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ—“ Checkout ì½”ë“œ
        uses: actions/checkout@v4

      - name: ğŸ“¦ requirements.txt ìƒì„± ë° í™•ì¸
        run: |
          echo "flask" > requirements.txt
          echo "flask_sqlalchemy" >> requirements.txt
          echo "python-dotenv" >> requirements.txt
          echo "psycopg2-binary" >> requirements.txt
          echo "SQLAlchemy" >> requirements.txt
          test -f requirements.txt && echo "[\u2714] requirements.txt ì¡´ì¬ í™•ì¸" || (echo "[âŒ] requirements.txt ëˆ„ë¥¸!" && exit 1)

      - name: âš™ï¸ .env íŒŒì¼ ìƒì„± ë° í™•ì¸
        run: |
          echo "FLASK_ENV=production" > .env
          echo "APP_NAME=FinanceTransactions" >> .env
          echo "DEBUG=False" >> .env
          echo "POSTGRES_DB=finance" >> .env
          echo "POSTGRES_USER=postgres" >> .env
          echo "POSTGRES_PASSWORD=postgres123" >> .env
          echo "DB_HOST=db" >> .env
          echo "DB_PORT=5432" >> .env
          test -f .env && echo "[\u2714] .env ì¡´ì¬ í™•ì¸" || (echo "[âŒ] .env ëˆ„ë¥¸!" && exit 1)

      - name: ğŸ¦– app.py ìƒì„± ë° í™•ì¸
        run: |
          echo "from flask import Flask, request, jsonify" > app.py
          echo "from flask_sqlalchemy import SQLAlchemy" >> app.py
          echo "from dotenv import load_dotenv" >> app.py
          echo "import os" >> app.py
          echo "load_dotenv()" >> app.py
          echo "app = Flask(__name__)" >> app.py
          echo "DB_URI = f\"postgresql://{os.getenv('POSTGRES_USER')}:{os.getenv('POSTGRES_PASSWORD')}@{os.getenv('DB_HOST')}:{os.getenv('DB_PORT')}/{os.getenv('POSTGRES_DB')}\"" >> app.py
          echo "app.config['SQLALCHEMY_DATABASE_URI'] = DB_URI" >> app.py
          echo "db = SQLAlchemy(app)" >> app.py
          echo "class Transaction(db.Model):" >> app.py
          echo "    id = db.Column(db.Integer, primary_key=True)" >> app.py
          echo "    amount = db.Column(db.Float)" >> app.py
          echo "    currency = db.Column(db.String(10))" >> app.py
          echo "    status = db.Column(db.String(20))" >> app.py
          echo "@app.before_first_request" >> app.py
          echo "def create_tables():" >> app.py
          echo "    db.create_all()" >> app.py
          echo "@app.route('/', methods=['GET'])" >> app.py
          echo "def index():" >> app.py
          echo "    return jsonify({'status': 'success', 'message': f\"{os.getenv('APP_NAME')} is running!\"})" >> app.py
          echo "@app.route('/transaction', methods=['POST'])" >> app.py
          echo "def transaction():" >> app.py
          echo "    try:" >> app.py
          echo "        data = request.get_json(force=True)" >> app.py
          echo "        tx = Transaction(**data)" >> app.py
          echo "        db.session.add(tx)" >> app.py
          echo "        db.session.commit()" >> app.py
          echo "        return jsonify({'status': 'success', 'message': 'Saved', 'data': data})" >> app.py
          echo "    except Exception as e:" >> app.py
          echo "        return jsonify({'status': 'error', 'message': str(e)}), 400" >> app.py
          echo "if __name__ == '__main__':" >> app.py
          echo "    app.run(host='0.0.0.0', port=5000)" >> app.py
          test -f app.py && echo "[\u2714] app.py ì¡´ì¬ í™•ì¸" || (echo "[âŒ] app.py ëˆ„ë¥¸!" && exit 1)

      - name: ğŸ³ Dockerfile ìƒì„± ë° í™•ì¸
        run: |
          echo "FROM python:3.11-slim" > Dockerfile
          echo "WORKDIR /app" >> Dockerfile
          echo "COPY . ." >> Dockerfile
          echo "RUN pip install --no-cache-dir -r requirements.txt" >> Dockerfile
          echo "EXPOSE 5000" >> Dockerfile
          echo "CMD [\"python\", \"app.py\"]" >> Dockerfile
          test -f Dockerfile && echo "[\u2714] Dockerfile ì¡´ì¬ í™•ì¸" || (echo "[âŒ] Dockerfile ëˆ„ë¥¸!" && exit 1)

      - name: ğŸ› ï¸ Docker ì„¤ì¹˜
        run: |
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          sudo systemctl start docker || sudo service docker start
          docker --version

      - name: ğŸ PostgreSQL ì»¤í…Œì´ë„ˆ ì‹¤í–‰
        run: |
          mkdir -p backup
          docker run -d --name db \
            -e POSTGRES_DB=finance \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres123 \
            -p 5432:5432 postgres:15
          sleep 20

      - name: ğŸ“„ ê±°ë˜ ì‹œë®¬ë¦¬ì–¸ ë°ì´í„° ìƒì„±
        run: |
          mkdir -p backup
          echo "import csv, random, datetime" > ledger.py
          echo "with open('backup/transactions.csv', 'w', newline='') as f:" >> ledger.py
          echo "    writer = csv.writer(f)" >> ledger.py
          echo "    writer.writerow(['timestamp', 'amount', 'currency', 'status'])" >> ledger.py
          echo "    for _ in range(60):" >> ledger.py
          echo "        ts = datetime.datetime.now().isoformat()" >> ledger.py
          echo "        amt = round(random.uniform(10.0, 1000.0), 2)" >> ledger.py
          echo "        currency = random.choice(['USD', 'KRW', 'JPY'])" >> ledger.py
          echo "        status = random.choice(['completed', 'pending', 'failed'])" >> ledger.py
          echo "        writer.writerow([ts, amt, currency, status])" >> ledger.py
          python3 ledger.py

      - name: ğŸ›ƒï¸ ê±°ë˜ CSV â†’ PostgreSQL ì ì¬
        run: |
          tail -n +2 backup/transactions.csv > backup/tmp.csv
          docker exec db psql -U postgres -d finance -c "CREATE TABLE IF NOT EXISTS transactions (timestamp TIMESTAMP, amount NUMERIC, currency VARCHAR(10), status VARCHAR(20));"
          docker cp backup/tmp.csv db:/tmp/tmp.csv
          docker exec db psql -U postgres -d finance -c "COPY transactions(timestamp, amount, currency, status) FROM '/tmp/tmp.csv' DELIMITER ',' CSV;"

      - name: ğŸ“€ DB ë°±ì—… ìˆ˜í–‰
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          docker exec db pg_dump -U postgres -d finance > backup/backup-$TIMESTAMP.sql
          echo "$TIMESTAMP" > backup/latest.txt

      - name: ğŸ“œ Provenance ì¦ëª…ì„œ ìƒì„±
        run: |
          mkdir -p provenance
          TIMESTAMP=$(cat backup/latest.txt)
          BACKUP_FILE="backup/backup-$TIMESTAMP.sql"
          HASH=$(sha256sum "$BACKUP_FILE" | awk '{print $1}')
          PROV_FILE="provenance/provenance-$TIMESTAMP.json"
          echo "{" > "$PROV_FILE"
          echo "  \"artifact\": \"$(basename $BACKUP_FILE)\"," >> "$PROV_FILE"
          echo "  \"generated_on\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"," >> "$PROV_FILE"
          echo "  \"db\": \"finance\"," >> "$PROV_FILE"
          echo "  \"sha256\": \"$HASH\"" >> "$PROV_FILE"
          echo "}" >> "$PROV_FILE"
          echo "[âœ”] ì¦ëª…ì„œ ìƒì„± ì™„ë£Œ: $PROV_FILE"
          cat "$PROV_FILE"

      - name: â¬‡ï¸ Provenance ì¦ëª…ì„œ ë‹¤ìš´ë¡œë“œìš© ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: provenance-certificate
          path: provenance/*.json

      - name: â™»ï¸ ì»¤í…Œì´ë„ˆ ì¬ê¸°ë™ ì²˜ë¦¬
        run: |
          echo "[ğŸ”] PostgreSQL ì»¤í…Œì´ë„ˆ ê²€ì‚¬"
          if ! docker ps | grep -q 'db'; then
            echo "[âš ï¸] db ì»¤í…Œì´ë„ˆ ê±´ì§€ì§€ ì•ŠìŒ. ì¬ê°œ ì‹œë„..."
            docker start db || docker run -d --name db \
              -e POSTGRES_DB=finance \
              -e POSTGRES_USER=postgres \
              -e POSTGRES_PASSWORD=postgres123 \
              -p 5432:5432 postgres:15
          fi

          echo "[ğŸ”] Flask ì• í”Œ ì»¤í…Œì´ë„ˆ ê²€ì‚¬"
          if ! docker ps | grep -q 'finance-transactions'; then
            echo "[âš ï¸] finance-transactions ì»¤í…Œì´ë„ˆ ê±´ì§€ì§€ ì•ŠìŒ. ë¦¬ë¸Œë”í›„ ì¬ì‹œë„..."
            docker build -t finance-transactions .
            docker run -d --name finance-transactions -p 5000:5000 finance-transactions
          fi

      - name: ğŸ“ƒ ì»¤í…Œì´ë„ˆ ì •ë³´ ê¸°ë³¸ .githubì— ë³´ì¡´
        run: |
          mkdir -p .github/container-info
          docker ps -a > .github/container-info/containers.txt
          docker images > .github/container-info/images.txt
          docker inspect db > .github/container-info/db-inspect.json || echo "[âš ï¸] db ì»¤í…Œì´ë„ˆ ì—†ìŒ"
          docker inspect finance-transactions > .github/container-info/finance-inspect.json || echo "[âš ï¸] finance-transactions ì»¤í…Œì´ë„ˆ ì—†ìŒ"
          ls -lh .github/container-info/

      - name: ğŸ“¦ ì»¤í…Œì´ë„ˆ ì •ë³´ ë‹¤ìš´ë¡œë“œìš© ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: container-info
          path: .github/container-info

      - name: ğŸ›‰ ì»¤í…Œì´ë„ˆ ì •ë¦¬
        if: always()
        run: |
          docker stop finance-transactions || true
          docker stop db || true
          docker rm finance-transactions || true
          docker rm db || true
