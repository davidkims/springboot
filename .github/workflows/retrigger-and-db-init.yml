name: ğŸ§¾ ê¸ˆìœµ ê±°ë˜ ìë™í™” (PDF ì˜ìˆ˜ì¦ í¬í•¨)

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  auto-finance:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“ echo ê¸°ë°˜ ì½”ë“œ íŒŒì¼ ë° ë””ë ‰í† ë¦¬ ìƒì„±
        run: |
          echo "ğŸ“‚ ë””ë ‰í† ë¦¬ ìƒì„±"
          mkdir -p app output

          echo "ğŸ“„ ledger.py ìƒì„± ì‹œì‘"
          echo 'import os, csv, time, random, datetime' > app/ledger.py
          echo 'import psycopg2, mysql.connector' >> app/ledger.py
          echo 'from fpdf import FPDF' >> app/ledger.py
          echo 'banks = ["í•œêµ­ì€í–‰", "ì¹´ì¹´ì˜¤ë±…í¬", "ì‹ í•œì€í–‰"]' >> app/ledger.py
          echo 'companies = ["ì‚¼ì„±ì „ì", "LGí™”í•™", "í˜„ëŒ€ëª¨ë¹„ìŠ¤"]' >> app/ledger.py
          echo 'logistics = ["ë°˜ë„ì²´", "ì´ì°¨ì „ì§€", "ìë™ì°¨ë¶€í’ˆ"]' >> app/ledger.py
          echo 'def wait(): time.sleep(10)' >> app/ledger.py
          echo 'def connect_pg(): return psycopg2.connect(host="postgres", dbname="ledgerdb", user="ledger", password="ledgerpass")' >> app/ledger.py
          echo 'def connect_my(): return mysql.connector.connect(host="mysql", database="ledgerdb", user="ledger", password="ledgerpass")' >> app/ledger.py
          echo 'def generate():' >> app/ledger.py
          echo ' rows = []' >> app/ledger.py
          echo ' now = datetime.datetime.now().isoformat()' >> app/ledger.py
          echo ' for _ in range(50):' >> app/ledger.py
          echo '  bank = random.choice(banks)' >> app/ledger.py
          echo '  company = random.choice(companies)' >> app/ledger.py
          echo '  item = random.choice(logistics)' >> app/ledger.py
          echo '  amount = round(random.uniform(10000, 50000000), 2)' >> app/ledger.py
          echo '  currency = random.choice(["KRW", "USD"])' >> app/ledger.py
          echo '  status = random.choice(["ì„±ê³µ", "ì‹¤íŒ¨"])' >> app/ledger.py
          echo '  memo = f"{bank}-{company} {item} ê±°ë˜"' >> app/ledger.py
          echo '  rows.append([now, bank, company, item, amount, currency, status, memo])' >> app/ledger.py
          echo ' return rows' >> app/ledger.py
          echo 'def save_csv(rows):' >> app/ledger.py
          echo ' os.makedirs("output", exist_ok=True)' >> app/ledger.py
          echo ' with open("output/transactions.csv", "w", encoding="utf-8", newline="") as f:' >> app/ledger.py
          echo '  writer = csv.writer(f)' >> app/ledger.py
          echo '  writer.writerow(["ì‹œê°„", "ì€í–‰", "ê¸°ì—…", "ë¬¼ë¥˜í•­ëª©", "ê¸ˆì•¡", "í†µí™”", "ìƒíƒœ", "ì„¤ëª…"])' >> app/ledger.py
          echo '  writer.writerows(rows)' >> app/ledger.py
          echo 'def save_pg(rows):' >> app/ledger.py
          echo ' conn = connect_pg(); cur = conn.cursor()' >> app/ledger.py
          echo ' cur.execute("CREATE TABLE IF NOT EXISTS ê±°ë˜ (ì‹œê°„ TEXT, ì€í–‰ TEXT, ê¸°ì—… TEXT, ë¬¼ë¥˜í•­ëª© TEXT, ê¸ˆì•¡ REAL, í†µí™” TEXT, ìƒíƒœ TEXT, ì„¤ëª… TEXT)")' >> app/ledger.py
          echo ' cur.executemany("INSERT INTO ê±°ë˜ VALUES (%s,%s,%s,%s,%s,%s,%s,%s)", rows)' >> app/ledger.py
          echo ' conn.commit(); conn.close()' >> app/ledger.py
          echo 'def save_my(rows):' >> app/ledger.py
          echo ' conn = connect_my(); cur = conn.cursor()' >> app/ledger.py
          echo ' cur.execute("CREATE TABLE IF NOT EXISTS ê±°ë˜ (ì‹œê°„ TEXT, ì€í–‰ TEXT, ê¸°ì—… TEXT, ë¬¼ë¥˜í•­ëª© TEXT, ê¸ˆì•¡ FLOAT, í†µí™” TEXT, ìƒíƒœ TEXT, ì„¤ëª… TEXT)")' >> app/ledger.py
          echo ' cur.executemany("INSERT INTO ê±°ë˜ VALUES (%s,%s,%s,%s,%s,%s,%s,%s)", rows)' >> app/ledger.py
          echo ' conn.commit(); conn.close()' >> app/ledger.py
          echo 'def generate_pdfs(rows):' >> app/ledger.py
          echo ' os.makedirs("output/receipts", exist_ok=True)' >> app/ledger.py
          echo ' for i, row in enumerate(rows):' >> app/ledger.py
          echo '  if row[6] != "ì„±ê³µ": continue' >> app/ledger.py
          echo '  pdf = FPDF(); pdf.add_page(); pdf.set_font("Arial", size=12)' >> app/ledger.py
          echo '  lines = [f"ì˜ìˆ˜ì¦ ë²ˆí˜¸: {i+1:03}", f"ì‹œê°„: {row[0]}", f"ì€í–‰: {row[1]}", f"ê¸°ì—…: {row[2]}", f"ë¬¼ë¥˜: {row[3]}", f"ê¸ˆì•¡: {row[4]} {row[5]}", f"ìƒíƒœ: {row[6]}", f"ì„¤ëª…: {row[7]}"]' >> app/ledger.py
          echo '  for line in lines: pdf.cell(200, 10, txt=line, ln=1)' >> app/ledger.py
          echo '  pdf.output(f"output/receipts/receipt_{i+1:03}.pdf")' >> app/ledger.py
          echo 'if __name__ == "__main__": wait(); rows = generate(); save_csv(rows); save_pg(rows); save_my(rows); generate_pdfs(rows)' >> app/ledger.py

          echo "ğŸ“„ Dockerfile ìƒì„±"
          echo 'FROM python:3.10-slim' > app/Dockerfile
          echo 'WORKDIR /app' >> app/Dockerfile
          echo 'COPY ledger.py .' >> app/Dockerfile
          echo 'RUN apt-get update && apt-get install -y gcc libpq-dev libjpeg-dev libfreetype6-dev build-essential' >> app/Dockerfile
          echo 'RUN pip install --no-cache-dir psycopg2 mysql-connector-python fpdf' >> app/Dockerfile
          echo 'CMD ["python", "ledger.py"]' >> app/Dockerfile

          echo "ğŸ“„ docker-compose.yml ìƒì„±"
          echo 'version: "3.9"' > docker-compose.yml
          echo 'services:' >> docker-compose.yml
          echo '  postgres:' >> docker-compose.yml
          echo '    image: postgres:14' >> docker-compose.yml
          echo '    environment:' >> docker-compose.yml
          echo '      POSTGRES_USER: ledger' >> docker-compose.yml
          echo '      POSTGRES_PASSWORD: ledgerpass' >> docker-compose.yml
          echo '      POSTGRES_DB: ledgerdb' >> docker-compose.yml
          echo '    volumes: [pgdata:/var/lib/postgresql/data]' >> docker-compose.yml
          echo '  mysql:' >> docker-compose.yml
          echo '    image: mysql:8' >> docker-compose.yml
          echo '    environment:' >> docker-compose.yml
          echo '      MYSQL_ROOT_PASSWORD: ledgerpass' >> docker-compose.yml
          echo '      MYSQL_DATABASE: ledgerdb' >> docker-compose.yml
          echo '      MYSQL_USER: ledger' >> docker-compose.yml
          echo '      MYSQL_PASSWORD: ledgerpass' >> docker-compose.yml
          echo '    volumes: [mysqldata:/var/lib/mysql]' >> docker-compose.yml
          echo '  ledger:' >> docker-compose.yml
          echo '    build: ./app' >> docker-compose.yml
          echo '    depends_on: [postgres, mysql]' >> docker-compose.yml
          echo '    volumes: [./output:/app/output]' >> docker-compose.yml
          echo 'volumes:' >> docker-compose.yml
          echo '  pgdata:' >> docker-compose.yml
          echo '  mysqldata:' >> docker-compose.yml

      - name: ğŸ› ï¸ Docker Compose Build & Start
        run: |
          echo "ğŸ”§ Docker Compose Build ì‹œì‘"
          docker compose build
          echo "ğŸš€ Docker Compose ì»¨í…Œì´ë„ˆ ì‹œì‘"
          docker compose up -d
          echo "â³ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™” ëŒ€ê¸°"
          sleep 30

      - name: ğŸ“¤ ê±°ë˜ CSV ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: ê±°ë˜ë°ì´í„°
          path: output/transactions.csv

      - name: ğŸ“¤ ì„±ê³µ ì˜ìˆ˜ì¦ PDF ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: ì˜ìˆ˜ì¦_PDF
          path: output/receipts/*.pdf
