name: 🔐 MySQL Ledger Setup with Root Access Fix

on:
  workflow_dispatch:
  schedule:
    - cron: '*/10 * * * *'

jobs:
  mysql-ledger-job:
    runs-on: ubuntu-latest

    env:
      MYSQL_ROOT_PASS: rootpass123
      DB_NAME: ledger_db

    steps:
      - name: 📦 Install MySQL Server
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-server

      - name: 🚀 Start MySQL Service
        run: |
          sudo systemctl start mysql
          sudo systemctl enable mysql

      - name: 🔐 Fix Root Login Method and Set Password
        run: |
          sudo mysql -e "
            ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '${MYSQL_ROOT_PASS}';
            FLUSH PRIVILEGES;
          "

      - name: 🧱 Create Ledger DB and Tables
        run: |
          mysql -u root -p${MYSQL_ROOT_PASS} -e "
            CREATE DATABASE IF NOT EXISTS ${DB_NAME};
            USE ${DB_NAME};
            CREATE TABLE IF NOT EXISTS ledger (
              id INT AUTO_INCREMENT PRIMARY KEY,
              transaction_type VARCHAR(30),
              amount DECIMAL(12, 2),
              currency VARCHAR(10),
              status VARCHAR(20),
              detail TEXT,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
            INSERT INTO ledger(transaction_type, amount, currency, status, detail) VALUES
              ('credit_card', 153000.00, 'KRW', 'completed', '신용카드 결제 완료'),
              ('check_card', 82000.00, 'KRW', 'completed', '체크카드 결제 완료'),
              ('stock', 1200000.00, 'KRW', 'executed', '삼성전자 주식 매수'),
              ('forex', 3000.00, 'USD', 'completed', 'KRW/USD 환전 거래 완료');
          "

      - name: 📄 View Ledger Table
        run: |
          mysql -u root -p${MYSQL_ROOT_PASS} -e "USE ${DB_NAME}; SELECT * FROM ledger;"
