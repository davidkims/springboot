name: ğŸ” Auto Finance Backup (Manual + Cron)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"  # 5ë¶„ë§ˆë‹¤ ìë™ ì‹¤í–‰

jobs:
  auto-finance-backup:
    runs-on: ubuntu-latest

    env:
      DB_NAME: finance
      DB_USER: root
      DB_PASS: rootpass123
      BACKUP_DIR: /opt/finance/backups
      SQL_INIT_FILE: /opt/finance/init.sql

    steps:
      - name: ğŸ“‚ 1. ë””ë ‰í† ë¦¬ ë° SQL ì´ˆê¸°í™” íŒŒì¼ ìƒì„±
        run: |
          echo "ğŸ“ [mkdir] Creating backup directory: $BACKUP_DIR"
          sudo mkdir -p "$BACKUP_DIR"

          echo "ğŸ“„ [echo] Writing SQL to $SQL_INIT_FILE"
          {
            echo "CREATE TABLE IF NOT EXISTS transactions ("
            echo "  id INT AUTO_INCREMENT PRIMARY KEY,"
            echo "  type VARCHAR(30),"
            echo "  amount DECIMAL(10,2),"
            echo "  currency VARCHAR(10),"
            echo "  status VARCHAR(20),"
            echo "  timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP"
            echo ");"
          } | tee "$SQL_INIT_FILE"

          echo "âœ… SQL ì´ˆê¸°í™” íŒŒì¼ ë‚´ìš©:"
          cat "$SQL_INIT_FILE"

      - name: ğŸ¬ 2. MySQL ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        run: |
          echo "ğŸ³ [docker run] Starting MySQL container..."
          docker run -d --rm \
            --name mysql-auto \
            -e MYSQL_ROOT_PASSWORD=$DB_PASS \
            -e MYSQL_DATABASE=$DB_NAME \
            -v "$SQL_INIT_FILE":/docker-entrypoint-initdb.d/init.sql \
            -p 3306:3306 \
            mysql:8.0

          echo "â³ Waiting 25s for DB init..."
          sleep 25

      - name: ğŸ” 3. ë¡œê·¸ì¸ êµ¬ì„± ë° ë°±ì—… ìˆ˜í–‰
        run: |
          echo "ğŸ” [auth] Creating ~/.my.cnf"
          {
            echo "[client]"
            echo "user=$DB_USER"
            echo "password=$DB_PASS"
            echo "host=127.0.0.1"
            echo "port=3306"
          } > ~/.my.cnf
          chmod 600 ~/.my.cnf

          echo "ğŸ• [timestamp] Generating timestamp"
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          BACKUP_FILE="$BACKUP_DIR/backup-$TIMESTAMP.sql"

          echo "ğŸ’¾ [mysqldump] Backing up to: $BACKUP_FILE"
          mysqldump --defaults-file=~/.my.cnf --no-tablespaces "$DB_NAME" > "$BACKUP_FILE"

          echo "âœ… Backup completed: $BACKUP_FILE"
          ls -lh "$BACKUP_FILE"

          echo "ğŸ“œ [verify] Running SHOW TABLES;"
          mysql --defaults-file=~/.my.cnf -e "USE $DB_NAME; SHOW TABLES;"

          echo "ğŸ“Œ [env] Exporting backup file info"
          echo "BACKUP_FILE_PATH=$BACKUP_FILE" >> $GITHUB_ENV
          echo "BACKUP_FILE_NAME=backup-$TIMESTAMP.sql" >> $GITHUB_ENV

      - name: ğŸ§¹ 4. MySQL ì»¨í…Œì´ë„ˆ ì •ë¦¬
        run: |
          echo "ğŸ§¼ [docker stop] Stopping MySQL container..."
          docker stop mysql-auto || echo "âš ï¸ MySQL container not running"

      - name: ğŸ“¦ 5. GitHub Release ìƒì„± ë° ë°±ì—… íŒŒì¼ ì—…ë¡œë“œ
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "backup-${{ env.BACKUP_FILE_NAME }}"
          name: "MySQL Backup - ${{ env.BACKUP_FILE_NAME }}"
          files: ${{ env.BACKUP_FILE_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
