name: ğŸ” Auto Finance Backup (Manual + Cron)

on:
  workflow_dispatch:  # âœ… ìˆ˜ë™ ì‹¤í–‰ ê¸°ëŠ¥ ì¶”ê°€ë¨
  schedule:
    - cron: "*/5 * * * *"  # â° ë§¤ 5ë¶„ë§ˆë‹¤ ìë™ ì‹¤í–‰

jobs:
  auto-finance-backup:
    runs-on: ubuntu-latest

    env:
      DB_NAME: finance
      DB_USER: root
      DB_PASS: rootpass123
      BACKUP_DIR: /opt/finance/backups
      SQL_INIT_FILE: /opt/finance/init.sql

    steps:
      - name: ğŸ“ ë””ë ‰í† ë¦¬ ìƒì„± ë° ì´ˆê¸° SQL íŒŒì¼ ì¤€ë¹„
        run: |
          sudo mkdir -p $BACKUP_DIR
          echo "CREATE TABLE IF NOT EXISTS transactions (
            id INT AUTO_INCREMENT PRIMARY KEY,
            type VARCHAR(30),
            amount DECIMAL(10,2),
            currency VARCHAR(10),
            status VARCHAR(20),
            timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );" > $SQL_INIT_FILE

      - name: ğŸ¬ MySQL ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        run: |
          docker run -d --rm \
            --name mysql-auto \
            -e MYSQL_ROOT_PASSWORD=$DB_PASS \
            -e MYSQL_DATABASE=$DB_NAME \
            -v $SQL_INIT_FILE:/docker-entrypoint-initdb.d/init.sql \
            -p 3306:3306 \
            mysql:8.0
          echo "â³ MySQL ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘..."
          sleep 25

      - name: ğŸ” MySQL ë¡œê·¸ì¸ êµ¬ì„± ë° ë°±ì—… ì‹¤í–‰
        run: |
          echo "[client]" > ~/.my.cnf
          echo "user=$DB_USER" >> ~/.my.cnf
          echo "password=$DB_PASS" >> ~/.my.cnf
          echo "host=127.0.0.1" >> ~/.my.cnf
          echo "port=3306" >> ~/.my.cnf
          chmod 600 ~/.my.cnf

          BACKUP_FILE=$BACKUP_DIR/backup-$(date +%Y%m%d%H%M%S).sql
          mysqldump --defaults-file=~/.my.cnf --no-tablespaces $DB_NAME > $BACKUP_FILE
          echo "âœ… ë°±ì—… ì™„ë£Œ: $BACKUP_FILE"

      - name: ğŸ§¹ MySQL ì»¨í…Œì´ë„ˆ ì •ë¦¬
        run: docker stop mysql-auto || true
