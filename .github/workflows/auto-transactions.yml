name: ğŸ§¾ Finance Auto Ledger with PostgreSQL & MySQL

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  ledger-setup:
    runs-on: ubuntu-latest

    env:
      PG_DB: finance
      PG_USER: postgres
      PG_PASS: pgpass
      MYSQL_ROOT_PASS: rootpass
      LEDGER_PATH: ledger
      SQL_DIR: sql
      TIMESTAMP: 20250603021601

    steps:
      - name: ğŸ“ ë””ë ‰í† ë¦¬ ë° SQL íŒŒì¼ ìƒì„±
        run: |
          mkdir -p $LEDGER_PATH $SQL_DIR
          cat <<EOF > $SQL_DIR/init.sql
          CREATE TABLE IF NOT EXISTS transactions (
            id SERIAL PRIMARY KEY,
            type VARCHAR(20),
            amount NUMERIC,
            currency VARCHAR(10),
            status VARCHAR(20),
            timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
          INSERT INTO transactions(type, amount, currency, status) VALUES
            ('credit_card', 30000, 'KRW', 'completed'),
            ('check_card', 25000, 'KRW', 'completed'),
            ('stock', 1200000, 'KRW', 'pending'),
            ('forex', 500, 'USD', 'completed');
          EOF

      - name: ğŸ˜ PostgreSQL ì„¤ì¹˜ ë° ì„¤ì •
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql
          sudo systemctl start postgresql
          sudo systemctl enable postgresql
          sudo -u postgres psql -c "ALTER USER $PG_USER WITH PASSWORD '$PG_PASS';"
          echo "localhost:5432:$PG_DB:$PG_USER:$PG_PASS" > ~/.pgpass
          chmod 600 ~/.pgpass

      - name: ğŸ˜ PostgreSQL DB ë° í…Œì´ë¸” ì´ˆê¸°í™”
        run: |
          sudo -u postgres createdb $PG_DB || echo "âœ… ì´ë¯¸ ì¡´ì¬"
          PGPASSFILE=$HOME/.pgpass psql -h localhost -U $PG_USER -d $PG_DB -f $SQL_DIR/init.sql

      - name: ğŸ¬ MySQL ì„¤ì¹˜ ë° ì›ì¥ í…Œì´ë¸” ìƒì„±
        run: |
          sudo apt-get install -y mysql-server
          sudo systemctl start mysql
          sudo systemctl enable mysql

          # root ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
          sudo mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '$MYSQL_ROOT_PASS'; FLUSH PRIVILEGES;"

          # ì›ì¥ DB ë° í…Œì´ë¸” ìƒì„±
          sudo mysql --user=root --password=$MYSQL_ROOT_PASS -e "
            CREATE DATABASE IF NOT EXISTS ledger_db;
            USE ledger_db;
            CREATE TABLE IF NOT EXISTS ledger (
              id INT AUTO_INCREMENT PRIMARY KEY,
              transaction_type VARCHAR(30),
              detail TEXT,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
            INSERT INTO ledger(transaction_type, detail) VALUES
              ('credit_card', 'ì‹ ìš©ì¹´ë“œ ê²°ì œ ì™„ë£Œ'),
              ('check_card', 'ì²´í¬ì¹´ë“œ ê²°ì œ ì™„ë£Œ'),
              ('stock', 'ì£¼ì‹ ë§¤ìˆ˜ ëŒ€ê¸°'),
              ('forex', 'í™˜ì „ ì™„ë£Œ');
          "

      - name: ğŸ“„ PostgreSQL ê±°ë˜ ë¡œê·¸ ì¶œë ¥
        run: |
          echo "ğŸ” PostgreSQL ê±°ë˜ ë¡œê·¸:"
          PGPASSFILE=$HOME/.pgpass psql -h localhost -U $PG_USER -d $PG_DB -c "SELECT * FROM transactions;"

      - name: ğŸ“„ MySQL ì›ì¥ ì¶œë ¥
        run: |
          echo "ğŸ” MySQL Ledger:"
          sudo mysql --user=root --password=$MYSQL_ROOT_PASS -e "USE ledger_db; SELECT * FROM ledger;"
