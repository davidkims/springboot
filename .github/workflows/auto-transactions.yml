name: 💳 Finance Auto-Ledger with MySQL

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  finance-ledger-job:
    runs-on: ubuntu-latest

    env:
      MYSQL_ROOT_PASS: rootpass123
      DB_NAME: ledger_db

    steps:
      - name: 🔧 MySQL 설치
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-server

      - name: 🚀 MySQL 시작 및 부팅 시 자동 실행 설정
        run: |
          sudo systemctl start mysql
          sudo systemctl enable mysql

      - name: 🔐 root 계정 패스워드 설정 (mysql_native_password)
        run: |
          sudo mysql <<EOF
          ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '${MYSQL_ROOT_PASS}';
          FLUSH PRIVILEGES;
          EOF

      - name: 🧱 Ledger DB 및 거래 테이블 생성 + 초기 데이터 입력
        run: |
          mysql -u root -p${MYSQL_ROOT_PASS} -e "
            CREATE DATABASE IF NOT EXISTS ${DB_NAME};
            USE ${DB_NAME};
            CREATE TABLE IF NOT EXISTS ledger (
              id INT AUTO_INCREMENT PRIMARY KEY,
              transaction_type VARCHAR(30),
              amount DECIMAL(12,2),
              currency VARCHAR(10),
              status VARCHAR(20),
              detail TEXT,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
            INSERT INTO ledger(transaction_type, amount, currency, status, detail) VALUES
              ('credit_card', 153000, 'KRW', 'completed', '신용카드 결제'),
              ('check_card', 82000, 'KRW', 'completed', '체크카드 결제'),
              ('stock', 1200000, 'KRW', 'executed', '주식 매수'),
              ('forex', 3000, 'USD', 'completed', '환전 처리'),
              ('bank_transfer', 500000, 'KRW', 'completed', '자동 이체 완료');
          "

      - name: 📋 거래 원장 확인
        run: |
          mysql -u root -p${MYSQL_ROOT_PASS} -e "USE ${DB_NAME}; SELECT * FROM ledger;"
