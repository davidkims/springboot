name: Install Java, Maven, NetBackup CLI & Ledger Generation with Git Tag & Release

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # … (생략: pom.xml, Java 소스, install script, NetBackup, 빌드 & shade, ledger 생성 & 커스터머 리스트까지)

      - name: Commit generated files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "▶ Committing CSV and customer list"
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          git add bulk_ledgers.csv customers.txt
          git commit -m "chore: add generated ledger and customer list" || echo "⚠ nothing to commit"
          git push origin HEAD:main || echo "⚠ push failed or no changes"

      - name: Create annotated Git tag
        id: tag
        run: |
          echo "▶ Creating annotated git tag"
          TAG=ledger-$(date +'%Y%m%d%H%M%S')
          git tag -a $TAG -m "Auto-release: $TAG – includes bulk_ledgers.csv & customers.txt"
          git push origin --tags
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          release_name: "Ledger Release ${{ steps.tag.outputs.tag }}"
          body: |
            Auto-generated transaction ledger and customer list.
          draft: false
          prerelease: false
