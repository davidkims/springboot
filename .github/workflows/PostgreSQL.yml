name: 💳 AutoTransfer Ledger Generation

on:
  workflow_dispatch:
  schedule:
    - cron: '*/10 * * * *'

jobs:
  autotransfer-ledger:
    runs-on: ubuntu-latest

    env:
      PG_DB: finance
      PG_USER: postgres
      PG_PASS: pgpass
      MYSQL_ROOT_PASS: rootpass
      LEDGER_PATH: ledger
      SQL_DIR: sql
      TIMESTAMP: "20250603020557"

    steps:
      - name: 📁 디렉토리 생성
        run: |
          mkdir -p $LEDGER_PATH $SQL_DIR

      - name: 🐘 PostgreSQL 설치 및 초기화
        run: |
          sudo apt update
          sudo apt install -y postgresql
          sudo systemctl start postgresql
          sudo -u postgres psql -c "ALTER USER $PG_USER WITH PASSWORD '$PG_PASS';"
          echo "127.0.0.1:5432:$PG_DB:$PG_USER:$PG_PASS" > ~/.pgpass
          chmod 600 ~/.pgpass

      - name: 🐘 PostgreSQL 거래 테이블 생성
        run: |
          sudo -u postgres createdb $PG_DB || echo "이미 존재"
          PGPASSFILE=$HOME/.pgpass psql -U $PG_USER -d $PG_DB -c "
            CREATE TABLE IF NOT EXISTS transactions (
              id SERIAL PRIMARY KEY,
              type VARCHAR(20),
              amount NUMERIC,
              currency VARCHAR(10),
              status VARCHAR(20),
              timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );"

      - name: 💳 자동이체 거래 삽입
        run: |
          PGPASSFILE=$HOME/.pgpass psql -U $PG_USER -d $PG_DB -c "
            INSERT INTO transactions (type, amount, currency, status)
            VALUES
              ('credit_card', 125000, 'KRW', 'completed'),
              ('check_card', 58000, 'KRW', 'completed'),
              ('stock', 1000000, 'KRW', 'completed'),
              ('forex', 870, 'USD', 'completed');"

      - name: 🧾 거래 원장 CSV 생성
        run: |
          PGPASSFILE=$HOME/.pgpass psql -U $PG_USER -d $PG_DB -c "\COPY transactions TO '$LEDGER_PATH/ledger-${TIMESTAMP}.csv' WITH CSV HEADER"

      - name: 📄 생성된 거래 원장 확인
        run: |
          ls -lh $LEDGER_PATH
          cat $LEDGER_PATH/ledger-${TIMESTAMP}.csv || echo "⚠️ 원장 파일 없음"
