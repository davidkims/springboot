# .github/workflows/rust-ci.yml
name: Rust CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Cache Cargo registry & git index
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Ensure rust-crate folder exists
        run: |
          mkdir -p rust-crate

      - name: Download or generate Cargo.toml
        run: |
          if [ ! -f rust-crate/Cargo.toml ]; then
            echo "ğŸ“„ Fetching Cargo.toml from remote..."
            curl -fsSL https://example.com/path/to/Cargo.toml -o rust-crate/Cargo.toml \
              && echo "âœ… Downloaded Cargo.toml" \
              || cat << 'EOF' > rust-crate/Cargo.toml
            echo "âš™ï¸ Generated default Cargo.toml"
          else
            echo "â„¹ï¸ rust-crate/Cargo.toml already exists, skipping"
          fi

      - name: Download or generate src/main.rs
        run: |
          mkdir -p rust-crate/src
          if [ ! -f rust-crate/src/main.rs ]; then
            echo "ğŸ“„ Fetching main.rs from remote..."
            curl -fsSL https://example.com/path/to/main.rs -o rust-crate/src/main.rs \
              && echo "âœ… Downloaded main.rs" \
              || cat << 'EOF' > rust-crate/src/main.rs
fn main() {
    println!("Hello, world!");
}
EOF
            echo "âš™ï¸ Generated default main.rs"
          else
            echo "â„¹ï¸ rust-crate/src/main.rs already exists, skipping"
          fi

      - name: Verify Cargo.toml path
        run: |
          echo "ğŸ” Listing rust-crate directory:"
          ls -R rust-crate

      - name: Cargo build
        working-directory: rust-crate
        run: cargo build --verbose

      - name: Cargo test
        working-directory: rust-crate
        run: cargo test --verbose
