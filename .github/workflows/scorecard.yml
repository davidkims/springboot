name: Scorecard Supply-Chain Security

on:
  branch_protection_rules:
    types: [created, edited, deleted]
  schedule:
    - cron: '21 2 * * 0'
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  analyze:
    name: Scorecard 분석
    runs-on: ubuntu-latest
    if: github.event.repository.default_branch == github.ref_name || github.event_name == 'pull_request'
    permissions:
      security-events: write
      id-token: write
      contents: read
    steps:
      - name: ">> 스텝 시작: 리포지토리 코드 체크아웃"
        run: echo "--- 리포지토리 체크아웃 스텝 시작 ---"
      - name: "리포지토리 코드 체크아웃"
        uses: actions/checkout@v4
        with:
          persist-credentials: false
      - name: "<< 스텝 완료: 리포지토리 코드 체크아웃"
        run: echo "--- 리포지토리 체크아웃 스텝 완료 ---"

      - name: ">> 스텝 시작: OpenSSF Scorecard 분석 실행"
        run: echo "--- 스코어카드 분석 스텝 시작 ---"
      - name: "OpenSSF Scorecard 분석 실행"
        uses: ossf/scorecard-action@1a415a775193984d720b7218684d0b17b01d6706
        with:
          results_file: results.sarif
          results_format: sarif
          publish_results: true

      - name: "Scorecard 분석 결과 확인"
        run: |
          echo "Scorecard 분석이 완료되었습니다. results.sarif 파일 내용을 확인합니다."
          if [ -f "results.sarif" ]; then
            echo "results.sarif 파일이 성공적으로 생성되었습니다."
            cat results.sarif | head -n 20
          else
            echo "오류: results.sarif 파일이 생성되지 않았습니다."
            exit 1
          fi
      - name: "<< 스텝 완료: OpenSSF Scorecard 분석 실행"
        run: echo "--- 스코어카드 분석 스텝 완료 ---"

      - name: ">> 스텝 시작: SARIF 결과를 아티팩트로 업로드"
        run: echo "--- 아티팩트 업로드 스텝 시작 ---"
      - name: "SARIF 결과를 아티팩트로 업로드"
        uses: actions/upload-artifact@v4
        with:
          name: Scorecard SARIF 파일
          path: results.sarif
          retention-days: 7
      - name: "<< 스텝 완료: SARIF 결과를 아티팩트로 업로드"
        run: echo "--- 아티팩트 업로드 스텝 완료 ---"

      - name: ">> 스텝 시작: 결과를 GitHub 코드 스캐닝 대시보드에 업로드"
        run: echo "--- 코드 스캐닝 업로드 스텝 시작 ---"
      - name: "결과를 GitHub 코드 스캐닝 대시보드에 업로드"
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
      - name: "<< 스텝 완료: 결과를 GitHub 코드 스캐닝 대시보드에 업로드"
        run: echo "--- 코드 스캐닝 업로드 스텝 완료 ---"

      - name: ">> 워크플로우 실행 종료"
        run: echo "--- 워크플로우 실행이 성공적으로 완료되었습니다 ---"
