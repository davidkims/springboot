name: π”“ κ³ κ° κ±°λ μ›ν¬ν”λ΅μ° λ³µνΈν™” λ° λ³΄κ³ μ„ μƒμ„±

on:
  workflow_dispatch:
  schedule:
    - cron: '30 3 * * *'  # λ§¤μΌ μ¤μ „ 03:30 μ‹¤ν–‰

jobs:
  decrypt-and-report:
    runs-on: ubuntu-latest
    env:
      ENCRYPTION_KEY: ${{ secrets.CUSTOMER_AES_KEY }}

    steps:
      - name: π“¥ Checkout repository
        uses: actions/checkout@v4

      - name: π“¦ λ³µνΈν™” λ€μƒ μ••μ¶• ν•΄μ 
        run: |
          mkdir -p .decrypted .reports
          if [ -f customer-encrypted.zip ]; then
            unzip customer-encrypted.zip -d .encrypted
          elif [ -d .encrypted ]; then
            echo "β… .encrypted ν΄λ” μ΅΄μ¬ν•¨"
          else
            echo "β .encrypted μ΅΄μ¬ν•μ§€ μ•μ"
            exit 1
          fi

      - name: π”“ λ³µνΈν™” λ° Markdown λ¦¬ν¬νΈ μƒμ„±
        run: |
          for encfile in .encrypted/*.enc; do
            orig_name=$(basename "$encfile" .yml.enc | sed 's/.yaml.enc$/.yaml/' | sed 's/.yml.enc$/.yml/')
            decfile=".decrypted/$orig_name"
            echo "π”“ λ³µνΈν™” λ€μƒ: $encfile β†’ $decfile"

            # λ³µνΈν™”
            openssl enc -d -aes-256-cbc -pbkdf2 -in "$encfile" -out "$decfile" -pass pass:"$ENCRYPTION_KEY"

            # λ³µνΈν™” μ„±κ³µ λ¦¬ν¬νΈ μƒμ„±
            report_file=".reports/${orig_name}.md"
            echo "## π” λ³µνΈν™” λ³΄κ³ μ„: ${orig_name}" > "$report_file"
            echo "- λ³µνΈν™”λ νμΌ κ²½λ΅: \`$decfile\`" >> "$report_file"
            echo "- μ›λ³Έ μ•”νΈν™” νμΌ: \`$encfile\`" >> "$report_file"
            echo "- λ³µνΈν™” μ‹κ°: \`$(date '+%Y-%m-%d %H:%M:%S')\`" >> "$report_file"

            # 'κ³ κ° κ±°λ' ν‚¤μ›λ“ ν¬ν•¨ μ—¬λ¶€ κ²€μ‚¬
            if grep -q 'κ³ κ° κ±°λ' "$decfile"; then
              echo "- μƒνƒ: β… κ³ κ° κ±°λ ν‚¤μ›λ“ ν¬ν•¨λ¨" >> "$report_file"
            else
              echo "- μƒνƒ: β οΈ κ³ κ° κ±°λ ν‚¤μ›λ“ μ—†μ" >> "$report_file"
            fi

            echo "π“„ λ³΄κ³ μ„ μƒμ„± μ™„λ£: $report_file"
          done

      - name: π“¦ λ³µνΈν™” νμΌ ZIP μƒμ„±
        run: |
          zip -r decrypted-workflows.zip .decrypted
          zip -r transaction-reports.zip .reports

      - name: π“¤ μ—…λ΅λ“: λ³µνΈν™” νμΌ μ•„μΉ΄μ΄λΈ
        uses: actions/upload-artifact@v4
        with:
          name: decrypted-workflows
          path: decrypted-workflows.zip

      - name: π“¤ μ—…λ΅λ“: Markdown λ¦¬ν¬νΈ
        uses: actions/upload-artifact@v4
        with:
          name: transaction-markdown-reports
          path: transaction-reports.zip
