name: ğŸ’³ Auto Transaction Ledger Backup

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  auto-transactions:
    runs-on: ubuntu-latest

    env:
      PG_DB: finance
      PG_USER: postgres
      PG_PASS: pgpass
      SQL_DIR: sql
      LEDGER_PATH: ledger
      TIMESTAMP: 20250603021045

    steps:
      - name: ğŸ“ ë””ë ‰í† ë¦¬ ë° SQL íŒŒì¼ ìƒì„±
        run: |
          sudo mkdir -p $SQL_DIR $LEDGER_PATH
          sudo chmod -R 777 $SQL_DIR $LEDGER_PATH
          echo "CREATE TABLE IF NOT EXISTS transactions (
            id SERIAL PRIMARY KEY,
            type VARCHAR(20),
            amount NUMERIC,
            currency VARCHAR(10),
            status VARCHAR(20),
            timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );" > $SQL_DIR/init.sql

      - name: ğŸ˜ PostgreSQL ì„¤ì¹˜ ë° ì‚¬ìš©ì íŒ¨ìŠ¤ì›Œë“œ ì„¤ì •
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql

          # PostgreSQL ì¸ì¦ ë°©ì‹ md5ë¡œ ë³€ê²½
          sudo sed -i "s/^local\s\+all\s\+postgres\s\+peer/local all postgres md5/" /etc/postgresql/*/main/pg_hba.conf
          sudo systemctl restart postgresql

          # postgres ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
          sudo -u postgres psql -c "ALTER USER $PG_USER PASSWORD '$PG_PASS';"

          echo "127.0.0.1:5432:$PG_DB:$PG_USER:$PG_PASS" > ~/.pgpass
          chmod 600 ~/.pgpass

      - name: ğŸ˜ DB ìƒì„± ë° í…Œì´ë¸” ì´ˆê¸°í™”
        run: |
          PGPASSFILE=$HOME/.pgpass createdb -h 127.0.0.1 -U $PG_USER $PG_DB || echo "âœ… ì´ë¯¸ ì¡´ì¬"
          PGPASSFILE=$HOME/.pgpass psql -h 127.0.0.1 -U $PG_USER -d $PG_DB -f $SQL_DIR/init.sql

      - name: ğŸ’³ ê°€ìƒ ê±°ë˜ ë‚´ì—­ ì¶”ê°€
        run: |
          PGPASSFILE=$HOME/.pgpass psql -h 127.0.0.1 -U $PG_USER -d $PG_DB -c "
            INSERT INTO transactions (type, amount, currency, status) VALUES
              ('credit_card', 150000, 'KRW', 'completed'),
              ('check_card', 35000, 'KRW', 'completed'),
              ('stock', 300000, 'KRW', 'completed'),
              ('forex', 1000, 'USD', 'completed');
          "

      - name: ğŸ“œ ê±°ë˜ ì›ì¥ íŒŒì¼ë¡œ ì¶œë ¥
        run: |
          FILE=$LEDGER_PATH/ledger-${{ env.TIMESTAMP }}.csv
          PGPASSFILE=$HOME/.pgpass psql -h 127.0.0.1 -U $PG_USER -d $PG_DB -c "\copy transactions TO '$FILE' CSV HEADER"
          ls -lh $LEDGER_PATH

      - name: ğŸ§¾ ê±°ë˜ ì›ì¥ í™•ì¸
        run: |
          cat $LEDGER_PATH/ledger-${{ env.TIMESTAMP }}.csv
