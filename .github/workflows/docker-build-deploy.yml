name: Setup & Load Loans Ledger with Backup and Tags

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'  # ë§¤ ì‹œê°„ ì •ê°ë§ˆë‹¤ ì‹¤í–‰

jobs:
  setup-and-load:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸ³ [tag:docker-install] Install Docker
        run: |
          echo "[tag:docker-install] Installing Docker..."
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          sudo systemctl start docker
          docker --version
          echo "[tag:docker-install] Docker ì„¤ì¹˜ ì™„ë£Œ"

      - name: ğŸ˜ [tag:pg-container] Start PostgreSQL Container
        run: |
          echo "[tag:pg-container] PostgreSQL ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘..."
          docker rm -f pg-loans || true
          docker run -d \
            --name pg-loans \
            -e POSTGRES_DB=loans \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres123 \
            -v pgdata:/var/lib/postgresql/data \
            -p 5433:5432 postgres:15
          echo "[tag:pg-container] PostgreSQL ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì™„ë£Œ"
          sleep 15

      - name: ğŸ§± [tag:create-schema] Create loan_ledger Schema
        run: |
          echo "[tag:create-schema] loan_ledger í…Œì´ë¸” ìƒì„± ì¤‘..."
          INIT_SQL=$(mktemp)
          echo "CREATE TABLE IF NOT EXISTS loan_ledger (" > $INIT_SQL
          echo "  id SERIAL PRIMARY KEY," >> $INIT_SQL
          echo "  customer_name TEXT NOT NULL," >> $INIT_SQL
          echo "  loan_amount DECIMAL(10,2) NOT NULL," >> $INIT_SQL
          echo "  issued_date DATE" >> $INIT_SQL
          echo ");" >> $INIT_SQL
          docker cp "$INIT_SQL" pg-loans:/tmp/schema.sql
          docker exec pg-loans psql -U postgres -d loans -f /tmp/schema.sql
          echo "[tag:create-schema] loan_ledger ìŠ¤í‚¤ë§ˆ ìƒì„± ì™„ë£Œ"

      - name: ğŸ“„ [tag:generate-csv] Generate loans.csv
        run: |
          echo "[tag:generate-csv] loans.csv íŒŒì¼ ìƒì„± ì¤€ë¹„ ì¤‘..."
          mkdir -p data
          echo "[tag:generate-csv] mkdir -p data"
          echo "[tag:generate-csv] echo header"
          echo "customer_name,loan_amount,issued_date" > data/loans.csv
          echo "[tag:generate-csv] echo line 1"
          echo "Alice,1000.00,2024-01-01" >> data/loans.csv
          echo "[tag:generate-csv] echo line 2"
          echo "Bob,2500.50,2024-02-15" >> data/loans.csv
          echo "[tag:generate-csv] echo line 3"
          echo "Charlie,3300.75,2024-03-10" >> data/loans.csv
          echo "[tag:generate-csv] loans.csv íŒŒì¼ ì‘ì„± ì™„ë£Œ"
          echo "[tag:generate-csv] loans.csv íŒŒì¼ í™•ì¸:"
          head -n 5 data/loans.csv
          if [ ! -f data/loans.csv ]; then echo "[tag:generate-csv] âŒ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤" && exit 1; fi

      - name: ğŸ“¥ [tag:load-csv] Load CSV to DB
        run: |
          echo "[tag:load-csv] CSV ì ì¬ ì¤‘..."
          docker cp data/loans.csv pg-loans:/tmp/loans.csv
          docker exec pg-loans bash -c "psql -U postgres -d loans -c \
            \"COPY loan_ledger(customer_name, loan_amount, issued_date) \
            FROM '/tmp/loans.csv' DELIMITER ',' CSV HEADER;\""
          echo "[tag:load-csv] CSV ì ì¬ ì™„ë£Œ"

      - name: ğŸ’¾ [tag:backup-db] SQL Backup
        run: |
          echo "[tag:backup-db] SQL ë°±ì—… ì¤‘..."
          mkdir -p backup
          TIMESTAMP=$(date +'%Y%m%d%H%M')
          BACKUP_FILE=backup/loan_backup_$TIMESTAMP.sql
          docker exec pg-loans pg_dump -U postgres -d loans > $BACKUP_FILE
          echo "[tag:backup-db] ë°±ì—… ì™„ë£Œ â†’ $BACKUP_FILE"

      - name: ğŸ” [tag:restore-latest] Restore Latest Backup
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "[tag:restore-latest] ë³µì› í…ŒìŠ¤íŠ¸ ì‹œì‘..."
          LATEST_BACKUP=$(ls backup/loan_backup_*.sql | sort | tail -n1)
          echo "[tag:restore-latest] ìµœì‹  ë°±ì—…: $LATEST_BACKUP"
          docker rm -f pg-restore || true
          docker run -d \
            --name pg-restore \
            -e POSTGRES_DB=loans \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres123 \
            -p 5434:5432 postgres:15
          sleep 15
          docker cp "$LATEST_BACKUP" pg-restore:/tmp/restore.sql
          docker exec pg-restore psql -U postgres -d loans -f /tmp/restore.sql
          echo "[tag:restore-latest] ë³µì› ì™„ë£Œ"
