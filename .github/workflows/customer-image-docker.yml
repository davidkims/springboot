name: 🧾 Docker 명함 이미지 생성 및 보안 디버깅 (echo 기반)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-customer-cards:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      packages: read
      security-events: write

    steps:
    - name: 📥 코드 체크아웃
      uses: actions/checkout@v4

    - name: 📁 디렉토리 생성
      run: |
        mkdir -p cards

    - name: 🐳 generate_card.py 및 Dockerfile 생성 (echo 기반)
      run: |
        echo "from PIL import Image, ImageDraw" > generate_card.py
        echo "img = Image.new('RGB', (400, 200), color=(73, 109, 137))" >> generate_card.py
        echo "d = ImageDraw.Draw(img)" >> generate_card.py
        echo "d.text((10,10), '고객 거래 명함', fill=(255,255,0))" >> generate_card.py
        echo "img.save('/data/cards/customer_card.png')" >> generate_card.py

        echo "FROM python:3.10-slim" > Dockerfile
        echo "WORKDIR /app" >> Dockerfile
        echo "COPY generate_card.py /app/" >> Dockerfile
        echo "RUN pip install pillow" >> Dockerfile
        echo "CMD [\"python\", \"generate_card.py\"]" >> Dockerfile

    - name: 🛠️ Docker 이미지 빌드
      run: docker build -t customer-card-generator .

    - name: 🏃 Docker 컨테이너 실행 및 이미지 생성
      run: |
        docker run --rm -v $(pwd)/cards:/data/cards customer-card-generator

    - name: 📷 생성된 명함 이미지 확인
      run: |
        ls -al cards
        file cards/customer_card.png || echo "❌ 이미지 생성 실패"

    - name: 🔐 .github/workflows 권한 문제 디버그
      run: |
        echo "🛡️ .github/workflows 권한 검사"
        ls -ld .github .github/workflows || echo "❌ 접근 실패"
        stat .github/workflows || true
        sudo chmod -R 755 .github || true

    - name: 📤 생성 이미지 아티팩트 업로드
      uses: actions/upload-artifact@v4
      with:
        name: customer-card-image
        path: cards/
