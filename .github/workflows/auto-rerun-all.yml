name: 실패한 모든 워크플로 자동 재시도

permissions:
  actions: write   # reRunWorkflowFailedJobs 호출 권한
  contents: read   # 리포지토리 워크플로우 목록 조회 권한

on:
  schedule:
    # 매 5분마다 실행
    - cron: '*/5 * * * *'

jobs:
  rerun-all-failed:
    runs-on: ubuntu-latest
    steps:
      - name: 🔄 재실행 대상 탐색 및 실행
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // 1) 리포지토리 내 모든 워크플로우 리스트 조회
            const { data: wfList } = await github.rest.actions.listWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            for (const wf of wfList.workflows) {
              // 2) 각 워크플로우별 최근 10건의 completed 실행 조회
              const { data: runs } = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: wf.id,
                status: 'completed',
                per_page: 10
              });
              
              for (const run of runs.workflow_runs) {
                // 3) 실패(failure) 또는 취소(cancelled)된 경우만 재실행 API 호출
                if (['failure', 'cancelled'].includes(run.conclusion)) {
                  console.log(`🔁 Re-running failed jobs of '${wf.name}' run #${run.id}`);
                  await github.rest.actions.reRunWorkflowFailedJobs({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: run.id
                  });
                }
              }
            }
