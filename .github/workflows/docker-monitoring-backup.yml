name: 🐳 Docker Finance Backup & GHCR Push

on:
  push:
    branches: [main]
  schedule:
    - cron: '*/10 * * * *'  # 10분마다 실행
  workflow_dispatch:

env:
  IMAGE_NAME: ghcr.io/davidkims/springboot/finance-app
  IMAGE_TAG: latest
  BACKUP_VOLUME: finance_backup_vol
  BACKUP_DIR_IN_CONTAINER: /backup
  KAFKA_LOG: kafka.log

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: 📦 Checkout Code
        uses: actions/checkout@v4

      - name: 🔐 Docker Login to GitHub Container Registry
        run: echo "${{ secrets.GH_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: 🛠️ Build Docker Image
        run: |
          docker build -t $IMAGE_NAME:$IMAGE_TAG .

      - name: 🚀 Push Docker Image to GHCR
        run: |
          docker push $IMAGE_NAME:$IMAGE_TAG

      - name: 🗃️ Create Backup Volume
        run: |
          docker volume create $BACKUP_VOLUME || true

      - name: 🏃 Run Container for Backup
        run: |
          docker run --rm -d --name finance-backup-runner \
            -v $BACKUP_VOLUME:$BACKUP_DIR_IN_CONTAINER \
            $IMAGE_NAME:$IMAGE_TAG

          echo "⏳ 컨테이너 초기화 대기 중..."
          sleep 10

      - name: 💾 Simulate Transaction Log Backup
        run: |
          docker exec finance-backup-runner sh -c "cp /app/transactions.log $BACKUP_DIR_IN_CONTAINER/transactions-$(date +%Y%m%d%H%M%S).log"
          echo "📝 백업 생성 시간: $(date +%Y%m%d%H%M%S)" >> $KAFKA_LOG

      - name: 📤 Stop Container After Backup
        run: |
          docker stop finance-backup-runner || echo "이미 종료됨"

      - name: 📑 View Kafka-style Logs
        run: |
          cat $KAFKA_LOG || echo "⚠️ Kafka-style 로그 없음"
