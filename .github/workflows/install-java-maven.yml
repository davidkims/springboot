name: Install Java & Maven

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  setup-java-maven:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create install script
        run: |
          echo "ğŸ“„ Creating scripts/install_java_maven.sh"
          mkdir -p scripts
          cat << 'EOF' > scripts/install_java_maven.sh
          #!/usr/bin/env bash
          set -euo pipefail

          #â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          #â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
          JAVA_PKG="openjdk-17-jdk"
          MAVEN_PKG="maven"

          # Temurin ë°”ì´ë„ˆë¦¬ ì§ì ‘ ì„¤ì¹˜ ì˜µì…˜
          USE_TEMURIN=false      # trueë¡œ ë°”ê¾¸ë©´ Temurin ë°©ì‹ìœ¼ë¡œ ì„¤ì¹˜
          TEMURIN_VERSION="17"
          TEMURIN_TMPDIR="$(mktemp -d)"
          TEMURIN_GH_URL="https://github.com/adoptium/temurin${TEMURIN_VERSION}-binaries/releases/latest/download/OpenJDK${TEMURIN_VERSION}U-jdk_x64_linux_hotspot.tar.gz"

          #â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
          # 1) APTìœ¼ë¡œ ì„¤ì¹˜
          #â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
          if [ "\$USE_TEMURIN" = false ]; then
            echo "â–¶ apt update ë° OpenJDK+Maven ì„¤ì¹˜ ì‹œì‘"
            sudo apt-get update -y
            sudo apt-get install -y "\${JAVA_PKG}" "\${MAVEN_PKG}"

            echo -e "\nâ–¶ ì„¤ì¹˜ í™•ì¸"
            java -version
            mvn -version
            exit 0
          fi

          #â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
          # 2) Temurin ì§ì ‘ ì„¤ì¹˜ (USE_TEMURIN=true ì‹œ ë™ì‘)
          #â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
          echo "â–¶ Temurin JDK ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜ ì‹œì‘"
          cd "\$TEMURIN_TMPDIR"
          wget -O temurin-jdk.tar.gz "\$TEMURIN_GH_URL"
          echo "âœ” ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: \$(du -h temurin-jdk.tar.gz | awk '{print \$1}')"

          sudo mkdir -p /opt/java
          sudo tar -xzf temurin-jdk.tar.gz -C /opt/java
          JDIR=\$(ls /opt/java | head -n1)

          echo "â–¶ update-alternatives ì„¤ì •"
          sudo update-alternatives --install /usr/bin/java java "/opt/java/\${JDIR}/bin/java" 100
          sudo update-alternatives --install /usr/bin/javac javac "/opt/java/\${JDIR}/bin/javac" 100

          echo -e "\nâ–¶ Temurin ì„¤ì¹˜ í™•ì¸"
          java -version
          javac -version

          echo -e "\nâ–¶ Maven ì„¤ì¹˜ (APT)"
          sudo apt-get update -y
          sudo apt-get install -y "\${MAVEN_PKG}"
          mvn -version

          # ì„ì‹œ ë””ë ‰í† ë¦¬ ì •ë¦¬
          cd /tmp && rm -rf "\$TEMURIN_TMPDIR"
          EOF

          chmod +x scripts/install_java_maven.sh

      - name: Run install script
        run: |
          ./scripts/install_java_maven.sh
