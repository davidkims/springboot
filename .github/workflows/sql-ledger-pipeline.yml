name: Ledger Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  ledger:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 🛠️ Ensure Dockerfile Exists or Create
        run: |
          if [ ! -f Dockerfile ]; then
            echo 'FROM mysql:8.0' > Dockerfile
            echo 'ENV MYSQL_ROOT_PASSWORD=root' >> Dockerfile
            echo 'ENV MYSQL_DATABASE=finance_db' >> Dockerfile
            echo 'COPY init.sql /docker-entrypoint-initdb.d/' >> Dockerfile
            echo 'COPY transactions.sql /docker-entrypoint-initdb.d/' >> Dockerfile
          fi

      - name: 🧾 Ensure SQL Files Exist
        run: |
          if [ ! -f init.sql ]; then
            echo 'CREATE DATABASE IF NOT EXISTS finance_db;' > init.sql
            echo 'USE finance_db;' >> init.sql
            echo 'CREATE TABLE IF NOT EXISTS customer_ledger (' >> init.sql
            echo '  id INT AUTO_INCREMENT PRIMARY KEY,' >> init.sql
            echo '  customer_id VARCHAR(50),' >> init.sql
            echo '  transaction_type VARCHAR(20),' >> init.sql
            echo '  transaction_amount DECIMAL(18, 2),' >> init.sql
            echo '  currency VARCHAR(10),' >> init.sql
            echo '  status VARCHAR(20),' >> init.sql
            echo '  transaction_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP' >> init.sql
            echo ');' >> init.sql
          fi
          if [ ! -f transactions.sql ]; then
            echo 'USE finance_db;' > transactions.sql
            echo "INSERT INTO customer_ledger (customer_id, transaction_type, transaction_amount, currency, status) VALUES" >> transactions.sql
            echo "('CUST1001', 'credit_card', 10200.50, 'KRW', 'approved')," >> transactions.sql
            echo "('CUST1002', 'check_card', 2300.00, 'KRW', 'pending')," >> transactions.sql
            echo "('CUST1003', 'forex', 153000.00, 'USD', 'completed');" >> transactions.sql
          fi

      - name: 🐳 Build Docker Image
        run: docker build -t finance-ledger-db .

      - name: 🚀 Run MySQL Container
        run: |
          docker run -d --name finance-db -e MYSQL_ROOT_PASSWORD=root -p 3307:3306 finance-ledger-db
          sleep 30

      - name: 📄 Export Ledger CSV
        run: |
          docker exec finance-db mysql -uroot -proot -e "USE finance_db; SELECT * FROM customer_ledger INTO OUTFILE '/var/lib/mysql-files/ledger.csv' FIELDS TERMINATED BY ',' ENCLOSED BY '\"' LINES TERMINATED BY '\n';"
          docker cp finance-db:/var/lib/mysql-files/ledger.csv ./ledger.csv

      - name: 💾 SQL Backup
        run: |
          docker exec finance-db mysqldump -uroot -proot finance_db > backup.sql

      - name: 🔁 Restore to New Container (Fixed)
        run: |
          docker run -d --name restore-db -e MYSQL_ROOT_PASSWORD=root -p 3308:3306 mysql:8.0
          sleep 30
          docker cp backup.sql restore-db:/tmp/backup.sql
          docker exec restore-db bash -c "mysql -uroot -proot < /tmp/backup.sql"

      - name: 🐍 Setup Python + Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          pip3 install mysql-connector-python pillow

      - name: 📊 Generate Log Analysis Script
        run: |
          echo 'import mysql.connector' > analyze_logs.py
          echo 'import csv' >> analyze_logs.py
          echo 'conn = mysql.connector.connect(host="127.0.0.1", user="root", password="root", database="finance_db")' >> analyze_logs.py
          echo 'cursor = conn.cursor()' >> analyze_logs.py
          echo 'cursor.execute("SELECT status, COUNT(*), SUM(transaction_amount) FROM customer_ledger GROUP BY status")' >> analyze_logs.py
          echo 'status_stats = cursor.fetchall()' >> analyze_logs.py
          echo 'cursor.execute("SELECT transaction_type, COUNT(*), SUM(transaction_amount) FROM customer_ledger GROUP BY transaction_type")' >> analyze_logs.py
          echo 'type_stats = cursor.fetchall()' >> analyze_logs.py
          echo 'with open("status_stats.csv", "w") as f:' >> analyze_logs.py
          echo '  writer = csv.writer(f); writer.writerow(["Status", "Count", "Total Amount"]); writer.writerows(status_stats)' >> analyze_logs.py
          echo 'with open("type_stats.csv", "w") as f:' >> analyze_logs.py
          echo '  writer = csv.writer(f); writer.writerow(["Transaction Type", "Count", "Total Amount"]); writer.writerows(type_stats)' >> analyze_logs.py
          echo 'with open("ledger_analysis.md", "w") as f:' >> analyze_logs.py
          echo '  f.write("## Ledger Status Summary\\n\\n| Status | Count | Total Amount |\\n|--------|-------|---------------|\\n")' >> analyze_logs.py
          echo '  for row in status_stats: f.write(f"| {row[0]} | {row[1]} | {row[2]:,.2f} |\\n")' >> analyze_logs.py
          echo '  f.write("\\n## Transaction Type Summary\\n\\n| Type | Count | Total Amount |\\n|------|-------|---------------|\\n")' >> analyze_logs.py
          echo '  for row in type_stats: f.write(f"| {row[0]} | {row[1]} | {row[2]:,.2f} |\\n")' >> analyze_logs.py
          echo 'cursor.close(); conn.close()' >> analyze_logs.py

      - name: 📈 Run Log Analysis
        run: python3 analyze_logs.py

      - name: 🖼️ Generate Customer Image Script
        run: |
          echo 'import mysql.connector' > generate_customer_images.py
          echo 'from PIL import Image, ImageDraw, ImageFont' >> generate_customer_images.py
          echo 'import os' >> generate_customer_images.py
          echo 'conn = mysql.connector.connect(host="127.0.0.1", user="root", password="root", database="finance_db")' >> generate_customer_images.py
          echo 'cursor = conn.cursor()' >> generate_customer_images.py
          echo 'cursor.execute("SELECT customer_id, transaction_type, transaction_amount, currency, status FROM customer_ledger")' >> generate_customer_images.py
          echo 'records = cursor.fetchall(); os.makedirs("customer_images", exist_ok=True)' >> generate_customer_images.py
          echo 'try: font = ImageFont.truetype("DejaVuSans-Bold.ttf", 18)' >> generate_customer_images.py
          echo 'except: font = ImageFont.load_default()' >> generate_customer_images.py
          echo 'for idx, row in enumerate(records):' >> generate_customer_images.py
          echo '  customer_id, tx_type, amount, currency, status = row' >> generate_customer_images.py
          echo '  img = Image.new("RGB", (500, 200), color="white")' >> generate_customer_images.py
          echo '  draw = ImageDraw.Draw(img)' >> generate_customer_images.py
          echo '  draw.text((20, 20), f"Customer ID: {customer_id}", font=font, fill="black")' >> generate_customer_images.py
          echo '  draw.text((20, 60), f"Transaction Type: {tx_type}", font=font, fill="black")' >> generate_customer_images.py
          echo '  draw.text((20, 100), f"Amount: {amount:.2f} {currency}", font=font, fill="black")' >> generate_customer_images.py
          echo '  draw.text((20, 140), f"Status: {status}", font=font, fill="blue" if status=="approved" else "red")' >> generate_customer_images.py
          echo '  img.save(f"customer_images/customer_{idx+1}.png")' >> generate_customer_images.py
          echo 'cursor.close(); conn.close()' >> generate_customer_images.py

      - name: 🖼️ Run Customer Image Generation
        run: python3 generate_customer_images.py

      - name: ☁️ Upload All Results
        uses: actions/upload-artifact@v4
        with:
          name: ledger-assets
          path: |
            ledger.csv
            backup.sql
            status_stats.csv
            type_stats.csv
            ledger_analysis.md
            customer_images/
