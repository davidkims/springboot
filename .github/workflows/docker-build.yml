name: ğŸ”§ Docker Build and Push

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  IMAGE_NAME: myapp
  IMAGE_TAG: latest
  REGISTRY: ghcr.io
  OWNER: ${{ github.repository_owner }}

jobs:
  docker-build:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ğŸ“‚ app ë””ë ‰í† ë¦¬ ìƒì„±
      run: mkdir -p app

    - name: ğŸ³ Dockerfile ë‹¤ìš´ë¡œë“œ ë˜ëŠ” ìƒì„±
      run: |
        if [ ! -f Dockerfile ]; then
          echo "ğŸ“¥ ì›ê²©ì—ì„œ Dockerfile ë‹¤ìš´ë¡œë“œ ì‹œë„ ì¤‘..."
          curl -fsSL https://raw.githubusercontent.com/davidkims/assets/main/finance-ledger/Dockerfile -o Dockerfile || {
            echo "âš ï¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨. ê¸°ë³¸ Dockerfile ìƒì„± ì¤‘..."
            cat << 'EOF' > Dockerfile
FROM python:3.10-slim
WORKDIR /app
COPY app/ .
CMD ["python", "main.py"]
EOF
          }
        else
          echo "âœ… ê¸°ì¡´ Dockerfile ì‚¬ìš©"
        fi

    - name: ğŸ ìƒ˜í”Œ app/main.py ìƒì„± (ì—†ì„ ê²½ìš°ë§Œ)
      run: |
        if [ ! -f app/main.py ]; then
          echo 'print("Hello from Docker!")' > app/main.py
        fi

    - name: ğŸ³ Docker Build
      run: |
        docker build -t $REGISTRY/$OWNER/$IMAGE_NAME:$IMAGE_TAG .

    - name: ğŸ” Docker ë¡œê·¸ì¸ (ghcr.io ê¸°ì¤€)
      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login $REGISTRY -u $OWNER --password-stdin

    - name: ğŸ“¤ Docker ì´ë¯¸ì§€ í‘¸ì‹œ
      run: |
        docker push $REGISTRY/$OWNER/$IMAGE_NAME:$IMAGE_TAG

    - name: âœ… ì™„ë£Œ ë©”ì‹œì§€
      run: echo "ğŸ‰ Docker ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ë¹Œë“œë˜ê³  í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤: $REGISTRY/$OWNER/$IMAGE_NAME:$IMAGE_TAG"
