name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ë°°í¬ (Echo í¬í•¨)

on:
  push:
    branches:
      - main # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
  pull_request:
    branches:
      - main # main ë¸Œëœì¹˜ë¡œ í’€ ë¦¬í€˜ìŠ¤íŠ¸ ë°œìƒ ì‹œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
  workflow_dispatch: # GitHub UIì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©

env:
  # Docker ì´ë¯¸ì§€ ì´ë¦„ (ì›í•˜ëŠ” ì´ë¦„ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”)
  IMAGE_NAME: my-app-image
  # Docker ì´ë¯¸ì§€ íƒœê·¸ (Git SHAë¥¼ ì‚¬ìš©í•˜ì—¬)
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # ì´ ì‘ì—…ì„ ì‹¤í–‰í•  ìš´ì˜ì²´ì œ í™˜ê²½ì„ ì§€ì •í•©ë‹ˆë‹¤.

    # ê¶Œí•œ ì„¤ì •: Docker Hub ë˜ëŠ” GHCRì— ì´ë¯¸ì§€ë¥¼ í‘¸ì‹œí•˜ë ¤ë©´ 'packages: write' ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.
    # 'contents: read'ëŠ” ì½”ë“œ ì²´í¬ì•„ì›ƒì„ ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤.
    # 'id-token: write'ëŠ” OIDCë¥¼ í†µí•œ ì¸ì¦ì— í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (GHCR ë¡œê·¸ì¸ ì‹œ í™œìš©).
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: ğŸš€ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ’¬ ì½”ë“œ ì²´í¬ì•„ì›ƒ ì™„ë£Œ ë©”ì‹œì§€
        run: echo "--- ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œ ì²´í¬ì•„ì›ƒ ì™„ë£Œ ---"

      - name: ğŸ³ Docker ìµœì‹  ë²„ì „ ë° CLI ì„¤ì¹˜
        uses: docker/setup-docker@v4

      - name: ğŸ’¬ Docker ì—”ì§„ ë° CLI ì„¤ì¹˜ ì™„ë£Œ ë©”ì‹œì§€
        run: echo "--- Docker ì—”ì§„ ë° CLI ì„¤ì¹˜ ì™„ë£Œ ---"

      - name: â„¹ï¸ Docker CLI ë²„ì „ í™•ì¸ ë° ì •ë³´ ì¶œë ¥
        run: |
          echo "í˜„ì¬ ì‹œìŠ¤í…œì˜ Docker ë²„ì „ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:"
          docker --version
          echo "Docker Compose ë²„ì „ (ì„¤ì¹˜ë˜ì–´ ìˆëŠ” ê²½ìš°):"
          docker compose version || true # docker composeê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•Šì•„ë„ ì˜¤ë¥˜ ë°œìƒí•˜ì§€ ì•Šë„ë¡
          echo "Docker ì‹œìŠ¤í…œ ì •ë³´:"
          docker info
          echo "--- Docker CLI ì¤€ë¹„ ì™„ë£Œ ---"

      - name: ğŸ“ íŒŒì¼ ë° ë””ë ‰í† ë¦¬ ìƒì„±
        run: |
          echo "--- íŒŒì¼ ë° ë””ë ‰í† ë¦¬ ìƒì„± ì‹œì‘ ---"
          echo "ìƒˆë¡œìš´ ë””ë ‰í† ë¦¬ 'my-data-volume' ìƒì„± ì¤‘..."
          mkdir -p my-data-volume/logs
          echo "ìƒˆë¡œìš´ íŒŒì¼ 'my-data-volume/app.log' ìƒì„± ì¤‘..."
          echo "ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ë¡œê·¸: $(date)" > my-data-volume/app.log
          echo "ë˜ ë‹¤ë¥¸ íŒŒì¼ 'my-data-volume/logs/error.log' ìƒì„± ì¤‘..."
          echo "ì—ëŸ¬ ë°œìƒ: $(date)" > my-data-volume/logs/error.log
          echo "ìƒì„±ëœ íŒŒì¼ ë° ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸:"
          ls -R my-data-volume/
          echo "--- íŒŒì¼ ë° ë””ë ‰í† ë¦¬ ìƒì„± ì™„ë£Œ ---"

      - name: âš™ï¸ Docker Buildx ì„¤ì • (ì„ íƒ ì‚¬í•­:ë©€í‹° í”Œë«í¼ ë¹Œë“œ ë° ìºì‹±ì— ìœ ìš©)
        uses: docker/setup-buildx-action@v3

      - name: ğŸ’¬ Docker Buildx ì„¤ì • ì™„ë£Œ ë©”ì‹œì§€
        run: echo "--- Docker Buildx ì„¤ì • ì™„ë£Œ ---"

      # --- â†“â†“â†“ ì´ ë¶€ë¶„ì—ì„œ ì˜¤ë¥˜ê°€ ê³„ì† ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤. â†“â†“â†“ ---
      - name: ğŸ”‘ Docker Hub ë¡œê·¸ì¸ (ì„ íƒ ì‚¬í•­:Docker Hubì— í‘¸ì‹œí•  ê²½ìš°)
        # secrets.DOCKER_USERNAMEê³¼ secrets.DOCKER_PASSWORDê°€ ëª¨ë‘ ì •ì˜ë˜ì–´ ìˆê³  ë¹„ì–´ìˆì§€ ì•Šì„ ë•Œë§Œ ì‹¤í–‰
        # GitHub Actions í‘œí˜„ì‹ì—ì„œ ì‹œí¬ë¦¿ì´ ì¡´ì¬í•˜ê³  ê°’ì´ ë¹„ì–´ìˆì§€ ì•Šì€ì§€ í™•ì¸í•˜ëŠ” í‘œì¤€ ë°©ì‹ì…ë‹ˆë‹¤.
        # ì´ ë‹¨ê³„ê°€ ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œí‚¨ë‹¤ë©´, GitHub ë¦¬í¬ì§€í† ë¦¬ ì„¤ì •ì—ì„œ DOCKER_USERNAMEê³¼ DOCKER_PASSWORD ì‹œí¬ë¦¿ì´
        # ì •í™•í•œ ì´ë¦„ìœ¼ë¡œ ë“±ë¡ë˜ì–´ ìˆëŠ”ì§€ ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.
        if: ${{ secrets.DOCKER_USERNAME && secrets.DOCKER_PASSWORD }} # L75
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ’¬ Docker Hub ë¡œê·¸ì¸ ì‹œë„ ì™„ë£Œ ë©”ì‹œì§€
        # ìœ„ ë¡œê·¸ì¸ ë‹¨ê³„ì™€ ë™ì¼í•œ ì¡°ê±´ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        if: ${{ secrets.DOCKER_USERNAME && secrets.DOCKER_PASSWORD }} # L82
        run: echo "--- Docker Hub ë¡œê·¸ì¸ ì‹œë„ ì™„ë£Œ (ì‹œí¬ë¦¿ì´ ìˆëŠ” ê²½ìš°) ---"
      # --- â†‘â†‘â†‘ ì´ ë¶€ë¶„ì—ì„œ ì˜¤ë¥˜ê°€ ê³„ì† ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤. â†‘â†‘â†‘ ---

      - name: ğŸ”‘ GitHub Container Registry (GHCR) ë¡œê·¸ì¸
        # GHCRì— í‘¸ì‹œí•  ê²½ìš°, GITHUB_TOKENì„ ì‚¬ìš©í•˜ì—¬ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        # GITHUB_TOKENì€ ê¸°ë³¸ì ìœ¼ë¡œ ì œê³µë˜ë¯€ë¡œ ë³„ë„ì˜ 'if' ì¡°ê±´ ì—†ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ’¬ GHCR ë¡œê·¸ì¸ ì‹œë„ ì™„ë£Œ ë©”ì‹œì§€
        run: echo "--- GHCR ë¡œê·¸ì¸ ì‹œë„ ì™„ë£Œ ---"

      - name: ğŸ—ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile # Dockerfile ê²½ë¡œ ì§€ì •
          tags: |
            ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest # GHCRì— í‘¸ì‹œí•  ë•Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ìµœì‹  íƒœê·¸
          outputs: type=docker # ë¹Œë“œëœ ì´ë¯¸ì§€ë¥¼ Docker ë°ëª¬ì— ë¡œë“œí•˜ì—¬ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.
          push: false # ì¼ë‹¨ ë¹Œë“œí•˜ê³  í‘¸ì‹œëŠ” í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

      - name: ğŸ’¬ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘ ë° ì™„ë£Œ ë©”ì‹œì§€
        run: |
          echo "--- Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘ ---"
          echo "ë¹Œë“œ ì¤‘ì¸ ì´ë¯¸ì§€: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          echo "Dockerfile ê²½ë¡œ: ./Dockerfile"
          echo "--- Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ ---"

      - name: ğŸ” ë¹Œë“œëœ Docker ì´ë¯¸ì§€ í™•ì¸
        run: |
          echo "--- ë¹Œë“œëœ Docker ì´ë¯¸ì§€ ëª©ë¡ ---"
          docker images
          echo "--- ì´ë¯¸ì§€ í™•ì¸ ì™„ë£Œ ---"

      - name: ğŸ“¤ Docker ì´ë¯¸ì§€ í‘¸ì‹œ (Docker Hub)
        # secrets.DOCKER_USERNAMEê³¼ secrets.DOCKER_PASSWORDê°€ ëª¨ë‘ ì •ì˜ë˜ì–´ ìˆê³  ë¹„ì–´ìˆì§€ ì•Šì„ ë•Œë§Œ í‘¸ì‹œ ì‹¤í–‰
        if: ${{ secrets.DOCKER_USERNAME && secrets.DOCKER_PASSWORD }}
        run: |
          echo "--- Docker Hubë¡œ ì´ë¯¸ì§€ í‘¸ì‹œ ì‹œì‘ ---"
          docker push ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          docker push ${{ env.IMAGE_NAME }}:latest # ìµœì‹  íƒœê·¸ë„ í‘¸ì‹œ
          echo "--- Docker Hub í‘¸ì‹œ ì™„ë£Œ ---"

      - name: ğŸ“¤ Docker ì´ë¯¸ì§€ í‘¸ì‹œ (GitHub Container Registry)
        run: |
          echo "--- GHCRë¡œ ì´ë¯¸ì§€ í‘¸ì‹œ ì‹œì‘ ---"
          docker push ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          docker push ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest
          echo "--- GHCR í‘¸ì‹œ ì™„ë£Œ ---"

      - name: ğŸƒ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ì„ íƒ ì‚¬í•­:ë¹Œë“œëœ ì´ë¯¸ì§€ í…ŒìŠ¤íŠ¸ìš©)
        run: |
          echo "--- Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹œì‘ (í…ŒìŠ¤íŠ¸ìš©) ---"
          echo "ì‹¤í–‰ ì¤‘ì¸ ì´ë¯¸ì§€: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          docker run --rm ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          echo "--- Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì™„ë£Œ ---"
