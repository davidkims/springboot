name: Generate and Backup Corporate Banking Data

on:
  workflow_dispatch: # GitHub UIì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê°€ëŠ¥
  push:
    branches: ["main"] # 'main' ë¸Œëœì¹˜ì— ì½”ë“œê°€ í‘¸ì‹œë  ë•Œ ì›Œí¬í”Œë¡œìš° ìë™ ì‹¤í–‰

jobs:
  generate-and-backup:
    runs-on: ubuntu-latest # ìµœì‹  Ubuntu í™˜ê²½ì—ì„œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4 # GitHub ì €ì¥ì†Œ ì½”ë“œë¥¼ ì›Œì»¤ì— ì²´í¬ì•„ì›ƒ

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5 # Python 3.11 í™˜ê²½ ì„¤ì •
        with:
          python-version: '3.11'

      - name: ğŸ“¥ Install Required Packages
        run: |
          pip install pyyaml faker # YAML ì²˜ë¦¬(`pyyaml`) ë° ë”ë¯¸ ë°ì´í„° ìƒì„±(`faker`)ì„ ìœ„í•œ Python íŒ¨í‚¤ì§€ ì„¤ì¹˜

      - name: ğŸ“„ Generate YAML Configuration
        run: |
          mkdir -p config # 'config' ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒì„±
          # banking_schema.yaml íŒŒì¼ ìƒì„± ë° ì˜ˆì‹œ ë‚´ìš© ì¶”ê°€
          # ì‹¤ì œ ê¸ˆìœµ ë°ì´í„° ìŠ¤í‚¤ë§ˆì— ë§ì¶° ì´ ë¶€ë¶„ì„ ìˆ˜ì •í•˜ê±°ë‚˜,
          # ë¦¬í¬ì§€í† ë¦¬ì— ì´ íŒŒì¼ì„ ë¯¸ë¦¬ ì»¤ë°‹í•´ ë‘ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
          echo "users:" > config/banking_schema.yaml
          echo "  - id: 1" >> config/banking_schema.yaml
          echo "    name: John Doe" >> config/banking_schema.yaml
          echo "    email: john.doe@example.com" >> config/banking_schema.yaml
          echo "    status: active" >> config/banking_schema.yaml
          echo "accounts:" >> config/banking_schema.yaml
          echo "  - account_id: 1001" >> config/banking_schema.yaml
          echo "    user_id: 1" >> config/banking_schema.yaml
          echo "    balance: 100000.00" >> config/banking_schema.yaml
          echo "    currency: KRW" >> config/banking_schema.yaml
          echo "    type: savings" >> config/banking_schema.yaml
          echo "transactions:" >> config/banking_schema.yaml
          echo "  - transaction_id: 5001" >> config/banking_schema.yaml
          echo "    account_id: 1001" >> config/banking_schema.yaml
          echo "    amount: -5000.00" >> config/banking_schema.yaml
          echo "    type: withdrawal" >> config/banking_schema.yaml
          echo "    date: '2025-06-01'" >> config/banking_schema.yaml
          echo "INFO: config/banking_schema.yaml íŒŒì¼ ìƒì„± ì™„ë£Œ"

      - name: ğŸ§ª Validate YAML File
        run: |
          # ìƒì„±ëœ YAML íŒŒì¼ì˜ ìœ íš¨ì„±ì„ ê²€ì‚¬í•©ë‹ˆë‹¤.
          # Python ìŠ¤í¬ë¦½íŠ¸ ë“¤ì—¬ì“°ê¸°ì— ìœ ì˜í•˜ì„¸ìš” (EOF ì•„ë˜ ë‘ ì¹¸ ë“¤ì—¬ì“°ê¸°).
          python - <<EOF
          import yaml
          try:
              with open('config/banking_schema.yaml', 'r') as f:
                  data = yaml.safe_load(f)
              print('âœ… YAML Validation Passed')
          except FileNotFoundError:
              print("Error: 'config/banking_schema.yaml' not found.")
              exit(1) # íŒŒì¼ì´ ì—†ìœ¼ë©´ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨
          except yaml.YAMLError as exc:
              print(f"Error parsing YAML file: {exc}")
              exit(1) # YAML êµ¬ë¬¸ ì˜¤ë¥˜ ì‹œ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨
          EOF

      - name: ğŸ“¦ Simulate Data Extraction
        run: |
          mkdir -p output # 'output' ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒì„±
          echo "INFO: ë°ì´í„° ì¶”ì¶œ ì‹œì‘"
          # ì—¬ê¸°ì— ì‹¤ì œ ë°ì´í„° ì¶”ì¶œ ë¡œì§ì„ ì¶”ê°€í•˜ì„¸ìš”.
          # í˜„ì¬ëŠ” ë”ë¯¸ SQL íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
          touch output/corporate_banking_backup.sql
          echo '-- SQL Dump Placeholder for Corporate Banking Data' > output/corporate_banking_backup.sql
          echo "INFO: ë°ì´í„° ì¶”ì¶œ ì™„ë£Œ: output/corporate_banking_backup.sql"

      - name: ğŸ” Encrypt Backup File
        run: |
          # ë°±ì—… íŒŒì¼ì„ ZIPìœ¼ë¡œ ì•”í˜¸í™”í•©ë‹ˆë‹¤.
          # ë¹„ë°€ë²ˆí˜¸ëŠ” GitHub Secretsì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤. `secrets.BACKUP_PASSWORD`ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
          # ë¹ˆ ë¹„ë°€ë²ˆí˜¸ë¡œ ì¸í•œ ì˜¤ë¥˜ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ë°˜ë“œì‹œ GitHub Secretsì— ê°’ì„ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.
          zip -P "${{ secrets.BACKUP_PASSWORD }}" output/corporate_banking_backup.zip output/corporate_banking_backup.sql
          echo "âœ… ë°±ì—… íŒŒì¼ ì•”í˜¸í™” ì™„ë£Œ"

      - name: â˜ Install OCI CLI
        run: |
          # OCI CLIë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì„¤ì¹˜í•©ë‹ˆë‹¤.
          # oracle-actions/setup-oci-cli ì•¡ì…˜ ì‚¬ìš© ì‹œ ë°œìƒí•˜ëŠ” ì˜¤ë¥˜ë¥¼ ìš°íšŒí•©ë‹ˆë‹¤.
          # ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ê³  ì‹¤í–‰í•©ë‹ˆë‹¤.
          # --accept-all-defaults: ëª¨ë“  ê¸°ë³¸ê°’ì„ ìˆ˜ë½í•˜ì—¬ ë¹„ëŒ€í™”í˜• ì„¤ì¹˜ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.
          # --install-dir /usr/local/bin: OCI CLI ì‹¤í–‰ íŒŒì¼ì„ /usr/local/binì— ì„¤ì¹˜í•˜ì—¬ PATHì— ìë™ìœ¼ë¡œ ì¶”ê°€ë˜ë„ë¡ í•©ë‹ˆë‹¤.
          echo "â„¹ï¸ OCI CLI ì„¤ì¹˜ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
          curl -L -O https://raw.githubusercontent.com/oracle/oci-cli/master/install.sh
          bash install.sh --accept-all-defaults --install-dir /usr/local/bin
          echo "âœ… OCI CLI ì„¤ì¹˜ ì™„ë£Œ"

      - name: â˜ Upload to OCI Object Storage (CLI)
        env:
          # OCI CLI ì¸ì¦ì„ ìœ„í•œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •.
          # ëª¨ë“  ê°’ì€ GitHub Secretsì—ì„œ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜µë‹ˆë‹¤.
          OCI_CLI_AUTH: "api_key"
          OCI_CLI_USER: ${{ secrets.OCI_USER_OCID }}
          OCI_CLI_TENANCY: ${{ secrets.OCI_TENANCY_OCID }}
          OCI_CLI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
          OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_API_KEY }}
          OCI_CLI_REGION: "ap-seoul-1" # ì‹¤ì œ OCI ë¦¬ì „ì— ë§ê²Œ ë³€ê²½í•˜ì„¸ìš”.
        run: |
          # OCI API í‚¤ íŒŒì¼ ìƒì„± ë° ê¶Œí•œ ì„¤ì •.
          # OCI_CLI_KEY_CONTENT Secretì— OCI API ê°œì¸ í‚¤ ë‚´ìš©ì´ PEM í˜•ì‹ìœ¼ë¡œ ë“¤ì–´ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
          mkdir -p ~/.oci
          echo "$OCI_CLI_KEY_CONTENT" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          
          # OCI CLIê°€ PATHì— ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸
          # which oci || (echo "Error: oci command not found after installation. Exiting." && exit 1)
          
          # OCI Object Storageì— ì•”í˜¸í™”ëœ ë°±ì—… íŒŒì¼ ì—…ë¡œë“œ.
          # --bucket-nameì€ OCIì— ë¯¸ë¦¬ ìƒì„±ëœ ë²„í‚· ì´ë¦„ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
          oci os object put \
            --bucket-name backups \
            --file output/corporate_banking_backup.zip \
            --name corporate_banking_backup.zip \
            --force
          echo "âœ… ë°±ì—… íŒŒì¼ OCI Object Storage ì—…ë¡œë“œ ì™„ë£Œ"

      - name: â˜‘ï¸ NetBackup CLI ì‹¤í–‰ (ì˜ˆì‹œ)
        run: |
          echo "ğŸ”„ NetBackup CLI ê°€ì • ì‹¤í–‰ ì¤‘..."
          # ì‹¤ì œ NetBackup í™˜ê²½ì´ë¼ë©´, ì—¬ê¸°ì— ì‹¤ì œ NetBackup CLI ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
          # ì˜ˆ: /usr/openv/netbackup/bin/bpbackup -i -L /tmp/backup_log -f output/corporate_banking_backup.zip
          echo "bpbackup -f output/corporate_banking_backup.zip"
          echo "âš ï¸ ì´ ìŠ¤í…ì€ NetBackup CLIì˜ ì‹¤í–‰ì„ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤."
          echo "âš ï¸ ì‹¤ì œ NetBackupì´ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•˜ë©°, CLI ê²½ë¡œë¥¼ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤."

      - name: âœ… ì™„ë£Œ ë©”ì‹œì§€
        run: echo "âœ… ê¸°ì—… ê¸ˆìœµ ë°ì´í„° ë°±ì—… ë° ì•”í˜¸í™”, OCI ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
