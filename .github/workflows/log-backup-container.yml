name: ğŸ“¦ Transaction Log Backup + Release Upload

on:
  workflow_dispatch:

jobs:
  backup_and_release:
    runs-on: ubuntu-latest

    env:
      BACKUP_DIR: /opt/backup/logs
      LOG_DIR_KR: /opt/logs/kr
      LOG_DIR_VN: /opt/logs/vn
      LOG_DIR_BTC: /opt/logs/btc
      CONTAINER_IMAGE: alpine:latest

    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ•’ Generate Timestamp and Container Name
        id: vars
        run: |
          TS=$(date +%Y%m%d%H%M%S)
          echo "timestamp=$TS" >> $GITHUB_OUTPUT
          echo "container=log-backup-$TS" >> $GITHUB_OUTPUT
          echo "tag=log-backup-$TS" >> $GITHUB_OUTPUT
          echo "report=report-$TS.tar.gz" >> $GITHUB_OUTPUT

      - name: ğŸ“ Prepare Log Directories and Sample Logs
        run: |
          sudo mkdir -p $LOG_DIR_KR $LOG_DIR_VN $LOG_DIR_BTC $BACKUP_DIR

          echo "[KR] 2025-06-02 ì¹´ë“œê²°ì œ: â‚©10000 | ìŠ¹ì¸ì™„ë£Œ" | sudo tee $LOG_DIR_KR/log-kr.txt
          echo "[VN] 2025-06-02 Thanh toÃ¡n tháº»: â‚«200000 | ThÃ nh cÃ´ng" | sudo tee $LOG_DIR_VN/log-vn.txt
          echo "[BTC] 2025-06-02 BTC ê±°ë˜: 0.005 BTC ì „ì†¡ ì™„ë£Œ" | sudo tee $LOG_DIR_BTC/log-btc.txt

          sudo chmod -R 777 /opt/logs $BACKUP_DIR

      - name: ğŸ³ Run Backup Container (Persistent)
        run: |
          docker run -d \
            --name ${{ steps.vars.outputs.container }} \
            -v /opt/logs:/data/logs:ro \
            -v $BACKUP_DIR:/data/backup \
            $CONTAINER_IMAGE \
            sh -c "mkdir -p /data/backup/${{ steps.vars.outputs.timestamp }} && cp -r /data/logs/* /data/backup/${{ steps.vars.outputs.timestamp }}/"

          sleep 10

      - name: ğŸ“¦ Compress Logs for Release
        run: |
          REPORT_FILE=${{ steps.vars.outputs.report }}
          cd $BACKUP_DIR
          tar -czf $REPORT_FILE ${{ steps.vars.outputs.timestamp }}
          mv $REPORT_FILE $GITHUB_WORKSPACE

      - name: ğŸš€ Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          name: "ğŸ“‹ Log Backup ${{ steps.vars.outputs.timestamp }}"
          body: |
            KR, VN, BTC ê±°ë˜ ë¡œê·¸ ë°±ì—… ë³´ê³ ì„œ
            - ìƒì„± ì‹œê°: ${{ steps.vars.outputs.timestamp }}
          files: report-${{ steps.vars.outputs.timestamp }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
