# .github/workflows/jfrog-sast-scan.yml
name: "JFrog SAST Scan"

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: '25 4 * * 1'  # Îß§Ï£º ÏõîÏöîÏùº UTC 04:25

env:
  # JFrog Platform(Base) URL: https://<your-domain>.jfrog.io
  JF_URL:           ${{ secrets.JF_URL }}
  # JFrog Xray URL:  https://<your-domain>.jfrog.io/xray
  JF_XRAY_URL:      ${{ secrets.JF_XRAY_URL }}
  # JFrog Access Token (Artifactory/Xray Î™®Îëê Í∂åÌïú Ìè¨Ìï®)
  JF_TOKEN:         ${{ secrets.JF_ACCESS_TOKEN }}

jobs:
  analyze:
    name: JFrog SAST Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16'

      - name: Install JFrog CLI
        run: |
          echo "üì¶ Installing JFrog CLI via npm..."
          if npm install -g jfrog-cli-v2-jf; then
            echo "‚úÖ JFrog CLI installed (npm)"
          else
            echo "‚ö†Ô∏è npm install failed, falling back to binary download"
            curl -fL https://getcli.jfrog.io | sh
            chmod +x jfrog
            sudo mv jfrog /usr/local/bin/jfrog
            echo "‚úÖ JFrog CLI installed (binary)"
          fi

      - name: Verify JFrog CLI version
        run: |
          echo "üîç Verifying JFrog CLI version..."
          jf --version

      - name: Create JFrog CLI config dir
        run: |
          mkdir -p ~/.jfrog
          echo "üìÇ ~/.jfrog directory ready"

      - name: Configure JFrog CLI (Artifactory + Xray)
        run: |
          echo "üîê Configuring JFrog CLI with Artifactory & Xray endpoints..."
          jf c add default \
            --url="$JF_URL" \
            --xray-url="$JF_XRAY_URL" \
            --access-token="$JF_TOKEN" \
            --interactive=false
          echo "‚úÖ JFrog CLI configured (default)"

      - name: Install dependencies if needed
        run: |
          if [ -f package.json ]; then
            echo "üì• package.json found ‚Äî running npm ci"
            npm ci
          else
            echo "‚ÑπÔ∏è No package.json ‚Äî skipping npm ci"
          fi

      - name: Create reports directory
        run: |
          mkdir -p reports
          echo "üìÇ reports directory created"

      - name: Run JFrog SAST scan
        run: |
          echo "üîé Running JFrog SAST scan..."
          jf audit --sast --format=sarif > reports/jfrog_sast.sarif
          echo "‚úÖ Scan complete: reports/jfrog_sast.sarif"

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/jfrog_sast.sarif
