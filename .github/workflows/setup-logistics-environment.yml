name: Setup Logistics + Loans Environment

on:
  workflow_dispatch:

jobs:
  setup-loans:
    runs-on: ubuntu-latest
    steps:

      # 1. 레포지토리 체크아웃
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. PostgreSQL 설치 및 서비스 시작
      - name: Install PostgreSQL
        run: |
          echo "[+] Installing PostgreSQL"
          sudo apt-get update
          sudo apt-get install -y postgresql postgresql-contrib
          sudo systemctl enable postgresql
          sudo systemctl start postgresql
          echo "[✔] PostgreSQL started"

      # 3. loans 데이터베이스 및 거래 원장 테이블 생성
      - name: Create loans DB and loan_ledger table
        run: |
          echo "[+] Creating 'loans' database"
          sudo -u postgres psql -c "CREATE DATABASE loans;" || echo "[i] Database already exists"
          echo "[+] Creating loan_ledger table"
          sudo -u postgres psql -d loans -c "\
            CREATE TABLE IF NOT EXISTS loan_ledger (
              loan_id SERIAL PRIMARY KEY,
              customer_id INT NOT NULL,
              amount NUMERIC(12, 2) NOT NULL,
              currency VARCHAR(10) DEFAULT 'KRW',
              interest_rate NUMERIC(5, 2),
              start_date DATE,
              end_date DATE,
              status VARCHAR(20) DEFAULT 'active'
            );"
          echo "[✔] loan_ledger 테이블 생성 완료"

      # 4. Salesforce CLI 설치 - 안정적이고 최신 방식으로 대체
      - name: Install Salesforce CLI (sf)
        run: |
          echo "[+] Installing Salesforce CLI (@salesforce/cli)"
          npm install --global @salesforce/cli || echo "[!] sf CLI 설치 실패"
          sf --version || echo "[!] sf CLI 버전 확인 실패"

      # 5. 오류가 발생한 기존 sfdx CLI 경고 제거
      - name: (Optional) Remove deprecated sfdx-cli
        run: |
          echo "[i] sfdx-cli 제거 (선택사항)"
          npm uninstall --global sfdx-cli || echo "[!] 기존 sfdx-cli 제거 실패 (무시됨)"

      # 6. 초기 테스트 레코드 삽입 (예시)
      - name: Insert test loans (optional)
        run: |
          echo "[+] Test loan 데이터 삽입"
          sudo -u postgres psql -d loans -c "\
            INSERT INTO loan_ledger (customer_id, amount, interest_rate, start_date, end_date)
            VALUES
              (1, 1000000, 3.5, CURRENT_DATE, CURRENT_DATE + INTERVAL '365 days'),
              (2, 500000, 2.9, CURRENT_DATE, CURRENT_DATE + INTERVAL '180 days');"
          echo "[✔] Test 데이터 삽입 완료"
