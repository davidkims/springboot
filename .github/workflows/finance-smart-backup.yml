name: ğŸ”„ Finance Smart Backup with PostgreSQL & Kafka

on:
  workflow_dispatch:

jobs:
  finance-backup:
    runs-on: ubuntu-latest

    env:
      ROOT_PASS: rootpass123
      SQL_DIR: /opt/finance/sql
      BACKUP_DIR: /opt/finance/backups
      KAFKA_LOG: /opt/finance/kafka.log
      PG_DB: postgres_finance
      PG_USER: postgres
      PG_PASS: pgpass
      TYPES: |
        bank_transfer
        check_card
        credit_card
        bitcoin
        stock
        futures

    steps:
      - name: ğŸ“ ë””ë ‰í† ë¦¬ ì¤€ë¹„ ë° SQL ìƒì„±
        run: |
          sudo mkdir -p $SQL_DIR $BACKUP_DIR
          sudo chmod -R 777 /opt/finance
          echo "CREATE TABLE IF NOT EXISTS transfers (id SERIAL PRIMARY KEY, type VARCHAR(30), amount NUMERIC, currency VARCHAR(5), status VARCHAR(20));" > $SQL_DIR/init.sql
          echo "INSERT INTO transfers(type, amount, currency, status) VALUES
            ('bank_transfer', 100000, 'KRW', 'completed'),
            ('check_card', 20000, 'KRW', 'completed'),
            ('credit_card', 150000, 'KRW', 'completed'),
            ('bitcoin', 0.03, 'BTC', 'pending'),
            ('stock', 1000000, 'KRW', 'completed'),
            ('futures', 500000, 'KRW', 'pending');" >> $SQL_DIR/init.sql

      - name: ğŸ˜ PostgreSQL ì„¤ì¹˜ ë° ì´ˆê¸°í™”
        run: |
          sudo apt-get update && sudo apt-get install -y postgresql
          sudo -u postgres psql -c "CREATE DATABASE $PG_DB;"
          sudo -u postgres psql -d $PG_DB -c "CREATE TABLE IF NOT EXISTS logs (type VARCHAR, status VARCHAR, backup_time TIMESTAMP);"

      - name: ğŸ” ê±°ë˜ìœ í˜• ì»¨í…Œì´ë„ˆ ì²˜ë¦¬ ë£¨í”„
        run: |
          for TYPE in $TYPES; do
            DB_NAME="db_${TYPE}"
            DB_USER="user_${TYPE}"
            DB_PASS="pass_${TYPE}"
            CONTAINER="mysql_${TYPE}"
            PORT=$((3307 + RANDOM % 1000))

            echo "ğŸš€ $TYPE ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘ (í¬íŠ¸: $PORT)"
            docker run -d --rm \
              --name $CONTAINER \
              -e MYSQL_ROOT_PASSWORD=$ROOT_PASS \
              -e MYSQL_DATABASE=$DB_NAME \
              -e MYSQL_USER=$DB_USER \
              -e MYSQL_PASSWORD=$DB_PASS \
              -v $SQL_DIR:/docker-entrypoint-initdb.d \
              -p $PORT:3306 \
              mysql:8.0

            echo "ğŸ•’ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘..."
            sleep 30

            STATUS=$(mysql -h 127.0.0.1 -P $PORT -u$DB_USER -p$DB_PASS -N -e "USE $DB_NAME; SELECT COUNT(*) FROM transfers WHERE type='$TYPE' AND status='completed';")

            echo "ğŸ” $TYPE completed ìƒíƒœ ê°œìˆ˜: $STATUS"

            if [ "$STATUS" != "0" ]; then
              BACKUP_FILE=$BACKUP_DIR/${TYPE}_backup.sql
              mysqldump --no-tablespaces -h 127.0.0.1 -P $PORT -u$DB_USER -p$DB_PASS $DB_NAME > $BACKUP_FILE
              echo "âœ… ë°±ì—… ì™„ë£Œ: $BACKUP_FILE"

              TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
              sudo -u postgres psql -d $PG_DB -c "INSERT INTO logs VALUES ('$TYPE', 'completed', '$TIMESTAMP');"
              echo "$TIMESTAMP [$TYPE] ë°±ì—… ì™„ë£Œ" >> $KAFKA_LOG
            else
              echo "â­ï¸ ë°±ì—… ìƒëµ: ì•„ì§ pending ìƒíƒœ"
            fi

            echo "ğŸ”„ pending ìƒíƒœ íŠ¸ëœì­ì…˜ì„ completed ë¡œ ì „í™˜ ì¤‘..."
            mysql -h 127.0.0.1 -P $PORT -u$DB_USER -p$DB_PASS -e "USE $DB_NAME; UPDATE transfers SET status='completed' WHERE type='$TYPE' AND status='pending';"

            STATUS_AFTER=$(mysql -h 127.0.0.1 -P $PORT -u$DB_USER -p$DB_PASS -N -e "USE $DB_NAME; SELECT COUNT(*) FROM transfers WHERE type='$TYPE' AND status='completed';")

            if [ "$STATUS_AFTER" -gt "$STATUS" ]; then
              echo "ğŸ” ìƒíƒœ ë³€ê²½ ê°ì§€ë¨ â†’ ì¬ë°±ì—… ìˆ˜í–‰"
              REBACKUP=$BACKUP_DIR/${TYPE}_rebaked.sql
              mysqldump --no-tablespaces -h 127.0.0.1 -P $PORT -u$DB_USER -p$DB_PASS $DB_NAME > $REBACKUP
              echo "â™»ï¸ ì¬ë°±ì—… ì™„ë£Œ: $REBACKUP"
              TIMESTAMP2=$(date +'%Y-%m-%d %H:%M:%S')
              sudo -u postgres psql -d $PG_DB -c "INSERT INTO logs VALUES ('$TYPE', 'rebackup', '$TIMESTAMP2');"
              echo "$TIMESTAMP2 [$TYPE] ì¬ë°±ì—… ì™„ë£Œ" >> $KAFKA_LOG
            fi

            docker stop $CONTAINER
          done

      - name: ğŸ“¦ ëª¨ë“  ë°±ì—… ì••ì¶•
        run: |
          cd $BACKUP_DIR
          tar -czf finance-full-backups-${{ github.run_id }}.tar.gz *.sql
          ls -lh $BACKUP_DIR

      - name: ğŸ“œ PostgreSQL ë¡œê·¸ ë³´ê¸°
        run: |
          sudo -u postgres psql -d $PG_DB -c "SELECT * FROM logs;"

      - name: ğŸ“„ Kafka í˜•ì‹ ë¡œê·¸ ì¶œë ¥
        run: |
          echo "ğŸ“„ Kafka Log:"
          cat $KAFKA_LOG || echo "No kafka-style logs found"
