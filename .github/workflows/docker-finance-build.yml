name: ğŸ³ Build and Optional Push Docker Image

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  docker-build:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: ghcr.io/davidkims/finance-app
      IMAGE_TAG: latest
      GHCR_PAT: ${{ secrets.GHCR_PAT || '' }}  # optional
      KAFKA_LOG: kafka.log

    steps:
      - name: ğŸ“‚ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Ensure Dockerfile Exists (Autogenerate if missing)
        run: |
          if [ ! -f Dockerfile ]; then
            echo "âš ï¸ Dockerfile not found. Creating default Dockerfile..."
            cat <<EOF > Dockerfile
FROM alpine:latest

RUN mkdir -p /app
RUN echo "\$(date) ê³„ì¢Œì´ì²´ ìƒíƒœ: ì™„ë£Œ" > /app/transactions.log
RUN echo "\$(date) ì‹ ìš©ì¹´ë“œ ìƒíƒœ: ì™„ë£Œ" >> /app/transactions.log
RUN echo "\$(date) ë¹„íŠ¸ì½”ì¸ ìƒíƒœ: ì§„í–‰ì¤‘" >> /app/transactions.log

CMD ["cat", "/app/transactions.log"]
EOF
          else
            echo "âœ… Dockerfile already exists."
          fi

      - name: ğŸ—ï¸ Build Docker Image
        run: docker build -t $IMAGE_NAME:$IMAGE_TAG .

      - name: ğŸ” Conditional Docker Login (GHCR)
        if: env.GHCR_PAT != ''
        run: echo "${GHCR_PAT}" | docker login ghcr.io -u davidkims --password-stdin

      - name: ğŸš€ Conditional Push to GHCR
        if: env.GHCR_PAT != ''
        run: docker push $IMAGE_NAME:$IMAGE_TAG

      - name: ğŸ“‹ Simulate Kafka Log Output
        run: |
          echo "$(date '+%Y-%m-%d %H:%M:%S') [backup] ê±°ë˜ ìƒíƒœ: ì™„ë£Œ" >> $KAFKA_LOG
          cat $KAFKA_LOG || echo "âš ï¸ ë¡œê·¸ ì—†ìŒ"
