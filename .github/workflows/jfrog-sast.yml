name: â™¾ï¸ Transfer Log Backup & Load - Download Scripts via curl

on:
  schedule:
    - cron: '*/5 * * * *'

jobs:
  transfer_log_and_load:
    runs-on: ubuntu-latest

    env:
      TRANSFER_LOG_DIR: /opt/logs/transfer
      BACKUP_DIR:        /opt/backup/transfer
      MYSQL_ROOT_PASS:   root
      MYSQL_DB:          transactions
      REPO_RAW_BASE:     https://raw.githubusercontent.com/${{ github.repository }}/main
      LOCAL_BRANCH:      main

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”„ Sync remote branch
        run: |
          echo "ğŸ”„ ì‹œì‘: ì›ê²© ë¸Œëœì¹˜ ì—…ë°ì´íŠ¸"
          git fetch origin $LOCAL_BRANCH
          echo "ìµœì¢… ë™ê¸°í™”ë¥¼ ìœ„í•´ ì›ê²© ë¸Œëœì¹˜ '$LOCAL_BRANCH'ë¥¼ í’€í•©ë‹ˆë‹¤."
          git pull --ff-only origin $LOCAL_BRANCH || {
            echo "âŒ ì˜¤ë¥˜: 'git pull --ff-only'ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì›Œí¬í”Œë¡œìš°ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤.";
            exit 1;
          }
          echo "âœ… ì›ê²© ë¸Œëœì¹˜ ë™ê¸°í™” ì™„ë£Œ"

      - name: ğŸ“ Prepare directories
        run: |
          echo "ğŸ“ ì‹œì‘: ë””ë ‰í† ë¦¬ ì¤€ë¹„"
          sudo mkdir -p "$TRANSFER_LOG_DIR" "$BACKUP_DIR"
          sudo chmod -R 777 "$TRANSFER_LOG_DIR" "$BACKUP_DIR"
          echo "âœ… ë””ë ‰í† ë¦¬ ì¤€ë¹„ ì™„ë£Œ"

      - name: ğŸ’¾ Generate 60 corporate transfer logs
        run: |
          echo "ğŸ•’ ì‹œì‘: 60ê±´ ê±°ë˜ ë¡œê·¸ ìƒì„±"
          sudo rm -f "$TRANSFER_LOG_DIR"/*.txt
          for i in $(seq 1 60); do
            echo "ğŸ“„ Generating log #$i"
            TS=$(date +'%Y-%m-%d %H:%M:%S')
            AMT=$((RANDOM % 900000 + 100000))
            LOG="[TRANSFER] $TS | ID:$i | ê¸ˆì•¡:â‚©${AMT} | ê³„ì¢Œ:110-123-4567$(printf '%02d' $i)"
            echo "$LOG" | sudo tee "$TRANSFER_LOG_DIR/transfer-$i.txt" >/dev/null
          done
          echo "âœ… 60ê±´ ê±°ë˜ ë¡œê·¸ ìƒì„± ì™„ë£Œ"

      - name: ğŸ“¦ Backup logs into timestamped folder
        id: backup
        run: |
          echo "ğŸ“¦ ì‹œì‘: ë°±ì—… ìƒì„±"
          TSF=$(date +'%Y%m%d_%H%M%S')
          echo "ts_folder=$TSF" >> "$GITHUB_OUTPUT"
          DEST="$BACKUP_DIR/$TSF"
          sudo mkdir -p "$DEST"
          sudo cp "$TRANSFER_LOG_DIR"/*.txt "$DEST/"
          echo "âœ… ë°±ì—… ì™„ë£Œ: $DEST"

      - name: ğŸ“¤ Upload logs artifact
        uses: actions/upload-artifact@v4
        with:
          name: transfer-logs-${{ steps.backup.outputs.ts_folder }}
          path: $TRANSFER_LOG_DIR/*.txt

      - name: ğŸ—„ Copy backup into .github/files
        run: |
          echo "ğŸ—„ ì‹œì‘: .github/files ê²½ë¡œì— ë°±ì—… ë³µì‚¬"
          mkdir -p ".github/files/${{ steps.backup.outputs.ts_folder }}"
          cp "$BACKUP_DIR/${{ steps.backup.outputs.ts_folder }}"/*.txt ".github/files/${{ steps.backup.outputs.ts_folder }}/"
          echo "âœ… .github/files/${{ steps.backup.outputs.ts_folder }}ì— ë³µì‚¬ ì™„ë£Œ"

      - name: ğŸ›  Download Dockerfile and helper scripts
        run: |
          echo "ğŸ›  ì‹œì‘: Dockerfile ë° ìŠ¤í¬ë¦½íŠ¸ ë‹¤ìš´ë¡œë“œ"
          mkdir -p .github/scripts
          curl -fsSL "$REPO_RAW_BASE/.github/Dockerfile" -o .github/Dockerfile && echo "âœ… .github/Dockerfile ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
          curl -fsSL "$REPO_RAW_BASE/.github/scripts/build_txn_processor.sh" -o .github/scripts/build_txn_processor.sh && chmod +x .github/scripts/build_txn_processor.sh && echo "âœ… build_txn_processor.sh ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
          curl -fsSL "$REPO_RAW_BASE/.github/scripts/init_mysql.sh" -o .github/scripts/init_mysql.sh && chmod +x .github/scripts/init_mysql.sh && echo "âœ… init_mysql.sh ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
          curl -fsSL "$REPO_RAW_BASE/.github/scripts/load_transactions.sh" -o .github/scripts/load_transactions.sh && chmod +x .github/scripts/load_transactions.sh && echo "âœ… load_transactions.sh ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"

      - name: ğŸ›  Run build_txn_processor.sh
        run: |
          echo "ğŸ›  ì‹œì‘: txn-processor ì´ë¯¸ì§€ ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰"
          .github/scripts/build_txn_processor.sh

      - name: ğŸ›  Run init_mysql.sh
        run: |
          echo "ğŸ›  ì‹œì‘: MySQL ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰"
          .github/scripts/init_mysql.sh

      - name: ğŸ›  Run load_transactions.sh
        run: |
          echo "ğŸ›  ì‹œì‘: ê±°ë˜ ì ì¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰"
          .github/scripts/load_transactions.sh

      - name: ğŸ“¤ Upload backup folder artifact
        uses: actions/upload-artifact@v4
        with:
          name: transfer-backup-${{ steps.backup.outputs.ts_folder }}
          path: $BACKUP_DIR/${{ steps.backup.outputs.ts_folder }}

      - name: ğŸ“‚ Show final backup state
        run: |
          echo "ğŸ“‚ ìµœì¢… ë°±ì—… ë””ë ‰í† ë¦¬ íŠ¸ë¦¬"
          ls -R "$BACKUP_DIR" | tail -n 20"}]}
