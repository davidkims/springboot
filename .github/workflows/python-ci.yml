# μ›ν¬ν”λ΅μ°μ μ΄λ¦„
name: PostgreSQL DB λ°±μ—… λ° S3 μ—…λ΅λ“

# μ›ν¬ν”λ΅μ°κ°€ μ‹¤ν–‰λ  μ΄λ²¤νΈλ¥Ό μ •μν•©λ‹λ‹¤.
# 'workflow_dispatch'λ¥Ό μ‚¬μ©ν•μ—¬ GitHub UIμ—μ„ μλ™μΌλ΅ μ›ν¬ν”λ΅μ°λ¥Ό μ‹¤ν–‰ν•  μ μμµλ‹λ‹¤.
on:
  workflow_dispatch:

# μ›ν¬ν”λ΅μ°μ—μ„ μ‹¤ν–‰λ  μ‘μ—…(Jobs)λ“¤μ„ μ •μν•©λ‹λ‹¤.
jobs:
  backup_postgres:
    # μ΄ μ‘μ—…μ΄ μ‹¤ν–‰λ  ν™κ²½μ„ μ§€μ •ν•©λ‹λ‹¤. μ—¬κΈ°μ„λ” μµμ‹  Ubuntu ν™κ²½μ„ μ‚¬μ©ν•©λ‹λ‹¤.
    runs-on: ubuntu-latest

    # μ‘μ—… μ „λ°μ— κ±Έμ³ μ‚¬μ©λ  ν™κ²½ λ³€μλ“¤μ„ μ •μν•©λ‹λ‹¤.
    # μ΄ κ°’λ“¤μ„ μ‹¤μ  PostgreSQL μ„λ²„ λ° AWS S3 μ •λ³΄λ΅ λ°λ“μ‹ λ³€κ²½ν•΄μ•Ό ν•©λ‹λ‹¤.
    env:
      # PostgreSQL μ—°κ²° μ •λ³΄
      DB_HOST: <YOUR_ACTUAL_DB_HOST_OR_IP> # μ: 192.168.1.100 λλ” myrdsinstance.abcdef.rds.amazonaws.com
      DB_PORT: 5432                       # PostgreSQL ν¬νΈ (κΈ°λ³Έ 5432)
      DB_USER: <YOUR_ACTUAL_DB_USER>      # PostgreSQL μ‚¬μ©μλ…
      DB_NAME: <YOUR_ACTUAL_DB_NAME>      # λ°±μ—…ν•  λ°μ΄ν„°λ² μ΄μ¤ μ΄λ¦„
      PGPASSWORD: ${{ secrets.DB_PASSWORD }} # GitHub Secretsμ— μ €μ¥λ DB λΉ„λ°€λ²νΈ

      # AWS S3 μ •λ³΄
      AWS_REGION: ap-northeast-2           # S3 λ²„ν‚·μ΄ μ„μΉν• AWS λ¦¬μ „
      S3_BUCKET_NAME: <YOUR_ACTUAL_S3_BUCKET_NAME> # λ°±μ—… νμΌμ„ μ—…λ΅λ“ν•  S3 λ²„ν‚· μ΄λ¦„

    # μ΄ μ‘μ—…μ—μ„ μ‹¤ν–‰λ  λ‹¨κ³„(Steps)λ“¤μ„ μ •μν•©λ‹λ‹¤.
    steps:
      - name: π“¦ μ‚¬μ „ μ¤€λΉ„: PostgreSQL ν΄λΌμ΄μ–ΈνΈ μ„¤μΉ
        run: |
          echo "Installing PostgreSQL client..."
          sudo apt-get update
          sudo apt-get install -y postgresql-client
          echo "PostgreSQL client installed."

      - name: π•’ νƒ€μ„μ¤νƒ¬ν”„ λ° λ°±μ—… νμΌ κ²½λ΅ μ„¤μ •
        id: set_vars # μ΄ λ‹¨κ³„μ μ¶λ ¥ κ°’μ„ λ‹¤μ λ‹¨κ³„μ—μ„ μ°Έμ΅°ν•κΈ° μ„ν• ID
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          BACKUP_FILE_NAME="database_backup_${TIMESTAMP}.sql"
          
          # λ°±μ—… νμΌμ„ μ €μ¥ν•  μ„μ‹ λ””λ ‰ν† λ¦¬λ¥Ό μƒμ„±ν•©λ‹λ‹¤.
          mkdir -p /tmp/db_backups
          BACKUP_FILE_PATH="/tmp/db_backups/${BACKUP_FILE_NAME}"
          
          # λ‹¤μ λ‹¨κ³„μ—μ„ μ‚¬μ©ν•  μ μλ„λ΅ μ¶λ ¥ λ³€μλ΅ μ„¤μ •ν•©λ‹λ‹¤.
          echo "BACKUP_FILE_PATH=${BACKUP_FILE_PATH}" >> "$GITHUB_OUTPUT"
          echo "BACKUP_FILE_NAME=${BACKUP_FILE_NAME}" >> "$GITHUB_OUTPUT"
          echo "TIMESTAMP=${TIMESTAMP}" >> "$GITHUB_OUTPUT"

      - name: π’Ύ PostgreSQL λ°μ΄ν„°λ² μ΄μ¤ λ°±μ—… (pg_dump)
        run: |
          echo "Starting PostgreSQL backup..."
          # pg_dump λ…λ Ήμ„ μ‚¬μ©ν•μ—¬ λ°μ΄ν„°λ² μ΄μ¤λ¥Ό λ°±μ—…ν•©λ‹λ‹¤.
          # PGPASSWORD ν™κ²½ λ³€μλ¥Ό ν†µν•΄ λΉ„λ°€λ²νΈλ¥Ό μ•μ „ν•κ² μ „λ‹¬ν•©λ‹λ‹¤.
          # λ¨λ“  λ³€μλ” ν°λ”°μ΄ν‘λ΅ κ°μ‹Έμ„ κ³µλ°±μ΄λ‚ νΉμ λ¬Έμλ΅ μΈν• μ¤λ¥λ¥Ό λ°©μ§€ν•©λ‹λ‹¤.
          pg_dump -h "${{ env.DB_HOST }}" -p "${{ env.DB_PORT }}" -U "${{ env.DB_USER }}" -d "${{ env.DB_NAME }}" > "${{ steps.set_vars.outputs.BACKUP_FILE_PATH }}"
          
          echo "β… PostgreSQL λ°±μ—… μ™„λ£: ${{ steps.set_vars.outputs.BACKUP_FILE_PATH }}"
          ls -lh "${{ steps.set_vars.outputs.BACKUP_FILE_PATH }}" # λ°±μ—… νμΌ μ •λ³΄ ν™•μΈ

      # ---
      # - name: π” λ°±μ—… νμΌ μ•”νΈν™” (μ„ νƒ μ‚¬ν•­)
      #   # μ΄ λ‹¨κ³„λ” μ•”νΈν™” ν‚¤ κ΄€λ¦¬ μ „λµμ— λ”°λΌ λ‹¬λΌμ§‘λ‹λ‹¤.
      #   # μμ‹λ΅ OpenSSLμ„ μ‚¬μ©ν•μ§€λ§, μ‹¤μ  ν”„λ΅λ•μ…μ—μ„λ” λ” μ•μ „ν• λ°©μ‹μ„ κ³ λ ¤ν•΄μ•Ό ν•©λ‹λ‹¤.
      #   run: |
      #     echo "Encrypting backup file..."
      #     openssl enc -aes-256-cbc -salt -in "${{ steps.set_vars.outputs.BACKUP_FILE_PATH }}" -out "${{ steps.set_vars.outputs.BACKUP_FILE_PATH }}.enc" -k "${{ secrets.ENCRYPTION_KEY }}"
      #     rm "${{ steps.set_vars.outputs.BACKUP_FILE_PATH }}" # μ›λ³Έ νμΌ μ‚­μ 
      #     echo "Backup file encrypted."
      #   continue-on-error: true # μ•”νΈν™” μ‹¤ν¨ μ‹μ—λ„ μ›ν¬ν”λ΅μ° μ§„ν–‰

      - name: βοΈ AWS μκ²© μ¦λ… κµ¬μ„±
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          
      - name: β¬†οΈ S3μ— λ°±μ—… μ—…λ΅λ“
        run: |
          echo "Uploading backup to S3..."
          # λ°±μ—… νμΌμ„ S3 λ²„ν‚·μ— μ—…λ΅λ“ν•©λ‹λ‹¤.
          # μ•”νΈν™”λ νμΌμ„ μ—…λ΅λ“ν•λ” κ²½μ°, μ—¬κΈ°μ—μ„ .enc ν™•μ¥μλ¥Ό μ¶”κ°€ν•΄μ•Ό ν•©λ‹λ‹¤.
          aws s3 cp "${{ steps.set_vars.outputs.BACKUP_FILE_PATH }}" "s3://${{ env.S3_BUCKET_NAME }}/backups/${{ steps.set_vars.outputs.BACKUP_FILE_NAME }}"
          echo "β… S3 μ—…λ΅λ“ μ™„λ£: s3://${{ env.S3_BUCKET_NAME }}/backups/${{ steps.set_vars.outputs.BACKUP_FILE_NAME }}"

      - name: π§Ή λ΅μ»¬ λ°±μ—… νμΌ μ •λ¦¬
        if: always() # μ΄μ „ λ‹¨κ³„ μ‹¤ν¨ μ—¬λ¶€μ™€ μƒκ΄€μ—†μ΄ ν•­μƒ μ‹¤ν–‰
        run: |
          echo "Cleaning up local backup files..."
          # μ„μ‹ λ°±μ—… νμΌκ³Ό λ””λ ‰ν† λ¦¬λ¥Ό μ‚­μ ν•©λ‹λ‹¤.
          rm -rf /tmp/db_backups
          echo "β… λ΅μ»¬ λ°±μ—… νμΌ μ •λ¦¬ μ™„λ£"
