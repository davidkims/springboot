name: 🛡️ SQL Backup and DB Migration

on:
  workflow_dispatch:

jobs:
  sql_backup_and_migration:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: example_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DB_HOST: 127.0.0.1
      DB_PORT: 3306
      DB_NAME: example_db
      DB_USER: root
      DB_PASS: password
      BACKUP_DIR: /opt/backup/sql
      MIGRATION_FILE: ./migrations/migrate.sql

    steps:
      - name: 📦 Checkout Repository
        uses: actions/checkout@v4

      - name: 🕒 Wait for MySQL to Become Ready
        run: |
          echo "⏳ Waiting for MySQL..."
          sleep 30

      - name: 📁 Create Backup Directory
        run: |
          sudo mkdir -p $BACKUP_DIR
          sudo chmod -R 777 $BACKUP_DIR

      - name: 💾 Backup SQL Database
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_FILE="$BACKUP_DIR/backup-$TIMESTAMP.sql"
          echo "🔁 백업 시작: $BACKUP_FILE"
          mysqldump -h $DB_HOST -P $DB_PORT -u$DB_USER -p$DB_PASS $DB_NAME > $BACKUP_FILE || {
            echo "❌ 백업 실패" >> backup-report.md
            exit 1
          }
          echo "✅ 백업 완료: $BACKUP_FILE" >> backup-report.md
          ls -lh $BACKUP_DIR >> backup-report.md

      - name: 🧱 Run DB Migration
        run: |
          echo "🔁 마이그레이션 시작: $MIGRATION_FILE"
          mysql -h $DB_HOST -P $DB_PORT -u$DB_USER -p$DB_PASS $DB_NAME < $MIGRATION_FILE || {
            echo "❌ 마이그레이션 실패" >> migration-report.md
            exit 1
          }
          echo "✅ 마이그레이션 완료" >> migration-report.md

      - name: 📋 Show Logs
        run: |
          echo "📄 Backup Log:"
          cat backup-report.md || echo "No backup-report.md"
          echo "📄 Migration Log:"
          cat migration-report.md || echo "No migration-report.md"
