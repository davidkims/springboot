name: Install Java & Maven

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  setup-java-maven:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create install script
        run: |
          echo "📄 Creating scripts/install_java_maven.sh"
          mkdir -p scripts
          cat << 'EOF' > scripts/install_java_maven.sh
          #!/usr/bin/env bash
          set -euo pipefail

          #————————————
          # 환경 변수 설정
          #————————————
          JAVA_PKG="openjdk-17-jdk"
          MAVEN_PKG="maven"

          # Temurin 바이너리 직접 설치 옵션
          USE_TEMURIN=false      # true로 바꾸면 Temurin 방식으로 설치
          TEMURIN_VERSION="17"
          TEMURIN_TMPDIR="$(mktemp -d)"
          TEMURIN_GH_URL="https://github.com/adoptium/temurin${TEMURIN_VERSION}-binaries/releases/latest/download/OpenJDK${TEMURIN_VERSION}U-jdk_x64_linux_hotspot.tar.gz"

          #————————————
          # 1) APT으로 설치
          #————————————
          if [ "\$USE_TEMURIN" = false ]; then
            echo "▶ apt update 및 OpenJDK+Maven 설치 시작"
            sudo apt-get update -y
            sudo apt-get install -y "\${JAVA_PKG}" "\${MAVEN_PKG}"

            echo -e "\n▶ 설치 확인"
            java -version
            mvn -version
            exit 0
          fi

          #————————————
          # 2) Temurin 직접 설치 (USE_TEMURIN=true 시 동작)
          #————————————
          echo "▶ Temurin JDK 다운로드 및 설치 시작"
          cd "\$TEMURIN_TMPDIR"
          wget -O temurin-jdk.tar.gz "\$TEMURIN_GH_URL"
          echo "✔ 다운로드 완료: \$(du -h temurin-jdk.tar.gz | awk '{print \$1}')"

          sudo mkdir -p /opt/java
          sudo tar -xzf temurin-jdk.tar.gz -C /opt/java
          JDIR=\$(ls /opt/java | head -n1)

          echo "▶ update-alternatives 설정"
          sudo update-alternatives --install /usr/bin/java java "/opt/java/\${JDIR}/bin/java" 100
          sudo update-alternatives --install /usr/bin/javac javac "/opt/java/\${JDIR}/bin/javac" 100

          echo -e "\n▶ Temurin 설치 확인"
          java -version
          javac -version

          echo -e "\n▶ Maven 설치 (APT)"
          sudo apt-get update -y
          sudo apt-get install -y "\${MAVEN_PKG}"
          mvn -version

          # 임시 디렉토리 정리
          cd /tmp && rm -rf "\$TEMURIN_TMPDIR"
          EOF

          chmod +x scripts/install_java_maven.sh

      - name: Run install script
        run: |
          ./scripts/install_java_maven.sh
