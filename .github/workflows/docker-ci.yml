name: Docker 이미지 빌드 및 배포 with Echo

on:
  push:
    branches:
      - main # main 브랜치에 푸시될 때 워크플로우 실행
  pull_request:
    branches:
      - main # main 브랜치로 풀 리퀘스트 발생 시 워크플로우 실행
  workflow_dispatch: # GitHub UI에서 수동으로 워크플로우를 실행할 수 있도록 허용

env:
  # Docker 이미지 이름 (원하는 이름으로 변경하세요)
  IMAGE_NAME: my-app-image
  # Docker 이미지 태그 (Git SHA를 기본값으로 사용)
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # 이 작업을 실행할 운영체제 환경을 지정합니다.

    steps:
      - name: 🚀 코드 체크아웃
        uses: actions/checkout@v4 # 리포지토리 코드를 워크플로우 러너로 가져옵니다.
        run: echo "--- 리포지토리 코드 체크아웃 완료 ---"

      - name: 🐳 Docker 최신 버전 및 CLI 설치
        # Docker 공식 setup-docker-action을 사용하여 Docker Engine 및 CLI를 설치합니다.
        uses: docker/setup-docker@v4
        run: echo "--- Docker Engine 및 CLI 설치 완료 ---"

      - name: ℹ️ Docker CLI 버전 확인
        run: |
          echo "현재 시스템의 Docker 버전은 다음과 같습니다:"
          docker --version
          echo "Docker Compose 버전 (설치되어 있다면):"
          docker compose version || true # docker compose가 설치되어 있지 않아도 오류 발생하지 않도록
          echo "Docker 시스템 정보:"
          docker info
          echo "--- Docker CLI 준비 완료 ---"

      - name: 📁 파일 및 디렉토리 생성
        run: |
          echo "--- 파일 및 디렉토리 생성 시작 ---"
          echo "새로운 디렉토리 'my-data-volume' 생성 중..."
          mkdir -p my-data-volume/logs
          echo "새로운 파일 'my-data-volume/app.log' 생성 중..."
          echo "애플리케이션 시작 로그: $(date)" > my-data-volume/app.log
          echo "또 다른 파일 'my-data-volume/logs/error.log' 생성 중..."
          echo "에러 발생: $(date)" > my-data-volume/logs/error.log
          echo "생성된 파일 및 디렉토리 구조 확인:"
          ls -R my-data-volume/
          echo "--- 파일 및 디렉토리 생성 완료 ---"

      - name: ⚙️ Docker Buildx 설정 (선택 사항:멀티 플랫폼 빌드 및 캐싱에 유용)
        # 멀티 플랫폼 이미지를 빌드하거나 빌드 캐싱을 사용하려면 필요합니다.
        # 빌드 속도 향상에 기여할 수 있습니다.
        uses: docker/setup-buildx-action@v3
        run: echo "--- Docker Buildx 설정 완료 ---"

      - name: 🔑 Docker Hub 로그인 (선택 사항:Docker Hub에 푸시할 경우)
        if: ${{ secrets.DOCKER_USERNAME && secrets.DOCKER_PASSWORD }} # 시크릿이 설정되어 있을 때만 실행
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
        run: echo "--- Docker Hub 로그인 시도 완료 (시크릿이 있는 경우) ---"

      - name: 🔑 GitHub Container Registry (GHCR) 로그인 (선택 사항:GHCR에 푸시할 경우)
        # GHCR에 푸시할 경우, GITHUB_TOKEN을 사용하여 로그인할 수 있습니다.
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
        run: echo "--- GHCR 로그인 시도 완료 ---"

      - name: 🏗️ Docker 이미지 빌드
        # Dockerfile을 사용하여 이미지를 빌드하고 태그를 지정합니다.
        # `context: .`은 현재 리포지토리 루트를 빌드 컨텍스트로 사용함을 의미합니다.
        # `push: false`로 설정하여 빌드만 하고 푸시는 하지 않습니다. (아래 스텝에서 푸시)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile # Dockerfile 경로 지정
          tags: |
            ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest # GHCR에 푸시할 때 유용한 latest 태그
          outputs: type=docker # 빌드된 이미지를 Docker 데몬에 로드하여 다음 스텝에서 사용 가능하게 합니다.
          push: false # 일단 빌드만 하고 푸시는 하지 않습니다.
        run: |
          echo "--- Docker 이미지 빌드 시작 ---"
          echo "빌드 중인 이미지: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          echo "Dockerfile 경로: ./Dockerfile"
          echo "--- Docker 이미지 빌드 완료 ---"

      - name: 🔍 빌드된 Docker 이미지 확인
        run: |
          echo "--- 빌드된 Docker 이미지 목록 ---"
          docker images
          echo "--- 이미지 확인 완료 ---"

      - name: 📤 Docker 이미지 푸시 (Docker Hub)
        if: ${{ secrets.DOCKER_USERNAME && secrets.DOCKER_PASSWORD }}
        run: |
          echo "--- Docker Hub로 이미지 푸시 시작 ---"
          docker push ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          docker push ${{ env.IMAGE_NAME }}:latest # latest 태그도 푸시
          echo "--- Docker Hub 푸시 완료 ---"

      - name: 📤 Docker 이미지 푸시 (GitHub Container Registry)
        # GHCR에 푸시할 경우, 이미지 이름 앞에 ghcr.io/OWNER/REPO를 붙여야 합니다.
        run: |
          echo "--- GHCR로 이미지 푸시 시작 ---"
          docker push ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          docker push ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest
          echo "--- GHCR 푸시 완료 ---"

      - name: 🏃 Docker 컨테이너 실행 (선택 사항:빌드된 이미지 테스트용)
        # 빌드된 이미지를 사용하여 컨테이너를 실행하여 간단한 테스트를 수행할 수 있습니다.
        run: |
          echo "--- Docker 컨테이너 실행 시작 (테스트용) ---"
          echo "실행 중인 이미지: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          docker run --rm ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          echo "--- Docker 컨테이너 실행 완료 ---"
