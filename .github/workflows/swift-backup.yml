name: ğŸ¦ ì¹´ë“œì‚¬ ê±°ë˜ ë°±ì—… + OCI + NetBackup

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  finance-backup:
    runs-on: ubuntu-latest

    env:
      OCI_BUCKET_NAME: your-bucket-name
      OCI_NAMESPACE: your-namespace
      OCI_COMPARTMENT_ID: your-compartment-ocid
      OCI_REGION: ap-seoul-1  # ì›í•˜ëŠ” ë¦¬ì „ìœ¼ë¡œ ë³€ê²½

    steps:
      - name: ğŸ“ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ§° Swift ì„¤ì¹˜
        run: |
          sudo apt-get update
          sudo apt-get install -y clang libicu-dev libpython3-dev zip
          curl -fsSL https://download.swift.org/swift-5.9-release/ubuntu2204/swift-5.9-RELEASE/swift-5.9-RELEASE-ubuntu22.04.tar.gz -o swift.tar.gz
          sudo mkdir -p /opt/swift
          sudo tar -xzf swift.tar.gz -C /opt/swift --strip-components=1
          echo "/opt/swift/usr/bin" >> $GITHUB_PATH

      - name: ğŸ§¾ ì¹´ë“œì‚¬ë³„ ê±°ë˜ JSON íŒŒì¼ ìƒì„±
        run: |
          mkdir -p /opt/backup /opt/reports
          companies=("ì‚¼ì„±" "í˜„ëŒ€" "ë¡¯ë°")
          for company in "${companies[@]}"; do
            cat <<EOF > /opt/backup/transactions_${company}.json
[
  {
    "company": "${company}",
    "card": "ì‹ ìš©ì¹´ë“œ",
    "amount": "$((RANDOM % 500000 + 50000))",
    "timestamp": "$(date -Iseconds)"
  },
  {
    "company": "${company}",
    "card": "ë²•ì¸ì¹´ë“œ",
    "amount": "$((RANDOM % 500000 + 50000))",
    "timestamp": "$(date -Iseconds)"
  },
  {
    "company": "${company}",
    "card": "ì²´í¬ì¹´ë“œ",
    "amount": "$((RANDOM % 500000 + 50000))",
    "timestamp": "$(date -Iseconds)"
  }
]
EOF

            echo "# ğŸ’³ ê±°ë˜ ë³´ê³ ì„œ (${company})" > /opt/reports/report_${company}.md
            echo "- ìƒì„± ì‹œê°„: $(date)" >> /opt/reports/report_${company}.md
            echo "- ì €ì¥ ìœ„ì¹˜: /opt/backup/transactions_${company}.json" >> /opt/reports/report_${company}.md
          done

      - name: ğŸ—œï¸ ì „ì²´ JSON íŒŒì¼ ì••ì¶•
        run: |
          mkdir -p output
          zip -j output/all_transactions_$(date +%Y%m%d%H%M).zip /opt/backup/transactions_*.json

      - name: â˜ï¸ Oracle OCI CLI ì„¤ì¹˜
        run: |
          curl -sL https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh | bash -s -- --accept-all-defaults
          echo "$HOME/bin" >> $GITHUB_PATH
          source ~/.bashrc
          oci --version || echo "âœ… OCI CLI ì„¤ì¹˜ë¨"

      - name: â˜ï¸ OCI ì—…ë¡œë“œ - ì¹´ë“œì‚¬ë³„ JSON íŒŒì¼
        run: |
          for jsonfile in /opt/backup/transactions_*.json; do
            filename=$(basename $jsonfile)
            echo "â˜ï¸ Uploading $filename to OCI Bucket..."
            oci os object put \
              --bucket-name $OCI_BUCKET_NAME \
              --namespace $OCI_NAMESPACE \
              --file "$jsonfile" \
              --name "backups/$filename" \
              --region $OCI_REGION \
              --force || echo "âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: $filename"
          done

      - name: ğŸ§± NetBackup êµ¬ì„± ë° bpbackup í˜¸ì¶œ (ì‹œë®¬ë ˆì´ì…˜)
        run: |
          mkdir -p /opt/netbackup/data
          cp /opt/backup/transactions_*.json /opt/netbackup/data/

          echo "ğŸ”§ NetBackup bpbackup ëª…ë ¹ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘"
          for file in /opt/netbackup/data/*.json; do
            echo "ğŸ—‚ï¸ ë°±ì—… ì‹¤í–‰: bpbackup -f $file"
            echo "[bpbackup] ë°±ì—…ë¨: $(basename $file)"
          done

      - name: ğŸ“Š ì „ì²´ ìš”ì•½ ë³´ê³ ì„œ ìƒì„±
        run: |
          echo "# âœ… ì „ì²´ ë°±ì—… ë° ì—…ë¡œë“œ ë³´ê³ ì„œ" > final-report.md
          echo "- ì‹¤í–‰ ì‹œê°„: $(date)" >> final-report.md
          echo "- ì¹´ë“œì‚¬ íŒŒì¼ ìˆ˜: $(ls /opt/backup/transactions_*.json | wc -l)" >> final-report.md
          echo "- ì••ì¶• íŒŒì¼: output/*.zip" >> final-report.md
          echo "- NetBackup ë””ë ‰í† ë¦¬: /opt/netbackup/data" >> final-report.md
          echo "- ë³´ê³ ì„œ ëª©ë¡:" >> final-report.md
          ls /opt/reports/report_*.md >> final-report.md
          cat final-report.md
