name: π” μ•”νΈν™”/λ³µνΈν™” + Codex μ”κΈ μ¶”μ 

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  encrypt-track-codex:
    runs-on: ubuntu-latest

    env:
      ENCRYPT_DIR: /opt/encrypt
      DECRYPT_DIR: /opt/decrypt
      TAG_REPORT: codex-usage.md
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: π“ μ €μ¥μ† μ²΄ν¬μ•„μ›ƒ
        uses: actions/checkout@v4

      - name: π”‘ Generate OpenAI token
        id: generate_token
        run: bash scripts/generate_openai_token.sh
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        continue-on-error: true

      - name: Skip when token missing
        if: steps.generate_token.outcome != 'success'
        run: echo "Token unavailable; skipping workflow." && exit 0

      - name: π” μ•”νΈν™” / λ³µνΈν™” νƒκ·Έ νμΌ μƒμ„±
        if: steps.generate_token.outcome == 'success'
        run: |
          mkdir -p $ENCRYPT_DIR $DECRYPT_DIR
          for company in μ‚Όμ„± ν„λ€ λ΅―λ°; do
            echo "company=$company" > "$ENCRYPT_DIR/transactions_${company}.enc"
            echo "key=secretkey-${RANDOM}" >> "$ENCRYPT_DIR/transactions_${company}.enc"
            echo "μ•”νΈν™”λ¨" >> "$ENCRYPT_DIR/transactions_${company}.enc"

            cp "$ENCRYPT_DIR/transactions_${company}.enc" "$DECRYPT_DIR/transactions_${company}.dec"
            echo "λ³µνΈν™”λ¨" >> "$DECRYPT_DIR/transactions_${company}.dec"
          done

      - name: π’° Codex μ”κΈ API νΈμ¶ λ° λ³΄κ³ μ„ μƒμ„±
        if: steps.generate_token.outcome == 'success'
        run: |
          echo "# π’µ Codex μ”κΈ μ¶”μ  λ³΄κ³ μ„" > $TAG_REPORT
          echo "μ‹¤ν–‰ μ‹κ°„: $(date)" >> $TAG_REPORT

          echo "Codex λ¨λΈ μ‚¬μ©λ‰ μ¶”μ  μ¤‘..." >> $TAG_REPORT

          curl --proto '=https' --tlsv1.2 https://api.openai.com/v1/usage \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            --silent > usage_raw.json || echo "β μ‚¬μ©λ‰ λ¶λ¬μ¤κΈ° μ‹¤ν¨"

          if grep -q "total_usage" usage_raw.json; then
            total=$(jq '.total_usage' usage_raw.json)
            echo "- μ „μ²΄ μ‚¬μ©λ‰: $total tokens" >> $TAG_REPORT
          else
            echo "- μ‚¬μ©λ‰ μ •λ³΄λ¥Ό κ°€μ Έμ¤μ§€ λ»ν–μµλ‹λ‹¤." >> $TAG_REPORT
          fi

          echo "λ³΄κ³  μ™„λ£"
          cat $TAG_REPORT

      - name: π§Ύ νƒκ·Έ λ° λ³΄κ³ μ„ μ•„μΉ΄μ΄λΈ
        if: steps.generate_token.outcome == 'success'
        run: |
          mkdir -p output
          zip -j output/encrypted_files.zip $ENCRYPT_DIR/*.enc $DECRYPT_DIR/*.dec
          cp $TAG_REPORT output/
          echo "π“¦ μ••μ¶• μ™„λ£ λ° λ³΄κ³ μ„ μƒμ„±λ¨"
