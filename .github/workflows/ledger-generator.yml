name: ğŸ—ƒï¸ ê±°ë˜ ë°ì´í„° - PostgreSQL & MySQL ì €ì¥ ìë™í™”

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  db-ledger:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:14
        ports: [5432:5432]
        env:
          POSTGRES_USER: ledger
          POSTGRES_PASSWORD: ledgerpass
          POSTGRES_DB: ledgerdb
        options: >-
          --health-cmd="pg_isready"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      mysql:
        image: mysql:8
        ports: [3306:3306]
        env:
          MYSQL_ROOT_PASSWORD: ledgerpass
          MYSQL_DATABASE: ledgerdb
          MYSQL_USER: ledger
          MYSQL_PASSWORD: ledgerpass
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: ğŸ“‚ ë””ë ‰í† ë¦¬ ë° ì½”ë“œ ìƒì„±
        run: |
          echo "ğŸ“ ë””ë ‰í† ë¦¬ ì¤€ë¹„"
          mkdir -p app/output

          echo "ğŸ“„ ledger.py ìƒì„±"
          echo 'import csv' > app/ledger.py
          echo 'import datetime' >> app/ledger.py
          echo 'import random' >> app/ledger.py
          echo 'import psycopg2' >> app/ledger.py
          echo 'import mysql.connector' >> app/ledger.py
          echo '' >> app/ledger.py
          echo 'def generate_transaction(transaction_type):' >> app/ledger.py
          echo '    company = random.choice(["ì¤‘ì†Œê¸°ì—…", "ëŒ€ê¸°ì—…"])' >> app/ledger.py
          echo '    amount = round(random.uniform(10.0, 10000.0), 2)' >> app/ledger.py
          echo '    currency = random.choice(["KRW", "USD", "JPY", "EUR"])' >> app/ledger.py
          echo '    status = random.choice(["ìŠ¹ì¸", "ê±°ì ˆ", "ë³´ë¥˜"])' >> app/ledger.py
          echo '    time = datetime.datetime.now().isoformat()' >> app/ledger.py
          echo '    description = f"{company} {transaction_type} ê±°ë˜"' >> app/ledger.py
          echo '    return [time, transaction_type, company, amount, currency, status, description]' >> app/ledger.py
          echo '' >> app/ledger.py
          echo 'def write_csv(transactions):' >> app/ledger.py
          echo '    with open("output/transactions.csv", mode="w", newline="", encoding="utf-8") as f:' >> app/ledger.py
          echo '        writer = csv.writer(f)' >> app/ledger.py
          echo '        writer.writerow(["ì‹œê°„", "ìœ í˜•", "ê¸°ì—…êµ¬ë¶„", "ê¸ˆì•¡", "í†µí™”", "ìƒíƒœ", "ì„¤ëª…"])' >> app/ledger.py
          echo '        writer.writerows(transactions)' >> app/ledger.py
          echo '' >> app/ledger.py
          echo 'def insert_postgresql(transactions):' >> app/ledger.py
          echo '    conn = psycopg2.connect(host="localhost", dbname="ledgerdb", user="ledger", password="ledgerpass")' >> app/ledger.py
          echo '    cur = conn.cursor()' >> app/ledger.py
          echo '    cur.execute("""CREATE TABLE IF NOT EXISTS transactions_pg (' >> app/ledger.py
          echo '        ì‹œê°„ TEXT, ìœ í˜• TEXT, ê¸°ì—…êµ¬ë¶„ TEXT, ê¸ˆì•¡ REAL, í†µí™” TEXT, ìƒíƒœ TEXT, ì„¤ëª… TEXT)""")' >> app/ledger.py
          echo '    cur.executemany("INSERT INTO transactions_pg VALUES (%s, %s, %s, %s, %s, %s, %s)", transactions)' >> app/ledger.py
          echo '    conn.commit(); cur.close(); conn.close()' >> app/ledger.py
          echo '' >> app/ledger.py
          echo 'def insert_mysql(transactions):' >> app/ledger.py
          echo '    conn = mysql.connector.connect(host="localhost", database="ledgerdb", user="ledger", password="ledgerpass")' >> app/ledger.py
          echo '    cur = conn.cursor()' >> app/ledger.py
          echo '    cur.execute("""CREATE TABLE IF NOT EXISTS transactions_my (' >> app/ledger.py
          echo '        ì‹œê°„ TEXT, ìœ í˜• TEXT, ê¸°ì—…êµ¬ë¶„ TEXT, ê¸ˆì•¡ FLOAT, í†µí™” TEXT, ìƒíƒœ TEXT, ì„¤ëª… TEXT)""")' >> app/ledger.py
          echo '    cur.executemany("INSERT INTO transactions_my VALUES (%s, %s, %s, %s, %s, %s, %s)", transactions)' >> app/ledger.py
          echo '    conn.commit(); cur.close(); conn.close()' >> app/ledger.py
          echo '' >> app/ledger.py
          echo 'if __name__ == "__main__":' >> app/ledger.py
          echo '    transactions = []' >> app/ledger.py
          echo '    for _ in range(50):' >> app/ledger.py
          echo '        transactions.append(generate_transaction("ì‹ ìš©ì¹´ë“œ"))' >> app/ledger.py
          echo '        transactions.append(generate_transaction("ì²´í¬ì¹´ë“œ"))' >> app/ledger.py
          echo '        transactions.append(generate_transaction("FX"))' >> app/ledger.py
          echo '    write_csv(transactions)' >> app/ledger.py
          echo '    insert_postgresql(transactions)' >> app/ledger.py
          echo '    insert_mysql(transactions)' >> app/ledger.py
          echo '    print("âœ… ëª¨ë“  ê±°ë˜ê°€ DBì™€ CSVì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")' >> app/ledger.py

          echo "ğŸ“„ Dockerfile ìƒì„±"
          echo 'FROM python:3.10-slim' > app/Dockerfile
          echo 'WORKDIR /app' >> app/Dockerfile
          echo 'COPY ledger.py .' >> app/Dockerfile
          echo 'RUN apt-get update && apt-get install -y gcc libpq-dev default-libmysqlclient-dev' >> app/Dockerfile
          echo 'RUN pip install --no-cache-dir psycopg2 mysql-connector-python' >> app/Dockerfile
          echo 'CMD ["python", "ledger.py"]' >> app/Dockerfile

      - name: ğŸ› ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ
        run: |
          echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ"
          docker build -t ledger-db ./app

      - name: ğŸš€ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (DB ì—°ê²° í¬í•¨)
        run: |
          echo "ğŸš€ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
          docker run --rm --network=host -v ${{ github.workspace }}/output:/app/output ledger-db
          echo "âœ… ì‹¤í–‰ ì™„ë£Œ: CSV ë° DB ì €ì¥"

      - name: ğŸ“¤ ê²°ê³¼ CSV ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: ê±°ë˜ë°ì´í„°
          path: output/transactions.csv
