# .github/workflows/finance-smart-backup1.yml
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” ê¸ˆìœµ ë°ì´í„°ì˜ ìŠ¤ë§ˆíŠ¸ ë°±ì—…ì„ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.
# MySQL ì»¨í…Œì´ë„ˆë¥¼ ê° íŠ¸ëœì­ì…˜ ìœ í˜•ë³„ë¡œ ë„ì›Œ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ê³ ,
# 'completed' ìƒíƒœì˜ ë°ì´í„°ê°€ ìˆì„ ê²½ìš° ë°±ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
# ë°±ì—… ë¡œê·¸ëŠ” PostgreSQLì— ê¸°ë¡ë˜ê³ , ê°„ë‹¨í•œ 'Kafka-style' ë¡œê·¸ íŒŒì¼ì—ë„ ë‚¨ê¹ë‹ˆë‹¤.
# OTP(ì¼íšŒìš© ë¹„ë°€ë²ˆí˜¸) ì—†ì´ ìë™í™”ëœ ë°±ì—… í”„ë¡œì„¸ìŠ¤ë¥¼ ê°€ì •í•©ë‹ˆë‹¤.

name: ğŸ”„ Finance Smart Backup without OTP

on:
  # ë§¤ 5ë¶„ë§ˆë‹¤ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
  schedule:
    - cron: "*/5 * * * *"
  # GitHub Actions UIì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
  workflow_dispatch:

jobs:
  finance-backup:
    # ì›Œí¬í”Œë¡œìš°ëŠ” ìµœì‹  Ubuntu ê°€ìƒ ë¨¸ì‹ ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.
    runs-on: ubuntu-latest

    # í™˜ê²½ ë³€ìˆ˜ ì •ì˜
    env:
      ROOT_PASS: rootpass123 # MySQL root ë¹„ë°€ë²ˆí˜¸
      SQL_DIR: /opt/finance/sql # SQL ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ ì €ì¥ ê²½ë¡œ
      BACKUP_DIR: /opt/finance/backups # ë°±ì—… íŒŒì¼ ì €ì¥ ê²½ë¡œ
      KAFKA_LOG: /opt/finance/kafka.log # Kafka ìŠ¤íƒ€ì¼ ë¡œê·¸ íŒŒì¼ ê²½ë¡œ
      PG_DB: postgres_finance # PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„
      PG_USER: postgres # PostgreSQL ì‚¬ìš©ì ì´ë¦„
      PG_PASS: pgpass # PostgreSQL ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸
      TYPES: | # ë°±ì—…í•  íŠ¸ëœì­ì…˜ ìœ í˜• ëª©ë¡ (íŒŒì´í”„(|) ë¬¸ìë¡œ ì—¬ëŸ¬ ì¤„ ê°’ ì •ì˜)
        bank_transfer
        check_card
        credit_card
        bitcoin
        stock
        futures

    steps:
      - name: Checkout repository # GitHub ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œë¥¼ ì›Œí¬í”Œë¡œìš° ëŸ¬ë„ˆë¡œ ì²´í¬ì•„ì›ƒí•©ë‹ˆë‹¤.
        uses: actions/checkout@v3

      - name: ğŸ“ Create Directories and Init SQL File # í•„ìš”í•œ ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•˜ê³  MySQL ì´ˆê¸°í™” SQL ìŠ¤í¬ë¦½íŠ¸ë¥¼ íŒŒì¼ë¡œ ì¤€ë¹„í•©ë‹ˆë‹¤.
        run: |
          set -euo pipefail
          echo "SQL ë° ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„± ì¤‘: ${SQL_DIR} ë° ${BACKUP_DIR}"
          sudo mkdir -p "${SQL_DIR}" "${BACKUP_DIR}"
          echo "SQL ë””ë ‰í† ë¦¬ ë¶€ëª¨ ê²½ë¡œì— ê¶Œí•œ ì„¤ì • ì¤‘: $(dirname "${SQL_DIR}")"
          sudo chmod -R 777 "$(dirname "${SQL_DIR}")"
          echo "MySQL ì»¨í…Œì´ë„ˆì—ì„œ ìë™ ì‹¤í–‰ë  init.sql íŒŒì¼ ${SQL_DIR}ì— ìƒì„± ì¤‘..." # ì„¤ëª… ì¶”ê°€
          cat << 'EOF' > "${SQL_DIR}/init.sql"
          # MySQLìš© SQL êµ¬ë¬¸: transfers í…Œì´ë¸”ì„ ìƒì„±í•˜ê³  ìƒ˜í”Œ ë°ì´í„°ë¥¼ ì‚½ì…í•©ë‹ˆë‹¤.
          # ì´ SQLì€ MySQL ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹œ '/docker-entrypoint-initdb.d' ë§ˆìš´íŠ¸ ê²½ë¡œë¥¼ í†µí•´ ìë™ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.
          CREATE TABLE IF NOT EXISTS transfers (
            id INT AUTO_INCREMENT PRIMARY KEY,
            type VARCHAR(30),
            amount NUMERIC,
            currency VARCHAR(5),
            status VARCHAR(20),
            timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
          INSERT INTO transfers(type, amount, currency, status) VALUES
            ('bank_transfer', 100000, 'KRW', 'completed'),
            ('check_card', 20000, 'KRW', 'completed'),
            ('credit_card', 150000, 'KRW', 'completed'),
            ('bitcoin', 0.03, 'BTC', 'pending'),
            ('stock', 1000000, 'KRW', 'completed'),
            ('futures', 500000, 'KRW', 'pending');
          EOF
          echo "init.sql íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. MySQL ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ë  ë•Œ ìë™ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤." # ì„¤ëª… ì¶”ê°€

      - name: ğŸ˜ Install and Configure PostgreSQL # PostgreSQLì„ ì„¤ì¹˜í•˜ê³  êµ¬ì„±í•©ë‹ˆë‹¤.
        run: |
          set -euo pipefail
          echo "apt-get íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ì¤‘..."
          sudo apt-get update
          echo "PostgreSQL ì„¤ì¹˜ ì¤‘..."
          sudo apt-get install -y postgresql
          echo "PostgreSQL ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."
          sudo systemctl start postgresql
          echo "PostgreSQL ì„œë¹„ìŠ¤ í™œì„±í™” ì¤‘..."
          sudo systemctl enable postgresql
          echo "PostgreSQL ì‚¬ìš©ì '${PG_USER}'ì˜ ë¹„ë°€ë²ˆí˜¸ ì„¤ì • ì¤‘..."
          sudo -u postgres psql -c \
            "ALTER USER ${PG_USER} WITH PASSWORD '${PG_PASS}';"
          echo ".pgpass íŒŒì¼ ìƒì„± ì¤‘ (ë¹„ë°€ë²ˆí˜¸ ì—†ëŠ” ì ‘ê·¼ìš©)..."
          cat << EOF > ~/.pgpass
          127.0.0.1:5432:${PG_DB}:${PG_USER}:${PG_PASS}
          EOF
          echo ".pgpass íŒŒì¼ ê¶Œí•œ ì„¤ì • ì¤‘."
          chmod 600 ~/.pgpass
          echo "PostgreSQL ì„¤ì¹˜ ë° êµ¬ì„± ì™„ë£Œ."

      - name: ğŸ˜ Create PostgreSQL DB and Log Tables # PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ ë° ë¡œê·¸ í…Œì´ë¸”ì„ ìƒì„±í•©ë‹ˆë‹¤.
        run: |
          set -euo pipefail
          echo "PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ '${PG_DB}'ê°€ ì—†ìœ¼ë©´ ìƒì„± ì¤‘..."
          sudo -u postgres createdb "${PG_DB}" || echo "${PG_DB} ë°ì´í„°ë² ì´ìŠ¤ê°€ ì´ë¯¸ ì¡´ì¬í•˜ë¯€ë¡œ ìƒì„± ê±´ë„ˆëœë‹ˆë‹¤."
          echo "PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ '${PG_DB}'ì— 'logs' í…Œì´ë¸” ìƒì„± ì¤‘..."
          PGPASSFILE=$HOME/.pgpass psql -h 127.0.0.1 -U "${PG_USER}" -d "${PG_DB}" << 'EOF'
          # PostgreSQLìš© SQL êµ¬ë¬¸: logs í…Œì´ë¸”ì„ ìƒì„±í•©ë‹ˆë‹¤.
          CREATE TABLE IF NOT EXISTS logs (
            type VARCHAR,
            status VARCHAR,
            backup_time TIMESTAMP
          );
          EOF
          echo "PostgreSQL DB ë° logs í…Œì´ë¸” ì„¤ì • ì™„ë£Œ."

      - name: ğŸ” Run Per-Type Backup Loop # ê° íŠ¸ëœì­ì…˜ ìœ í˜•ë³„ë¡œ ë°±ì—… ë£¨í”„ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
        run: |
          set -euo pipefail
          echo "ë°±ì—… ë£¨í”„ ì‹œì‘ (ìœ í˜•: ${TYPES})"
          for TYPE in ${TYPES}; do
            DB_NAME="db_${TYPE}"
            DB_USER="user_${TYPE}"
            DB_PASS="pass_${TYPE}"
            CONTAINER="mysql_${TYPE}"
            PORT=$((3307 + RANDOM % 1000))

            echo "ğŸš€ ${TYPE} MySQL ì»¨í…Œì´ë„ˆ (${CONTAINER})ë¥¼ í¬íŠ¸ ${PORT}ì—ì„œ ì‹œì‘ ì¤‘..."
            echo "init.sqlì€ ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹œ ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ì–´ '${DB_NAME}' ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤." # ì„¤ëª… ì¶”ê°€
            docker run -d --rm \
              --name "${CONTAINER}" \
              -e MYSQL_ROOT_PASSWORD="${ROOT_PASS}" \
              -e MYSQL_DATABASE="${DB_NAME}" \
              -e MYSQL_USER="${DB_USER}" \
              -e MYSQL_PASSWORD="${DB_PASS}" \
              -v "${SQL_DIR}:/docker-entrypoint-initdb.d" \
              -p "${PORT}:3306" \
              mysql:8.0

            echo "â³ ${TYPE} ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘ (30ì´ˆ)..."
            sleep 30

            echo "ğŸ” ${TYPE} MySQL ë¡œê·¸ì¸ ì„¤ì • êµ¬ì„± ì¤‘..."
          cat << EOF > ~/.my.cnf
          [client]
          user=${DB_USER}
          password=${DB_PASS}
          host=127.0.0.1
          port=${PORT}
          EOF
            chmod 600 ~/.my.cnf
            echo "ìœ í˜• '${TYPE}'ì— ëŒ€í•œ 'completed' íŠ¸ëœì­ì…˜ í™•ì¸ ì¤‘..."
            STATUS=$(mysql --defaults-file=~/.my.cnf -N \
              -e "SELECT COUNT(*) FROM ${DB_NAME}.transfers WHERE type='${TYPE}' AND status='completed';")

            if [ "${STATUS}" -gt 0 ]; then
              BACKUP_FILE="${BACKUP_DIR}/${TYPE}_backup.sql"
              echo "âœ… '${TYPE}'ì— ëŒ€í•´ ${STATUS}ê°œì˜ ì™„ë£Œëœ íŠ¸ëœì­ì…˜ ë°œê²¬. ${BACKUP_FILE}ë¡œ ë°±ì—… ìˆ˜í–‰ ì¤‘..."
              mysqldump --defaults-file=~/.my.cnf --no-tablespaces \
                "${DB_NAME}" > "${BACKUP_FILE}"
              echo "${TYPE} ë°±ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
              TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
              PGPASSFILE=$HOME/.pgpass psql -h 127.0.0.1 -U "${PG_USER}" -d "${PG_DB}" \
                -c "INSERT INTO logs(type,status,backup_time) VALUES('${TYPE}','backup','${TIMESTAMP}');"
              echo "${TYPE} ë°±ì—… ìƒíƒœë¥¼ PostgreSQLì— ê¸°ë¡ ì¤‘."
              echo "${TIMESTAMP} [${TYPE}] backup done" >> "${KAFKA_LOG}"
              echo "${TYPE} ë°±ì—… ìƒíƒœë¥¼ Kafka-style ë¡œê·¸ì— ê¸°ë¡ ì¤‘."
            else
              echo "âš ï¸ ìœ í˜• '${TYPE}'ì— ëŒ€í•´ ì™„ë£Œëœ íŠ¸ëœì­ì…˜ì´ ì—†ìŠµë‹ˆë‹¤. ë°±ì—…ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            fi

            echo "âš¡ ${TYPE}ì— ëŒ€í•´ 'pending'ì„ 'completed'ë¡œ ì—…ë°ì´íŠ¸ ì¤‘..."
            mysql --defaults-file=~/.my.cnf -e \
              "UPDATE ${DB_NAME}.transfers SET status='completed' WHERE type='${TYPE}' AND status='pending';"
            echo "MySQL ì»¨í…Œì´ë„ˆ '${CONTAINER}' ì •ì§€ ì¤‘..."
            docker stop "${CONTAINER}"
            echo "----------------------------------------"
          done
          echo "ëª¨ë“  ìœ í˜•ë³„ ë°±ì—… ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."

      - name: ğŸ“¦ Compress Backups # ë°±ì—… íŒŒì¼ì„ ì••ì¶•í•©ë‹ˆë‹¤.
        run: |
          set -euo pipefail
          echo "ë°±ì—… ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ì¤‘: ${BACKUP_DIR}"
          cd "${BACKUP_DIR}"
          echo "ëª¨ë“  SQL ë°±ì—… íŒŒì¼ì„ finance-backups-${{ github.run_id }}.tar.gzë¡œ ì••ì¶• ì¤‘..."
          tar -czf "finance-backups-${{ github.run_id }}.tar.gz" -- *.sql
          echo "ì••ì¶•ëœ ë°±ì—… íŒŒì¼ ëª©ë¡:"
          ls -lh
          echo "ë°±ì—… ì••ì¶• ì™„ë£Œ."

      - name: ğŸ““ View PostgreSQL Logs # PostgreSQLì— ê¸°ë¡ëœ ë¡œê·¸ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
        run: |
          set -euo pipefail
          echo "PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ '${PG_DB}'ì—ì„œ ë¡œê·¸ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
          PGPASSFILE=$HOME/.pgpass psql -h 127.0.0.1 -U "${PG_USER}" -d "${PG_DB}" \
            -c "SELECT * FROM logs;"
          echo "PostgreSQL ë¡œê·¸ í‘œì‹œ ì™„ë£Œ."

      - name: ğŸ“„ Kafka-style Logs # Kafka-style ë¡œê·¸ íŒŒì¼ì„ í‘œì‹œí•©ë‹ˆë‹¤.
        run: |
          set -euo pipefail
          echo "Kafka-style ë¡œê·¸ íŒŒì¼ '${KAFKA_LOG}' ë‚´ìš© í‘œì‹œ ì¤‘..."
          cat "${KAFKA_LOG}" || echo "ìƒì„±ëœ Kafka-style ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤."
          echo "Kafka-style ë¡œê·¸ í‘œì‹œ ì™„ë£Œ."
