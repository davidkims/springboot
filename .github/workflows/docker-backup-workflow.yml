name: ğŸ³ Docker Image Build and Backup Storage Setup

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  schedule:
    - cron: "*/5 * * * *"  # 5ë¶„ë§ˆë‹¤ ìë™ ì‹¤í–‰

jobs:
  build-and-backup:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: finance-app
      IMAGE_TAG: latest
      BACKUP_VOLUME: finance_backup_vol
      BACKUP_DIR_IN_CONTAINER: /backup

    steps:
      - name: ğŸ§¾ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Dockerfile ìƒì„± (ì˜ˆì‹œìš©)
        run: |
          echo 'FROM alpine:latest' > Dockerfile
          echo 'RUN mkdir -p /app && echo "FINANCE DATA" > /app/data.txt' >> Dockerfile
          echo 'CMD ["sleep", "3600"]' >> Dockerfile

      - name: ğŸ—ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ
        run: |
          docker build -t $IMAGE_NAME:$IMAGE_TAG .

      - name: ğŸ“¦ ë°±ì—… ì €ì¥ì†Œìš© Docker ë³¼ë¥¨ ìƒì„±
        run: |
          docker volume create $BACKUP_VOLUME

      - name: ğŸš€ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ë³¼ë¥¨ ê³µìœ  í¬í•¨)
        run: |
          docker run -d --rm \
            --name finance-container \
            -v $BACKUP_VOLUME:$BACKUP_DIR_IN_CONTAINER \
            $IMAGE_NAME:$IMAGE_TAG

      - name: ğŸ’¾ ë°ì´í„° ë°±ì—… ì‹œë®¬ë ˆì´ì…˜ (ì˜ˆ: íŒŒì¼ ë³µì‚¬)
        run: |
          docker exec finance-container sh -c "cp /app/data.txt $BACKUP_DIR_IN_CONTAINER/backup-$(date +%Y%m%d%H%M%S).txt"

      - name: ğŸ“‚ ë³¼ë¥¨ ë‚´ ë°±ì—… íŒŒì¼ í™•ì¸
        run: |
          docker run --rm \
            -v $BACKUP_VOLUME:$BACKUP_DIR_IN_CONTAINER \
            alpine ls -l $BACKUP_DIR_IN_CONTAINER

      - name: ğŸ§¹ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ
        run: |
          docker stop finance-container || true
