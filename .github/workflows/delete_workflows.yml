name: Auto YAML Workflow Fix & Re-run

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write


jobs:
  auto_yaml_fix:
    name: "Auto-Fix YAML 워크플로우 파일 → 커밋 → 재실행"
    runs-on: ubuntu-latest
    permissions:
      contents: write


    steps:
      ####################################################################
      # 1) 전체 히스토리 체크아웃
      ####################################################################
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      ####################################################################
      # 2) “auto-yaml-fix” 커밋인지 확인해서 중복 실행 방지
      ####################################################################
      - name: Check if this commit is auto-yaml-fix
        id: is_autofix
        run: |
          MSG="${{ github.event.head_commit.message }}"
          echo "HEAD commit message: $MSG"
          if [[ "$MSG" == *"chore(auto-yaml-fix)"* ]]; then
            echo "is_autofix=true" >> $GITHUB_OUTPUT
          else
            echo "is_autofix=false" >> $GITHUB_OUTPUT
          fi

      ####################################################################
      # 3) auto-yaml-fix 커밋이 아닌 경우 → 필요한 도구 설치
      ####################################################################
      - name: Install Node.js & YAML linter
        if: steps.is_autofix.outputs.is_autofix == 'false'
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install yamllint

          # Node.js 설치 (Prettier 실행용)
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs
          npm install -g prettier

      ####################################################################
      # 4) auto-yaml-fix 커밋이 아닌 경우 → Prettier로 YAML 포맷팅
      ####################################################################
      - name: Run Prettier on .github/workflows/*.yml
        if: steps.is_autofix.outputs.is_autofix == 'false'
        run: |
          set -eux
          echo "▶ Prettier로 YAML 워크플로우 파일 포맷팅 중..."
          prettier --write ".github/workflows/*.yml" || true

      ####################################################################
      # 5) 변경사항이 있으면 커밋 준비
      ####################################################################
      - name: Check for unstaged changes
        if: steps.is_autofix.outputs.is_autofix == 'false'
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
          fi

      ####################################################################
      # 6) 수정사항이 있으면 자동으로 stash/rebase → 커밋 → 푸시
      ####################################################################
      - name: Commit & push YAML fixes
        if: steps.is_autofix.outputs.is_autofix == 'false' && steps.check_changes.outputs.no_changes == 'false'
        run: |
          set -eux
          echo "▶ YAML 워크플로우 파일 변경사항 감지됨 → 자동 rebase 및 커밋/푸시 시도"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # 1) 로컬 변경사항을 stash
          echo "→ 로컬 변경사항 stash 모드로 저장"
          git stash push -u -m "pre-rebase auto-yaml-fix" 1>/dev/null

          # 2) origin/main 최신 커밋 가져와서 rebase
          git fetch origin main
          echo "→ origin/main으로 rebase 시도"
          if ! git rebase origin/main; then
            echo "❌ Rebase 실패: 충돌 발생. 수동 해결이 필요합니다."
            git rebase --abort
            git stash pop 1>/dev/null || true
            exit 1
          fi

          # 3) stash 복원 후 충돌 검사
          echo "→ stash 복원"
          if ! git stash pop 1>/dev/null; then
            echo "❌ Stash 적용 중 충돌 발생: 자동 해결 불가"
            git merge --abort || true
            exit 1
          fi

          # 4) 포맷팅 후 추가로 변경된 파일을 다시 add
          git add .github/workflows/*.yml

          # 5) 커밋
          echo "→ auto-yaml-fix 커밋 생성"
          git commit -m "chore(auto-yaml-fix): format workflow YAML files"

          # 6) 원격 브랜치에 --force-with-lease 옵션으로 푸시
          echo "→ origin/main에 --force-with-lease 옵션으로 푸시"
          git push origin main --force-with-lease

          echo "✅ auto-yaml-fix 커밋 완료. 새 푸시로 워크플로우가 재실행됩니다."
          exit 0

      ####################################################################
      # 7) “auto-yaml-fix” 커밋이거나 변경사항 없는 경우 → yamllint 검사
      ####################################################################
      - name: Run yamllint on .github/workflows/*.yml
        run: |
          echo "=========================================="
          echo "▶ yamllint으로 YAML 워크플로우 파일 검사"
          echo "=========================================="
          yamllint -d "{extends: default, rules: {line-length: {max: 80}}}" .github/workflows/*.yml
