name: Disk & Cache Optimizer with Git Tagging

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'ìƒì„±í•  Git íƒœê·¸ ì´ë¦„ (ì˜ˆ: v1.0.0, release-20250608)'
        required: false
        type: string

jobs:
  optimize_and_tag:
    runs-on: ubuntu-latest
    permissions: # ğŸ‘ˆ ì´ ì„¹ì…˜ì„ ì¶”ê°€í•˜ê±°ë‚˜ ìˆ˜ì •í•©ë‹ˆë‹¤.
      contents: write # ğŸ‘ˆ íƒœê·¸ í‘¸ì‹œë¥¼ ìœ„í•´ 'write' ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.
      id-token: write # AWS OIDCë¥¼ ì‚¬ìš©í•œë‹¤ë©´ ìœ ì§€
      pull-requests: write # PR ê´€ë ¨ ì‘ì—…ì´ ìˆë‹¤ë©´ ì¶”ê°€
      # packages: write # GitHub Packagesì— í‘¸ì‹œí•œë‹¤ë©´ ì¶”ê°€
      # deployments: write # ë°°í¬ ì‘ì—…ì´ ìˆë‹¤ë©´ ì¶”ê°€
      # issues: write # ì´ìŠˆ ê´€ë ¨ ì‘ì—…ì´ ìˆë‹¤ë©´ ì¶”ê°€
      # etc. í•„ìš”í•œ ë‹¤ë¥¸ ê¶Œí•œë„ ì—¬ê¸°ì— ì¶”ê°€

    steps:
      - name: ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --- ë””ìŠ¤í¬ ìµœì í™” ë° ì •ë¦¬ ---
      - name: ì´ˆê¸° ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ë³´ê³ 
        run: |
          echo "ì´ˆê¸° ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
          df -h

      - name: ë¶ˆí•„ìš”í•œ Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬
        run: |
          echo "ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” Docker ì´ë¯¸ì§€, ì»¨í…Œì´ë„ˆ, ë³¼ë¥¨, ë¹Œë“œ ìºì‹œ ì •ë¦¬..."
          docker system prune --all --force --volumes
          echo "Docker ì •ë¦¬ í›„ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
          df -h

      - name: ìºì‹œ ë””ë ‰í† ë¦¬ ìƒì„± í™•ì¸
        run: |
          mkdir -p ~/.npm
          echo "ìºì‹œ ë””ë ‰í† ë¦¬ ìƒì„±ì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤."

      # --- ìºì‹œ ìµœì í™” (ì†ë„ í–¥ìƒ) ---
      - name: ì¢…ì†ì„± ìºì‹œ ë³µì›
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      # --- ë¹Œë“œ í”„ë¡œì„¸ìŠ¤ (ì£¼ìš” ì‘ì—…) ---
      # âš ï¸ ì¤‘ìš”: ì•„ë˜ ì¢…ì†ì„± ì„¤ì¹˜ ë° ìºì‹œ ì„¤ì •ì„ í”„ë¡œì íŠ¸ ìœ í˜•ì— ë§ê²Œ ì„ íƒ/ìˆ˜ì •í•˜ì„¸ìš”.
      - name: package.json ì¡´ì¬ ì—¬ë¶€ í™•ì¸ (Node.js í”„ë¡œì íŠ¸ìš©)
        id: check_package_json
        run: |
          if [ -f "package.json" ]; then
            echo "::set-output name=exists::true"
            echo "package.json íŒŒì¼ì´ í˜„ì¬ ë””ë ‰í† ë¦¬ì—ì„œ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            echo "::set-output name=exists::false"
            echo "package.json íŒŒì¼ì´ í˜„ì¬ ë””ë ‰í† ë¦¬ì—ì„œ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          fi

      - name: Node.js ì¢…ì†ì„± ì„¤ì¹˜
        if: steps.check_package_json.outputs.exists == 'true'
        run: |
          npm ci
          echo "Node.js ì¢…ì†ì„±ì´ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤."

      - name: Node.js ì¢…ì†ì„± ìºì‹œ ì €ì¥
        if: steps.check_package_json.outputs.exists == 'true' && success()
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}

      # --- ì‚¬ìš©ì ì •ì˜ ë””ìŠ¤í¬ ìµœì í™” ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ---
      - name: ì‚¬ìš©ì ì •ì˜ ë””ìŠ¤í¬ ìµœì í™” ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        run: |
          chmod +x scripts/optimize_disk.sh
          bash scripts/optimize_disk.sh .github
          echo "ì‚¬ìš©ì ì •ì˜ ë””ìŠ¤í¬ ìµœì í™” ìŠ¤í¬ë¦½íŠ¸ê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "ì‚¬ìš©ì ì •ì˜ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ í›„ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
          df -h

      # --- Git íƒœê·¸ ìƒì„± ë° í‘¸ì‹œ ---
      - name: Git íƒœê·¸ ìƒì„± ë° í‘¸ì‹œ
        if: github.event.inputs.tag_name != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME=${{ github.event.inputs.tag_name }}
          echo "ìƒˆë¡œìš´ Git íƒœê·¸ '$TAG_NAME'ì„ ìƒì„±í•˜ê³  í‘¸ì‹œí•©ë‹ˆë‹¤."

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git tag $TAG_NAME
          git push origin $TAG_NAME

          echo "íƒœê·¸ '$TAG_NAME' í‘¸ì‹œ ì™„ë£Œ."
