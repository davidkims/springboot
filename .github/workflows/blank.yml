name: 📘 README에 워크플로우 자동 요약 (echo 기반)

on:
  push:
    paths:
      - ".github/workflows/*.yml"
  workflow_dispatch:

jobs:
  summarize-workflows:
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Checkout
      uses: actions/checkout@v4

    - name: 🐍 Python 설치 및 스크립트 생성 (echo 기반)
      run: |
        pip install pyyaml

        echo "import os, yaml

workflow_dir = '.github/workflows'
rows = []

for file in os.listdir(workflow_dir):
    if file.endswith('.yml') or file.endswith('.yaml'):
        path = os.path.join(workflow_dir, file)
        with open(path, encoding='utf-8') as f:
            try:
                data = yaml.safe_load(f)
                name = data.get('name', 'N/A')
                trigger = ', '.join(data.get('on', {}).keys()) if isinstance(data.get('on'), dict) else str(data.get('on'))
                jobs = ', '.join(data.get('jobs', {}).keys()) if 'jobs' in data else 'N/A'
                rows.append((file, name, trigger, jobs))
            except Exception as e:
                rows.append((file, '⚠️ 오류', 'N/A', 'N/A'))

table = '| 워크플로우 파일 | 워크플로우 이름 | 트리거 | 주요 작업 |\\n'
table += '|----------------|----------------|--------|-----------|\\n'
for r in rows:
    table += f'| {r[0]} | {r[1]} | {r[2]} | {r[3]} |\\n'

readme_path = 'README.md'
if not os.path.exists(readme_path):
    with open(readme_path, 'w', encoding='utf-8') as f:
        f.write('# 프로젝트 설명\\n\\n')

with open(readme_path, 'r', encoding='utf-8') as rf:
    original = rf.read()

if '## 🔧 GitHub Actions 워크플로우 요약' in original:
    head = original.split('## 🔧 GitHub Actions 워크플로우 요약')[0].strip()
else:
    head = original.strip()

with open(readme_path, 'w', encoding='utf-8') as wf:
    wf.write(head + '\\n\\n## 🔧 GitHub Actions 워크플로우 요약\\n\\n' + table)

print('✅ README.md 업데이트 완료')
" > summarize_workflows.py

        python3 summarize_workflows.py

    - name: ✅ 변경 커밋 및 푸시
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add README.md
        git commit -m "📘 README 워크플로우 요약 자동 업데이트" || echo "변경 사항 없음"
        git push
