name: ğŸ¦¾ ê±°ë˜ ìë™í™” - PDF ì˜ìˆ˜ì¦ í¬í•¨

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  compose-ledger:
    runs-on: ubuntu-latest
    steps:
      - name: íŒŒì¼ ê²€ìƒ‰
        run: |
          mkdir -p output/receipts
          echo "\n\nğŸ“¦ ì˜ìˆ˜ì¦ PDF ëª©ë¡ í™•ì¸:\n"
          find output/receipts -type f -name "*.pdf" || echo "âŒ PDF ì—†ìŒ"
          echo "\nğŸ“¦ ì „ì²´ output ë””ë ‰í† ë¦¬ êµ¬ì¡°:\n"
          ls -R output || echo "âŒ output ë””ë ‰í† ë¦¬ ì—†ìŒ"

      - name: í•„ë“œ í´ë˜ìŠ¤ ê±°ë˜ ë³€ë™ë³´ ì¶”ê°€
        run: |
          mkdir -p app/export
          echo "ğŸ“„ exchange.py ìƒì„±"
          echo 'import csv, datetime, random, os' > app/exchange.py
          echo 'def generate_export_report():' >> app/exchange.py
          echo ' os.makedirs("output/export", exist_ok=True)' >> app/exchange.py
          echo ' f = open("output/export/export_transactions.csv", "w", newline="", encoding="utf-8")' >> app/exchange.py
          echo ' writer = csv.writer(f)' >> app/exchange.py
          echo ' writer.writerow(["ì‹œê°„", "í†µí™”", "ìœ í˜•", "ê¸ˆì•¡", "ìˆ˜ìˆ˜ë£Œ", "ì´ì•¡"])' >> app/exchange.py
          echo ' for i in range(50):' >> app/exchange.py
          echo '  dt = datetime.datetime.now().isoformat()' >> app/exchange.py
          echo '  currency = random.choice(["USD", "KRW", "EUR", "JPY"])' >> app/exchange.py
          echo '  type = random.choice(["ìˆ˜ì…", "ìˆ˜ì¶œ"])' >> app/exchange.py
          echo '  amt = round(random.uniform(1000, 50000), 2)' >> app/exchange.py
          echo '  fee = round(amt * 0.015, 2)' >> app/exchange.py
          echo '  total = amt - fee' >> app/exchange.py
          echo '  writer.writerow([dt, currency, type, amt, fee, total])' >> app/exchange.py
          echo ' f.close()' >> app/exchange.py
          echo 'if __name__ == "__main__": generate_export_report()' >> app/exchange.py

          echo 'FROM python:3.10-slim' > app/Dockerfile.exchange
          echo 'WORKDIR /app' >> app/Dockerfile.exchange
          echo 'COPY exchange.py .' >> app/Dockerfile.exchange
          echo 'CMD ["python", "exchange.py"]' >> app/Dockerfile.exchange

      - name: ğŸ“¦ ê¸ˆìœµ ìˆ˜ì¶œì… ê±°ë˜ ìƒì„± ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        run: |
          docker build -f app/Dockerfile.exchange -t exchange-ledger ./app
          docker run --rm -v ${{ github.workspace }}/output:/app/output exchange-ledger

      - name: ğŸ“¤ ìˆ˜ì¶œì… ê±°ë˜ CSV ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: ê¸ˆìœµ_ìˆ˜ì¶œì…_ê±°ë˜
          path: output/export/export_transactions.csv

      - name: ğŸ“¦ ê²°ê³¼ í™•ì¸ìš© ë””ë ‰í† ë¦¬ ì¶œë ¥
        run: |
          echo "\nğŸ“ ê²°ê³¼ ë””ë ‰í† ë¦¬ êµ¬ì¡°:\n"
          ls -R output || echo "âŒ ê²°ê³¼ ì—†ìŒ"

      - name: ğŸ“¤ ê±°ë˜ CSV ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: ê±°ë˜ë°ì´í„°
          path: output/transactions.csv

      - name: ğŸ“¤ ì˜ìˆ˜ì¦ TXT ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: ì˜ìˆ˜ì¦_í…ìŠ¤íŠ¸
          path: output/receipts/*.txt

      - name: ğŸ“¤ ì˜ìˆ˜ì¦ PDF ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: ì˜ìˆ˜ì¦_PDF
          path: output/receipts/*.pdf
