name: 🧾 SQL Docker Finance Backup

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  IMAGE_NAME: ghcr.io/davidkims/finance-ledger
  IMAGE_TAG: latest
  BACKUP_DIR: /tmp/finance-backup
  DB_FILE: finance.db

jobs:
  finance-ledger:
    runs-on: ubuntu-latest

    steps:
    - name: 📦 Checkout Code
      uses: actions/checkout@v4

    - name: ⬇️ Download Dockerfile and ledger.py
      run: |
        mkdir -p app
        curl -fsSL https://raw.githubusercontent.com/davidkims/assets/main/finance-ledger/Dockerfile -o Dockerfile
        curl -fsSL https://raw.githubusercontent.com/davidkims/assets/main/finance-ledger/ledger.py -o app/ledger.py

    - name: 🐳 Build Docker Image
      run: docker build -t $IMAGE_NAME:$IMAGE_TAG .

    - name: 📁 Prepare Backup Directory
      run: |
        sudo mkdir -p $BACKUP_DIR
        sudo chmod -R 777 $BACKUP_DIR

    - name: 🐳 Run Container to Generate Ledger
      run: docker run --rm -v $BACKUP_DIR:/data $IMAGE_NAME:$IMAGE_TAG

    - name: 📄 Show Ledger Contents
      run: |
        if [ -f "$BACKUP_DIR/$DB_FILE" ]; then
          sudo apt-get update && sudo apt-get install -y sqlite3
          sqlite3 $BACKUP_DIR/$DB_FILE "SELECT * FROM ledger;"
        else
          echo "❌ DB not found: $BACKUP_DIR/$DB_FILE"
          exit 1
        fi

    - name: 💾 Compress Ledger
      run: |
        cd $BACKUP_DIR
        tar -czf finance-ledger-${{ github.run_id }}.tar.gz $DB_FILE
