name: Setup & Load Loans Ledger with Backup

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'  # ë§¤ì‹œ ì •ê° ìë™ ì‹¤í–‰

jobs:
  setup-and-load:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸ³ Setup Docker
        run: |
          echo "[+] Installing Docker..."
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          sudo systemctl start docker
          docker --version
          echo "[âœ”] Docker ì„¤ì¹˜ ì™„ë£Œ"

      - name: ğŸ˜ Run PostgreSQL Container
        run: |
          echo "[+] PostgreSQL ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘..."
          docker rm -f pg-loans || true
          docker run -d \
            --name pg-loans \
            -e POSTGRES_DB=loans \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres123 \
            -v pgdata:/var/lib/postgresql/data \
            -p 5433:5432 postgres:15
          echo "[âœ”] PostgreSQL ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì™„ë£Œ"
          sleep 15

      - name: ğŸ§± Create loan_ledger Schema
        run: |
          echo "[+] loan_ledger í…Œì´ë¸” ìƒì„± ì¤‘..."
          INIT_SQL=$(mktemp)
          echo "CREATE TABLE IF NOT EXISTS loan_ledger (" > $INIT_SQL
          echo "  id SERIAL PRIMARY KEY," >> $INIT_SQL
          echo "  customer_name TEXT NOT NULL," >> $INIT_SQL
          echo "  loan_amount DECIMAL(10,2) NOT NULL," >> $INIT_SQL
          echo "  issued_date DATE" >> $INIT_SQL
          echo ");" >> $INIT_SQL
          docker cp "$INIT_SQL" pg-loans:/tmp/schema.sql
          docker exec pg-loans psql -U postgres -d loans -f /tmp/schema.sql
          echo "[âœ”] loan_ledger ìŠ¤í‚¤ë§ˆ ìƒì„± ì™„ë£Œ"

      - name: ğŸ“„ Generate loans.csv
        run: |
          echo "[+] loans.csv íŒŒì¼ ìƒì„± ì¤€ë¹„ ì¤‘..."
          mkdir -p data
          echo "[+] mkdir -p data"
          echo "[+] echo header"
          echo "customer_name,loan_amount,issued_date" > data/loans.csv

          echo "[+] echo line 1"
          echo "Alice,1000.00,2024-01-01" >> data/loans.csv

          echo "[+] echo line 2"
          echo "Bob,2500.50,2024-02-15" >> data/loans.csv

          echo "[+] echo line 3"
          echo "Charlie,3300.75,2024-03-10" >> data/loans.csv

          echo "[âœ”] loans.csv íŒŒì¼ ì‘ì„± ì™„ë£Œ"
          echo "[+] loans.csv íŒŒì¼ í™•ì¸:"
          head -n 5 data/loans.csv
          if [ ! -f data/loans.csv ]; then echo "[âŒ] loans.csv íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤." && exit 1; fi

      - name: ğŸ“¥ Load CSV to loan_ledger
        run: |
          echo "[+] CSV íŒŒì¼ì„ loan_ledger í…Œì´ë¸”ë¡œ ì ì¬ ì¤‘..."
          docker cp data/loans.csv pg-loans:/tmp/loans.csv
          docker exec pg-loans bash -c "psql -U postgres -d loans -c \
            \"COPY loan_ledger(customer_name, loan_amount, issued_date) \
            FROM '/tmp/loans.csv' DELIMITER ',' CSV HEADER;\""
          echo "[âœ”] CSV ì ì¬ ì™„ë£Œ"

      - name: ğŸ’¾ Export SQL Backup
        run: |
          echo "[+] SQL ë°±ì—… ì‹œì‘..."
          mkdir -p backup
          TIMESTAMP=$(date +'%Y%m%d%H%M')
          BACKUP_FILE=backup/loan_backup_$TIMESTAMP.sql
          docker exec pg-loans pg_dump -U postgres -d loans > $BACKUP_FILE
          echo "[âœ”] SQL ë°±ì—… ì™„ë£Œ â†’ $BACKUP_FILE"

      - name: ğŸ” Restore Latest Backup (Optional Test)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "[+] ìµœì‹  ë°±ì—… ë³µì› í…ŒìŠ¤íŠ¸ ì‹œì‘..."
          LATEST_BACKUP=$(ls backup/loan_backup_*.sql | sort | tail -n1)
          echo "[+] ìµœì‹  ë°±ì—… íŒŒì¼: $LATEST_BACKUP"

          docker rm -f pg-restore || true
          docker run -d \
            --name pg-restore \
            -e POSTGRES_DB=loans \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres123 \
            -p 5434:5432 postgres:15
          sleep 15
          docker cp "$LATEST_BACKUP" pg-restore:/tmp/restore.sql
          docker exec pg-restore psql -U postgres -d loans -f /tmp/restore.sql
          echo "[âœ”] ë³µì› ì™„ë£Œ from $LATEST_BACKUP"
