# .github/workflows/codespace-security-check.yml
name: Codespace Security Configuration Check

on:
  pull_request:
    branches:
      - main # main 브랜치로 merge되는 Pull Request에 대해 실행
    paths:
      - '.devcontainer/**' # .devcontainer 디렉토리 내의 파일 변경 시 트리거

jobs:
  check-devcontainer-config:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4

      - name: Check devcontainer.json for insecure port forwarding
        id: check_ports
        run: |
          if [ -f .devcontainer/devcontainer.json ]; then
            if grep -q '"portsAttributes": {.*"visibility": "public".*}' .devcontainer/devcontainer.json; then
              echo "::error file=.devcontainer/devcontainer.json::Public port forwarding detected in devcontainer.json. Please review for security implications."
              echo "Public port forwarding is generally not recommended unless strictly necessary and reviewed."
              exit 1 # Public 포트 포워딩이 발견되면 워크플로우 실패
            else
              echo "No public port forwarding found in devcontainer.json. Good."
            fi
          else
            echo ".devcontainer/devcontainer.json not found. Skipping port check."
          fi
        # If you want to allow codespaces without .devcontainer, remove `exit 1` or make this step continue-on-error: true

      - name: Check Dockerfile for approved base image
        id: check_dockerfile_base
        run: |
          if [ -f .devcontainer/Dockerfile ]; then
            # Universal Dev Container Image 사용 강제
            if ! grep -q '^FROM mcr.microsoft.com/vscode/devcontainers/universal:latest' .devcontainer/Dockerfile; then
              echo "::error file=.devcontainer/Dockerfile::Unauthorized base image found in Dockerfile. Only 'mcr.microsoft.com/vscode/devcontainers/universal:latest' is allowed."
              exit 1 # 승인되지 않은 베이스 이미지 발견 시 워크플로우 실패
            else
              echo "Dockerfile uses the approved base image. Good."
            fi
          else
            echo ".devcontainer/Dockerfile not found. Skipping Dockerfile base image check."
          fi

      - name: Notify security team if checks fail
        if: failure()
        run: |
          echo "Security checks for Codespace configuration failed. Please review the Pull Request."
          # 실제 시나리오에서는 여기에 보안 팀에게 Slack, email 등의 알림을 보내는 코드를 추가할 수 있습니다.
          # 예: curl -X POST -H 'Content-type: application/json' --data '{"text":"Codespace configuration check failed for PR #${{ github.event.pull_request.number }}"}' YOUR_SLACK_WEBHOOK_URL
