name: üß™ Maven Spring Boot Multi-Module Build & Export

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-and-export:
    runs-on: ubuntu-latest
    env:
      MAVEN_VERSION: 3.9.6
      EXPORT_DIR: /opt/export
      BUILD_DIR: build-artifacts
      TIMESTAMP: "20250603015712"

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: ‚òï Install Latest Maven
        run: |
          wget https://downloads.apache.org/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz
          tar -xzvf apache-maven-${MAVEN_VERSION}-bin.tar.gz -C /opt
          mv /opt/apache-maven-${MAVEN_VERSION} /opt/maven
          echo "MAVEN_HOME=/opt/maven" >> $GITHUB_ENV
          echo "/opt/maven/bin" >> $GITHUB_PATH

      - name: üß™ Build & Test Spring Boot App
        run: |
          if [ -f "./pom.xml" ]; then
            echo "üìÅ Î£®Ìä∏Ïóê pom.xml ÏûàÏùå ‚Üí ÎπåÎìú Ïã§Ìñâ"
            /opt/maven/bin/mvn clean install -B
          elif [ -f "./project/pom.xml" ]; then
            echo "üìÅ ./project Í≤ΩÎ°úÏóê pom.xml ÏûàÏùå ‚Üí Ìï¥Îãπ Í≤ΩÎ°úÎ°ú Ïù¥Îèô ÌõÑ ÎπåÎìú"
            cd project
            /opt/maven/bin/mvn clean install -B
          else
            echo "‚ùå pom.xmlÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. ÎπåÎìúÎ•º Í±¥ÎÑàÎúÅÎãàÎã§."
            exit 1
          fi

      - name: üì¶ Create Export Directory
        run: |
          sudo mkdir -p $EXPORT_DIR
          sudo chmod -R 777 $EXPORT_DIR
          mkdir -p $BUILD_DIR

      - name: üöö Export JARs from all modules
        run: |
          find . -type f -name "*.jar" -path "*/target/*.jar" -exec cp {} $EXPORT_DIR/ \;
          if compgen -G "$EXPORT_DIR/*.jar" > /dev/null; then
            cp -r $EXPORT_DIR/*.jar $BUILD_DIR/
            echo "üì¶ Exported JARs to $BUILD_DIR"
          else
            echo "‚ö†Ô∏è No JARs found to export."
          fi

      - name: üìú List Exported Files
        run: ls -lh $BUILD_DIR || echo "‚ö†Ô∏è No build artifacts found."

      - name: üßæ Timestamped Artifact Archive
        run: |
          cd $BUILD_DIR
          tar -czf maven-artifacts-${TIMESTAMP}.tar.gz *.jar || echo "‚ö†Ô∏è No JARs to compress."
          ls -lh
