name: â™»ï¸ ì›Œí¬í”Œë¡œìš° ì¬ì‹¤í–‰ & ê±°ë˜ìš© í…Œì´ë¸” ìë™ ìƒì„±

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: write
  id-token: write

jobs:
  retrigger-and-init:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“ echo ê¸°ë°˜ SQL ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
        run: |
          mkdir -p db/init

          echo "ğŸ“„ PostgreSQL í…Œì´ë¸” ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ìƒì„±"
          cat << 'EOF' > db/init/init-postgres.sql
          CREATE TABLE IF NOT EXISTS workflow_audit_log (
            id SERIAL PRIMARY KEY,
            workflow_name TEXT,
            triggered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            status TEXT
          );

          CREATE TABLE IF NOT EXISTS ledger_transactions (
            id SERIAL PRIMARY KEY,
            tx_time TEXT,
            tx_type TEXT,
            company TEXT,
            amount NUMERIC,
            currency TEXT,
            status TEXT,
            description TEXT
          );
          EOF

          echo "ğŸ“„ MySQL í…Œì´ë¸” ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ìƒì„±"
          cat << 'EOF' > db/init/init-mysql.sql
          CREATE TABLE IF NOT EXISTS workflow_audit_log (
            id INT AUTO_INCREMENT PRIMARY KEY,
            workflow_name VARCHAR(255),
            triggered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            status VARCHAR(50)
          );

          CREATE TABLE IF NOT EXISTS ledger_transactions (
            id INT AUTO_INCREMENT PRIMARY KEY,
            tx_time VARCHAR(100),
            tx_type VARCHAR(50),
            company VARCHAR(50),
            amount FLOAT,
            currency VARCHAR(10),
            status VARCHAR(50),
            description TEXT
          );
          EOF

      - name: ğŸ˜ PostgreSQL ì»¨í…Œì´ë„ˆ ì‹œì‘ ë° í…Œì´ë¸” ì ìš©
        run: |
          echo "ğŸ˜ PostgreSQL ì‹œì‘"
          docker run --rm --name pg-init -e POSTGRES_PASSWORD=pass -e POSTGRES_DB=ledger -v ${{ github.workspace }}/db/init:/docker-entrypoint-initdb.d -d postgres:14

          echo "â±ï¸ PostgreSQL ì´ˆê¸°í™” ëŒ€ê¸°"
          sleep 10

          echo "âœ… PostgreSQL ì´ˆê¸°í™” ì™„ë£Œ í›„ ì¢…ë£Œ"
          docker stop pg-init

      - name: ğŸ¬ MySQL ì»¨í…Œì´ë„ˆ ì‹œì‘ ë° í…Œì´ë¸” ì ìš©
        run: |
          echo "ğŸ¬ MySQL ì‹œì‘"
          docker run --rm --name mysql-init -e MYSQL_ROOT_PASSWORD=pass -e MYSQL_DATABASE=ledger -v ${{ github.workspace }}/db/init:/docker-entrypoint-initdb.d -d mysql:8

          echo "â±ï¸ MySQL ì´ˆê¸°í™” ëŒ€ê¸°"
          sleep 25

          echo "âœ… MySQL ì´ˆê¸°í™” ì™„ë£Œ í›„ ì¢…ë£Œ"
          docker stop mysql-init

      - name: â™»ï¸ .github/workflows/*.yml ì›Œí¬í”Œë¡œìš° ì¬ì‹¤í–‰ ìš”ì²­
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” ëª¨ë“  ì›Œí¬í”Œë¡œìš° YAML ëª©ë¡ ìˆ˜ì§‘"
          for file in .github/workflows/*.yml; do
            name=$(basename "$file" .yml)
            echo "ğŸ” ì›Œí¬í”Œë¡œìš° [$name] ê°•ì œ ì¬íŠ¸ë¦¬ê±°"
            gh workflow run "$name.yml" || echo "âš ï¸ $name ì¬ì‹¤í–‰ ì‹¤íŒ¨"
          done
