name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ë°°í¬ (ì˜¤ë¥˜ ìŠ¤í‚µ í¬í•¨)

on:
  push:
    branches:
      - main # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
  pull_request:
    branches:
      - main # main ë¸Œëœì¹˜ë¡œ í’€ ë¦¬í€˜ìŠ¤íŠ¸ ë°œìƒ ì‹œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
  workflow_dispatch: # GitHub UIì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©

env:
  # Docker ì´ë¯¸ì§€ ì´ë¦„ (ì›í•˜ëŠ” ì´ë¦„ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”)
  IMAGE_NAME: my-app-image
  # Docker ì´ë¯¸ì§€ íƒœê·¸ (Git SHAë¥¼ ì‚¬ìš©í•˜ì—¬)
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # ì´ ì‘ì—…ì„ ì‹¤í–‰í•  ìš´ì˜ì²´ì œ í™˜ê²½ì„ ì§€ì •í•©ë‹ˆë‹¤.

    # ê¶Œí•œ ì„¤ì •: Docker Hub ë˜ëŠ” GHCRì— ì´ë¯¸ì§€ë¥¼ í‘¸ì‹œí•˜ë ¤ë©´ 'packages: write' ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: ğŸš€ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        continue-on-error: true # ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰

      - name: ğŸ’¬ ì½”ë“œ ì²´í¬ì•„ì›ƒ ì™„ë£Œ ë©”ì‹œì§€
        run: echo "--- ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œ ì²´í¬ì•„ì›ƒ ì™„ë£Œ ---"

      - name: ğŸ³ Docker ë° Docker Compose ìˆ˜ë™ ì„¤ì¹˜
        # docker/setup-docker ì•¡ì…˜ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  ì§ì ‘ ì„¤ì¹˜í•©ë‹ˆë‹¤.
        run: |
          echo "--- Docker ë° Docker Compose ìˆ˜ë™ ì„¤ì¹˜ ì‹œì‘ ---"
          sudo apt-get update -y
          sudo apt-get install -y apt-transport-https ca-certificates curl software-properties-common
          curl --proto '=https' --tlsv1.2 -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt-get update -y
          sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
          echo "--- Docker ë° Docker Compose ìˆ˜ë™ ì„¤ì¹˜ ì™„ë£Œ ---"
        continue-on-error: true # ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰

      - name: â„¹ï¸ Docker CLI ë²„ì „ í™•ì¸ ë° ì •ë³´ ì¶œë ¥
        run: |
          echo "í˜„ì¬ ì‹œìŠ¤í…œì˜ Docker ë²„ì „ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:"
          docker --version
          echo "Docker Compose ë²„ì „ (ì„¤ì¹˜ë˜ì–´ ìˆëŠ” ê²½ìš°):"
          docker compose version || true
          echo "Docker ì‹œìŠ¤í…œ ì •ë³´:"
          docker info
          echo "--- Docker CLI ì¤€ë¹„ ì™„ë£Œ ---"
        continue-on-error: true # ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰

      - name: ğŸ“ íŒŒì¼ ë° ë””ë ‰í† ë¦¬ ìƒì„±
        run: |
          echo "--- íŒŒì¼ ë° ë””ë ‰í† ë¦¬ ìƒì„± ì‹œì‘ ---"
          echo "ìƒˆë¡œìš´ ë””ë ‰í† ë¦¬ 'my-data-volume' ìƒì„± ì¤‘..."
          mkdir -p my-data-volume/logs
          echo "ìƒˆë¡œìš´ íŒŒì¼ 'my-data-volume/app.log' ìƒì„± ì¤‘..."
          echo "ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ë¡œê·¸: $(date)" > my-data-volume/app.log
          echo "ë˜ ë‹¤ë¥¸ íŒŒì¼ 'my-data-volume/logs/error.log' ìƒì„± ì¤‘..."
          echo "ì—ëŸ¬ ë°œìƒ: $(date)" > my-data-volume/logs/error.log
          echo "ìƒì„±ëœ íŒŒì¼ ë° ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸:"
          ls -R my-data-volume/
          echo "--- íŒŒì¼ ë° ë””ë ‰í† ë¦¬ ìƒì„± ì™„ë£Œ ---"
        continue-on-error: true # ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰

      - name: âš™ï¸ Docker Buildx ì„¤ì • (Docker ìˆ˜ë™ ì„¤ì¹˜ ì‹œì—ëŠ” í•„ìš” ì—†ì„ ìˆ˜ ìˆìŒ)
        # docker-buildx-pluginì´ ìˆ˜ë™ ì„¤ì¹˜ì— í¬í•¨ë˜ì—ˆìœ¼ë¯€ë¡œ ì´ ì•¡ì…˜ì€ í•„ìš” ì—†ì„ ìˆ˜ ìˆìœ¼ë‚˜,
        # ì•ˆì •ì„±ì„ ìœ„í•´ ë‚¨ê²¨ë‘¡ë‹ˆë‹¤. ì˜¤ë¥˜ ë°œìƒ ì‹œ ì´ ì•¡ì…˜ë„ ì œê±° ê³ ë ¤.
        uses: docker/setup-buildx-action@v2
        continue-on-error: true # ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰

      - name: ğŸ’¬ Docker Buildx ì„¤ì • ì™„ë£Œ ë©”ì‹œì§€
        run: echo "--- Docker Buildx ì„¤ì • ì™„ë£Œ ---"
        continue-on-error: true # ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰

      - name: ğŸ”‘ Docker Hub ì‹œí¬ë¦¿ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        run: |
          echo "DOCKER_USERNAME_VAL=${{ secrets.DOCKER_USERNAME || '' }}" >> $GITHUB_ENV
          echo "DOCKER_PASSWORD_VAL=${{ secrets.DOCKER_PASSWORD || '' }}" >> $GITHUB_ENV
        continue-on-error: true

      - name: ğŸ”‘ Docker Hub ë¡œê·¸ì¸ (ì„ íƒ ì‚¬í•­:docker Hubì— í‘¸ì‹œí•  ê²½ìš°)
        if: ${{ env.DOCKER_USERNAME_VAL != '' && env.DOCKER_PASSWORD_VAL != '' }}
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME_VAL }}
          password: ${{ env.DOCKER_PASSWORD_VAL }}
        continue-on-error: true # ë¡œê·¸ì¸ ì‹¤íŒ¨ ì‹œì—ë„ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰

      - name: ğŸ’¬ Docker Hub ë¡œê·¸ì¸ ì‹œë„ ì™„ë£Œ ë©”ì‹œì§€ (ì¡°ê±´ë¶€ ì¶œë ¥)
        if: ${{ env.DOCKER_USERNAME_VAL != '' && env.DOCKER_PASSWORD_VAL != '' }}
        run: echo "--- Docker Hub ë¡œê·¸ì¸ ì‹œë„ ì™„ë£Œ (ì‹œí¬ë¦¿ì´ ìˆëŠ” ê²½ìš°) ---"
        continue-on-error: true # ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰

      - name: ğŸ”‘ GitHub Container Registry (GHCR) ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true # ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰

      - name: ğŸ’¬ GHCR ë¡œê·¸ì¸ ì‹œë„ ì™„ë£Œ ë©”ì‹œì§€
        run: echo "--- GHCR ë¡œê·¸ì¸ ì‹œë„ ì™„ë£Œ ---"
        continue-on-error: true # ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰

      - name: ğŸ—ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ
        # docker/build-push-action@v4ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile # Dockerfile ê²½ë¡œ ì§€ì •
          tags: |
            ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest
          outputs: type=docker # ë¹Œë“œëœ ì´ë¯¸ì§€ë¥¼ Docker ë°ëª¬ì— ë¡œë“œí•˜ì—¬ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.
          push: false # ì¼ë‹¨ ë¹Œë“œí•˜ê³  í‘¸ì‹œëŠ” í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        continue-on-error: true # ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰

      - name: ğŸ’¬ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘ ë° ì™„ë£Œ ë©”ì‹œì§€
        run: |
          echo "--- Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘ ---"
          echo "ë¹Œë“œ ì¤‘ì¸ ì´ë¯¸ì§€: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          echo "Dockerfile ê²½ë¡œ: ./Dockerfile"
          echo "--- Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ ---"
        continue-on-error: true # ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰

      - name: ğŸ” ë¹Œë“œëœ Docker ì´ë¯¸ì§€ í™•ì¸
        run: |
          echo "--- ë¹Œë“œëœ Docker ì´ë¯¸ì§€ ëª©ë¡ ---"
          docker images
          echo "--- ì´ë¯¸ì§€ í™•ì¸ ì™„ë£Œ ---"
        continue-on-error: true # ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰

      - name: ğŸ“¤ Docker ì´ë¯¸ì§€ í‘¸ì‹œ (Docker Hub)
        if: ${{ env.DOCKER_USERNAME_VAL != '' && env.DOCKER_PASSWORD_VAL != '' }}
        run: |
          echo "--- Docker Hubë¡œ ì´ë¯¸ì§€ í‘¸ì‹œ ì‹œì‘ ---"
          docker push ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          docker push ${{ env.IMAGE_NAME }}:latest # ìµœì‹  íƒœê·¸ë„ í‘¸ì‹œ
          echo "--- Docker Hub í‘¸ì‹œ ì™„ë£Œ ---"
        continue-on-error: true # í‘¸ì‹œ ì‹¤íŒ¨ ì‹œì—ë„ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰

      - name: ğŸ“¤ Docker ì´ë¯¸ì§€ í‘¸ì‹œ (GitHub Container Registry)
        run: |
          echo "--- GHCRë¡œ ì´ë¯¸ì§€ í‘¸ì‹œ ì‹œì‘ ---"
          docker push ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          docker push ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest
          echo "--- GHCR í‘¸ì‹œ ì™„ë£Œ ---"
        continue-on-error: true # ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰

      - name: ğŸƒ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ì„ íƒ ì‚¬í•­:ë¹Œë“œëœ ì´ë¯¸ì§€ í…ŒìŠ¤íŠ¸ìš©)
        run: |
          echo "--- Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹œì‘ (í…ŒìŠ¤íŠ¸ìš©) ---"
          echo "ì‹¤í–‰ ì¤‘ì¸ ì´ë¯¸ì§€: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          docker run --rm ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          echo "--- Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì™„ë£Œ ---"
        continue-on-error: true # ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰
