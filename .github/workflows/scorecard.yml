name: Scorecard Supply-Chain Security

on:
  # 브랜치 보호 확인. 기본 브랜치만 지원됩니다.
  # https://github.com/ossf/scorecard/blob/main/docs/checks.md#branch-protection 참조
  # 유지 관리 점검이 정기적으로 업데이트되도록 보장합니다.
  # https://github.com/ossf/scorecard/blob/main/docs/checks.md#maintained 참조
  schedule:
    - cron: '21 2 * * 0' # 매주 일요일 새벽 2시 21분 UTC에 실행
  push:
    branches: ["main"] # 'main' 브랜치에 푸시될 때 실행

# 기본 권한을 읽기 전용으로 선언하여 최소 권한 원칙을 따릅니다.
permissions:
  contents: read # 기본적으로 리포지토리 콘텐츠에 대한 읽기 권한만 부여

jobs:
  analyze:
    name: Scorecard 분석
    runs-on: ubuntu-latest

    # `publish_results: true`는 기본 브랜치에서 실행할 때만 작동합니다.
    if: github.event.repository.default_branch == github.ref_name || github.event_name == 'pull_request'

    permissions:
      security-events: write # 코드 스캐닝 대시보드에 결과를 업로드하기 위해 필요
      id-token: write      # 결과를 게시하고 배지를 받기 위해 필요 (publish_results와 관련)
      contents: read       # 개인 저장소 또는 특정 검사(Branch-Protection)를 위해 필요

    steps:
      - name: ">> 스텝 시작: 리포지토리 코드 체크아웃"
        run: echo "--- 리포지토리 체크아웃 스텝 시작 ---"
      - name: "리포지토리 코드 체크아웃"
        uses: actions/checkout@v4 # 최신 안정화 버전 태그 사용 (v4)
        with:
          persist-credentials: false
      - name: "<< 스텝 완료: 리포지토리 코드 체크아웃"
        run: echo "--- 리포지토리 체크아웃 스텝 완료 ---"

      - name: ">> 스텝 시작: OpenSSF Scorecard 분석 실행"
        run: echo "--- Scorecard 분석 스텝 시작 ---"
      - name: "OpenSSF Scorecard 분석 실행"
        uses: ossf/scorecard-action@v2 # 최신 안정화 버전 태그 사용 (v2)
        with:
          results_file: results.sarif
          results_format: sarif
          publish_results: true
          # (선택 사항) PAT 토큰 사용 고려:
          # 공개 저장소에서 브랜치 보호 검사 활성화 또는 개인 저장소 사용 시 필요.
          # repo_token: ${{ secrets.SCORECARD_TOKEN }}

      - name: "Scorecard 분석 결과 확인"
        run: |
          echo "Scorecard 분석이 완료되었습니다. results.sarif 파일 내용을 확인합니다."
          if [ -f "results.sarif" ]; then
            echo "results.sarif 파일이 성공적으로 생성되었습니다."
            cat results.sarif | head -n 20 # 파일의 앞 20줄만 출력하여 확인
          else
            echo "오류: results.sarif 파일이 생성되지 않았습니다."
            exit 1 # 파일이 없으면 오류로 처리
          fi
      - name: "<< 스텝 완료: OpenSSF Scorecard 분석 실행"
        run: echo "--- Scorecard 분석 스텝 완료 ---"

      - name: ">> 스텝 시작: SARIF 결과를 아티팩트로 업로드"
        run: echo "--- 아티팩트 업로드 스텝 시작 ---"
      - name: "SARIF 결과를 아티팩트로 업로드"
        uses: actions/upload-artifact@v4 # 최신 안정화 버전 태그 사용 (v4)
        with:
          name: Scorecard SARIF 파일
          path: results.sarif
          retention-days: 7
      - name: "<< 스텝 완료: SARIF 결과를 아티팩트로 업로드"
        run: echo "--- 아티팩트 업로드 스텝 완료 ---"

      - name: ">> 스텝 시작: 결과를 GitHub 코드 스캐닝 대시보드에 업로드"
        run: echo "--- 코드 스캐닝 업로드 스텝 시작 ---"
      - name: "결과를 GitHub 코드 스캐닝 대시보드에 업로드"
        uses: github/codeql-action/upload-sarif@v3 # 최신 안정화 버전 태그 사용 (v3)
        with:
          sarif_file: results.sarif
      - name: "<< 스텝 완료: 결과를 GitHub 코드 스캐닝 대시보드에 업로드"
        run: echo "--- 코드 스캐닝 업로드 스텝 완료 ---"

      - name: ">> 워크플로우 실행 종료"
        run: echo "--- 워크플로우 실행이 성공적으로 완료되었습니다 ---"
