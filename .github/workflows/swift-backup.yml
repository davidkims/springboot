name: 🛠️ Swift CLI 설치 및 DB 백업

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  swift-backup:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    env:
      SWIFT_VERSION: 5.9

    steps:
      - name: 📁 저장소 체크아웃
        uses: actions/checkout@v4

      - name: 🧰 Swift CLI 설치
        run: |
          sudo apt-get update
          sudo apt-get install -y clang libicu-dev libpython3-dev
          curl -fsSL https://download.swift.org/swift-${SWIFT_VERSION}-release/ubuntu2204/swift-${SWIFT_VERSION}-RELEASE/swift-${SWIFT_VERSION}-RELEASE-ubuntu22.04.tar.gz -o swift.tar.gz
          sudo mkdir -p /opt/swift
          sudo tar -xzf swift.tar.gz -C /opt/swift --strip-components=1
          echo 'export PATH="/opt/swift/usr/bin:$PATH"' >> $GITHUB_ENV
          swift --version

      - name: 🛠️ Swift 프로젝트 빌드 (main.swift)
        run: |
          mkdir -p swiftapp
          echo "print(\"✅ Swift 프로그램 실행\")" > swiftapp/main.swift
          swiftc swiftapp/main.swift -o swiftapp/Program
          ./swiftapp/Program

      - name: 🚀 프로그램 파일 설치
        run: |
          sudo mkdir -p /opt/swiftapp/bin
          sudo cp swiftapp/Program /opt/swiftapp/bin/
          sudo chmod +x /opt/swiftapp/bin/Program

      - name: 💾 Swift DB 백업 (샘플 JSON)
        run: |
          sudo mkdir -p /opt/backup/swift
          echo "📄 Swift DB JSON 파일 생성"
          cat << 'EOF' > /opt/backup/swift/swift-db.json
{
  "users": [
    { "id": 1, "name": "홍길동", "email": "hong@example.com" },
    { "id": 2, "name": "김철수", "email": "kim@example.com" }
  ],
  "backup_time": "$(date -Iseconds)"
}
EOF
          cat /opt/backup/swift/swift-db.json

      - name: 📊 백업 보고서 생성 (Markdown)
        run: |
          echo "# Swift 백업 보고서" > swift-backup-report.md
          echo "- 백업 시간: $(date)" >> swift-backup-report.md
          echo "- 프로그램 경로: /opt/swiftapp/bin/Program" >> swift-backup-report.md
          echo "- 백업 파일: /opt/backup/swift/swift-db.json" >> swift-backup-report.md
