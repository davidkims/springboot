name: Build & Deploy finance-transactions

on:
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›’ Checkout ì½”ë“œ
        uses: actions/checkout@v4

      - name: ğŸ“„ requirements.txt ìƒì„±
        run: |
          echo "[âœ”ï¸] requirements.txt ìƒì„±"
          echo "flask" > requirements.txt
          echo "python-dotenv" >> requirements.txt
          cat requirements.txt

      - name: âš™ï¸ .env ìƒì„±
        run: |
          echo "[âœ”ï¸] .env ìƒì„±"
          echo "FLASK_ENV=production" > .env
          echo "APP_NAME=FinanceTransactions" >> .env
          echo "DEBUG=False" >> .env
          cat .env

      - name: ğŸ“„ app.py echo ìƒì„± (GET/POST API)
        run: |
          echo "[âœ”ï¸] app.py ìƒì„± ì‹œì‘"
          echo "from flask import Flask, request, jsonify" > app.py
          echo "from dotenv import load_dotenv" >> app.py
          echo "import os" >> app.py
          echo "" >> app.py
          echo "load_dotenv()" >> app.py
          echo "app = Flask(__name__)" >> app.py
          echo "" >> app.py
          echo "@app.route('/', methods=['GET'])" >> app.py
          echo "def index():" >> app.py
          echo "    return jsonify({" >> app.py
          echo "        'status': 'success'," >> app.py
          echo "        'message': f'{os.getenv(\"APP_NAME\")} is running!'," >> app.py
          echo "        'env': os.getenv('FLASK_ENV')" >> app.py
          echo "    })" >> app.py
          echo "" >> app.py
          echo "@app.route('/transaction', methods=['POST'])" >> app.py
          echo "def transaction():" >> app.py
          echo "    try:" >> app.py
          echo "        data = request.get_json(force=True)" >> app.py
          echo "        return jsonify({" >> app.py
          echo "            'status': 'success'," >> app.py
          echo "            'message': 'Transaction received'," >> app.py
          echo "            'data': data" >> app.py
          echo "        }), 200" >> app.py
          echo "    except Exception as e:" >> app.py
          echo "        return jsonify({" >> app.py
          echo "            'status': 'error'," >> app.py
          echo "            'message': str(e)" >> app.py
          echo "        }), 400" >> app.py
          echo "" >> app.py
          echo "if __name__ == '__main__':" >> app.py
          echo "    app.run(host='0.0.0.0', port=5000)" >> app.py
          echo "[âœ”ï¸] app.py ìƒì„± ì™„ë£Œ"
          cat app.py

      - name: ğŸ“„ Dockerfile ìƒì„±
        run: |
          echo "[âœ”ï¸] Dockerfile ìƒì„± ì‹œì‘"
          echo "FROM python:3.11-slim" > Dockerfile
          echo "WORKDIR /app" >> Dockerfile
          echo "COPY . ." >> Dockerfile
          echo "RUN pip install --no-cache-dir -r requirements.txt" >> Dockerfile
          echo "EXPOSE 5000" >> Dockerfile
          echo "CMD [\"python\", \"app.py\"]" >> Dockerfile
          echo "[âœ”ï¸] Dockerfile ìƒì„± ì™„ë£Œ"
          cat Dockerfile

      - name: ğŸ³ Docker ì„¤ì¹˜
        run: |
          echo "[âœ”ï¸] Docker ì„¤ì¹˜ ì‹œì‘"
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          sudo systemctl start docker || sudo service docker start
          docker --version

      - name: ğŸ—ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ
        run: |
          echo "[ğŸš§] Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘"
          docker build -t finance-transactions:latest .
          echo "[âœ”ï¸] Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"

      - name: ğŸš€ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        run: |
          echo "[ğŸ§¹] ì´ì „ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘"
          docker rm -f finance-transactions || echo "âš ï¸ ì´ì „ ì»¨í…Œì´ë„ˆ ì—†ìŒ"
          echo "[ğŸš€] ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘"
          docker run -d \
            -p 8080:5000 \
            --name finance-transactions \
            -v finance-data:/data \
            finance-transactions:latest
          echo "[âœ”ï¸] ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì™„ë£Œ"

      - name: ğŸ§¹ ì •ë¦¬ ì‘ì—… (Always)
        if: always()
        run: |
          echo "[ğŸ§¼] ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘"
          docker rm -f finance-transactions || true
          docker volume prune -f || true
