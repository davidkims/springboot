name: PostgreSQL DB λ°±μ—… λ° S3 μ—…λ΅λ“

on:
  workflow_dispatch: # GitHub UIμ—μ„ μλ™ μ‹¤ν–‰ κ°€λ¥ν•λ„λ΅ μ„¤μ •

jobs:
  backup_postgres:
    runs-on: ubuntu-latest

    # ν™κ²½ λ³€μ μ •μ
    env:
      DB_HOST: your_db_host        # PostgreSQL νΈμ¤νΈ IP λλ” λ„λ©”μΈ
      DB_PORT: 5432              # PostgreSQL ν¬νΈ (κΈ°λ³Έ 5432)
      DB_USER: your_db_user      # PostgreSQL μ‚¬μ©μλ…
      DB_NAME: your_db_name      # λ°±μ—…ν•  λ°μ΄ν„°λ² μ΄μ¤ μ΄λ¦„
      PGPASSWORD: your_db_password # PostgreSQL μ‚¬μ©μ λΉ„λ°€λ²νΈ
      
      AWS_REGION: ap-northeast-2 # S3 λ²„ν‚·μ΄ μ„μΉν• AWS λ¦¬μ „
      S3_BUCKET_NAME: your-s3-backup-bucket # λ°±μ—… νμΌμ„ μ—…λ΅λ“ν•  S3 λ²„ν‚· μ΄λ¦„

    steps:
      - name: π“¦ μ‚¬μ „ μ¤€λΉ„: PostgreSQL ν΄λΌμ΄μ–ΈνΈ μ„¤μΉ
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: π•’ νƒ€μ„μ¤νƒ¬ν”„ λ° λ°±μ—… νμΌ κ²½λ΅ μ„¤μ •
        id: set_vars # μ΄ λ‹¨κ³„μ μ¶λ ¥ κ°’μ„ μ°Έμ΅°ν•κΈ° μ„ν• ID
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          BACKUP_FILE_NAME="database_backup_${TIMESTAMP}.sql"
          
          # λ°±μ—… νμΌμ„ μ €μ¥ν•  μ„μ‹ λ””λ ‰ν† λ¦¬ μƒμ„± (runner ν™κ²½)
          mkdir -p /tmp/db_backups
          BACKUP_FILE_PATH="/tmp/db_backups/${BACKUP_FILE_NAME}"
          
          echo "BACKUP_FILE_PATH=${BACKUP_FILE_PATH}" >> "$GITHUB_OUTPUT"
          echo "BACKUP_FILE_NAME=${BACKUP_FILE_NAME}" >> "$GITHUB_OUTPUT"
          echo "TIMESTAMP=${TIMESTAMP}" >> "$GITHUB_OUTPUT" # ν•„μ” μ‹ μ‚¬μ©

      - name: π’Ύ PostgreSQL λ°μ΄ν„°λ² μ΄μ¤ λ°±μ—… (pg_dump)
        run: |
          # ν™κ²½ λ³€μ PGPASSWORDλ¥Ό μ‚¬μ©ν•μ—¬ λΉ„λ°€λ²νΈλ¥Ό μ•μ „ν•κ² μ „λ‹¬
          # BACKUP_FILE_PATHλ” μ΄μ „ λ‹¨κ³„μ—μ„ μ„¤μ •λ μ •ν™•ν• κ²½λ΅λ¥Ό μ‚¬μ©
          pg_dump -h "${{ env.DB_HOST }}" -p "${{ env.DB_PORT }}" -U "${{ env.DB_USER }}" -d "${{ env.DB_NAME }}" > "${{ steps.set_vars.outputs.BACKUP_FILE_PATH }}"
          
          echo "β… PostgreSQL λ°±μ—… μ™„λ£: ${{ steps.set_vars.outputs.BACKUP_FILE_PATH }}"
          ls -lh "${{ steps.set_vars.outputs.BACKUP_FILE_PATH }}" # λ°±μ—… νμΌ μ •λ³΄ ν™•μΈ

      - name: π” λ°±μ—… νμΌ μ•”νΈν™” (μ„ νƒ μ‚¬ν•­)
        # μ΄ λ‹¨κ³„λ” μ•”νΈν™” ν‚¤ κ΄€λ¦¬ μ „λµμ— λ”°λΌ λ‹¬λΌμ§‘λ‹λ‹¤.
        # μμ‹λ΅ OpenSSLμ„ μ‚¬μ©ν•μ§€λ§, μ‹¤μ  ν”„λ΅λ•μ…μ—μ„λ” λ” μ•μ „ν• λ°©μ‹μ„ κ³ λ ¤ν•΄μ•Ό ν•©λ‹λ‹¤.
        # openssl enc -aes-256-cbc -salt -in "${{ steps.set_vars.outputs.BACKUP_FILE_PATH }}" -out "${{ steps.set_vars.outputs.BACKUP_FILE_PATH }}.enc" -k "your_encryption_key_here" # μ‹¤μ  ν‚¤ μ‚¬μ©
        # rm "${{ steps.set_vars.outputs.BACKUP_FILE_PATH }}" # μ›λ³Έ νμΌ μ‚­μ  (μ•”νΈν™” μ„±κ³µ μ‹)
        run: echo "μ•”νΈν™” λ‹¨κ³„λ” λ³΄μ• ν‚¤ κ΄€λ¦¬ λ°©μ•μ— λ”°λΌ κµ¬ν„ ν•„μ”"
        # continue-on-error: true # μ•”νΈν™” μ‹¤ν¨ μ‹μ—λ„ μ›ν¬ν”λ΅μ° μ§„ν–‰

      - name: βοΈ AWS μκ²© μ¦λ… κµ¬μ„±
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: β¬†οΈ S3μ— λ°±μ—… μ—…λ΅λ“
        run: |
          # λ°±μ—… νμΌμ„ S3 λ²„ν‚·μ— μ—…λ΅λ“ν•©λ‹λ‹¤.
          # μ•”νΈν™”λ νμΌμ„ μ—…λ΅λ“ν•λ” κ²½μ°, ${BACKUP_FILE_PATH}.enc λ¥Ό μ‚¬μ©ν•΄μ•Ό ν•©λ‹λ‹¤.
          aws s3 cp "${{ steps.set_vars.outputs.BACKUP_FILE_PATH }}" "s3://${{ env.S3_BUCKET_NAME }}/backups/${{ steps.set_vars.outputs.BACKUP_FILE_NAME }}"
          echo "β… S3 μ—…λ΅λ“ μ™„λ£: s3://${{ env.S3_BUCKET_NAME }}/backups/${{ steps.set_vars.outputs.BACKUP_FILE_NAME }}"

      - name: π§Ή λ΅μ»¬ λ°±μ—… νμΌ μ •λ¦¬
        if: always() # μ΄μ „ λ‹¨κ³„ μ‹¤ν¨ μ—¬λ¶€μ™€ μƒκ΄€μ—†μ΄ ν•­μƒ μ‹¤ν–‰
        run: |
          # μ„μ‹ λ°±μ—… νμΌκ³Ό λ””λ ‰ν† λ¦¬λ¥Ό μ‚­μ ν•©λ‹λ‹¤.
          rm -rf /tmp/db_backups
          echo "β… λ΅μ»¬ λ°±μ—… νμΌ μ •λ¦¬ μ™„λ£"
