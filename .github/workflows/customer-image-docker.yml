name: π§Ύ λ‹¤μ¤‘ κ³ κ° λ…ν•¨ μƒμ„± + μ•”νΈν™”/λ³µνΈν™”

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-encrypted-cards:
    runs-on: ubuntu-latest

    steps:
    - name: π“¥ μ½”λ“ μ²΄ν¬μ•„μ›ƒ
      uses: actions/checkout@v4

    - name: π“ λ””λ ‰ν† λ¦¬ μƒμ„±
      run: |
        mkdir -p cards_encrypted cards_decrypted

    - name: π generate_multi_cards.py λ° Dockerfile μƒμ„±
      run: |
        echo "from PIL import Image, ImageDraw" > generate_multi_cards.py
        echo "from cryptography.fernet import Fernet" >> generate_multi_cards.py
        echo "import os" >> generate_multi_cards.py
        echo "key = Fernet.generate_key()" >> generate_multi_cards.py
        echo "fernet = Fernet(key)" >> generate_multi_cards.py
        echo "os.makedirs('/data/encrypted', exist_ok=True)" >> generate_multi_cards.py
        echo "os.makedirs('/data/decrypted', exist_ok=True)" >> generate_multi_cards.py
        echo "customer_ids = ['CUST001', 'CUST002', 'CUST003']" >> generate_multi_cards.py
        echo "with open('/data/encrypted/key.key', 'wb') as kf: kf.write(key)" >> generate_multi_cards.py
        echo "for cid in customer_ids:" >> generate_multi_cards.py
        echo "  img = Image.new('RGB', (400, 200), color=(200, 120, 120))" >> generate_multi_cards.py
        echo "  d = ImageDraw.Draw(img)" >> generate_multi_cards.py
        echo "  d.text((10, 80), f'κ³ κ° ID: {cid}', fill=(0, 0, 0))" >> generate_multi_cards.py
        echo "  img_path = f'/data/tmp_{cid}.png'" >> generate_multi_cards.py
        echo "  img.save(img_path)" >> generate_multi_cards.py
        echo "  with open(img_path, 'rb') as f: enc = fernet.encrypt(f.read())" >> generate_multi_cards.py
        echo "  with open(f'/data/encrypted/{cid}.enc', 'wb') as ef: ef.write(enc)" >> generate_multi_cards.py
        echo "  dec = fernet.decrypt(enc)" >> generate_multi_cards.py
        echo "  with open(f'/data/decrypted/{cid}.decrypted.png', 'wb') as df: df.write(dec)" >> generate_multi_cards.py
        echo "  os.remove(img_path)" >> generate_multi_cards.py
        echo "print('β… λ‹¤μ¤‘ λ…ν•¨ μƒμ„± λ° μ•”νΈν™”/λ³µνΈν™” μ™„λ£')" >> generate_multi_cards.py

        echo "FROM python:3.10-slim" > Dockerfile
        echo "WORKDIR /app" >> Dockerfile
        echo "COPY generate_multi_cards.py /app/" >> Dockerfile
        echo "RUN pip install pillow cryptography" >> Dockerfile
        echo "CMD [\"python\", \"generate_multi_cards.py\"]" >> Dockerfile

    - name: π› οΈ Docker μ΄λ―Έμ§€ λΉλ“
      run: docker build -t customer-card-multi-encrypt .

    - name: πƒ Docker μ»¨ν…μ΄λ„ μ‹¤ν–‰
      run: |
        docker run --rm \
          -v $(pwd)/cards_encrypted:/data/encrypted \
          -v $(pwd)/cards_decrypted:/data/decrypted \
          customer-card-multi-encrypt

    - name: π“‚ κ²°κ³Ό ν™•μΈ
      run: |
        echo "π“¦ μ•”νΈν™”λ λ…ν•¨:"
        ls -lh cards_encrypted
        echo "π–ΌοΈ λ³µνΈν™”λ λ…ν•¨:"
        ls -lh cards_decrypted

    - name: π“¤ μ•„ν‹°ν©νΈ μ—…λ΅λ“ (μ•”νΈν™”λ λ…ν•¨)
      uses: actions/upload-artifact@v4
      with:
        name: encrypted-customer-cards
        path: cards_encrypted/

    - name: π“¤ μ•„ν‹°ν©νΈ μ—…λ΅λ“ (λ³µνΈν™”λ λ…ν•¨)
      uses: actions/upload-artifact@v4
      with:
        name: decrypted-customer-cards
        path: cards_decrypted/
