name: 🧾 Finance Auto Ledger with PostgreSQL & MySQL

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  ledger-setup:
    runs-on: ubuntu-latest

    env:
      PG_DB: finance
      PG_USER: postgres
      PG_PASS: pgpass
      MYSQL_ROOT_PASS: rootpass
      LEDGER_PATH: ledger
      SQL_DIR: sql
      TIMESTAMP: 20250603021601

    steps:
      - name: 📁 디렉토리 및 SQL 파일 생성
        run: |
          mkdir -p $LEDGER_PATH $SQL_DIR
          cat <<EOF > $SQL_DIR/init.sql
          CREATE TABLE IF NOT EXISTS transactions (
            id SERIAL PRIMARY KEY,
            type VARCHAR(20),
            amount NUMERIC,
            currency VARCHAR(10),
            status VARCHAR(20),
            timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
          INSERT INTO transactions(type, amount, currency, status) VALUES
            ('credit_card', 30000, 'KRW', 'completed'),
            ('check_card', 25000, 'KRW', 'completed'),
            ('stock', 1200000, 'KRW', 'pending'),
            ('forex', 500, 'USD', 'completed');
          EOF

      - name: 🐘 PostgreSQL 설치 및 설정
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql
          sudo systemctl start postgresql
          sudo systemctl enable postgresql
          sudo -u postgres psql -c "ALTER USER $PG_USER WITH PASSWORD '$PG_PASS';"
          echo "localhost:5432:$PG_DB:$PG_USER:$PG_PASS" > ~/.pgpass
          chmod 600 ~/.pgpass

      - name: 🐘 PostgreSQL DB 및 테이블 초기화
        run: |
          sudo -u postgres createdb $PG_DB || echo "✅ 이미 존재"
          PGPASSFILE=$HOME/.pgpass psql -h localhost -U $PG_USER -d $PG_DB -f $SQL_DIR/init.sql

      - name: 🐬 MySQL 설치 및 원장 테이블 생성
        run: |
          sudo apt-get install -y mysql-server
          sudo systemctl start mysql
          sudo systemctl enable mysql

          # root 비밀번호 설정
          sudo mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '$MYSQL_ROOT_PASS'; FLUSH PRIVILEGES;"

          # 원장 DB 및 테이블 생성
          sudo mysql --user=root --password=$MYSQL_ROOT_PASS -e "
            CREATE DATABASE IF NOT EXISTS ledger_db;
            USE ledger_db;
            CREATE TABLE IF NOT EXISTS ledger (
              id INT AUTO_INCREMENT PRIMARY KEY,
              transaction_type VARCHAR(30),
              detail TEXT,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
            INSERT INTO ledger(transaction_type, detail) VALUES
              ('credit_card', '신용카드 결제 완료'),
              ('check_card', '체크카드 결제 완료'),
              ('stock', '주식 매수 대기'),
              ('forex', '환전 완료');
          "

      - name: 📄 PostgreSQL 거래 로그 출력
        run: |
          echo "🔍 PostgreSQL 거래 로그:"
          PGPASSFILE=$HOME/.pgpass psql -h localhost -U $PG_USER -d $PG_DB -c "SELECT * FROM transactions;"

      - name: 📄 MySQL 원장 출력
        run: |
          echo "🔍 MySQL Ledger:"
          sudo mysql --user=root --password=$MYSQL_ROOT_PASS -e "USE ledger_db; SELECT * FROM ledger;"
