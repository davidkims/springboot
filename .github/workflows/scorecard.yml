name: Scorecard Supply-Chain Security

on:
  # OSSF Scorecard 문서는 브랜치 보호 규칙을 '검사'할 것을 언급하지만,
  # 'branch_protection_rules'는 GitHub Actions의 유효한 트리거 이벤트 이름이 아닙니다.
  # 따라서 이 부분을 제거합니다.

  # 유지 관리 점검이 정기적으로 업데이트되도록 보장합니다.
  schedule:
    - cron: '21 2 * * 0' # 매주 일요일 새벽 2시 21분 UTC에 실행

  # 'main' 브랜치에 코드가 푸시될 때 실행
  push:
    branches: ["main"]

  # 워크플로우를 수동으로 실행할 수 있도록 허용
  workflow_dispatch:

# 기본 권한을 읽기 전용으로 선언합니다.
permissions:
  contents: read

jobs:
  analyze:
    name: Scorecard 분석
    runs-on: ubuntu-latest

    # `publish_results: true`는 기본 브랜치에서 실행할 때만 작동합니다.
    if: github.event.repository.default_branch == github.ref_name || github.event_name == 'pull_request'

    permissions:
      security-events: write # 코드 스캐닝 대시보드에 결과를 업로드하기 위해 필요
      id-token: write      # 결과를 게시하고 배지를 받기 위해 필요
      contents: read       # 개인 저장소 또는 특정 검사(Branch-Protection)를 위해 필요

    steps:
      - name: ">> 스텝 시작: 리포지토리 코드 체크아웃"
        run: echo "--- 리포지토리 체크아웃 스텝 시작 ---"
      - name: "리포지토리 코드 체크아웃"
        uses: actions/checkout@v4 # 최신 안정화 버전 태그 사용
        with:
          persist-credentials: false
      - name: "<< 스텝 완료: 리포지토리 코드 체크아웃"
        run: echo "--- 리포지토리 체크아웃 스텝 완료 ---"

      - name: ">> 스텝 시작: OpenSSF Scorecard 분석 실행"
        run: echo "--- 스코어카드 분석 스텝 시작 ---"
      - name: "OpenSSF Scorecard 분석 실행"
        # 🔴 이 부분을 아래 옵션 중 하나로 수정하세요 🔴
        # 옵션 1 (권장 - 더 안전하고 재현성 높음): 최신 커밋 SHA 사용
        # (ossf/scorecard-action GitHub 저장소에서 'main' 브랜치 또는 최신 릴리스의 SHA 확인)
        uses: ossf/scorecard-action@1a415a775193984d720b7218684d0b17b01d6706 # 2025년 6월 8일 기준 v2.4.1의 SHA

        # 옵션 2 (대안 - 유연하지만 잠재적 위험 있음): 최신 안정화 버전 태그 사용
        # (ossf/scorecard-action GitHub 저장소에서 현재 유효한 최신 주 버전 태그 확인)
        # uses: ossf/scorecard-action@v2.4.1 # v2 태그가 유효하지 않다면 구체적인 v2.x.x 태그 시도

        with:
          results_file: results.sarif
          results_format: sarif
          publish_results: true
          # (선택 사항) PAT 토큰 사용 고려:
          # 공개 저장소에서 브랜치 보호 검사 활성화 또는 개인 저장소 사용 시 필요.
          # repo_token: ${{ secrets.SCORECARD_TOKEN }}

      - name: "Scorecard 분석 결과 확인"
        run: |
          echo "Scorecard 분석이 완료되었습니다. results.sarif 파일 내용을 확인합니다."
          if [ -f "results.sarif" ]; then
            echo "results.sarif 파일이 성공적으로 생성되었습니다."
            cat results.sarif | head -n 20 # 파일의 앞 20줄만 출력하여 확인
          else
            echo "오류: results.sarif 파일이 생성되지 않았습니다."
            exit 1 # 파일이 없으면 오류로 처리
          fi
      - name: "<< 스텝 완료: OpenSSF Scorecard 분석 실행"
        run: echo "--- 스코어카드 분석 스텝 완료 ---"

      - name: ">> 스텝 시작: SARIF 결과를 아티팩트로 업로드"
        run: echo "--- 아티팩트 업로드 스텝 시작 ---"
      - name: "SARIF 결과를 아티팩트로 업로드"
        uses: actions/upload-artifact@v4 # 최신 안정화 버전 태그 사용
        with:
          name: Scorecard SARIF 파일
          path: results.sarif
          retention-days: 7
      - name: "<< 스텝 완료: SARIF 결과를 아티팩트로 업로드"
        run: echo "--- 아티팩트 업로드 스텝 완료 ---"

      - name: ">> 스텝 시작: 결과를 GitHub 코드 스캐닝 대시보드에 업로드"
        run: echo "--- 코드 스캐닝 업로드 스텝 시작 ---"
      - name: "결과를 GitHub 코드 스캐닝 대시보드에 업로드"
        uses: github/codeql-action/upload-sarif@v3 # 최신 안정화 버전 태그 사용
        with:
          sarif_file: results.sarif
      - name: "<< 스텝 완료: 결과를 GitHub 코드 스캐닝 대시보드에 업로드"
        run: echo "--- 코드 스캐닝 업로드 스텝 완료 ---"

      - name: ">> 워크플로우 실행 종료"
        run: echo "--- 워크플로우 실행이 성공적으로 완료되었습니다 ---"
