name: ğŸ” ê¸ˆìœµ ê±°ë˜ ìë™ ë°±ì—…

on:
  push:
    branches: ["main"]
  schedule:
    - cron: "*/5 * * * *"  # 5ë¶„ ê°„ê²©
  workflow_dispatch:

jobs:
  finance-sql-backup:
    runs-on: ubuntu-latest

    env:
      MYSQL_ROOT_PASSWORD: rootpass123
      BACKUP_DIR: /opt/finance/backups
      SQL_SCHEMA_PATH: ./finance-schema.sql

    steps:
      - name: ğŸ“‚ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“ ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±
        run: |
          sudo mkdir -p $BACKUP_DIR
          sudo chmod -R 777 $BACKUP_DIR

      - name: ğŸ“œ Dockerfile ìë™ ìƒì„±
        run: |
          cat <<EOF > Dockerfile
          FROM mysql:8.0
          ENV MYSQL_ROOT_PASSWORD=\$MYSQL_ROOT_PASSWORD
          COPY finance-schema.sql /docker-entrypoint-initdb.d/
          EOF

      - name: ğŸ“ ê¸ˆìœµ ìŠ¤í‚¤ë§ˆ ì‘ì„±
        run: |
          cat <<EOSQL > finance-schema.sql
          CREATE DATABASE IF NOT EXISTS finance;
          USE finance;
          CREATE TABLE IF NOT EXISTS bank_transfers (
            id INT AUTO_INCREMENT PRIMARY KEY,
            account_number VARCHAR(30),
            amount DECIMAL(12,2),
            currency VARCHAR(5),
            timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
          CREATE TABLE IF NOT EXISTS stock_transfers (
            id INT AUTO_INCREMENT PRIMARY KEY,
            stock_symbol VARCHAR(10),
            shares INT,
            price DECIMAL(10,2),
            timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
          CREATE TABLE IF NOT EXISTS stock_infos (
            id INT AUTO_INCREMENT PRIMARY KEY,
            ticker VARCHAR(10),
            company_name VARCHAR(100),
            market VARCHAR(20)
          );
          CREATE TABLE IF NOT EXISTS card_transactions (
            id INT AUTO_INCREMENT PRIMARY KEY,
            card_type ENUM('credit', 'check'),
            amount DECIMAL(10,2),
            merchant VARCHAR(100),
            status VARCHAR(20),
            timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
          INSERT INTO bank_transfers(account_number, amount, currency) VALUES ('123456789', 500000, 'KRW');
          INSERT INTO stock_transfers(stock_symbol, shares, price) VALUES ('AAPL', 10, 200.00);
          INSERT INTO stock_infos(ticker, company_name, market) VALUES ('AAPL', 'Apple Inc.', 'NASDAQ');
          INSERT INTO card_transactions(card_type, amount, merchant, status) VALUES ('credit', 120000, 'CoffeeShop', 'approved');
          EOSQL

      - name: ğŸ‹ Docker ì´ë¯¸ì§€ ë¹Œë“œ
        run: docker build -t finance-backup .

      - name: ğŸš€ MySQL ì»¨í…Œì´ë„ˆ ì‹œì‘ ë° ëŒ€ê¸°
        run: |
          docker run -d --name finance-db \
            -e MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD \
            -p 3307:3306 \
            finance-backup

          echo "â³ MySQL ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘..."
          sleep 30

      - name: ğŸ’¾ SQL ë°±ì—… ì‹¤í–‰
        run: |
          docker exec finance-db mysqldump -u root -p$MYSQL_ROOT_PASSWORD finance > $BACKUP_DIR/finance-backup-${{ github.run_id }}.sql
          ls -lh $BACKUP_DIR

      - name: ğŸ§¹ ì»¨í…Œì´ë„ˆ ì •ë¦¬
        run: docker rm -f finance-db || true
