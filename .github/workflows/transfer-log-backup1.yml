name: â™¾ï¸ Transfer Log Backup - Infinite Resident Container

on:
  workflow_dispatch:

jobs:
  transfer_log_backup:
    runs-on: ubuntu-latest

    env:
      TRANSFER_LOG_DIR: /opt/logs/transfer
      BACKUP_DIR: /opt/backup/transfer
      CONTAINER_IMAGE: alpine:latest

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“ Prepare transfer log directory and sample log
        run: |
          sudo mkdir -p $TRANSFER_LOG_DIR
          sudo mkdir -p $BACKUP_DIR
          echo "[TRANSFER] 2025-06-02 15:00 ì†¡ê¸ˆ â‚©1,000,000 ì™„ë£Œ | ê³„ì¢Œ: 110-123-456789" | sudo tee $TRANSFER_LOG_DIR/transfer-log.txt
          sudo chmod -R 777 $TRANSFER_LOG_DIR $BACKUP_DIR

      - name: ğŸ³ Run infinite backup container
        run: |
          docker run -d \
            --name transfer-backup-resident \
            --restart unless-stopped \
            -v $TRANSFER_LOG_DIR:/data/logs:ro \
            -v $BACKUP_DIR:/data/backup \
            $CONTAINER_IMAGE \
            sh -c '
              echo "â™¾ï¸ Transfer log backup container started";
              while true; do
                TS=$(date +%Y%m%d_%H%M%S);
                mkdir -p "/data/backup/$TS";
                cp -r /data/logs/* "/data/backup/$TS/";
                echo "âœ… Backup completed at $TS";
                sleep 60;
              done
            '

      - name: ğŸ“‚ Show initial backup result
        run: |
          sleep 10
          echo "ğŸ“¦ ë°±ì—… ë””ë ‰í† ë¦¬ ìƒíƒœ:"
          ls -R $BACKUP_DIR | tail -n 20
